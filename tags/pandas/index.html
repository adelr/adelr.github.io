<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Overview of all pages with the tag #pandas - Dinkum Data Blog</title>
  <meta property="og:title" content="Overview of all pages with the tag #pandas" />
  <meta name="twitter:title" content="Overview of all pages with the tag #pandas" />
  <meta name="description" content="Overview of all pages with the tag #pandas, such as: Polyglot Data Wrangling">
  <meta property="og:description" content="Overview of all pages with the tag #pandas, such as: Polyglot Data Wrangling">
  <meta name="twitter:description" content="Overview of all pages with the tag #pandas, such as: Polyglot Data Wrangling">
  <meta name="author" content="Adel Rahmani"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Dinkum Data Blog",
    
    "url": "https:\/\/adelr.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/adelr.github.io\/"
  
  
  
  
}
</script>

<meta property="og:title" content="pandas" />
<meta property="og:image" content="https://adelr.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://adelr.github.io/tags/pandas/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Dinkum Data Blog" />

  <meta name="twitter:title" content="pandas" />
  <meta name="twitter:image" content="https://adelr.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@DinkumData" />
  <meta name="twitter:creator" content="@DinkumData" />
  <meta property="og:image" content="https://adelr.github.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://adelr.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@DinkumData" />
  <meta name="twitter:creator" content="@DinkumData" />
  <meta property="og:url" content="https://adelr.github.io/tags/pandas/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Dinkum Data Blog" />

  <meta name="generator" content="Hugo 0.55.5" />
  <link rel="alternate" href="https://adelr.github.io/index.xml" type="application/rss+xml" title="Dinkum Data Blog"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://adelr.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://adelr.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://adelr.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-96102728-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://adelr.github.io/">Dinkum Data Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Dinkum Data Blog" href="https://adelr.github.io/">
            <img class="avatar-img" src="https://adelr.github.io/img/avatar-icon.png" alt="Dinkum Data Blog" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="tags-heading">
              
                <h1>pandas</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
  <div class="container" role="main">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        <div class="posts-list">
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2019/03/polyglot_wrangling/">
                <h2 class="post-title">Polyglot Data Wrangling</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on March 28, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;40&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;8477&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<h1 id="sql-vs-python-vs-r">SQL vs Python vs R</h1>

<p>In this post we will look a how basic data wrangling operations can be performed in 3 languages
commonly used in data science:</p>

<ul>
<li>Structured Query Language (SQL)</li>
<li>Python</li>
<li>R
<br /></li>
</ul>

<p>Note that while Python and R have obvious similarities in their approach to data wrangling, SQL is designed to work with relational data, where most of the time consuming operations are (ideally) performed on the database side rather than
in the client&rsquo;s memory. Both Python and R can process data in chunks, or even work with huge, distributed data sets through libraries like <a href="https://docs.dask.org/en/latest/">Dask</a> (Python only) or <a href="https://spark.apache.org/">Apache Spark</a> (Python, R, Scala, Java).
However, we&rsquo;re mostly interested in illustrating some basic data wrangling pipelines in all three languages, so we&rsquo;ll be using a small database that can easily fit in memory.</p>

<p>The <a href="https://jupyter.org/">Jupyter notebook</a> allows us to run all our examples in one place.
We&rsquo;ll run an IPython kernel as our base platform and use an <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">IPython magic command</a> to run our R code within the same environment, and we&rsquo;ll use <a href="https://www.sqlalchemy.org/">sqlalchemy</a> to run queries on a postgreSQL data base.</p>

<p>We won&rsquo;t be covering the basics of each language in this post. There are many excellent resources online.
For data wrangling the <a href="https://jakevdp.github.io/PythonDataScienceHandbook/">Python Data Science Handbook</a> is an outstanding book. For R it&rsquo;s hard to get past the wonderful <a href="https://r4ds.had.co.nz/">R for Data Science</a> by Garrett Grolemund and Hadley Wickham. For SQL there are more resources than we can mention, especially once we factor in the various vendor-specific flavours of SQL. One of my personal favourites is <a href="https://www.packtpub.com/application-development/sql-fundamentals-business-intelligence-video">SQL Fundamentals for BI</a> by Jeffrey James.
Our SQL examples are based on some of the contents of that course.</p>

<p>We start by loading the Python required libraries (we&rsquo;ll do all our data wrangling using the awesome <a href="https://pandas.pydata.org/">pandas</a> module) and create a connection to the PostgreSQL database using sqlalchemy.
For our examples we&rsquo;ll be using the well-known <a href="http://www.postgresqltutorial.com/postgresql-sample-database/">dvdrental database</a> which contains 15 tables representing various aspects of a DVD rental business.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Connect to a SQL (PostgreSQL) database</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;postgres:///dvdrental&#39;</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># Import pandas for data wrangling in python</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># use ipython magic command to load R into our environment.</span>
<span class="o">%</span><span class="n">load_ext</span> <span class="n">rpy2</span><span class="o">.</span><span class="n">ipython</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<p>All our R code will be preceded by <code>%%R</code> command to run it on the R interpreter from within our Jupyter notebook.
We start by loading the <a href="https://www.tidyverse.org/">tidyverse</a> library (which is in fact a collection of libraries),
and setting an option to improve how some outputs are rendered in the notebook.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
<span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kp">options</span><span class="p">(</span>crayon.enabled <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span></code></pre></div>
<p>Because we&rsquo;re running on top of an ipython kernel, we&rsquo;ll write our SQL queries as strings and use pandas to run them on our database via sqlalchemy.</p>

<hr />

<h2 id="the-data">The data</h2>

<p>First, let&rsquo;s see what tables are in our DVD rental database.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT * FROM pg_catalog.pg_tables;
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pg_&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">df</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sql_&#39;</span><span class="p">))]</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">values</span>
<span class="k">print</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;category&#39; &#39;country&#39; &#39;film_category&#39; &#39;language&#39; &#39;inventory&#39; &#39;actor&#39;
 &#39;staff&#39; &#39;payment&#39; &#39;rental&#39; &#39;store&#39; &#39;city&#39; &#39;film&#39; &#39;address&#39; &#39;film_actor&#39;
 &#39;customer&#39;]</pre></div>
<p>For convenience, let&rsquo;s create a python dictionary with all the tables as dataframes.</p>

<p>Obviously, this means that we&rsquo;re loading all the tables into memory, <strong>which is not what one would typically want to do with a SQL database</strong>, however, since our database is small, and we&rsquo;re only interested in comparing the wrangling syntax across different languages, this is fine for our purpose.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tbl</span> <span class="o">=</span> <span class="p">{</span><span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SELECT * FROM {table};&#39;</span><span class="p">,</span> 
                                <span class="n">con</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_date&#39;</span><span class="p">])</span> 
       <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">}</span></code></pre></div>
<p>Let&rsquo;s look at a few rows of the payment table.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">payment</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;payment&#39;</span><span class="p">]</span>
<span class="n">payment</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17503</td>
      <td>341</td>
      <td>2</td>
      <td>1520</td>
      <td>7.99</td>
      <td>2007-02-15 22:25:46.996577</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17504</td>
      <td>341</td>
      <td>1</td>
      <td>1778</td>
      <td>1.99</td>
      <td>2007-02-16 17:23:14.996577</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17505</td>
      <td>341</td>
      <td>1</td>
      <td>1849</td>
      <td>7.99</td>
      <td>2007-02-16 22:41:45.996577</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17506</td>
      <td>341</td>
      <td>2</td>
      <td>2829</td>
      <td>2.99</td>
      <td>2007-02-19 19:39:56.996577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17507</td>
      <td>341</td>
      <td>2</td>
      <td>3130</td>
      <td>7.99</td>
      <td>2007-02-20 17:31:48.996577</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can &ldquo;pass&rdquo; the <code>payment</code> dataframe to R in the following way:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>i payment
<span class="kp">head</span><span class="p">(</span>payment<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">  payment_id customer_id staff_id rental_id amount        payment_date
0      17503         341        2      1520   7.99 2007-02-15 22:25:46
1      17504         341        1      1778   1.99 2007-02-16 17:23:14
2      17505         341        1      1849   7.99 2007-02-16 22:41:45
3      17506         341        2      2829   2.99 2007-02-19 19:39:56
4      17507         341        2      3130   7.99 2007-02-20 17:31:48
5      17508         341        1      3382   5.99 2007-02-21 12:33:49</pre></div>
<p>Now that we&rsquo;ve got all the tables loaded, let&rsquo;s run a few queries.</p>

<p>Let&rsquo;s start with something simple.</p>

<hr />

<h3 id="which-movie-rentals-were-below-a-dollar-for-customers-with-an-id-above-500">Which movie rentals were below a dollar for customers with an id above 500?</h3>

<h4 id="sql">▶ SQL</h4>

<p>The query is nothing fancy here. We&rsquo;re selecting a few features (columns) from the <code>payment</code> table,
filtering on the dollar amount and customer id before ordering the rows.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.payment_id, p.customer_id, p.amount 
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">WHERE 
</span><span class="s1">    p.amount &lt; 1 AND p.customer_id &gt; 500
</span><span class="s1">ORDER BY 1 ASC, 2 DESC, 3 ASC;
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>     <span class="c1"># run the query on the database</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>                    <span class="c1"># output the shape of the resulting table</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>                          <span class="c1"># display the first few rows</span></code></pre></div><div class="highlight"><pre class="chroma">(413, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18121</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18122</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18125</td>
      <td>503</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18134</td>
      <td>506</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18144</td>
      <td>510</td>
      <td>0.99</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python">▶ Python</h4>

<p>Pandas allow us to chain methods on a dataframe, however, writing everything on a single line is cumbersome for long pipelines.</p>

<p>We can write each step of the pipeline on its own line by wrapping the pipeline in brackets.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span><span class="p">[(</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)]</span>  <span class="c1"># select rows based on conditions</span>
         <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;payment_id&#39;</span><span class="p">,</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">]]</span>            <span class="c1"># select 3 columns</span>
         <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">],</span>  <span class="c1"># sort the rows according to the values  </span>
                      <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">])</span>               <span class="c1">#      in the columns</span>
         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                                   <span class="c1"># not really required but looks nicer</span>
        <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(413, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18121</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18122</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18125</td>
      <td>503</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18134</td>
      <td>506</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18144</td>
      <td>510</td>
      <td>0.99</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r">▶ R</h4>

<p>For this simple query the R code is similar to the Python one. The pipe symbol <code>%&gt;%</code> is equivalent to the dot symbol in pandas which allows us to chain methods together.</p>

<p>The <code>%%R -o df_r</code> part of the code is a way to transfer the R dataframe back to our Python interpreter.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>o df_r   
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>amount <span class="o">&lt;</span> <span class="m">1</span><span class="p">,</span> customer_id <span class="o">&gt;</span> <span class="m">500</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        select<span class="p">(</span>payment_id<span class="p">,</span> customer_id<span class="p">,</span> amount<span class="p">)</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>payment_id<span class="p">,</span> desc<span class="p">(</span>customer_id<span class="p">),</span> amount<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_r</span><span class="o">.</span><span class="n">shape</span>
<span class="n">df_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18121</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18122</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18125</td>
      <td>503</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18134</td>
      <td>506</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18144</td>
      <td>510</td>
      <td>0.99</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="sanity-check">Sanity check</h4>

<p>Just to make sure that we&rsquo;ve run our query correctly, we can compare the result from the SQL query with the results of the Python and R pipelines. Because of the fact that R indexing starts at 1 instead of 0, we need to reset the index of the R dataframe after we export it to Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">df_r</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">(True, True)</pre></div>
<p>Any other trivial query could be handled in a similar way&hellip;</p>

<p>Let&rsquo;s look at a query where we need to extract a feature that doesn&rsquo;t appear explicitly in the original data.</p>

<hr />

<h3 id="which-transactions-occured-in-the-month-of-march-only">Which transactions occured in the month of March only?</h3>

<p>The <code>payment</code> table has a <code>payment_date</code> feature from which we will need to extract the month.</p>

<h4 id="sql-1">▶  SQL</h4>

<p>We can extract the month value out of the <code>payment_date</code> column using the <code>EXTRACT</code> function.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.payment_id, p.customer_id cust_id, p.amount, p.payment_date
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">WHERE 
</span><span class="s1">    EXTRACT(month FROM p.payment_date) = 3
</span><span class="s1">    AND p.amount &lt; 1
</span><span class="s1">ORDER BY 
</span><span class="s1">    cust_id DESC, 3 ASC;
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(1021, 4)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>cust_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22611</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-02 15:51:25.996577</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22613</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-21 07:09:41.996577</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22606</td>
      <td>597</td>
      <td>0.99</td>
      <td>2007-03-19 05:51:32.996577</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22589</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-01 20:50:37.996577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22598</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-22 21:49:07.996577</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-1">▶ Python</h4>

<p>When we loaded the payment table from the database using sqlalchemy, the <code>payment_date</code> feature was correctly
parsed as a datetime object.</p>

<p>This allows us to use the pandas <code>dt</code> accessor to extract a variety of date and time related features, including the month.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span><span class="p">[(</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">==</span><span class="mi">3</span><span class="p">)]</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust_id&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reindex</span><span class="p">([</span><span class="s1">&#39;payment_id&#39;</span><span class="p">,</span><span class="s1">&#39;cust_id&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span><span class="s1">&#39;payment_date&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;cust_id&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">])</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
     <span class="p">)</span>
      
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(1021, 4)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>cust_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22611</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-02 15:51:25.996577</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22613</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-21 07:09:41.996577</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22606</td>
      <td>597</td>
      <td>0.99</td>
      <td>2007-03-19 05:51:32.996577</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22589</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-01 20:50:37.996577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22592</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-17 15:08:26.996577</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-1">▶ R</h4>

<p>A great way to handle datetime objects in R is via the <a href="https://lubridate.tidyverse.org/">lubridate</a> library.
To make it clear when we&rsquo;re using a lubridate object, we won&rsquo;t load the library, but we call its functions using
the <code>lubridate::</code> prefix.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>o df_r
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>amount <span class="o">&lt;</span> <span class="m">1</span><span class="p">,</span> lubridate<span class="o">::</span>month<span class="p">(</span>payment<span class="o">$</span>payment_date<span class="p">)</span><span class="o">==</span><span class="m">3</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        rename<span class="p">(</span>cust_id<span class="o">=</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        select<span class="p">(</span><span class="o">-</span>rental_id<span class="p">,</span> <span class="o">-</span>staff_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>desc<span class="p">(</span>cust_id<span class="p">),</span> amount<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">df_r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(1021, 4)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>cust_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22611</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-02 15:51:25+11:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22613</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-21 07:09:41+11:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22606</td>
      <td>597</td>
      <td>0.99</td>
      <td>2007-03-19 05:51:32+11:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22589</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-01 20:50:37+11:00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22592</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-17 15:08:26+11:00</td>
    </tr>
  </tbody>
</table>
</div>

<p>Here we get an glimpse into the infinite joy of working with datetime objects.</p>

<p>During the transfer from Python to R and back to Python, our <code>payment_date</code> format has changed slightly.</p>

<p>Instead of worrying about fixing this we&rsquo;ll just exclude that column when comparing the R result with the SQL/Python ones.</p>

<p>Henceforth, we won&rsquo;t be worrying about this issue. We&rsquo;ll simply check that the dataframes shape match and
the first few rows are consistent.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">df_r</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">(True, True)</pre></div>
<hr />

<h3 id="which-day-saw-the-most-business-largest-number-of-transactions">Which day saw the most business (largest number of transactions)?</h3>

<p>This is a common operation. We need to group our payments by date, count how many transactions occured on that date
and order the results accordingly.</p>

<h4 id="sql-2">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.payment_date::date, COUNT(*)
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">GROUP BY 1
</span><span class="s1">ORDER BY 2 DESC
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(32, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_date</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-04-30</td>
      <td>1311</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-04-27</td>
      <td>643</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-04-29</td>
      <td>640</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-04-28</td>
      <td>627</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-04-08</td>
      <td>516</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-04-09</td>
      <td>514</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-04-06</td>
      <td>486</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-04-10</td>
      <td>482</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-04-07</td>
      <td>472</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-04-11</td>
      <td>468</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-04-12</td>
      <td>452</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-02-19</td>
      <td>310</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-02-15</td>
      <td>308</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-02-18</td>
      <td>302</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-02-20</td>
      <td>291</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-02-17</td>
      <td>283</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-02-16</td>
      <td>282</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-02-21</td>
      <td>213</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-05-14</td>
      <td>182</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-04-26</td>
      <td>79</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-04-05</td>
      <td>64</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-02-14</td>
      <td>27</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-2">▶  Python</h4>

<p>The Python pipeline mimics the SQL query rather closely.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
       <span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
     <span class="p">)</span>
<span class="n">df</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_date</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-04-30</td>
      <td>1311</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-04-27</td>
      <td>643</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-04-29</td>
      <td>640</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-04-28</td>
      <td>627</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-04-08</td>
      <td>516</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-04-09</td>
      <td>514</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-04-06</td>
      <td>486</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-04-10</td>
      <td>482</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-04-07</td>
      <td>472</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-04-11</td>
      <td>468</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-04-12</td>
      <td>452</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-02-19</td>
      <td>310</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-02-15</td>
      <td>308</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-02-18</td>
      <td>302</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-02-20</td>
      <td>291</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-02-17</td>
      <td>283</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-02-16</td>
      <td>282</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-02-21</td>
      <td>213</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-05-14</td>
      <td>182</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-04-26</td>
      <td>79</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-04-05</td>
      <td>64</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-02-14</td>
      <td>27</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-2">▶  R</h4>

<p>We follow the same pattern for our R code. The conversion to a dataframe at the end (using <code>as.data.frame</code>) is
simply to get a nicer formatting of the output.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>payment_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment<span class="o">$</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
        summarise<span class="p">(</span>n <span class="o">=</span> n<span class="p">())</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>desc<span class="p">(</span>n<span class="p">))</span> <span class="o">%&gt;%</span>
        <span class="kp">as.data.frame</span><span class="p">()</span>
df_r</code></pre></div><div class="highlight"><pre class="chroma">   payment_date    n
1    2007-04-30 1311
2    2007-03-01  676
3    2007-03-21  673
4    2007-04-27  643
5    2007-04-29  640
6    2007-03-19  631
7    2007-04-28  627
8    2007-03-18  624
9    2007-03-22  621
10   2007-03-20  611
11   2007-03-02  595
12   2007-03-17  584
13   2007-03-23  557
14   2007-04-08  516
15   2007-04-09  514
16   2007-04-06  486
17   2007-04-10  482
18   2007-04-07  472
19   2007-04-11  468
20   2007-04-12  452
21   2007-02-19  310
22   2007-02-15  308
23   2007-02-18  302
24   2007-02-20  291
25   2007-02-17  283
26   2007-02-16  282
27   2007-02-21  213
28   2007-05-14  182
29   2007-04-26   79
30   2007-03-16   72
31   2007-04-05   64
32   2007-02-14   27</pre></div>
<hr />

<h3 id="how-much-did-each-customer-spend-and-when">How much did each customer spend and when?</h3>

<p>We can answer this question in a number of ways. Let&rsquo;s return a sequence of transaction dates for each customer. In SQL we can do that with an array.</p>

<h4 id="sql-3">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.customer_id, 
</span><span class="s1">    SUM(p.amount) total, 
</span><span class="s1">    ARRAY_AGG(p.payment_date::date) dates
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">GROUP BY 1
</span><span class="s1">ORDER BY 2 DESC
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>total</th>
      <th>dates</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>148</td>
      <td>211.55</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-19, 2007-02-1...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>526</td>
      <td>208.58</td>
      <td>[2007-02-15, 2007-02-16, 2007-02-17, 2007-02-1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>178</td>
      <td>194.61</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-16, 2007-02-1...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>137</td>
      <td>191.62</td>
      <td>[2007-02-18, 2007-02-19, 2007-02-20, 2007-02-2...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>144</td>
      <td>189.60</td>
      <td>[2007-02-16, 2007-02-17, 2007-02-19, 2007-02-2...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-3">▶  Python</h4>

<p>In Python we&rsquo;ll gather the transaction dates for each customer as a list.</p>

<p>We can build that list using a <code>lambda</code> (anonymous) function during the aggregation step.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_date&#39;</span><span class="p">]]</span>
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span>
               <span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
               <span class="s1">&#39;payment_date&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="p">})</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_date&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
      <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>total</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>148</td>
      <td>211.55</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-19, 2007-02-1...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>526</td>
      <td>208.58</td>
      <td>[2007-02-15, 2007-02-16, 2007-02-17, 2007-02-1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>178</td>
      <td>194.61</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-16, 2007-02-1...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>137</td>
      <td>191.62</td>
      <td>[2007-02-18, 2007-02-19, 2007-02-20, 2007-02-2...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>144</td>
      <td>189.60</td>
      <td>[2007-02-16, 2007-02-17, 2007-02-19, 2007-02-2...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-3">▶ R</h4>

<p>For this query the R code is similar to the Python one (syntactic idiosyncrasies aside).</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
      mutate<span class="p">(</span>payment_date <span class="o">=</span> <span class="kp">as.Date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
      summarise<span class="p">(</span>total<span class="o">=</span><span class="kp">sum</span><span class="p">(</span>amount<span class="p">),</span> dates<span class="o">=</span><span class="kt">list</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      arrange<span class="p">(</span>desc<span class="p">(</span>total<span class="p">))</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">print</span><span class="p">(</span><span class="kp">head</span><span class="p">(</span>df_r<span class="p">,</span> <span class="m">5</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 599   3
# A tibble: 5 x 3
  customer_id total dates      
        &lt;int&gt; &lt;dbl&gt; &lt;list&gt;     
1         148  212. &lt;date [45]&gt;
2         526  209. &lt;date [42]&gt;
3         178  195. &lt;date [39]&gt;
4         137  192. &lt;date [38]&gt;
5         144  190. &lt;date [40]&gt;</pre></div>
<p>At first glance it looks like the results are different from the SQL/Python, but this is purely cosmetic. The R data structure (a <code>tibble</code> actually) rounds up the floating point values and shrinks the lists when displaying the results. We could convert the <code>tibble</code> to a R dataframe but the output would be unwieldy.
Instead, we can unpack the first row to show that the data has been parsed correctly.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
<span class="kp">print</span><span class="p">(</span>df_r<span class="o">$</span>total<span class="p">[</span><span class="m">1</span><span class="p">])</span> 
<span class="kp">print</span><span class="p">(</span>df_r<span class="o">$</span>dates<span class="p">[</span><span class="m">1</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 211.55
[[1]]
 [1] &#34;2007-02-15&#34; &#34;2007-02-15&#34; &#34;2007-02-19&#34; &#34;2007-02-19&#34; &#34;2007-02-19&#34;
 [6] &#34;2007-03-01&#34; &#34;2007-03-02&#34; &#34;2007-03-17&#34; &#34;2007-03-17&#34; &#34;2007-03-18&#34;
[11] &#34;2007-03-18&#34; &#34;2007-03-18&#34; &#34;2007-03-20&#34; &#34;2007-03-20&#34; &#34;2007-03-20&#34;
[16] &#34;2007-03-21&#34; &#34;2007-03-21&#34; &#34;2007-03-21&#34; &#34;2007-03-21&#34; &#34;2007-03-22&#34;
[21] &#34;2007-03-22&#34; &#34;2007-03-22&#34; &#34;2007-03-22&#34; &#34;2007-04-05&#34; &#34;2007-04-06&#34;
[26] &#34;2007-04-08&#34; &#34;2007-04-08&#34; &#34;2007-04-08&#34; &#34;2007-04-09&#34; &#34;2007-04-10&#34;
[31] &#34;2007-04-11&#34; &#34;2007-04-12&#34; &#34;2007-04-27&#34; &#34;2007-04-27&#34; &#34;2007-04-27&#34;
[36] &#34;2007-04-28&#34; &#34;2007-04-28&#34; &#34;2007-04-28&#34; &#34;2007-04-29&#34; &#34;2007-04-29&#34;
[41] &#34;2007-04-29&#34; &#34;2007-04-29&#34; &#34;2007-04-30&#34; &#34;2007-04-29&#34; &#34;2007-04-30&#34;</pre></div>
<hr />

<h3 id="which-days-of-march-2007-recorded-no-sale">Which  days of March 2007 recorded no sale?</h3>

<p>This may seem like the sort of query we&rsquo;ve already looked at, however there is a catch.
The database only records transactions that have occurred (it seems obvious when said like that!).
This means that dates with no sales aren&rsquo;t in the database.
Therefore we need to generate a series of dates (with a daily frequency) and join our payment data on it to find the days with no sales.</p>

<p>In PostgreSQL we can use <code>generate_series</code> to do that. Note that we select from it as if it were a table (which
we name <code>gs</code>). By joining on it we can &ldquo;expand&rdquo; our payment data to include the dates for which no transaction took place. These would of course contain <code>NULL</code> values for the transaction data. By identifying where those <code>NULL</code> rows are we can answer the original question.</p>

<h4 id="sql-4">▶  SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    gs::date, p.*
</span><span class="s1">FROM 
</span><span class="s1">    generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 Day&#39;) gs
</span><span class="s1">LEFT JOIN 
</span><span class="s1">    payment p 
</span><span class="s1">ON 
</span><span class="s1">    p.payment_date::date = gs::date
</span><span class="s1">WHERE 
</span><span class="s1">    payment_date is NULL
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="s1">&#39;gs&#39;</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(21,)
0     2007-03-03
1     2007-03-04
2     2007-03-05
3     2007-03-06
4     2007-03-07
5     2007-03-08
6     2007-03-09
7     2007-03-10
8     2007-03-11
9     2007-03-12
10    2007-03-13
11    2007-03-14
12    2007-03-15
13    2007-03-24
14    2007-03-25
15    2007-03-26
16    2007-03-27
17    2007-03-28
18    2007-03-29
19    2007-03-30
20    2007-03-31
Name: gs, dtype: object</pre></div>
<h4 id="python-4">▶ Python</h4>

<p>We could do something similar in Python, however let&rsquo;s try a more pythonic approach and use set operations to extract the dates we want. We simply construct the set of all dates in March 2007 and take the difference with the dates that are already in the database. The moral of the story here is that whereas the Python (and R) syntax can often look <em>SQLish</em>, this is not always the most concise or even suitable way to get to the answer.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;20070301&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;20070331&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(21, 0)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2007-03-03</th>
    </tr>
    <tr>
      <th>2007-03-04</th>
    </tr>
    <tr>
      <th>2007-03-05</th>
    </tr>
    <tr>
      <th>2007-03-06</th>
    </tr>
    <tr>
      <th>2007-03-07</th>
    </tr>
    <tr>
      <th>2007-03-08</th>
    </tr>
    <tr>
      <th>2007-03-09</th>
    </tr>
    <tr>
      <th>2007-03-10</th>
    </tr>
    <tr>
      <th>2007-03-11</th>
    </tr>
    <tr>
      <th>2007-03-12</th>
    </tr>
    <tr>
      <th>2007-03-13</th>
    </tr>
    <tr>
      <th>2007-03-14</th>
    </tr>
    <tr>
      <th>2007-03-15</th>
    </tr>
    <tr>
      <th>2007-03-24</th>
    </tr>
    <tr>
      <th>2007-03-25</th>
    </tr>
    <tr>
      <th>2007-03-26</th>
    </tr>
    <tr>
      <th>2007-03-27</th>
    </tr>
    <tr>
      <th>2007-03-28</th>
    </tr>
    <tr>
      <th>2007-03-29</th>
    </tr>
    <tr>
      <th>2007-03-30</th>
    </tr>
    <tr>
      <th>2007-03-31</th>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-4">▶ R</h4>

<p>Set operations also work in R. The output is a bit strange. We have a list of lists with a single element.
We could flatten the nested list but it would only obfuscate the code so we&rsquo;ll leave it like that.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
gs <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span>lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">),</span> lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">),</span> by <span class="o">=</span> <span class="s">&#39;1 day&#39;</span><span class="p">)</span>
<span class="kp">lapply</span><span class="p">(</span><span class="kp">sort</span><span class="p">(</span><span class="kp">setdiff</span><span class="p">(</span>gs<span class="p">,</span> lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment<span class="o">$</span>payment_date<span class="p">))),</span> <span class="kp">as.Date</span><span class="p">,</span> origin<span class="o">=</span><span class="s">&#39;1970-01-01&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[[1]]
[1] &#34;2007-03-03&#34;

[[2]]
[1] &#34;2007-03-04&#34;

[[3]]
[1] &#34;2007-03-05&#34;

[[4]]
[1] &#34;2007-03-06&#34;

[[5]]
[1] &#34;2007-03-07&#34;

[[6]]
[1] &#34;2007-03-08&#34;

[[7]]
[1] &#34;2007-03-09&#34;

[[8]]
[1] &#34;2007-03-10&#34;

[[9]]
[1] &#34;2007-03-11&#34;

[[10]]
[1] &#34;2007-03-12&#34;

[[11]]
[1] &#34;2007-03-13&#34;

[[12]]
[1] &#34;2007-03-14&#34;

[[13]]
[1] &#34;2007-03-15&#34;

[[14]]
[1] &#34;2007-03-24&#34;

[[15]]
[1] &#34;2007-03-25&#34;

[[16]]
[1] &#34;2007-03-26&#34;

[[17]]
[1] &#34;2007-03-27&#34;

[[18]]
[1] &#34;2007-03-28&#34;

[[19]]
[1] &#34;2007-03-29&#34;

[[20]]
[1] &#34;2007-03-30&#34;

[[21]]
[1] &#34;2007-03-31&#34;</pre></div>
<hr />

<h3 id="how-many-transactions-were-there-for-each-day-of-march-2007">How many transactions were there for each day of March 2007?</h3>

<p>This is a simple question, we just need to keep in mind that some days had no transaction. We should still ouput those with a count of zero. The basic idea is similar to the previous example. We create a time series to &ldquo;pad out&rdquo; the missing days in the <code>payment_date</code> feature.</p>

<h4 id="sql-5">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    gs::date date, 
</span><span class="s1">    COUNT(p.*) number_of_transactions
</span><span class="s1">FROM 
</span><span class="s1">    generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 Day&#39;) gs
</span><span class="s1">LEFT JOIN 
</span><span class="s1">    payment p 
</span><span class="s1">ON 
</span><span class="s1">    p.payment_date::date = gs::date 
</span><span class="s1">GROUP BY 
</span><span class="s1">    gs::date 
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(31, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-03</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-04</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-05</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-06</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-07</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-08</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-14</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-15</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-27</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-28</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-31</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-5">▶ Python</h4>

<p>Similarly, in Python we can create the series of dates for March 2007 using the <code>date_range</code> object from <code>pandas</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;20070301&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;20070331&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">payment_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;payment_date&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;number_of_transactions&#39;</span><span class="p">})</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(31, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-03</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-04</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-05</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-06</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-07</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-08</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-14</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-15</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-27</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-28</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-31</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-5">▶  R</h4>

<p>Once again, the pattern for R follows the same principles.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 
gs <span class="o">=</span> <span class="kt">data_frame</span><span class="p">(</span>payment_date<span class="o">=</span><span class="kp">seq</span><span class="p">(</span>lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">),</span> 
                                 lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">),</span> 
                                 by <span class="o">=</span> <span class="s">&#39;1 day&#39;</span><span class="p">))</span>

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
      mutate<span class="p">(</span>payment_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      group_by<span class="p">(</span>payment_date<span class="p">)</span> <span class="o">%&gt;%</span> 
      summarise<span class="p">(</span>number_of_transactions<span class="o">=</span>n<span class="p">())</span> <span class="o">%&gt;%</span> 
      right_join<span class="p">(</span>gs<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;payment_date&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
      replace_na<span class="p">(</span><span class="kt">list</span><span class="p">(</span>number_of_transactions<span class="o">=</span><span class="m">0</span><span class="p">))</span>

<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">   payment_date number_of_transactions
1    2007-03-01                    676
2    2007-03-02                    595
3    2007-03-03                      0
4    2007-03-04                      0
5    2007-03-05                      0
6    2007-03-06                      0
7    2007-03-07                      0
8    2007-03-08                      0
9    2007-03-09                      0
10   2007-03-10                      0
11   2007-03-11                      0
12   2007-03-12                      0
13   2007-03-13                      0
14   2007-03-14                      0
15   2007-03-15                      0
16   2007-03-16                     72
17   2007-03-17                    584
18   2007-03-18                    624
19   2007-03-19                    631
20   2007-03-20                    611
21   2007-03-21                    673
22   2007-03-22                    621
23   2007-03-23                    557
24   2007-03-24                      0
25   2007-03-25                      0
26   2007-03-26                      0
27   2007-03-27                      0
28   2007-03-28                      0
29   2007-03-29                      0
30   2007-03-30                      0
31   2007-03-31                      0</pre></div>
<hr />

<h3 id="days-with-no-transactions-in-march-2007-alternate-version">Days with no transactions in March 2007 - Alternate version</h3>

<p>Let&rsquo;s revisit the problem we dealt with previous using set operations in Python and R and illustrate how we could answer the question using a more SQLish pipeline.
We can reuse the code from the previous example. We just need to add a filtering step.</p>

<h4 id="sql-6">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    gs::date date, COUNT(p.*) number_of_transactions
</span><span class="s1">FROM 
</span><span class="s1">    generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 Day&#39;) gs
</span><span class="s1">LEFT JOIN 
</span><span class="s1">    payment p 
</span><span class="s1">ON 
</span><span class="s1">    p.payment_date::date = gs::date 
</span><span class="s1">GROUP BY 
</span><span class="s1">    gs::date 
</span><span class="s1">HAVING 
</span><span class="s1">    COUNT(p.*) = 0
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(21, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-03</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-04</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-05</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-06</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-07</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-08</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-14</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-15</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-27</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-28</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-31</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-6">▶ Python</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;20070301&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;20070331&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">payment_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;payment_date&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;number_of_transactions&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;number_of_transactions == 0&#39;</span><span class="p">)</span>  
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(21, 1)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2007-03-03</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-04</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-05</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-06</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-07</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-08</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-09</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-10</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-11</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-12</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-13</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-14</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-15</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-24</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-25</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-26</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-27</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-28</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-29</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-30</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-31</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-6">▶ R</h4>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
gs <span class="o">=</span> <span class="kt">data_frame</span><span class="p">(</span>payment_date<span class="o">=</span><span class="kp">seq</span><span class="p">(</span>lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">),</span> 
                                 lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">),</span> 
                                 by <span class="o">=</span> <span class="s">&#39;1 day&#39;</span><span class="p">))</span>

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
      mutate<span class="p">(</span>payment_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      group_by<span class="p">(</span>payment_date<span class="p">)</span> <span class="o">%&gt;%</span> 
      summarise<span class="p">(</span>number_of_transactions<span class="o">=</span>n<span class="p">())</span> <span class="o">%&gt;%</span> 
      right_join<span class="p">(</span>gs<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;payment_date&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
      replace_na<span class="p">(</span><span class="kt">list</span><span class="p">(</span>number_of_transactions<span class="o">=</span><span class="m">0</span><span class="p">))</span> <span class="o">%&gt;%</span>
      <span class="kp">subset</span><span class="p">(</span>number_of_transactions<span class="o">==</span><span class="m">0</span><span class="p">)</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 21  2
   payment_date number_of_transactions
1    2007-03-03                      0
2    2007-03-04                      0
3    2007-03-05                      0
4    2007-03-06                      0
5    2007-03-07                      0
6    2007-03-08                      0
7    2007-03-09                      0
8    2007-03-10                      0
9    2007-03-11                      0
10   2007-03-12                      0
11   2007-03-13                      0
12   2007-03-14                      0
13   2007-03-15                      0
14   2007-03-24                      0
15   2007-03-25                      0
16   2007-03-26                      0
17   2007-03-27                      0
18   2007-03-28                      0
19   2007-03-29                      0
20   2007-03-30                      0
21   2007-03-31                      0</pre></div>
<hr />

<h3 id="which-movies-have-never-been-rented">Which movies have never been rented?</h3>

<p>So far we&rsquo;ve only worked with a single table out of the 15 contained in the database. To match movies to rental transactions we will need
to use 3 new tables. The film one contains information about the movies, the inventory one links the movies to an inventory id, which is used in the rental table to connect movies to actual rentals.</p>

<p>Let&rsquo;s have a look at the structures of these tables.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">,</span> <span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="s1">&#39;rental&#39;</span><span class="p">,</span> <span class="s1">&#39;film&#39;</span><span class="p">]:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT * FROM {t}
</span><span class="s1">LIMIT 1
</span><span class="s1">&#39;&#39;&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">inventory</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>inventory_id</th>
      <th>film_id</th>
      <th>store_id</th>
      <th>last_update</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2006-02-15 10:09:17</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma">payment</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17503</td>
      <td>341</td>
      <td>2</td>
      <td>1520</td>
      <td>7.99</td>
      <td>2007-02-15 22:25:46.996577</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma">rental</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rental_id</th>
      <th>rental_date</th>
      <th>inventory_id</th>
      <th>customer_id</th>
      <th>return_date</th>
      <th>staff_id</th>
      <th>last_update</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>2005-05-24 22:54:33</td>
      <td>1525</td>
      <td>459</td>
      <td>2005-05-28 19:40:33</td>
      <td>1</td>
      <td>2006-02-16 02:30:53</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma">film</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>description</th>
      <th>release_year</th>
      <th>language_id</th>
      <th>rental_duration</th>
      <th>rental_rate</th>
      <th>length</th>
      <th>replacement_cost</th>
      <th>rating</th>
      <th>last_update</th>
      <th>special_features</th>
      <th>fulltext</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>133</td>
      <td>Chamber Italian</td>
      <td>A Fateful Reflection of a Moose And a Husband ...</td>
      <td>2006</td>
      <td>1</td>
      <td>7</td>
      <td>4.99</td>
      <td>117</td>
      <td>14.99</td>
      <td>NC-17</td>
      <td>2013-05-26 14:50:58.951</td>
      <td>[Trailers]</td>
      <td>'chamber':1 'fate':4 'husband':11 'italian':2 ...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="sql-7">▶ SQL</h4>

<p>Let&rsquo;s join the tables, count how many times each movie has been rented and select those for which the count is zero.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    t.film_id, t.title, t.rentals 
</span><span class="s1">FROM 
</span><span class="s1">    (SELECT 
</span><span class="s1">        f.film_id, f.title, 
</span><span class="s1">        COUNT(distinct r.rental_id) as rentals
</span><span class="s1">    FROM film f
</span><span class="s1">        LEFT JOIN inventory i ON i.film_id = f.film_id
</span><span class="s1">        LEFT JOIN rental r ON r.inventory_id = i.inventory_id
</span><span class="s1">    GROUP BY 1,2
</span><span class="s1">    HAVING 
</span><span class="s1">        COUNT(distinct r.rental_id) = 0
</span><span class="s1">        ) t
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(42, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rentals</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14</td>
      <td>Alice Fantasia</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33</td>
      <td>Apollo Teen</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36</td>
      <td>Argonauts Town</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>38</td>
      <td>Ark Ridgemont</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41</td>
      <td>Arsenic Independence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>87</td>
      <td>Boondock Ballroom</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>108</td>
      <td>Butch Panther</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>128</td>
      <td>Catch Amistad</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>144</td>
      <td>Chinatown Gladiator</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>148</td>
      <td>Chocolate Duck</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>171</td>
      <td>Commandments Express</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>192</td>
      <td>Crossing Divorce</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>195</td>
      <td>Crowds Telemark</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>198</td>
      <td>Crystal Breaking</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>217</td>
      <td>Dazed Punk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>221</td>
      <td>Deliverance Mulholland</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>318</td>
      <td>Firehouse Vietnam</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>325</td>
      <td>Floats Garden</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>332</td>
      <td>Frankenstein Stranger</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>359</td>
      <td>Gladiator Westward</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>386</td>
      <td>Gump Date</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>404</td>
      <td>Hate Handicap</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>419</td>
      <td>Hocus Frida</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>495</td>
      <td>Kentuckian Giant</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>497</td>
      <td>Kill Brotherhood</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>607</td>
      <td>Muppet Mile</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>642</td>
      <td>Order Betrayed</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>669</td>
      <td>Pearl Destiny</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>671</td>
      <td>Perdition Fargo</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>701</td>
      <td>Psycho Shrunk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>712</td>
      <td>Raiders Antitrust</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>713</td>
      <td>Rainbow Shock</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32</th>
      <td>742</td>
      <td>Roof Champion</td>
      <td>0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>801</td>
      <td>Sister Freddy</td>
      <td>0</td>
    </tr>
    <tr>
      <th>34</th>
      <td>802</td>
      <td>Sky Miracle</td>
      <td>0</td>
    </tr>
    <tr>
      <th>35</th>
      <td>860</td>
      <td>Suicides Silence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>36</th>
      <td>874</td>
      <td>Tadpole Park</td>
      <td>0</td>
    </tr>
    <tr>
      <th>37</th>
      <td>909</td>
      <td>Treasure Command</td>
      <td>0</td>
    </tr>
    <tr>
      <th>38</th>
      <td>943</td>
      <td>Villain Desperate</td>
      <td>0</td>
    </tr>
    <tr>
      <th>39</th>
      <td>950</td>
      <td>Volume House</td>
      <td>0</td>
    </tr>
    <tr>
      <th>40</th>
      <td>954</td>
      <td>Wake Jaws</td>
      <td>0</td>
    </tr>
    <tr>
      <th>41</th>
      <td>955</td>
      <td>Walls Artist</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-7">▶ Python</h4>

<p>The go to approach for join operations in pandas is the <code>merge</code> method. The type of join can be specified as an optional parameter.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">film</span><span class="p">,</span> <span class="n">inventory</span><span class="p">,</span> <span class="n">rental</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;film&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rental&#39;</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">film</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rental</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;inventory_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">])[[</span><span class="s1">&#39;rental_id&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rental_id&#39;</span><span class="p">:</span><span class="s1">&#39;rentals&#39;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;rentals == 0&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
     <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(42, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rentals</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14</td>
      <td>Alice Fantasia</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33</td>
      <td>Apollo Teen</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36</td>
      <td>Argonauts Town</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>38</td>
      <td>Ark Ridgemont</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41</td>
      <td>Arsenic Independence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>87</td>
      <td>Boondock Ballroom</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>108</td>
      <td>Butch Panther</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>128</td>
      <td>Catch Amistad</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>144</td>
      <td>Chinatown Gladiator</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>148</td>
      <td>Chocolate Duck</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>171</td>
      <td>Commandments Express</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>192</td>
      <td>Crossing Divorce</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>195</td>
      <td>Crowds Telemark</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>198</td>
      <td>Crystal Breaking</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>217</td>
      <td>Dazed Punk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>221</td>
      <td>Deliverance Mulholland</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>318</td>
      <td>Firehouse Vietnam</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>325</td>
      <td>Floats Garden</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>332</td>
      <td>Frankenstein Stranger</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>359</td>
      <td>Gladiator Westward</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>386</td>
      <td>Gump Date</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>404</td>
      <td>Hate Handicap</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>419</td>
      <td>Hocus Frida</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>495</td>
      <td>Kentuckian Giant</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>497</td>
      <td>Kill Brotherhood</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>607</td>
      <td>Muppet Mile</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>642</td>
      <td>Order Betrayed</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>669</td>
      <td>Pearl Destiny</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>671</td>
      <td>Perdition Fargo</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>701</td>
      <td>Psycho Shrunk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>712</td>
      <td>Raiders Antitrust</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>713</td>
      <td>Rainbow Shock</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32</th>
      <td>742</td>
      <td>Roof Champion</td>
      <td>0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>801</td>
      <td>Sister Freddy</td>
      <td>0</td>
    </tr>
    <tr>
      <th>34</th>
      <td>802</td>
      <td>Sky Miracle</td>
      <td>0</td>
    </tr>
    <tr>
      <th>35</th>
      <td>860</td>
      <td>Suicides Silence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>36</th>
      <td>874</td>
      <td>Tadpole Park</td>
      <td>0</td>
    </tr>
    <tr>
      <th>37</th>
      <td>909</td>
      <td>Treasure Command</td>
      <td>0</td>
    </tr>
    <tr>
      <th>38</th>
      <td>943</td>
      <td>Villain Desperate</td>
      <td>0</td>
    </tr>
    <tr>
      <th>39</th>
      <td>950</td>
      <td>Volume House</td>
      <td>0</td>
    </tr>
    <tr>
      <th>40</th>
      <td>954</td>
      <td>Wake Jaws</td>
      <td>0</td>
    </tr>
    <tr>
      <th>41</th>
      <td>955</td>
      <td>Walls Artist</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-7">▶ R</h4>

<p>We start by &ldquo;transfering&rdquo; the new dataframes to R. The rest of the pipeline is very much like the one used in Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>i rental <span class="o">-</span>i inventory <span class="o">-</span>i film <span class="o">-</span>o df_r
df_r <span class="o">=</span> film <span class="o">%&gt;%</span> 
        left_join<span class="p">(</span>inventory<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;film_id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        left_join<span class="p">(</span>rental<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;inventory_id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>film_id<span class="p">,</span> title<span class="p">)</span> <span class="o">%&gt;%</span> 
        summarise<span class="p">(</span>rentals<span class="o">=</span>n_distinct<span class="p">(</span>rental_id<span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>rentals<span class="o">==</span><span class="m">0</span><span class="p">)</span> <span class="o">%&gt;%</span>
        <span class="kp">as.data.frame</span><span class="p">()</span>

df_r</code></pre></div><div class="highlight"><pre class="chroma">   film_id                  title rentals
1       14         Alice Fantasia       0
2       33            Apollo Teen       0
3       36         Argonauts Town       0
4       38          Ark Ridgemont       0
5       41   Arsenic Independence       0
6       87      Boondock Ballroom       0
7      108          Butch Panther       0
8      128          Catch Amistad       0
9      144    Chinatown Gladiator       0
10     148         Chocolate Duck       0
11     171   Commandments Express       0
12     192       Crossing Divorce       0
13     195        Crowds Telemark       0
14     198       Crystal Breaking       0
15     217             Dazed Punk       0
16     221 Deliverance Mulholland       0
17     318      Firehouse Vietnam       0
18     325          Floats Garden       0
19     332  Frankenstein Stranger       0
20     359     Gladiator Westward       0
21     386              Gump Date       0
22     404          Hate Handicap       0
23     419            Hocus Frida       0
24     495       Kentuckian Giant       0
25     497       Kill Brotherhood       0
26     607            Muppet Mile       0
27     642         Order Betrayed       0
28     669          Pearl Destiny       0
29     671        Perdition Fargo       0
30     701          Psycho Shrunk       0
31     712      Raiders Antitrust       0
32     713          Rainbow Shock       0
33     742          Roof Champion       0
34     801          Sister Freddy       0
35     802            Sky Miracle       0
36     860       Suicides Silence       0
37     874           Tadpole Park       0
38     909       Treasure Command       0
39     943      Villain Desperate       0
40     950           Volume House       0
41     954              Wake Jaws       0
42     955           Walls Artist       0</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_r</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">(True, True)</pre></div>
<hr />

<h3 id="find-each-customer-s-first-order">Find each customer&rsquo;s first order.</h3>

<p>To solve the problem in SQL we need to use a <a href="https://en.wikipedia.org/wiki/Correlated_subquery"><strong>correlated subquery</strong></a> whereby the inner query gets executed for every row of the outer query.</p>

<p>In our case, the inner query gets executed for every row of the outer query because <code>min(rental_id)</code> will change with each customer.</p>

<h4 id="sql-8">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    r.customer_id, 
</span><span class="s1">    min(r.rental_id) first_order_id, 
</span><span class="s1">    (    
</span><span class="s1">        SELECT r2.rental_date::date FROM rental r2 
</span><span class="s1">        WHERE r2.rental_id = min(r.rental_id)
</span><span class="s1">    ) first_order_date
</span><span class="s1">FROM 
</span><span class="s1">    rental r
</span><span class="s1">GROUP BY 1
</span><span class="s1">ORDER BY 1
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_order_id</th>
      <th>first_order_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>76</td>
      <td>2005-05-25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>320</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>435</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1297</td>
      <td>2005-06-15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>731</td>
      <td>2005-05-29</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-8">▶ Python</h4>

<p>In this case the Python syntax is a bit simpler. We group by the <code>customer_id</code> and pick the smallest <code>rental_id</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">rental</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rental_date</span><span class="o">=</span><span class="n">rental</span><span class="o">.</span><span class="n">rental_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_id&#39;</span> <span class="p">])[</span><span class="s1">&#39;rental_id&#39;</span><span class="p">,</span><span class="s1">&#39;rental_date&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="nb">min</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rental_id&#39;</span><span class="p">:</span><span class="s1">&#39;first_order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rental_date&#39;</span><span class="p">:</span><span class="s1">&#39;first_order_date&#39;</span><span class="p">})</span>
      <span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_order_id</th>
      <th>first_order_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>76</td>
      <td>2005-05-25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>320</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>435</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1297</td>
      <td>2005-06-15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>731</td>
      <td>2005-05-29</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<h4 id="r-8">▶ R</h4>

<p>The R version of the code is similar to the Python one.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 

df_r <span class="o">=</span> rental <span class="o">%&gt;%</span> 
        mutate<span class="p">(</span>rental_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>rental_date<span class="p">))</span> <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        summarise_at<span class="p">(</span>vars<span class="p">(</span>rental_id<span class="p">,</span> rental_date<span class="p">),</span> funs<span class="p">(</span><span class="kp">min</span><span class="p">))</span> <span class="o">%&gt;%</span>
        <span class="kp">as.data.frame</span><span class="p">()</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">print</span><span class="p">(</span><span class="kp">head</span><span class="p">(</span>df_r<span class="p">,</span> <span class="m">5</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 599   3
  customer_id rental_id rental_date
1           1        76  2005-05-25
2           2       320  2005-05-27
3           3       435  2005-05-27
4           4      1297  2005-06-15
5           5       731  2005-05-29</pre></div>
<hr />

<h3 id="handling-multiple-conditions">Handling multiple conditions.</h3>

<p>Let&rsquo;s look at a more complex query. We&rsquo;d like to return all the rental transactions conducted by the staff with id 1, for which the rental id is larger than 15000, and the payment occured between 3am and 4am or 11pm and midnight in March 2007.</p>

<h4 id="sql-9">▶ SQL</h4>

<p>Although more complex than our previous examples, this query can be built from the pieces we&rsquo;ve used before.
To keep things somewhat simple, we&rsquo;ll assume that between 3am and 4am means between 3:00 and 3:59. This will allow use to only concern ourselves with the hour number when filtering our data. Same with the second time period.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">WITH base_table AS (
</span><span class="s1">    SELECT gs::date AS date,  p.*
</span><span class="s1">    FROM 
</span><span class="s1">        generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 day&#39;) as gs
</span><span class="s1">    LEFT JOIN payment p ON p.payment_date::date=gs::date AND p.staff_id = 1
</span><span class="s1">    ORDER BY 1 NULLS FIRST
</span><span class="s1">) 
</span><span class="s1">SELECT 
</span><span class="s1">    bt.date, bt.payment_id, bt.customer_id, bt.staff_id, bt.rental_id, bt.amount, 
</span><span class="s1">    EXTRACT(hour FROM bt.payment_date)::int AS hour
</span><span class="s1">FROM 
</span><span class="s1">    base_table bt
</span><span class="s1">WHERE 
</span><span class="s1">    bt.rental_id &gt; 15000 
</span><span class="s1">    AND         
</span><span class="s1">    EXTRACT(hour FROM bt.payment_date) IN (4,23)
</span><span class="s1">ORDER BY bt.payment_date, bt.rental_id
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(36, 7)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-22</td>
      <td>23134</td>
      <td>46</td>
      <td>1</td>
      <td>15438</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-22</td>
      <td>23958</td>
      <td>136</td>
      <td>1</td>
      <td>15439</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-22</td>
      <td>23095</td>
      <td>42</td>
      <td>1</td>
      <td>15442</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-22</td>
      <td>22615</td>
      <td>598</td>
      <td>1</td>
      <td>15443</td>
      <td>7.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-22</td>
      <td>22960</td>
      <td>28</td>
      <td>1</td>
      <td>15445</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-22</td>
      <td>20574</td>
      <td>379</td>
      <td>1</td>
      <td>15446</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-22</td>
      <td>21651</td>
      <td>490</td>
      <td>1</td>
      <td>15448</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-22</td>
      <td>20027</td>
      <td>322</td>
      <td>1</td>
      <td>15450</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>21866</td>
      <td>514</td>
      <td>1</td>
      <td>15451</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-22</td>
      <td>20370</td>
      <td>359</td>
      <td>1</td>
      <td>15453</td>
      <td>1.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-22</td>
      <td>24882</td>
      <td>238</td>
      <td>1</td>
      <td>15455</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-22</td>
      <td>25113</td>
      <td>262</td>
      <td>1</td>
      <td>15456</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-22</td>
      <td>19906</td>
      <td>306</td>
      <td>1</td>
      <td>15457</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-22</td>
      <td>22876</td>
      <td>20</td>
      <td>1</td>
      <td>15460</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-22</td>
      <td>23646</td>
      <td>103</td>
      <td>1</td>
      <td>15461</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-22</td>
      <td>20675</td>
      <td>389</td>
      <td>1</td>
      <td>15462</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-22</td>
      <td>23869</td>
      <td>127</td>
      <td>1</td>
      <td>15463</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-22</td>
      <td>23283</td>
      <td>62</td>
      <td>1</td>
      <td>15464</td>
      <td>6.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-22</td>
      <td>21921</td>
      <td>520</td>
      <td>1</td>
      <td>15465</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-22</td>
      <td>20970</td>
      <td>418</td>
      <td>1</td>
      <td>15466</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-22</td>
      <td>23647</td>
      <td>103</td>
      <td>1</td>
      <td>15467</td>
      <td>3.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>20768</td>
      <td>399</td>
      <td>1</td>
      <td>15468</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-22</td>
      <td>22610</td>
      <td>597</td>
      <td>1</td>
      <td>15469</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-23</td>
      <td>24692</td>
      <td>215</td>
      <td>1</td>
      <td>15583</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-23</td>
      <td>21731</td>
      <td>500</td>
      <td>1</td>
      <td>15584</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-23</td>
      <td>22149</td>
      <td>545</td>
      <td>1</td>
      <td>15585</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-23</td>
      <td>21723</td>
      <td>499</td>
      <td>1</td>
      <td>15587</td>
      <td>7.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-23</td>
      <td>21764</td>
      <td>503</td>
      <td>1</td>
      <td>15588</td>
      <td>3.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-23</td>
      <td>22901</td>
      <td>22</td>
      <td>1</td>
      <td>15589</td>
      <td>6.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-23</td>
      <td>23284</td>
      <td>62</td>
      <td>1</td>
      <td>15591</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-23</td>
      <td>24163</td>
      <td>153</td>
      <td>1</td>
      <td>15593</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-03-23</td>
      <td>25135</td>
      <td>264</td>
      <td>1</td>
      <td>15595</td>
      <td>4.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2007-03-23</td>
      <td>24478</td>
      <td>186</td>
      <td>1</td>
      <td>15596</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2007-03-23</td>
      <td>23323</td>
      <td>66</td>
      <td>1</td>
      <td>15598</td>
      <td>8.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>34</th>
      <td>2007-03-23</td>
      <td>23648</td>
      <td>103</td>
      <td>1</td>
      <td>15599</td>
      <td>5.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>35</th>
      <td>2007-03-23</td>
      <td>23729</td>
      <td>113</td>
      <td>1</td>
      <td>15600</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-9">▶ Python</h4>

<p>Just for some variety we use the <code>between</code> method of pandas series to select the March 2007 data.
We pass pandas <code>Timestamp</code> objects to mark the first and last day of the month.
The rest of the pipeline should be self-explanatory. The last line is added for convenience.
We order the columns of the pandas dataframe to match the ordering of the columns in our SQL result.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
  <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">between</span><span class="p">(</span>
              <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2007</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
              <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2007</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">))</span>
      <span class="p">]</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
  <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(hour in (4, 23)) &amp; (rental_id &gt; 15000) &amp; (staff_id == 1)&#39;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;payment_date&#39;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df_sql</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="p">)</span> 

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(36, 7)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-22</td>
      <td>23134</td>
      <td>46</td>
      <td>1</td>
      <td>15438</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-22</td>
      <td>23958</td>
      <td>136</td>
      <td>1</td>
      <td>15439</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-22</td>
      <td>23095</td>
      <td>42</td>
      <td>1</td>
      <td>15442</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-22</td>
      <td>22615</td>
      <td>598</td>
      <td>1</td>
      <td>15443</td>
      <td>7.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-22</td>
      <td>22960</td>
      <td>28</td>
      <td>1</td>
      <td>15445</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-22</td>
      <td>20574</td>
      <td>379</td>
      <td>1</td>
      <td>15446</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-22</td>
      <td>21651</td>
      <td>490</td>
      <td>1</td>
      <td>15448</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-22</td>
      <td>20027</td>
      <td>322</td>
      <td>1</td>
      <td>15450</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>21866</td>
      <td>514</td>
      <td>1</td>
      <td>15451</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-22</td>
      <td>20370</td>
      <td>359</td>
      <td>1</td>
      <td>15453</td>
      <td>1.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-22</td>
      <td>24882</td>
      <td>238</td>
      <td>1</td>
      <td>15455</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-22</td>
      <td>25113</td>
      <td>262</td>
      <td>1</td>
      <td>15456</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-22</td>
      <td>19906</td>
      <td>306</td>
      <td>1</td>
      <td>15457</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-22</td>
      <td>22876</td>
      <td>20</td>
      <td>1</td>
      <td>15460</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-22</td>
      <td>23646</td>
      <td>103</td>
      <td>1</td>
      <td>15461</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-22</td>
      <td>20675</td>
      <td>389</td>
      <td>1</td>
      <td>15462</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-22</td>
      <td>23869</td>
      <td>127</td>
      <td>1</td>
      <td>15463</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-22</td>
      <td>23283</td>
      <td>62</td>
      <td>1</td>
      <td>15464</td>
      <td>6.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-22</td>
      <td>21921</td>
      <td>520</td>
      <td>1</td>
      <td>15465</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-22</td>
      <td>20970</td>
      <td>418</td>
      <td>1</td>
      <td>15466</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-22</td>
      <td>23647</td>
      <td>103</td>
      <td>1</td>
      <td>15467</td>
      <td>3.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>20768</td>
      <td>399</td>
      <td>1</td>
      <td>15468</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-22</td>
      <td>22610</td>
      <td>597</td>
      <td>1</td>
      <td>15469</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-23</td>
      <td>24692</td>
      <td>215</td>
      <td>1</td>
      <td>15583</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-23</td>
      <td>21731</td>
      <td>500</td>
      <td>1</td>
      <td>15584</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-23</td>
      <td>22149</td>
      <td>545</td>
      <td>1</td>
      <td>15585</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-23</td>
      <td>21723</td>
      <td>499</td>
      <td>1</td>
      <td>15587</td>
      <td>7.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-23</td>
      <td>21764</td>
      <td>503</td>
      <td>1</td>
      <td>15588</td>
      <td>3.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-23</td>
      <td>22901</td>
      <td>22</td>
      <td>1</td>
      <td>15589</td>
      <td>6.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-23</td>
      <td>23284</td>
      <td>62</td>
      <td>1</td>
      <td>15591</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-23</td>
      <td>24163</td>
      <td>153</td>
      <td>1</td>
      <td>15593</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-03-23</td>
      <td>25135</td>
      <td>264</td>
      <td>1</td>
      <td>15595</td>
      <td>4.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2007-03-23</td>
      <td>24478</td>
      <td>186</td>
      <td>1</td>
      <td>15596</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2007-03-23</td>
      <td>23323</td>
      <td>66</td>
      <td>1</td>
      <td>15598</td>
      <td>8.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>34</th>
      <td>2007-03-23</td>
      <td>23648</td>
      <td>103</td>
      <td>1</td>
      <td>15599</td>
      <td>5.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>35</th>
      <td>2007-03-23</td>
      <td>23729</td>
      <td>113</td>
      <td>1</td>
      <td>15600</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<h4 id="r-9">▶ R</h4>

<p>Once again a similar pipeline can be build in R.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>o df_r

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
  filter<span class="p">(</span>date <span class="o">&gt;=</span> <span class="kp">as.Date</span><span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">)</span> <span class="o">&amp;</span>  date <span class="o">&lt;=</span> <span class="kp">as.Date</span><span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>hour<span class="o">=</span>lubridate<span class="o">::</span>hour<span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
  filter<span class="p">(</span>hour <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="m">23</span><span class="p">)</span> <span class="o">&amp;</span> rental_id <span class="o">&gt;</span> <span class="m">15000</span> <span class="o">&amp;</span> staff_id <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  arrange<span class="p">(</span>payment_date<span class="p">)</span> <span class="o">%&gt;%</span> 
  select<span class="p">(</span><span class="kp">date</span><span class="p">,</span> payment_id<span class="p">,</span> customer_id<span class="p">,</span> staff_id<span class="p">,</span> rental_id<span class="p">,</span> amount<span class="p">,</span> hour<span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="kp">as.data.frame</span><span class="p">()</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
df_r</code></pre></div><div class="highlight"><pre class="chroma">[1] 36  7
         date payment_id customer_id staff_id rental_id amount hour
1  2007-03-22      23134          46        1     15438   2.99   23
2  2007-03-22      23958         136        1     15439   4.99   23
3  2007-03-22      23095          42        1     15442   2.99   23
4  2007-03-22      22615         598        1     15443   7.99   23
5  2007-03-22      22960          28        1     15445   4.99   23
6  2007-03-22      20574         379        1     15446   4.99   23
7  2007-03-22      21651         490        1     15448   2.99   23
8  2007-03-22      20027         322        1     15450   0.99   23
9  2007-03-22      21866         514        1     15451   2.99   23
10 2007-03-22      20370         359        1     15453   1.99   23
11 2007-03-22      24882         238        1     15455   0.99   23
12 2007-03-22      25113         262        1     15456   0.99   23
13 2007-03-22      19906         306        1     15457   2.99   23
14 2007-03-22      22876          20        1     15460   2.99   23
15 2007-03-22      23646         103        1     15461   5.99   23
16 2007-03-22      20675         389        1     15462   5.99   23
17 2007-03-22      23869         127        1     15463   5.99   23
18 2007-03-22      23283          62        1     15464   6.99   23
19 2007-03-22      21921         520        1     15465   0.99   23
20 2007-03-22      20970         418        1     15466   4.99   23
21 2007-03-22      23647         103        1     15467   3.99   23
22 2007-03-22      20768         399        1     15468   4.99   23
23 2007-03-22      22610         597        1     15469   4.99   23
24 2007-03-23      24692         215        1     15583   2.99    4
25 2007-03-23      21731         500        1     15584   2.99    4
26 2007-03-23      22149         545        1     15585   0.99    4
27 2007-03-23      21723         499        1     15587   7.99    4
28 2007-03-23      21764         503        1     15588   3.99    4
29 2007-03-23      22901          22        1     15589   6.99    4
30 2007-03-23      23284          62        1     15591   0.99    4
31 2007-03-23      24163         153        1     15593   1.99    4
32 2007-03-23      25135         264        1     15595   4.99    4
33 2007-03-23      24478         186        1     15596   0.99    4
34 2007-03-23      23323          66        1     15598   8.99    4
35 2007-03-23      23648         103        1     15599   5.99    4
36 2007-03-23      23729         113        1     15600   1.99    4</pre></div>
<hr />

<h3 id="customer-lifetime-value">Customer lifetime value</h3>

<p>Which customers made their first order on a weekend, paid more than \$5, and have a customer lifetime value (total amount spent) which exceeds \$100?</p>

<h4 id="sql-10">▶ SQL</h4>

<p>For this query we need to extract the day of the week for each transaction. This can be done using <code>dow</code>.</p>

<p>Note that in PostgreSQL Sunday is coded as 0, and Saturday as 6.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT t.* FROM (
</span><span class="s1">    SELECT 
</span><span class="s1">        p.*, 
</span><span class="s1">        EXTRACT(dow FROM p.payment_date)::int  dow,
</span><span class="s1">        (
</span><span class="s1">            SELECT SUM(p3.amount) 
</span><span class="s1">            FROM payment p3
</span><span class="s1">            WHERE p3.customer_id = p.customer_id   
</span><span class="s1">        ) as CLV
</span><span class="s1">    FROM 
</span><span class="s1">        payment p
</span><span class="s1">    WHERE 
</span><span class="s1">        p.payment_id = (
</span><span class="s1">            SELECT MIN(p2.payment_id)
</span><span class="s1">            FROM payment p2
</span><span class="s1">            WHERE p.customer_id = p2.customer_id
</span><span class="s1">        ) 
</span><span class="s1">        AND 
</span><span class="s1">            EXTRACT(dow FROM p.payment_date) IN (0, 6)
</span><span class="s1">        AND 
</span><span class="s1">            p.amount &gt; 5     
</span><span class="s1">
</span><span class="s1">    GROUP BY 1
</span><span class="s1">)t WHERE t.CLV &gt; 100
</span><span class="s1">ORDER BY t.CLV DESC
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(17, 8)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
      <th>dow</th>
      <th>clv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>19029</td>
      <td>137</td>
      <td>1</td>
      <td>2469</td>
      <td>6.99</td>
      <td>2007-02-18 18:52:49.996577</td>
      <td>0</td>
      <td>191.62</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18572</td>
      <td>21</td>
      <td>2</td>
      <td>2235</td>
      <td>7.99</td>
      <td>2007-02-18 02:37:16.996577</td>
      <td>0</td>
      <td>146.68</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17526</td>
      <td>346</td>
      <td>1</td>
      <td>1994</td>
      <td>5.99</td>
      <td>2007-02-17 09:35:32.996577</td>
      <td>6</td>
      <td>145.70</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19502</td>
      <td>265</td>
      <td>2</td>
      <td>2027</td>
      <td>7.99</td>
      <td>2007-02-17 11:35:22.996577</td>
      <td>6</td>
      <td>132.72</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17509</td>
      <td>342</td>
      <td>2</td>
      <td>2190</td>
      <td>5.99</td>
      <td>2007-02-17 23:58:17.996577</td>
      <td>6</td>
      <td>130.68</td>
    </tr>
    <tr>
      <th>5</th>
      <td>17866</td>
      <td>436</td>
      <td>1</td>
      <td>2291</td>
      <td>9.99</td>
      <td>2007-02-18 06:05:12.996577</td>
      <td>0</td>
      <td>126.73</td>
    </tr>
    <tr>
      <th>6</th>
      <td>18099</td>
      <td>497</td>
      <td>2</td>
      <td>2180</td>
      <td>8.99</td>
      <td>2007-02-17 23:16:09.996577</td>
      <td>6</td>
      <td>121.73</td>
    </tr>
    <tr>
      <th>7</th>
      <td>18995</td>
      <td>128</td>
      <td>2</td>
      <td>2519</td>
      <td>7.99</td>
      <td>2007-02-18 22:47:47.996577</td>
      <td>0</td>
      <td>118.70</td>
    </tr>
    <tr>
      <th>8</th>
      <td>19496</td>
      <td>263</td>
      <td>2</td>
      <td>2126</td>
      <td>8.99</td>
      <td>2007-02-17 19:23:02.996577</td>
      <td>6</td>
      <td>116.73</td>
    </tr>
    <tr>
      <th>9</th>
      <td>18636</td>
      <td>32</td>
      <td>2</td>
      <td>1887</td>
      <td>6.99</td>
      <td>2007-02-17 02:21:44.996577</td>
      <td>6</td>
      <td>112.74</td>
    </tr>
    <tr>
      <th>10</th>
      <td>19345</td>
      <td>225</td>
      <td>2</td>
      <td>2226</td>
      <td>7.99</td>
      <td>2007-02-18 02:08:22.996577</td>
      <td>0</td>
      <td>111.76</td>
    </tr>
    <tr>
      <th>11</th>
      <td>18395</td>
      <td>579</td>
      <td>2</td>
      <td>2425</td>
      <td>5.99</td>
      <td>2007-02-18 16:06:11.996577</td>
      <td>0</td>
      <td>111.73</td>
    </tr>
    <tr>
      <th>12</th>
      <td>18554</td>
      <td>16</td>
      <td>2</td>
      <td>1934</td>
      <td>6.99</td>
      <td>2007-02-17 05:33:23.996577</td>
      <td>6</td>
      <td>109.75</td>
    </tr>
    <tr>
      <th>13</th>
      <td>18666</td>
      <td>40</td>
      <td>2</td>
      <td>2470</td>
      <td>7.99</td>
      <td>2007-02-18 18:56:57.996577</td>
      <td>0</td>
      <td>105.74</td>
    </tr>
    <tr>
      <th>14</th>
      <td>18446</td>
      <td>593</td>
      <td>2</td>
      <td>2055</td>
      <td>5.99</td>
      <td>2007-02-17 13:55:29.996577</td>
      <td>6</td>
      <td>101.76</td>
    </tr>
    <tr>
      <th>15</th>
      <td>18367</td>
      <td>572</td>
      <td>2</td>
      <td>1889</td>
      <td>10.99</td>
      <td>2007-02-17 02:33:38.996577</td>
      <td>6</td>
      <td>100.76</td>
    </tr>
    <tr>
      <th>16</th>
      <td>19441</td>
      <td>251</td>
      <td>1</td>
      <td>2238</td>
      <td>6.99</td>
      <td>2007-02-18 02:50:32.996577</td>
      <td>0</td>
      <td>100.75</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-10">▶ Python</h4>

<p>Let&rsquo;s break the pipeline in two parts.
First we compute the subset of customers who placed their first order on a week-end.</p>

<p>Note that unlike PostgreSQL, pandas codes Saturday as 5 and Sunday as 6.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">subset_fo</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dow</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">)</span> <span class="c1"># extract the day of the week as an integer</span>
               <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;payment_date&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;rental_id&#39;</span><span class="p">,</span> <span class="s1">&#39;staff_id&#39;</span><span class="p">,</span> <span class="s1">&#39;dow&#39;</span><span class="p">]]</span>
               <span class="o">.</span><span class="n">first</span><span class="p">()</span>                                         <span class="c1"># pick the first row for each group</span>
               <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(amount &gt; 5) &amp; (dow in [5, 6])&#39;</span><span class="p">)</span>
             <span class="p">)</span>
<span class="n">subset_fo</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_date</th>
      <th>payment_id</th>
      <th>amount</th>
      <th>rental_id</th>
      <th>staff_id</th>
      <th>dow</th>
    </tr>
    <tr>
      <th>customer_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>16</th>
      <td>2007-02-17 05:33:23.996577</td>
      <td>18554</td>
      <td>6.99</td>
      <td>1934</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-02-17 22:46:24.996577</td>
      <td>18558</td>
      <td>5.99</td>
      <td>2175</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-02-18 02:37:16.996577</td>
      <td>18572</td>
      <td>7.99</td>
      <td>2235</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2007-02-17 02:21:44.996577</td>
      <td>18636</td>
      <td>6.99</td>
      <td>1887</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>40</th>
      <td>2007-02-18 18:56:57.996577</td>
      <td>18666</td>
      <td>7.99</td>
      <td>2470</td>
      <td>2</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>

<p>We then join the payment table on this subset to get the information we want.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">payment</span><span class="o">.</span><span class="n">customer_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset_fo</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;amount&#39;</span><span class="p">]]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;clv&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;clv &gt;= 100&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subset_fo</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;clv&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df_sql</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(17, 8)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
      <th>dow</th>
      <th>clv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>19029</td>
      <td>137</td>
      <td>1</td>
      <td>2469</td>
      <td>6.99</td>
      <td>2007-02-18 18:52:49.996577</td>
      <td>6</td>
      <td>191.62</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18572</td>
      <td>21</td>
      <td>2</td>
      <td>2235</td>
      <td>7.99</td>
      <td>2007-02-18 02:37:16.996577</td>
      <td>6</td>
      <td>146.68</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17526</td>
      <td>346</td>
      <td>1</td>
      <td>1994</td>
      <td>5.99</td>
      <td>2007-02-17 09:35:32.996577</td>
      <td>5</td>
      <td>145.70</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19502</td>
      <td>265</td>
      <td>2</td>
      <td>2027</td>
      <td>7.99</td>
      <td>2007-02-17 11:35:22.996577</td>
      <td>5</td>
      <td>132.72</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17509</td>
      <td>342</td>
      <td>2</td>
      <td>2190</td>
      <td>5.99</td>
      <td>2007-02-17 23:58:17.996577</td>
      <td>5</td>
      <td>130.68</td>
    </tr>
    <tr>
      <th>5</th>
      <td>17866</td>
      <td>436</td>
      <td>1</td>
      <td>2291</td>
      <td>9.99</td>
      <td>2007-02-18 06:05:12.996577</td>
      <td>6</td>
      <td>126.73</td>
    </tr>
    <tr>
      <th>6</th>
      <td>18099</td>
      <td>497</td>
      <td>2</td>
      <td>2180</td>
      <td>8.99</td>
      <td>2007-02-17 23:16:09.996577</td>
      <td>5</td>
      <td>121.73</td>
    </tr>
    <tr>
      <th>7</th>
      <td>18995</td>
      <td>128</td>
      <td>2</td>
      <td>2519</td>
      <td>7.99</td>
      <td>2007-02-18 22:47:47.996577</td>
      <td>6</td>
      <td>118.70</td>
    </tr>
    <tr>
      <th>8</th>
      <td>19496</td>
      <td>263</td>
      <td>2</td>
      <td>2126</td>
      <td>8.99</td>
      <td>2007-02-17 19:23:02.996577</td>
      <td>5</td>
      <td>116.73</td>
    </tr>
    <tr>
      <th>9</th>
      <td>18636</td>
      <td>32</td>
      <td>2</td>
      <td>1887</td>
      <td>6.99</td>
      <td>2007-02-17 02:21:44.996577</td>
      <td>5</td>
      <td>112.74</td>
    </tr>
    <tr>
      <th>10</th>
      <td>19345</td>
      <td>225</td>
      <td>2</td>
      <td>2226</td>
      <td>7.99</td>
      <td>2007-02-18 02:08:22.996577</td>
      <td>6</td>
      <td>111.76</td>
    </tr>
    <tr>
      <th>11</th>
      <td>18395</td>
      <td>579</td>
      <td>2</td>
      <td>2425</td>
      <td>5.99</td>
      <td>2007-02-18 16:06:11.996577</td>
      <td>6</td>
      <td>111.73</td>
    </tr>
    <tr>
      <th>12</th>
      <td>18554</td>
      <td>16</td>
      <td>2</td>
      <td>1934</td>
      <td>6.99</td>
      <td>2007-02-17 05:33:23.996577</td>
      <td>5</td>
      <td>109.75</td>
    </tr>
    <tr>
      <th>13</th>
      <td>18666</td>
      <td>40</td>
      <td>2</td>
      <td>2470</td>
      <td>7.99</td>
      <td>2007-02-18 18:56:57.996577</td>
      <td>6</td>
      <td>105.74</td>
    </tr>
    <tr>
      <th>14</th>
      <td>18446</td>
      <td>593</td>
      <td>2</td>
      <td>2055</td>
      <td>5.99</td>
      <td>2007-02-17 13:55:29.996577</td>
      <td>5</td>
      <td>101.76</td>
    </tr>
    <tr>
      <th>15</th>
      <td>18367</td>
      <td>572</td>
      <td>2</td>
      <td>1889</td>
      <td>10.99</td>
      <td>2007-02-17 02:33:38.996577</td>
      <td>5</td>
      <td>100.76</td>
    </tr>
    <tr>
      <th>16</th>
      <td>19441</td>
      <td>251</td>
      <td>1</td>
      <td>2238</td>
      <td>6.99</td>
      <td>2007-02-18 02:50:32.996577</td>
      <td>6</td>
      <td>100.75</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<h4 id="r-10">▶ R</h4>

<p>Let&rsquo;s do the same with R. We&rsquo;ll drop the <code>payment_date</code> column at the end so that we can fit all the remaining columns horizontally.</p>

<p>Of course, R (lubridate) uses yet another encoding for the days of the week. Saturday is represented as 7 and Sunday as 1.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R

subset_fo <span class="o">=</span> payment <span class="o">%&gt;%</span> 
              group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
              mutate<span class="p">(</span>dow<span class="o">=</span>lubridate<span class="o">::</span>wday<span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
              filter<span class="p">(</span>row_number<span class="p">()</span><span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> dow<span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span> <span class="o">&amp;</span> amount<span class="o">&gt;</span><span class="m">5</span><span class="p">)</span> 

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        right_join<span class="p">(</span>subset_fo<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;customer_id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        summarise<span class="p">(</span>clv<span class="o">=</span><span class="kp">sum</span><span class="p">(</span>amount.x<span class="p">))</span> <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>clv <span class="o">&gt;</span> <span class="m">100</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        left_join<span class="p">(</span>subset_fo<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;customer_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        select<span class="p">(</span>payment_id<span class="p">,</span> customer_id<span class="p">,</span> staff_id<span class="p">,</span> rental_id<span class="p">,</span> amount<span class="p">,</span> payment_date<span class="p">,</span> dow<span class="p">,</span> clv<span class="p">)</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>desc<span class="p">(</span>clv<span class="p">))</span> <span class="o">%&gt;%</span>
        select<span class="p">(</span><span class="o">-</span>payment_date<span class="p">)</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 17  7
   payment_id customer_id staff_id rental_id amount dow    clv
1       19029         137        1      2469   6.99   1 191.62
2       18572          21        2      2235   7.99   1 146.68
3       17526         346        1      1994   5.99   7 145.70
4       19502         265        2      2027   7.99   7 132.72
5       17509         342        2      2190   5.99   7 130.68
6       17866         436        1      2291   9.99   1 126.73
7       18099         497        2      2180   8.99   7 121.73
8       18995         128        2      2519   7.99   1 118.70
9       19496         263        2      2126   8.99   7 116.73
10      18636          32        2      1887   6.99   7 112.74
11      19345         225        2      2226   7.99   1 111.76
12      18395         579        2      2425   5.99   1 111.73
13      18554          16        2      1934   6.99   7 109.75
14      18666          40        2      2470   7.99   1 105.74
15      18446         593        2      2055   5.99   7 101.76
16      18367         572        2      1889  10.99   7 100.76
17      19441         251        1      2238   6.99   1 100.75</pre></div>
<hr />

<h3 id="how-many-movies-have-a-replacement-cost-above-or-below-the-average-replacement-cost">How many movies have a replacement cost above or below the average replacement cost?</h3>

<p>Once way to answer this is to compute how many movies have a replacement cost higher than the average, how many
have a replacement cost lower or equal to the average, and take the union of the two.</p>

<h4 id="sql-11">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT t.grouping, COUNT(*) FROM (
</span><span class="s1">    SELECT f.*, &#39;above&#39; as grouping
</span><span class="s1">    FROM film f
</span><span class="s1">    WHERE f.replacement_cost &gt; (SELECT AVG(f2.replacement_cost) FROM film f2) 
</span><span class="s1">
</span><span class="s1">    UNION 
</span><span class="s1">
</span><span class="s1">    SELECT f.*, &#39;below_eq&#39; as grouping
</span><span class="s1">    FROM film f
</span><span class="s1">    WHERE f.replacement_cost &lt;= (SELECT AVG(f2.replacement_cost) FROM film f2) 
</span><span class="s1">    )t 
</span><span class="s1">GROUP BY 1
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(2, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>grouping</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>below_eq</td>
      <td>464</td>
    </tr>
    <tr>
      <th>1</th>
      <td>above</td>
      <td>536</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-11">▶ Python</h4>

<p>The Python syntax is definitely simpler here because we can create a Boolean mask telling us whether the replacement cost is above average, and then use <code>value_counts</code> to tally up the <code>True</code> and <code>False</code> counts.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="p">(</span><span class="n">film</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">above</span><span class="o">=</span><span class="n">film</span><span class="o">.</span><span class="n">replacement_cost</span> <span class="o">&gt;</span> <span class="n">film</span><span class="o">.</span><span class="n">replacement_cost</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
  <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;above&#39;</span><span class="p">]</span>
  <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
  <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">{</span><span class="bp">True</span><span class="p">:</span> <span class="s1">&#39;above&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span> <span class="s1">&#39;below_eq&#39;</span><span class="p">})</span>
<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">above       536
below_eq    464
Name: above, dtype: int64</pre></div>
<h4 id="r-11">▶  R</h4>

<p>The R code is similar to the Python one.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
film <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>above<span class="o">=</span>replacement_cost<span class="o">&gt;</span><span class="kp">mean</span><span class="p">(</span>film<span class="o">$</span>replacement_cost<span class="p">))</span> <span class="o">%&gt;%</span> 
  count<span class="p">(</span>above<span class="p">)</span> <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>above<span class="o">=</span>if_else<span class="p">(</span>above<span class="p">,</span> <span class="s">&#39;above&#39;</span><span class="p">,</span> <span class="s">&#39;below_eq&#39;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"># A tibble: 2 x 2
  above        n
  &lt;chr&gt;    &lt;int&gt;
1 below_eq   464
2 above      536</pre></div>
<hr />

<h3 id="which-movie-generated-the-more-revenue-for-each-viewer-rating-category">Which movie generated the more revenue, for each viewer rating category?</h3>

<h4 id="sql-12">▶ SQL</h4>

<p>The grouping by rating part is straightforward, however, we want the <em>top performing movie</em> within each group.
We can use a window function (the <code>OVER</code> part) to do this.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">WITH some_table AS (
</span><span class="s1">    SELECT 
</span><span class="s1">        f.film_id, 
</span><span class="s1">        f.title, 
</span><span class="s1">        f.rating, 
</span><span class="s1">        SUM(p.amount),
</span><span class="s1">        ROW_NUMBER() OVER(PARTITION BY f.rating ORDER BY SUM(p.amount) DESC)
</span><span class="s1">
</span><span class="s1">    FROM film f
</span><span class="s1">    JOIN inventory i ON f.film_id = i.film_id
</span><span class="s1">    JOIN rental r ON r.inventory_id = i.inventory_id
</span><span class="s1">    JOIN payment p ON p.rental_id = r.rental_id
</span><span class="s1">    GROUP BY 1, 2, 3
</span><span class="s1">    ORDER BY 3) 
</span><span class="s1">    
</span><span class="s1">SELECT st.* FROM some_table st 
</span><span class="s1">WHERE st.row_number = 1
</span><span class="s1">ORDER BY 4 DESC
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rating</th>
      <th>sum</th>
      <th>row_number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>879</td>
      <td>Telegraph Voyage</td>
      <td>PG</td>
      <td>215.75</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1000</td>
      <td>Zorro Ark</td>
      <td>NC-17</td>
      <td>199.72</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>460</td>
      <td>Innocent Usual</td>
      <td>PG-13</td>
      <td>191.74</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>764</td>
      <td>Saturday Lambs</td>
      <td>G</td>
      <td>190.74</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>938</td>
      <td>Velvet Terminator</td>
      <td>R</td>
      <td>152.77</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-12">▶ Python</h4>

<p>The pattern below is a common one. We group by some features to compute an aggregate measure, and then ungroup (<code>reset_index</code>) to group the data again at a different level of granularity.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">film</span>
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>    
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rental</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;inventory_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">payment</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;rental_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;film_id&#39;</span><span class="p">])[[</span><span class="s1">&#39;amount&#39;</span><span class="p">]]</span>
       <span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">first</span><span class="p">()</span>
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">film</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;sum&#39;</span><span class="p">]]</span>
      <span class="p">)</span>

<span class="n">df</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rating</th>
      <th>sum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>879</td>
      <td>Telegraph Voyage</td>
      <td>PG</td>
      <td>215.75</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1000</td>
      <td>Zorro Ark</td>
      <td>NC-17</td>
      <td>199.72</td>
    </tr>
    <tr>
      <th>2</th>
      <td>460</td>
      <td>Innocent Usual</td>
      <td>PG-13</td>
      <td>191.74</td>
    </tr>
    <tr>
      <th>3</th>
      <td>764</td>
      <td>Saturday Lambs</td>
      <td>G</td>
      <td>190.74</td>
    </tr>
    <tr>
      <th>4</th>
      <td>938</td>
      <td>Velvet Terminator</td>
      <td>R</td>
      <td>152.77</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-12">▶ R</h4>

<p>This the same approach as in Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
df_r <span class="o">=</span> film <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>inventory<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;film_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>rental<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;inventory_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>payment<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;rental_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  group_by<span class="p">(</span>rating<span class="p">,</span> film_id<span class="p">)</span> <span class="o">%&gt;%</span> 
  summarise<span class="p">(</span>sum<span class="o">=</span><span class="kp">sum</span><span class="p">(</span>amount<span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  ungroup<span class="p">()</span> <span class="o">%&gt;%</span> 
  arrange<span class="p">(</span>desc<span class="p">(</span><span class="kp">sum</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  group_by<span class="p">(</span>rating<span class="p">)</span> <span class="o">%&gt;%</span> 
  filter<span class="p">(</span>row_number<span class="p">()</span><span class="o">==</span><span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>film<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;film_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  select<span class="p">(</span>film_id<span class="p">,</span> title<span class="p">,</span> rating.x<span class="p">,</span> <span class="kp">sum</span><span class="p">)</span> 

<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">  film_id             title rating.x    sum
1     879  Telegraph Voyage       PG 215.75
2    1000         Zorro Ark    NC-17 199.72
3     460    Innocent Usual    PG-13 191.74
4     764    Saturday Lambs        G 190.74
5     938 Velvet Terminator        R 152.77</pre></div>
<hr />

<p>Hopefully, the examples above show that a significant part of the syntax used to wrangle structured data (data arranged in tables), in both Python (pandas) and R (tidyverse), has been influenced by SQL.</p>

<p>Many of the pipelines we built are comprised of the same steps as the corresponding SQL query. This is especially true for basic queries where we do
simple things like group by columns or build a simple aggregate measure.
Similarly, syntactic differences aside, joining operations work in a comparable way across the three languages.</p>

<p>As we consider more complex operations, however, a direct port of the SQL querie to the other languages may not be the most optimal way.
We saw a small example of this when we computed which days in March had no rentals.
The good news, however, is that these languages aren&rsquo;t mutually exclusive. After all, we did run all our SQL via Python (pandas).
Rather these languages complement each other and can be used in conjunction to build pipelines that can perform complex manipulation of the data in an
efficient way. Very often, SQL is used to first extract a subset of the data from a large database, which can then be manipulated and transformed further in Python or R.</p>

<p>To steal a line from  Alexandre Dumas&rsquo; The Three Musketeers, this is truly a case of <em>All for one and one for all</em>!</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/sql/">sql</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/r/">r</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/pandas/">pandas</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/tidyverse/">tidyverse</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/data-wrangling/">data wrangling</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/11/pandas_groupby/">
                <h2 class="post-title">Pandas (Blood)groupby</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on November 15, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;37&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;7831&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<h2 id="1-pandas-groupby">1. Pandas GroupBy</h2>

<p>To illustrate how the pandas <code>groupby</code> operation works let&rsquo;s use some fake data. With <code>numpy</code> it&rsquo;s trivial to generate random numerical data, however, it&rsquo;s usually a lot more tedious to generate random people data that looks realistic.</p>

<p>A very useful tool for this is the <a href="http://www.fakenamegenerator.com/">Fake Name Generator</a>. That&rsquo;s what I used to generate
this dataset.</p>

<p>Let&rsquo;s load the dataset into a dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/people.csv&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>8/25/1968</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1/31/1962</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1/10/1964</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>4/12/1933</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>11/20/1946</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>

<p>The data contains information about fictitious people.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName        5000
Surname          5000
Gender           5000
StreetAddress    5000
City             5000
Country          5000
Birthday         5000
BloodType        5000
dtype: int64</pre></div>
<div style="background-color:#F7F2E0;">
<h4> <font color=MediumVioletRed>Remark:</font> </h4>
<p>We've got different types of variables here. For instance, <code>Gender</code> is a categorical variable, so are <code>BloodType</code> and <code>Country</code>. </p>
<p><code>Birthday</code> can be thought of as an interval variable, although we'll convert it to an <code>Age</code> variable, which is more convenient for our purpose, and will be treated as a continuous numeric variable. </p>
<p>Notice, however, that by default pandas will identify non-numeric data as a generic object, which is not the most efficient way of handling categorical data. Let's fix that.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName        object
Surname          object
Gender           object
StreetAddress    object
City             object
Country          object
Birthday         object
BloodType        object
dtype: object</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName          object
Surname            object
Gender           category
StreetAddress      object
City               object
Country          category
Birthday           object
BloodType        category
dtype: object</pre></div>
<h3> <center><font color=MediumVioletRed>A. Dealing with dates.</font></center></h3>

<h4>Method 1 - <code>datetime</code> module.</h4>

<p>One of the features (columns) in our dataset is <code>Birthday</code>. While this information may be useful if you wanted to
find out, for instance, how many people share a birthday, most of the time we mainly care about their age.</p>

<p>One way to convert the <code>Birthday</code> into an <code>Age</code> feature would be to extract the year and compute the current year minus
the birthday year. The <code>split</code> method of string objects could be used for that, however, there&rsquo;s a more elegant, and general
way of handling dates in Python using the <a href="https://pymotw.com/3/datetime/"><code>datetime.strptime</code> function</a>.</p>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>This isn't necessarily the fastest, or best way to handle date and time objects in <code>pandas</code>. </p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&#34;21/01/2019&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">%d</span><span class="s2">/%m/%Y&#34;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">2019
62 days, 20:14:58.495945</pre></div>
<p>The <code>datetime</code> module allows you to manipulate date objects and perform basic <strong>operations on dates</strong>. It also allows you to
format dates in a consistent way.</p>

<p>We can apply this to our <code>Birthday</code> feature.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">(&#39;8/25/1968&#39;, &#39;1/31/1962&#39;)</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&#34;%m/</span><span class="si">%d</span><span class="s2">/%Y&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">datetime.datetime(1968, 8, 25, 0, 0)</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s2">&#34;%m/</span><span class="si">%d</span><span class="s2">/%Y&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">datetime.datetime(1962, 1, 31, 0, 0)</pre></div>
<h4 id="let-s-use-the-pandas-apply-method-to-format-the-dates-in-a-consistent-way">Let&rsquo;s use the Pandas <code>apply</code> method to format the dates in a consistent way</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">],</span> <span class="s2">&#34;%m/</span><span class="si">%d</span><span class="s2">/%Y&#34;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0   1968-08-25
1   1962-01-31
2   1964-01-10
3   1933-04-12
4   1946-11-20
Name: Birthday, dtype: datetime64[ns]</pre></div>
<h4>Method 2 - using the <code>to_datetime</code> method of pandas.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">original_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">)</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0   1968-08-25
1   1962-01-31
2   1964-01-10
3   1933-04-12
4   1946-11-20
Name: Birthday, dtype: datetime64[ns]</pre></div>
<h4>Method 3 - convert at reading time.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">original_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">])</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0   1968-08-25
1   1962-01-31
2   1964-01-10
3   1933-04-12
4   1946-11-20
Name: Birthday, dtype: datetime64[ns]</pre></div>
<h4>We can now define an <code>Age</code> feature by subtracting the year of birth from the current year.</h4> 

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Because we are not hard-coding (typing by hand) the current date, if we come back to this code in a year's time and run it again,
    the <code>Age</code> will be updated automatically. </p>
</div>

<h4 id="we-could-compute-the-age-using-code-apply-code-to-iterate-through-the-rows-of-the-dataframe">We could compute the age using <code>apply</code> to iterate through the rows of the dataframe&hellip;</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0    51
1    57
2    55
3    86
4    73
dtype: int64</pre></div>
<h4>However, it is usually faster to operate on the whole dataframe at one.</h4>

<p>Datetime methods on a pandas series (such as a column of a dataframe), can be accessed via the <code>dt</code> method.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0    51
1    57
2    55
3    86
4    73
Name: Birthday, dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>1968-08-25</td>
      <td>A+</td>
      <td>51</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1962-01-31</td>
      <td>A+</td>
      <td>57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1964-01-10</td>
      <td>B+</td>
      <td>55</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>1933-04-12</td>
      <td>O-</td>
      <td>86</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>1946-11-20</td>
      <td>A+</td>
      <td>73</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>B. GroupBy feature.</font></center></h3>

<p>Given the data, common questions to answer would be how certain features are distributed in each
country, or for each gender.</p>

<p>These could be as simple as <strong>What is the average age in each country?</strong>
to much more complex questions such as <strong>How many people of each blood type are there in each country, for
each gender, for a given age group?</strong></p>

<p>Fortunately, Pandas&rsquo; <code>GroupBy</code> method allows us to organise the data in ways only limited by our sagacity.</p>

<h4> Let's look at the country distribution first.  </h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Country</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">Australia         1800
Italy              800
United States      700
United Kingdom     500
New Zealand        500
France             500
Iceland            200
Name: Country, dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Country</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span></code></pre></div>
<p><img src="output_31_0.png" alt="png" /></p>

<h4 id="the-groupby-method-creates-a-groupby-object">The <code>groupby</code> method creates a <code>GroupBy</code> object.</h4>

<p>The <code>groupby</code> object is a recipe for how to perform operation on the data.</p>

<p>To use a <code>groupby</code> object, we need to perform some operation on it.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span>
<span class="n">grouped_by_country</span></code></pre></div><div class="highlight"><pre class="chroma">&lt;pandas.core.groupby.generic.DataFrameGroupBy object at 0x106ca5710&gt;</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="o">.</span><span class="n">size</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">Country
Australia         1800
France             500
Iceland            200
Italy              800
New Zealand        500
United Kingdom     500
United States      700
dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="o">.</span><span class="n">ngroups</span></code></pre></div><div class="highlight"><pre class="chroma">7</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_by_country</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Australia
France
Iceland
Italy
New Zealand
United Kingdom
United States</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">Country
Australia         57.817778
France            57.944000
Iceland           57.660000
Italy             56.607500
New Zealand       56.630000
United Kingdom    57.740000
United States     57.415714
Name: Age, dtype: float64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Recall that the <code>apply</code> method allows you to apply an <b>arbitrary function</b> to all the rows in your dataframe. Therefore, as long as you can express your operations as a function (lambda or otherwise), you can include it in the <code>apply</code>, <b>even if your function returns multiple values</b>, provided you wrap them in a tuple.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                                           <span class="n">f</span><span class="s1">&#39;{x.mean():0.2f}&#39;</span><span class="p">,</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                                           <span class="n">f</span><span class="s1">&#39;{x.std():0.2f}&#39;</span><span class="p">)</span>
                                <span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Country
Australia         (24, 57.82, 91, 19.49)
France            (24, 57.94, 91, 19.54)
Iceland           (24, 57.66, 91, 19.46)
Italy             (24, 56.61, 91, 18.98)
New Zealand       (24, 56.63, 91, 19.05)
United Kingdom    (24, 57.74, 91, 19.53)
United States     (24, 57.42, 91, 19.29)
Name: Age, dtype: object</pre></div>
<h4 id="a-different-and-nicer-output-can-be-obtained-using-the-agg-method-on-a-groupby-object">A different and nicer output can be obtained using the <code>agg</code> method on a groupby object.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>24</td>
      <td>57.817778</td>
      <td>91</td>
      <td>19.488031</td>
    </tr>
    <tr>
      <th>France</th>
      <td>24</td>
      <td>57.944000</td>
      <td>91</td>
      <td>19.541869</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>24</td>
      <td>57.660000</td>
      <td>91</td>
      <td>19.461194</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>24</td>
      <td>56.607500</td>
      <td>91</td>
      <td>18.981275</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>24</td>
      <td>56.630000</td>
      <td>91</td>
      <td>19.049905</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>24</td>
      <td>57.740000</td>
      <td>91</td>
      <td>19.527905</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>24</td>
      <td>57.415714</td>
      <td>91</td>
      <td>19.285003</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="for-categorical-variables-such-as-bloodtype-basic-information-can-be-extracted-using-the-describe-method">For categorical variables, such as <code>BloodType</code>, basic information can be extracted using the <code>describe</code> method.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>1800</td>
      <td>8</td>
      <td>O+</td>
      <td>648</td>
    </tr>
    <tr>
      <th>France</th>
      <td>500</td>
      <td>8</td>
      <td>O+</td>
      <td>184</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>200</td>
      <td>7</td>
      <td>O+</td>
      <td>86</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>800</td>
      <td>8</td>
      <td>O+</td>
      <td>299</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>500</td>
      <td>8</td>
      <td>O+</td>
      <td>185</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>500</td>
      <td>8</td>
      <td>O+</td>
      <td>188</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>700</td>
      <td>8</td>
      <td>O+</td>
      <td>273</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;GivenName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>1800</td>
      <td>1368</td>
      <td>Michael</td>
      <td>9</td>
    </tr>
    <tr>
      <th>France</th>
      <td>500</td>
      <td>444</td>
      <td>Anna</td>
      <td>4</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>200</td>
      <td>193</td>
      <td>Dieter</td>
      <td>2</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>800</td>
      <td>677</td>
      <td>Jennifer</td>
      <td>6</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>500</td>
      <td>447</td>
      <td>James</td>
      <td>4</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>500</td>
      <td>450</td>
      <td>Ellis</td>
      <td>3</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>700</td>
      <td>620</td>
      <td>Lily</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>

<p><code>describe</code> only tells us about the most frequent blood type. To get a count of the boodtypes let us use a <code>Counter</code> object.</p>

<div style="background-color:#FBEFFB;">
<h4>Which item appears most frequently?</h4>

Counting the number of objects of a given type is such a common operation that Python has a very useful <code>Counter</code> object
from the <code>collections</code> module. 

What a <code>Counter</code> object does to a sequence of items is group the elements of the sequence into bins according to their value, and count how many element each bin has. A <code>Counter</code> object also had several useful properties, for instance, to determine the most common object in the sequence.
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
<span class="n">c</span></code></pre></div><div class="highlight"><pre class="chroma">Counter({&#39;a&#39;: 3, &#39;b&#39;: 5, &#39;c&#39;: 2})</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">[(&#39;b&#39;, 5), (&#39;a&#39;, 3), (&#39;c&#39;, 2)]
[(&#39;b&#39;, 5), (&#39;a&#39;, 3)]
[(&#39;b&#39;, 5)]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Country            
Australia       A+     468.0
                A-      59.0
                AB+    100.0
                AB-      8.0
                B+     419.0
                B-      24.0
                O+     648.0
                O-      74.0
France          A+     145.0
                A-      17.0
                AB+     19.0
                AB-      1.0
                B+     106.0
                B-       4.0
                O+     184.0
                O-      24.0
Iceland         A+      45.0
                A-       6.0
                AB+      5.0
                B+      44.0
                B-       5.0
                O+      86.0
                O-       9.0
Italy           A+     207.0
                A-      31.0
                AB+     37.0
                AB-      5.0
                B+     185.0
                B-       4.0
                O+     299.0
                O-      32.0
New Zealand     A+     154.0
                A-       9.0
                AB+     21.0
                AB-      5.0
                B+     100.0
                B-       5.0
                O+     185.0
                O-      21.0
United Kingdom  A+     132.0
                A-      23.0
                AB+     25.0
                AB-      4.0
                B+     102.0
                B-       7.0
                O+     188.0
                O-      19.0
United States   A+     157.0
                A-      25.0
                AB+     35.0
                AB-      4.0
                B+     157.0
                B-      15.0
                O+     273.0
                O-      34.0
Name: BloodType, dtype: float64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Note how the result is one long column of information. This result is actually a Pandas <code>Series</code> object (recall that a <code>Series</code> object is essentially an array with an index).</p>

<p>It may look a bit like a dataframe, but remember that in a dataframe each column corresponds to a <b>unique</b> feature. Here, what looks like the second column is actually a second level for the index. We'll talk about multi-index shortly.  </p>
<p>The result as it stands may not be the easiest to read. It would be better if we could transform it back into a dataframe so
that we could compare the results for two countries more easily. In Pandas, you can do that with one command: <code>unstack</code>.
</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>468.0</td>
      <td>59.0</td>
      <td>100.0</td>
      <td>8.0</td>
      <td>419.0</td>
      <td>24.0</td>
      <td>648.0</td>
      <td>74.0</td>
    </tr>
    <tr>
      <th>France</th>
      <td>145.0</td>
      <td>17.0</td>
      <td>19.0</td>
      <td>1.0</td>
      <td>106.0</td>
      <td>4.0</td>
      <td>184.0</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>45.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>NaN</td>
      <td>44.0</td>
      <td>5.0</td>
      <td>86.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>207.0</td>
      <td>31.0</td>
      <td>37.0</td>
      <td>5.0</td>
      <td>185.0</td>
      <td>4.0</td>
      <td>299.0</td>
      <td>32.0</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>154.0</td>
      <td>9.0</td>
      <td>21.0</td>
      <td>5.0</td>
      <td>100.0</td>
      <td>5.0</td>
      <td>185.0</td>
      <td>21.0</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>132.0</td>
      <td>23.0</td>
      <td>25.0</td>
      <td>4.0</td>
      <td>102.0</td>
      <td>7.0</td>
      <td>188.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>157.0</td>
      <td>25.0</td>
      <td>35.0</td>
      <td>4.0</td>
      <td>157.0</td>
      <td>15.0</td>
      <td>273.0</td>
      <td>34.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>If we want to switch the index and the columns around, we need to specify the <code>level</code> parameter in  <code>unstack()</code> which, by default, is -1, that is the last (innermost) level of the index.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Country</th>
      <th>Australia</th>
      <th>France</th>
      <th>Iceland</th>
      <th>Italy</th>
      <th>New Zealand</th>
      <th>United Kingdom</th>
      <th>United States</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>468.0</td>
      <td>145.0</td>
      <td>45.0</td>
      <td>207.0</td>
      <td>154.0</td>
      <td>132.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.0</td>
      <td>17.0</td>
      <td>6.0</td>
      <td>31.0</td>
      <td>9.0</td>
      <td>23.0</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>100.0</td>
      <td>19.0</td>
      <td>5.0</td>
      <td>37.0</td>
      <td>21.0</td>
      <td>25.0</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>8.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>419.0</td>
      <td>106.0</td>
      <td>44.0</td>
      <td>185.0</td>
      <td>100.0</td>
      <td>102.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>24.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>648.0</td>
      <td>184.0</td>
      <td>86.0</td>
      <td>299.0</td>
      <td>185.0</td>
      <td>188.0</td>
      <td>273.0</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>74.0</td>
      <td>24.0</td>
      <td>9.0</td>
      <td>32.0</td>
      <td>21.0</td>
      <td>19.0</td>
      <td>34.0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="the-level-can-also-be-specified-by-name">The level can also be specified by name</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Country</th>
      <th>Australia</th>
      <th>France</th>
      <th>Iceland</th>
      <th>Italy</th>
      <th>New Zealand</th>
      <th>United Kingdom</th>
      <th>United States</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>468.0</td>
      <td>145.0</td>
      <td>45.0</td>
      <td>207.0</td>
      <td>154.0</td>
      <td>132.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.0</td>
      <td>17.0</td>
      <td>6.0</td>
      <td>31.0</td>
      <td>9.0</td>
      <td>23.0</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>100.0</td>
      <td>19.0</td>
      <td>5.0</td>
      <td>37.0</td>
      <td>21.0</td>
      <td>25.0</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>8.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>419.0</td>
      <td>106.0</td>
      <td>44.0</td>
      <td>185.0</td>
      <td>100.0</td>
      <td>102.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>24.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>648.0</td>
      <td>184.0</td>
      <td>86.0</td>
      <td>299.0</td>
      <td>185.0</td>
      <td>188.0</td>
      <td>273.0</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>74.0</td>
      <td>24.0</td>
      <td>9.0</td>
      <td>32.0</td>
      <td>21.0</td>
      <td>19.0</td>
      <td>34.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Note that we have a  bunch of <code>NaN</code> in our dataframe. This indicates that no one from Iceland has blood type <code>AB+</code> in our dataset.</p>

<p>Since there was no such data in our dataset, it appears as a <strong>missing value</strong>.</p>

<p>However, here, a value of 0 would be more appropriate. We can tell the dataframe to
replace its missing values by 0 using the <code>fillna</code> method.</p>

<p>Since we&rsquo;re dealing with count data, it&rsquo;s also a good idea to convert the type to <code>int</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>468</td>
      <td>59</td>
      <td>100</td>
      <td>8</td>
      <td>419</td>
      <td>24</td>
      <td>648</td>
      <td>74</td>
    </tr>
    <tr>
      <th>France</th>
      <td>145</td>
      <td>17</td>
      <td>19</td>
      <td>1</td>
      <td>106</td>
      <td>4</td>
      <td>184</td>
      <td>24</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>45</td>
      <td>6</td>
      <td>5</td>
      <td>0</td>
      <td>44</td>
      <td>5</td>
      <td>86</td>
      <td>9</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>207</td>
      <td>31</td>
      <td>37</td>
      <td>5</td>
      <td>185</td>
      <td>4</td>
      <td>299</td>
      <td>32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>154</td>
      <td>9</td>
      <td>21</td>
      <td>5</td>
      <td>100</td>
      <td>5</td>
      <td>185</td>
      <td>21</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>132</td>
      <td>23</td>
      <td>25</td>
      <td>4</td>
      <td>102</td>
      <td>7</td>
      <td>188</td>
      <td>19</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>157</td>
      <td>25</td>
      <td>35</td>
      <td>4</td>
      <td>157</td>
      <td>15</td>
      <td>273</td>
      <td>34</td>
    </tr>
  </tbody>
</table>
</div>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>We are using <b>fake data</b> so don't give too much credence to these results. </p>

<p>This being said,  blood type frequencies do vary
across countries and you can read more about it <a href="http://en.wikipedia.org/wiki/Blood_type_distribution_by_country">here</a>.
</p>
</div>

<h3> <center><font color=MediumVioletRed>C. GroupBy on multiple features.</font></center></h3>

<p>Of, course, <code>GroupBy</code> operations aren&rsquo;t limited to single features.</p>

<p>If we want to see the data grouped by country <b>and</b> blood type , we just need to specify both features in constructing the <code>GroupBy</code> object.
<h4>Note that with a <code>groupby</code> on multiple features we can obtain the previous result in a different way.</h4></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;BloodType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>468</td>
      <td>59</td>
      <td>100</td>
      <td>8</td>
      <td>419</td>
      <td>24</td>
      <td>648</td>
      <td>74</td>
    </tr>
    <tr>
      <th>France</th>
      <td>145</td>
      <td>17</td>
      <td>19</td>
      <td>1</td>
      <td>106</td>
      <td>4</td>
      <td>184</td>
      <td>24</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>45</td>
      <td>6</td>
      <td>5</td>
      <td>0</td>
      <td>44</td>
      <td>5</td>
      <td>86</td>
      <td>9</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>207</td>
      <td>31</td>
      <td>37</td>
      <td>5</td>
      <td>185</td>
      <td>4</td>
      <td>299</td>
      <td>32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>154</td>
      <td>9</td>
      <td>21</td>
      <td>5</td>
      <td>100</td>
      <td>5</td>
      <td>185</td>
      <td>21</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>132</td>
      <td>23</td>
      <td>25</td>
      <td>4</td>
      <td>102</td>
      <td>7</td>
      <td>188</td>
      <td>19</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>157</td>
      <td>25</td>
      <td>35</td>
      <td>4</td>
      <td>157</td>
      <td>15</td>
      <td>273</td>
      <td>34</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="let-s-group-our-data-based-on-country-and-gender">Let&rsquo;s group our data based on country and gender.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">])</span>

<span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>229.0</td>
      <td>29.0</td>
      <td>54.0</td>
      <td>4.0</td>
      <td>205.0</td>
      <td>13.0</td>
      <td>328.0</td>
      <td>41.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>239.0</td>
      <td>30.0</td>
      <td>46.0</td>
      <td>4.0</td>
      <td>214.0</td>
      <td>11.0</td>
      <td>320.0</td>
      <td>33.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>76.0</td>
      <td>11.0</td>
      <td>10.0</td>
      <td>NaN</td>
      <td>47.0</td>
      <td>2.0</td>
      <td>79.0</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69.0</td>
      <td>6.0</td>
      <td>9.0</td>
      <td>1.0</td>
      <td>59.0</td>
      <td>2.0</td>
      <td>105.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>22.0</td>
      <td>5.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>17.0</td>
      <td>4.0</td>
      <td>34.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>23.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>52.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>102.0</td>
      <td>14.0</td>
      <td>22.0</td>
      <td>1.0</td>
      <td>89.0</td>
      <td>1.0</td>
      <td>160.0</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>105.0</td>
      <td>17.0</td>
      <td>15.0</td>
      <td>4.0</td>
      <td>96.0</td>
      <td>3.0</td>
      <td>139.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>75.0</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>53.0</td>
      <td>2.0</td>
      <td>91.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>79.0</td>
      <td>4.0</td>
      <td>13.0</td>
      <td>4.0</td>
      <td>47.0</td>
      <td>3.0</td>
      <td>94.0</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>65.0</td>
      <td>6.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>55.0</td>
      <td>4.0</td>
      <td>99.0</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>67.0</td>
      <td>17.0</td>
      <td>11.0</td>
      <td>3.0</td>
      <td>47.0</td>
      <td>3.0</td>
      <td>89.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>89.0</td>
      <td>13.0</td>
      <td>18.0</td>
      <td>3.0</td>
      <td>77.0</td>
      <td>7.0</td>
      <td>138.0</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>68.0</td>
      <td>12.0</td>
      <td>17.0</td>
      <td>1.0</td>
      <td>80.0</td>
      <td>8.0</td>
      <td>135.0</td>
      <td>22.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Once again let&rsquo;s replace missing values by 0.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>229</td>
      <td>29</td>
      <td>54</td>
      <td>4</td>
      <td>205</td>
      <td>13</td>
      <td>328</td>
      <td>41</td>
    </tr>
    <tr>
      <th>male</th>
      <td>239</td>
      <td>30</td>
      <td>46</td>
      <td>4</td>
      <td>214</td>
      <td>11</td>
      <td>320</td>
      <td>33</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>76</td>
      <td>11</td>
      <td>10</td>
      <td>0</td>
      <td>47</td>
      <td>2</td>
      <td>79</td>
      <td>16</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>6</td>
      <td>9</td>
      <td>1</td>
      <td>59</td>
      <td>2</td>
      <td>105</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>22</td>
      <td>5</td>
      <td>2</td>
      <td>0</td>
      <td>17</td>
      <td>4</td>
      <td>34</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>23</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>27</td>
      <td>1</td>
      <td>52</td>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>102</td>
      <td>14</td>
      <td>22</td>
      <td>1</td>
      <td>89</td>
      <td>1</td>
      <td>160</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>105</td>
      <td>17</td>
      <td>15</td>
      <td>4</td>
      <td>96</td>
      <td>3</td>
      <td>139</td>
      <td>15</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>75</td>
      <td>5</td>
      <td>8</td>
      <td>1</td>
      <td>53</td>
      <td>2</td>
      <td>91</td>
      <td>9</td>
    </tr>
    <tr>
      <th>male</th>
      <td>79</td>
      <td>4</td>
      <td>13</td>
      <td>4</td>
      <td>47</td>
      <td>3</td>
      <td>94</td>
      <td>12</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>65</td>
      <td>6</td>
      <td>14</td>
      <td>1</td>
      <td>55</td>
      <td>4</td>
      <td>99</td>
      <td>13</td>
    </tr>
    <tr>
      <th>male</th>
      <td>67</td>
      <td>17</td>
      <td>11</td>
      <td>3</td>
      <td>47</td>
      <td>3</td>
      <td>89</td>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>89</td>
      <td>13</td>
      <td>18</td>
      <td>3</td>
      <td>77</td>
      <td>7</td>
      <td>138</td>
      <td>12</td>
    </tr>
    <tr>
      <th>male</th>
      <td>68</td>
      <td>12</td>
      <td>17</td>
      <td>1</td>
      <td>80</td>
      <td>8</td>
      <td>135</td>
      <td>22</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Age</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
    </tr>
  </tbody>
</table>
</div>

<p>Notice how we didn&rsquo;t specify the <code>Age</code> feature. Pandas automatically outputs results for which the <code>mean</code> function makes sense. Here only Age fits the bill.</p>

<p>Like with any dataframe, you can also use <code>apply</code> to map a function to the grouped data, however, for anything more complex, like applying multiple functions at once, the <code>agg</code> method is more convenient.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>58.101883</td>
      <td>19.587278</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.531773</td>
      <td>19.394326</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>25</td>
      <td>91</td>
      <td>59.207469</td>
      <td>19.041143</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>56.768340</td>
      <td>19.961407</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.315217</td>
      <td>19.527343</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.953704</td>
      <td>19.490896</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.300493</td>
      <td>19.116494</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>90</td>
      <td>55.893401</td>
      <td>18.838508</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>55.823770</td>
      <td>19.546233</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.398438</td>
      <td>18.570202</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.284047</td>
      <td>20.168651</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>58.222222</td>
      <td>18.856132</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.299720</td>
      <td>19.167134</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.536443</td>
      <td>19.434197</td>
    </tr>
  </tbody>
</table>
</div>

<p><h4> For descriptive statistics of numerical data, the <code>quantile</code> function is also useful.</h4>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>The 0.5 quantile is the <b>median</b> of our data.</p>
</div></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">((</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">))</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>0.1</th>
      <th>0.25</th>
      <th>0.5</th>
      <th>0.75</th>
      <th>0.9</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>31.0</td>
      <td>41.00</td>
      <td>58.0</td>
      <td>75.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.0</td>
      <td>41.00</td>
      <td>58.0</td>
      <td>74.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>31.0</td>
      <td>44.00</td>
      <td>61.0</td>
      <td>76.00</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.0</td>
      <td>37.00</td>
      <td>57.0</td>
      <td>75.00</td>
      <td>83.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>32.1</td>
      <td>40.75</td>
      <td>59.0</td>
      <td>74.00</td>
      <td>83.9</td>
    </tr>
    <tr>
      <th>male</th>
      <td>32.0</td>
      <td>42.00</td>
      <td>56.5</td>
      <td>74.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31.0</td>
      <td>41.00</td>
      <td>57.0</td>
      <td>73.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31.0</td>
      <td>39.00</td>
      <td>55.0</td>
      <td>71.00</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>29.3</td>
      <td>39.00</td>
      <td>54.0</td>
      <td>72.25</td>
      <td>83.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>32.0</td>
      <td>41.00</td>
      <td>58.0</td>
      <td>72.00</td>
      <td>83.5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>29.6</td>
      <td>39.00</td>
      <td>57.0</td>
      <td>75.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.2</td>
      <td>43.00</td>
      <td>59.0</td>
      <td>73.00</td>
      <td>83.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>31.0</td>
      <td>41.00</td>
      <td>57.0</td>
      <td>74.00</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.0</td>
      <td>40.50</td>
      <td>58.0</td>
      <td>74.00</td>
      <td>83.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>How can we use the <code>grouped_by_country_and_gender</code> object to output the number of people who were born
on a given month (numbered 1 to 12), for each country, and for each gender?</p>

<p><b>Hint:</b>
This can be done in one line using <code>apply</code> and <code>value_counts</code>, but you need to make sure you keep track of the type of object you are dealing with at each stage of the pipeline.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Method 1 - one liner </span>
<span class="p">(</span><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>83</td>
      <td>75</td>
      <td>70</td>
      <td>66</td>
      <td>71</td>
      <td>78</td>
      <td>90</td>
      <td>77</td>
      <td>70</td>
      <td>65</td>
      <td>73</td>
      <td>85</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>64</td>
      <td>74</td>
      <td>71</td>
      <td>74</td>
      <td>57</td>
      <td>77</td>
      <td>91</td>
      <td>80</td>
      <td>81</td>
      <td>81</td>
      <td>78</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>26</td>
      <td>15</td>
      <td>18</td>
      <td>13</td>
      <td>30</td>
      <td>22</td>
      <td>22</td>
      <td>19</td>
      <td>11</td>
      <td>21</td>
      <td>21</td>
      <td>23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>22</td>
      <td>15</td>
      <td>22</td>
      <td>28</td>
      <td>19</td>
      <td>22</td>
      <td>26</td>
      <td>23</td>
      <td>26</td>
      <td>22</td>
      <td>16</td>
      <td>18</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>7</td>
      <td>11</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>10</td>
      <td>10</td>
      <td>12</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>7</td>
      <td>11</td>
      <td>15</td>
      <td>2</td>
      <td>8</td>
      <td>9</td>
      <td>11</td>
      <td>6</td>
      <td>12</td>
      <td>10</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31</td>
      <td>34</td>
      <td>39</td>
      <td>33</td>
      <td>36</td>
      <td>28</td>
      <td>33</td>
      <td>36</td>
      <td>36</td>
      <td>37</td>
      <td>34</td>
      <td>29</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31</td>
      <td>28</td>
      <td>35</td>
      <td>41</td>
      <td>27</td>
      <td>28</td>
      <td>37</td>
      <td>33</td>
      <td>29</td>
      <td>33</td>
      <td>33</td>
      <td>39</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>18</td>
      <td>20</td>
      <td>19</td>
      <td>21</td>
      <td>22</td>
      <td>26</td>
      <td>26</td>
      <td>15</td>
      <td>14</td>
      <td>23</td>
      <td>23</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>22</td>
      <td>16</td>
      <td>22</td>
      <td>30</td>
      <td>19</td>
      <td>16</td>
      <td>25</td>
      <td>18</td>
      <td>25</td>
      <td>23</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>22</td>
      <td>14</td>
      <td>20</td>
      <td>31</td>
      <td>22</td>
      <td>19</td>
      <td>24</td>
      <td>34</td>
      <td>14</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>16</td>
      <td>22</td>
      <td>26</td>
      <td>20</td>
      <td>21</td>
      <td>23</td>
      <td>18</td>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>38</td>
      <td>32</td>
      <td>35</td>
      <td>24</td>
      <td>37</td>
      <td>25</td>
      <td>25</td>
      <td>25</td>
      <td>32</td>
      <td>31</td>
      <td>21</td>
      <td>32</td>
    </tr>
    <tr>
      <th>male</th>
      <td>44</td>
      <td>30</td>
      <td>23</td>
      <td>25</td>
      <td>23</td>
      <td>29</td>
      <td>31</td>
      <td>29</td>
      <td>26</td>
      <td>28</td>
      <td>26</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Method 2 - Starting from the original data</span>
<span class="c1"># create a month series first and use it to perform groupby</span>

<span class="n">months</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="p">(</span><span class="n">data</span>
   <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="n">months</span><span class="p">])[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>
   <span class="o">.</span><span class="n">count</span><span class="p">()</span>
   <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
   <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Birthday</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>83</td>
      <td>75</td>
      <td>70</td>
      <td>66</td>
      <td>71</td>
      <td>78</td>
      <td>90</td>
      <td>77</td>
      <td>70</td>
      <td>65</td>
      <td>73</td>
      <td>85</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>64</td>
      <td>74</td>
      <td>71</td>
      <td>74</td>
      <td>57</td>
      <td>77</td>
      <td>91</td>
      <td>80</td>
      <td>81</td>
      <td>81</td>
      <td>78</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>26</td>
      <td>15</td>
      <td>18</td>
      <td>13</td>
      <td>30</td>
      <td>22</td>
      <td>22</td>
      <td>19</td>
      <td>11</td>
      <td>21</td>
      <td>21</td>
      <td>23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>22</td>
      <td>15</td>
      <td>22</td>
      <td>28</td>
      <td>19</td>
      <td>22</td>
      <td>26</td>
      <td>23</td>
      <td>26</td>
      <td>22</td>
      <td>16</td>
      <td>18</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>7</td>
      <td>11</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>10</td>
      <td>10</td>
      <td>12</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>7</td>
      <td>11</td>
      <td>15</td>
      <td>2</td>
      <td>8</td>
      <td>9</td>
      <td>11</td>
      <td>6</td>
      <td>12</td>
      <td>10</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31</td>
      <td>34</td>
      <td>39</td>
      <td>33</td>
      <td>36</td>
      <td>28</td>
      <td>33</td>
      <td>36</td>
      <td>36</td>
      <td>37</td>
      <td>34</td>
      <td>29</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31</td>
      <td>28</td>
      <td>35</td>
      <td>41</td>
      <td>27</td>
      <td>28</td>
      <td>37</td>
      <td>33</td>
      <td>29</td>
      <td>33</td>
      <td>33</td>
      <td>39</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>18</td>
      <td>20</td>
      <td>19</td>
      <td>21</td>
      <td>22</td>
      <td>26</td>
      <td>26</td>
      <td>15</td>
      <td>14</td>
      <td>23</td>
      <td>23</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>22</td>
      <td>16</td>
      <td>22</td>
      <td>30</td>
      <td>19</td>
      <td>16</td>
      <td>25</td>
      <td>18</td>
      <td>25</td>
      <td>23</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>22</td>
      <td>14</td>
      <td>20</td>
      <td>31</td>
      <td>22</td>
      <td>19</td>
      <td>24</td>
      <td>34</td>
      <td>14</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>16</td>
      <td>22</td>
      <td>26</td>
      <td>20</td>
      <td>21</td>
      <td>23</td>
      <td>18</td>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>38</td>
      <td>32</td>
      <td>35</td>
      <td>24</td>
      <td>37</td>
      <td>25</td>
      <td>25</td>
      <td>25</td>
      <td>32</td>
      <td>31</td>
      <td>21</td>
      <td>32</td>
    </tr>
    <tr>
      <th>male</th>
      <td>44</td>
      <td>30</td>
      <td>23</td>
      <td>25</td>
      <td>23</td>
      <td>29</td>
      <td>31</td>
      <td>29</td>
      <td>26</td>
      <td>28</td>
      <td>26</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Note that although we&#39;ve used &#39;Age&#39; here, any feature would have done. </span>
<span class="c1"># Do you see why?</span>

<span class="c1"># Method 3 - Starting from the original data and assign a new month column</span>
<span class="p">(</span><span class="n">data</span>
   <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
   <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>
   <span class="o">.</span><span class="n">count</span><span class="p">()</span>
   <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
   <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>month</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>83</td>
      <td>75</td>
      <td>70</td>
      <td>66</td>
      <td>71</td>
      <td>78</td>
      <td>90</td>
      <td>77</td>
      <td>70</td>
      <td>65</td>
      <td>73</td>
      <td>85</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>64</td>
      <td>74</td>
      <td>71</td>
      <td>74</td>
      <td>57</td>
      <td>77</td>
      <td>91</td>
      <td>80</td>
      <td>81</td>
      <td>81</td>
      <td>78</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>26</td>
      <td>15</td>
      <td>18</td>
      <td>13</td>
      <td>30</td>
      <td>22</td>
      <td>22</td>
      <td>19</td>
      <td>11</td>
      <td>21</td>
      <td>21</td>
      <td>23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>22</td>
      <td>15</td>
      <td>22</td>
      <td>28</td>
      <td>19</td>
      <td>22</td>
      <td>26</td>
      <td>23</td>
      <td>26</td>
      <td>22</td>
      <td>16</td>
      <td>18</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>7</td>
      <td>11</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>10</td>
      <td>10</td>
      <td>12</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>7</td>
      <td>11</td>
      <td>15</td>
      <td>2</td>
      <td>8</td>
      <td>9</td>
      <td>11</td>
      <td>6</td>
      <td>12</td>
      <td>10</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31</td>
      <td>34</td>
      <td>39</td>
      <td>33</td>
      <td>36</td>
      <td>28</td>
      <td>33</td>
      <td>36</td>
      <td>36</td>
      <td>37</td>
      <td>34</td>
      <td>29</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31</td>
      <td>28</td>
      <td>35</td>
      <td>41</td>
      <td>27</td>
      <td>28</td>
      <td>37</td>
      <td>33</td>
      <td>29</td>
      <td>33</td>
      <td>33</td>
      <td>39</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>18</td>
      <td>20</td>
      <td>19</td>
      <td>21</td>
      <td>22</td>
      <td>26</td>
      <td>26</td>
      <td>15</td>
      <td>14</td>
      <td>23</td>
      <td>23</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>22</td>
      <td>16</td>
      <td>22</td>
      <td>30</td>
      <td>19</td>
      <td>16</td>
      <td>25</td>
      <td>18</td>
      <td>25</td>
      <td>23</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>22</td>
      <td>14</td>
      <td>20</td>
      <td>31</td>
      <td>22</td>
      <td>19</td>
      <td>24</td>
      <td>34</td>
      <td>14</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>16</td>
      <td>22</td>
      <td>26</td>
      <td>20</td>
      <td>21</td>
      <td>23</td>
      <td>18</td>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>38</td>
      <td>32</td>
      <td>35</td>
      <td>24</td>
      <td>37</td>
      <td>25</td>
      <td>25</td>
      <td>25</td>
      <td>32</td>
      <td>31</td>
      <td>21</td>
      <td>32</td>
    </tr>
    <tr>
      <th>male</th>
      <td>44</td>
      <td>30</td>
      <td>23</td>
      <td>25</td>
      <td>23</td>
      <td>29</td>
      <td>31</td>
      <td>29</td>
      <td>26</td>
      <td>28</td>
      <td>26</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>D. MultiIndex.</font></center></h3>

<p><h4> We can of course group the data by more than 2 features.</h4>
However, results might get a bit harder to take in.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;Gender&#39;</span><span class="p">,</span><span class="s1">&#39;BloodType&#39;</span><span class="p">])[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">s</span></code></pre></div><div class="highlight"><pre class="chroma">Country         Gender  BloodType
Australia       female  A+           59.36
                        A-           59.90
                        AB+          53.13
                        AB-          61.50
                        B+           56.62
                        B-           66.00
                        O+           58.46
                        O-           58.02
                male    A+           57.67
                        A-           51.70
                        AB+          59.98
                        AB-          62.00
                        B+           58.79
                        B-           44.73
                        O+           56.94
                        O-           59.76
France          female  A+           58.54
                        A-           53.09
                        AB+          63.40
                        B+           58.47
                        B-           61.50
                        O+           60.18
                        O-           61.06
                male    A+           60.81
                        A-           56.00
                        AB+          62.78
                        AB-          41.00
                        B+           55.03
                        B-           67.00
                        O+           53.90
                                     ...  
United Kingdom  female  AB+          49.79
                        AB-          63.00
                        B+           55.33
                        B-           65.50
                        O+           57.16
                        O-           63.23
                male    A+           57.39
                        A-           60.41
                        AB+          53.91
                        AB-          65.33
                        B+           59.68
                        B-           32.67
                        O+           58.37
                        O-           64.83
United States   female  A+           57.46
                        A-           71.54
                        AB+          58.44
                        AB-          53.67
                        B+           55.75
                        B-           65.57
                        O+           57.57
                        O-           41.83
                male    A+           55.07
                        A-           47.08
                        AB+          55.12
                        AB-          66.00
                        B+           54.34
                        B-           71.25
                        O+           61.33
                        O-           55.73
Name: Age, Length: 109, dtype: float64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p><code>s</code> is a Pandas <code>Series</code> object with a <code>MultiIndex</code> object as its index.
</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">index</span></code></pre></div><div class="highlight"><pre class="chroma">MultiIndex(levels=[[&#39;Australia&#39;, &#39;France&#39;, &#39;Iceland&#39;, &#39;Italy&#39;, &#39;New Zealand&#39;, &#39;United Kingdom&#39;, &#39;United States&#39;], [&#39;female&#39;, &#39;male&#39;], [&#39;A+&#39;, &#39;A-&#39;, &#39;AB+&#39;, &#39;AB-&#39;, &#39;B+&#39;, &#39;B-&#39;, &#39;O+&#39;, &#39;O-&#39;]],
           codes=[[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6], [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1], [0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 4, 5, 6, 7, 0, 1, 2, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7]],
           names=[&#39;Country&#39;, &#39;Gender&#39;, &#39;BloodType&#39;])</pre></div>
<p>We can convert the MultiIndexed series to a MultiIndexed dataframe using unstack.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.67</td>
      <td>51.70</td>
      <td>59.98</td>
      <td>62.00</td>
      <td>58.79</td>
      <td>44.73</td>
      <td>56.94</td>
      <td>59.76</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>0.00</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>male</th>
      <td>60.81</td>
      <td>56.00</td>
      <td>62.78</td>
      <td>41.00</td>
      <td>55.03</td>
      <td>67.00</td>
      <td>53.90</td>
      <td>65.62</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>0.00</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>male</th>
      <td>62.09</td>
      <td>35.00</td>
      <td>57.00</td>
      <td>0.00</td>
      <td>59.37</td>
      <td>74.00</td>
      <td>55.13</td>
      <td>81.00</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>male</th>
      <td>54.45</td>
      <td>54.47</td>
      <td>62.60</td>
      <td>44.75</td>
      <td>54.82</td>
      <td>66.00</td>
      <td>57.32</td>
      <td>55.47</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>male</th>
      <td>60.39</td>
      <td>74.75</td>
      <td>65.08</td>
      <td>64.00</td>
      <td>53.96</td>
      <td>52.33</td>
      <td>54.68</td>
      <td>57.42</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.39</td>
      <td>60.41</td>
      <td>53.91</td>
      <td>65.33</td>
      <td>59.68</td>
      <td>32.67</td>
      <td>58.37</td>
      <td>64.83</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.07</td>
      <td>47.08</td>
      <td>55.12</td>
      <td>66.00</td>
      <td>54.34</td>
      <td>71.25</td>
      <td>61.33</td>
      <td>55.73</td>
    </tr>
  </tbody>
</table>
</div>

<p>To access specific data using the MultiIndex for a <strong>Series</strong>, you can use the <code>xs</code> method and specify the level at which you are extracting the data, if you are not using the top level.</p>

<p>To access specific data using the MultiIndex for a <strong>DataFrame</strong>, you can use the <code>loc</code> method, but specifying the level is a bit more involved.</p>

<h4 id="top-level-selection">Top level selection</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">Gender  BloodType
female  A+           59.36
        A-           59.90
        AB+          53.13
        AB-          61.50
        B+           56.62
        B-           66.00
        O+           58.46
        O-           58.02
male    A+           57.67
        A-           51.70
        AB+          59.98
        AB-          62.00
        B+           58.79
        B-           44.73
        O+           56.94
        O-           59.76
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="p">:]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>59.36</td>
      <td>59.9</td>
      <td>53.13</td>
      <td>61.5</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.67</td>
      <td>51.7</td>
      <td>59.98</td>
      <td>62.0</td>
      <td>58.79</td>
      <td>44.73</td>
      <td>56.94</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is equivalent to:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>59.36</td>
      <td>59.9</td>
      <td>53.13</td>
      <td>61.5</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.67</td>
      <td>51.7</td>
      <td>59.98</td>
      <td>62.0</td>
      <td>58.79</td>
      <td>44.73</td>
      <td>56.94</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>

<p>The levels can be exchanged either by unstacking the right level, or by transposing the resulting dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>BloodType</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>59.36</td>
      <td>57.67</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.90</td>
      <td>51.70</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>53.13</td>
      <td>59.98</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>61.50</td>
      <td>62.00</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>56.62</td>
      <td>58.79</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>66.00</td>
      <td>44.73</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>58.02</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">T</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>BloodType</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>59.36</td>
      <td>57.67</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.90</td>
      <td>51.70</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>53.13</td>
      <td>59.98</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>61.50</td>
      <td>62.00</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>56.62</td>
      <td>58.79</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>66.00</td>
      <td>44.73</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>58.02</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="to-select-data-at-a-deeper-level-of-the-multiindex-you-need-to-specify-the-level">To select data at a deeper level of the multiindex, you need to  specify the level.</h4>

<h4 id="here-s-an-example-with-gender">Here&rsquo;s an example with Gender.</h4>

<p>Notice the different syntax using <code>xs</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>France</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>NaN</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>NaN</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="selecting-the-data-from-a-deeper-level-is-trickier-with-a-dataframe">Selecting the data from a deeper level is trickier with a dataframe.</h4>

<h4 id="we-need-to-specify-an-index-slice">We need to specify an index <code>slice</code>.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="s1">&#39;female&#39;</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>France</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>0.00</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>0.00</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
  </tbody>
</table>
</div>

<p>or alternatively, using a pandas <code>IndexSlice</code> object.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span> <span class="s1">&#39;female&#39;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>France</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>0.00</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>0.00</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="same-if-you-want-to-select-bloodtype-as-the-level">Same if you want to select <code>BloodType</code> as the level.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;O+&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;BloodType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>France</th>
      <td>60.18</td>
      <td>53.90</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>53.15</td>
      <td>55.13</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>57.96</td>
      <td>57.32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>53.22</td>
      <td>54.68</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>57.16</td>
      <td>58.37</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.57</td>
      <td>61.33</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;O+&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;BloodType&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>France</th>
      <td>60.18</td>
      <td>53.90</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>53.15</td>
      <td>55.13</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>57.96</td>
      <td>57.32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>53.22</td>
      <td>54.68</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>57.16</td>
      <td>58.37</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.57</td>
      <td>61.33</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="multiple-levels-can-be-specified-at-once">Multiple levels can be specified at once</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span><span class="s1">&#39;female&#39;</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;Gender&#39;</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">BloodType
A+     59.36
A-     59.90
AB+    53.13
AB-    61.50
B+     56.62
B-     66.00
O+     58.46
O-     58.02
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">),</span> <span class="p">:]</span></code></pre></div><div class="highlight"><pre class="chroma">BloodType
A+     59.36
A-     59.90
AB+    53.13
AB-    61.50
B+     56.62
B-     66.00
O+     58.46
O-     58.02
Name: (Australia, female), dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span><span class="s1">&#39;O+&#39;</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;BloodType&#39;</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">Gender
female    58.46
male      56.94
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;O+&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">Gender
female    58.46
male      56.94
Name: O+, dtype: float64</pre></div>
<h3 id="let-s-visualise-some-of-these-results">Let&rsquo;s visualise some of these results</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># colormap from matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="c1"># Also see this stackoverflow post for the legend placement: </span>
<span class="c1"># http://stackoverflow.com/questions/23556153/how-to-put-legend-outside-the-plot-with-pandas</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
       <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> 
             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> 
             <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
             <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired_r</span><span class="p">)</span>
     <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_105_0.png" alt="png" /></p>

<h4 id="notice-the-difference-between-the-previous-plot-and-the-one-below">Notice the difference between the previous plot and the one below.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> 
             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> 
             <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
             <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired_r</span><span class="p">)</span>
     <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_107_0.png" alt="png" /></p>

<h3> <center><font color=MediumVioletRed>E. Fine Tuning.</font></center></h3>

<p>So far we&rsquo;ve applied an operation on a <b>single feature</b> of a GroupBy object.</p>

<p>For instance, we&rsquo;ve computed the mean for the <code>Age</code> feature, and then, <b>in a separate computation</b> we&rsquo;ve computed
a count of the blood types.</p>

<p>You can actually do everything at once by specifying <b>a different operation for each feature</b> using a dictionary,
and use the <code>agg</code> method to aggregate the data across the dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">data_count</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

<span class="n">method</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">],</span> <span class="s1">&#39;BloodType&#39;</span><span class="p">:</span> <span class="n">data_count</span><span class="p">}</span>

<span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;data_count&#39;</span><span class="p">:</span><span class="s1">&#39;group_counts&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Age</th>
      <th>BloodType</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>group_counts</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
      <td>19.587278</td>
      <td>((B+, 205), (O-, 41), (AB+, 54), (O+, 328), (A...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
      <td>19.394326</td>
      <td>((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
      <td>19.041143</td>
      <td>((A-, 11), (B+, 47), (A+, 76), (O+, 79), (O-, ...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
      <td>19.961407</td>
      <td>((B+, 59), (A+, 69), (AB+, 9), (O+, 105), (O-,...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
      <td>19.527343</td>
      <td>((O+, 34), (A+, 22), (B-, 4), (B+, 17), (A-, 5...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
      <td>19.490896</td>
      <td>((O+, 52), (A+, 23), (AB+, 3), (B+, 27), (O-, ...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
      <td>19.116494</td>
      <td>((A+, 102), (O+, 160), (B+, 89), (O-, 17), (AB...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
      <td>18.838508</td>
      <td>((A+, 105), (O+, 139), (B+, 96), (AB-, 4), (B-...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
      <td>19.546233</td>
      <td>((O-, 9), (O+, 91), (A+, 75), (AB+, 8), (B+, 5...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
      <td>18.570202</td>
      <td>((A+, 79), (O+, 94), (AB+, 13), (B+, 47), (O-,...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
      <td>20.168651</td>
      <td>((A+, 65), (B+, 55), (O-, 13), (O+, 99), (AB+,...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
      <td>18.856132</td>
      <td>((A+, 67), (B+, 47), (O-, 6), (A-, 17), (O+, 8...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
      <td>19.167134</td>
      <td>((A+, 89), (B+, 77), (O+, 138), (AB+, 18), (A-...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
      <td>19.434197</td>
      <td>((A+, 68), (O+, 135), (B+, 80), (A-, 12), (AB+...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="accessing-a-particular-portion-of-the-result-is-just-a-matter-of-navigating-the-multilevel-structure-of-the-index-and-the-columns">Accessing a particular portion of the result is just a matter of navigating the multilevel structure of the index and the columns.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[[(</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">)]]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Age</th>
      <th>BloodType</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>data_count</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <th>male</th>
      <td>57.531773</td>
      <td>19.394326</td>
      <td>((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is equivalent to</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Age</th>
      <th>BloodType</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>data_count</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <th>male</th>
      <td>57.531773</td>
      <td>19.394326</td>
      <td>((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="notice-the-difference-with">Notice the difference with</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">Age        mean                                                    57.5318
           std                                                     19.3943
BloodType  data_count    ((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...
Name: (Australia, male), dtype: object</pre></div>
<h4 id="we-can-select-data-using-levels-of-the-columns">We can select data using levels of the columns.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)]]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>Age</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is equivalent to</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">([(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>Age</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="you-can-go-as-deep-as-you-need">You can go as &ldquo;deep&rdquo; as you need.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">58.10188261351052</pre></div>
<p>This is equivalent to</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">))[</span><span class="s1">&#39;Age&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">58.10188261351052</pre></div>
<h4 id="to-extract-just-the-values-without-the-index-use-the-values-attribute">To extract just the values (without the index), use the <code>values</code> attribute.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span></code></pre></div><div class="highlight"><pre class="chroma">array([dict_items([(&#39;B+&#39;, 205), (&#39;O-&#39;, 41), (&#39;AB+&#39;, 54), (&#39;O+&#39;, 328), (&#39;A+&#39;, 229), (&#39;A-&#39;, 29), (&#39;B-&#39;, 13), (&#39;AB-&#39;, 4)])],
      dtype=object)</pre></div>
<h4 id="cross-tabulation-is-an-effective-way-to-have-a-quick-look-at-how-the-data-is-distributed-across-categories">Cross-tabulation is an effective way to have a quick look at how the data is distributed across categories.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Gender</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">BloodType</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
      <th>All</th>
    </tr>
    <tr>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>658</td>
      <td>83</td>
      <td>128</td>
      <td>10</td>
      <td>543</td>
      <td>33</td>
      <td>929</td>
      <td>116</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>male</th>
      <td>650</td>
      <td>87</td>
      <td>114</td>
      <td>17</td>
      <td>570</td>
      <td>31</td>
      <td>934</td>
      <td>97</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>All</th>
      <td>1308</td>
      <td>170</td>
      <td>242</td>
      <td>27</td>
      <td>1113</td>
      <td>64</td>
      <td>1863</td>
      <td>213</td>
      <td>5000</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">Country</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Gender</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">BloodType</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
      <th>All</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>229</td>
      <td>29</td>
      <td>54</td>
      <td>4</td>
      <td>205</td>
      <td>13</td>
      <td>328</td>
      <td>41</td>
      <td>903</td>
    </tr>
    <tr>
      <th>male</th>
      <td>239</td>
      <td>30</td>
      <td>46</td>
      <td>4</td>
      <td>214</td>
      <td>11</td>
      <td>320</td>
      <td>33</td>
      <td>897</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>76</td>
      <td>11</td>
      <td>10</td>
      <td>0</td>
      <td>47</td>
      <td>2</td>
      <td>79</td>
      <td>16</td>
      <td>241</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>6</td>
      <td>9</td>
      <td>1</td>
      <td>59</td>
      <td>2</td>
      <td>105</td>
      <td>8</td>
      <td>259</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>22</td>
      <td>5</td>
      <td>2</td>
      <td>0</td>
      <td>17</td>
      <td>4</td>
      <td>34</td>
      <td>8</td>
      <td>92</td>
    </tr>
    <tr>
      <th>male</th>
      <td>23</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>27</td>
      <td>1</td>
      <td>52</td>
      <td>1</td>
      <td>108</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>102</td>
      <td>14</td>
      <td>22</td>
      <td>1</td>
      <td>89</td>
      <td>1</td>
      <td>160</td>
      <td>17</td>
      <td>406</td>
    </tr>
    <tr>
      <th>male</th>
      <td>105</td>
      <td>17</td>
      <td>15</td>
      <td>4</td>
      <td>96</td>
      <td>3</td>
      <td>139</td>
      <td>15</td>
      <td>394</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>75</td>
      <td>5</td>
      <td>8</td>
      <td>1</td>
      <td>53</td>
      <td>2</td>
      <td>91</td>
      <td>9</td>
      <td>244</td>
    </tr>
    <tr>
      <th>male</th>
      <td>79</td>
      <td>4</td>
      <td>13</td>
      <td>4</td>
      <td>47</td>
      <td>3</td>
      <td>94</td>
      <td>12</td>
      <td>256</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>65</td>
      <td>6</td>
      <td>14</td>
      <td>1</td>
      <td>55</td>
      <td>4</td>
      <td>99</td>
      <td>13</td>
      <td>257</td>
    </tr>
    <tr>
      <th>male</th>
      <td>67</td>
      <td>17</td>
      <td>11</td>
      <td>3</td>
      <td>47</td>
      <td>3</td>
      <td>89</td>
      <td>6</td>
      <td>243</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>89</td>
      <td>13</td>
      <td>18</td>
      <td>3</td>
      <td>77</td>
      <td>7</td>
      <td>138</td>
      <td>12</td>
      <td>357</td>
    </tr>
    <tr>
      <th>male</th>
      <td>68</td>
      <td>12</td>
      <td>17</td>
      <td>1</td>
      <td>80</td>
      <td>8</td>
      <td>135</td>
      <td>22</td>
      <td>343</td>
    </tr>
    <tr>
      <th>All</th>
      <th></th>
      <td>1308</td>
      <td>170</td>
      <td>242</td>
      <td>27</td>
      <td>1113</td>
      <td>64</td>
      <td>1863</td>
      <td>213</td>
      <td>5000</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>F. GroupBy on continuous features.</font></center></h3>

<p>We&rsquo;ve seen how we can group the data according to the features that are in the original dataset.</p>

<p>For instance, grouping the data by country is trivial. Same for the blood type because these are <b>categorical</b> data.</p>

<p>But what about <code>Age</code>? If we do a <code>groupby</code> without thinking too much about it we get something rather useless.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">g</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">       Age
count  24     37
       25     72
       26     73
       27     86
       28     69
       29     81
       30     71
       31     86
       32     73
       33     78
       34     54
       35     79
       36     70
       37     88
       38     70
       39     81
       40     62
       41     75
       42     66
       43     70
       44     67
       45     80
       46     85
       47     65
       48     77
       49     88
       50     77
       51     75
       52     83
       53     86
              ..
freq   62     28
       63     41
       64     26
       65     26
       66     38
       67     28
       68     35
       69     36
       70     25
       71     25
       72     39
       73     21
       74     32
       75     39
       76     21
       77     20
       78     33
       79     32
       80     30
       81     21
       82     34
       83     27
       84     25
       85     25
       86     28
       87     32
       88     23
       89     30
       90     24
       91     18
Length: 272, dtype: object</pre></div>
<p>We get one entry for each year of <code>Age</code> which isn&rsquo;t what we want.</p>

<p>Ideally, we&rsquo;d want to split the data into age groups and use that to group the data. Pandas has a <code>cut</code> function that allows us to do that.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">count    5000.000000
mean       57.447600
std        19.339422
min        24.000000
25%        41.000000
50%        57.000000
75%        74.000000
max        91.000000
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">bins</span></code></pre></div><div class="highlight"><pre class="chroma">array([20, 30, 40, 50, 60, 70, 80, 90])</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Age</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
<span class="n">labels</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">0    (50, 60]
1    (50, 60]
2    (50, 60]
3    (80, 90]
4    (70, 80]
Name: Age, dtype: category
Categories (7, interval[int64]): [(20, 30] &lt; (30, 40] &lt; (40, 50] &lt; (50, 60] &lt; (60, 70] &lt; (70, 80] &lt; (80, 90]]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0    51
1    57
2    55
3    86
4    73
Name: Age, dtype: int64</pre></div>
<h4 id="we-can-use-the-newly-created-label-to-partition-the-age-variable-into-intervals">We can use the newly created label to partition the Age variable into intervals.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>

<span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Age             (20, 30]  (30, 40]  (40, 50]  (50, 60]  (60, 70]  (70, 80]  \
Country                                                                      
Australia            177       254       269       275       257       280   
France                48        76        68        71        75        76   
Iceland               16        32        36        24        30        26   
Italy                 74       131       120       134       128        96   
New Zealand           49        76        81        70        93        57   
United Kingdom        54        69        77        64        72        91   
United States         71       103        99       111       102       115   

Age             (80, 90]  
Country                   
Australia            272  
France                82  
Iceland               34  
Italy                111  
New Zealand           71  
United Kingdom        69  
United States         94  </pre></div>
<p>If we want the <code>Age</code> groups to be our index we can use <code>unstack(0)</code> or much the more explicit and therefore better, <code>unstack('Country')</code> .</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Country</th>
      <th>Australia</th>
      <th>France</th>
      <th>Iceland</th>
      <th>Italy</th>
      <th>New Zealand</th>
      <th>United Kingdom</th>
      <th>United States</th>
    </tr>
    <tr>
      <th>Age</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(20, 30]</th>
      <td>177</td>
      <td>48</td>
      <td>16</td>
      <td>74</td>
      <td>49</td>
      <td>54</td>
      <td>71</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>254</td>
      <td>76</td>
      <td>32</td>
      <td>131</td>
      <td>76</td>
      <td>69</td>
      <td>103</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>269</td>
      <td>68</td>
      <td>36</td>
      <td>120</td>
      <td>81</td>
      <td>77</td>
      <td>99</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>275</td>
      <td>71</td>
      <td>24</td>
      <td>134</td>
      <td>70</td>
      <td>64</td>
      <td>111</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>257</td>
      <td>75</td>
      <td>30</td>
      <td>128</td>
      <td>93</td>
      <td>72</td>
      <td>102</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>280</td>
      <td>76</td>
      <td>26</td>
      <td>96</td>
      <td>57</td>
      <td>91</td>
      <td>115</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>272</td>
      <td>82</td>
      <td>34</td>
      <td>111</td>
      <td>71</td>
      <td>69</td>
      <td>94</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="just-like-before-we-can-pass-more-features-to-the-groupby-method">Just like before, we can pass more features to the <code>groupby</code> method.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;BloodType&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>
<span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;BloodType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Age</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="7" valign="top">Australia</th>
      <th>(20, 30]</th>
      <td>41.0</td>
      <td>11.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>49.0</td>
      <td>3.0</td>
      <td>53.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>63.0</td>
      <td>8.0</td>
      <td>14.0</td>
      <td>2.0</td>
      <td>57.0</td>
      <td>4.0</td>
      <td>97.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>73.0</td>
      <td>9.0</td>
      <td>16.0</td>
      <td>2.0</td>
      <td>56.0</td>
      <td>2.0</td>
      <td>100.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>74.0</td>
      <td>5.0</td>
      <td>16.0</td>
      <td>0.0</td>
      <td>67.0</td>
      <td>2.0</td>
      <td>100.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>60.0</td>
      <td>7.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>55.0</td>
      <td>8.0</td>
      <td>106.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>85.0</td>
      <td>7.0</td>
      <td>15.0</td>
      <td>1.0</td>
      <td>57.0</td>
      <td>4.0</td>
      <td>101.0</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>65.0</td>
      <td>11.0</td>
      <td>16.0</td>
      <td>3.0</td>
      <td>77.0</td>
      <td>1.0</td>
      <td>84.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">France</th>
      <th>(20, 30]</th>
      <td>17.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>19.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>17.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>28.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>17.0</td>
      <td>3.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>12.0</td>
      <td>0.0</td>
      <td>27.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>18.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>2.0</td>
      <td>32.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>23.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>25.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>22.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>30.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>17.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">Iceland</th>
      <th>(20, 30]</th>
      <td>4.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>7.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>15.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>5.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>17.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>8.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>5.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>12.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>7.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>3.0</td>
      <td>9.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>9.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">Italy</th>
      <th>(20, 30]</th>
      <td>19.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>23.0</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>39.0</td>
      <td>8.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>0.0</td>
      <td>45.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>36.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>40.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>27.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>32.0</td>
      <td>1.0</td>
      <td>62.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>33.0</td>
      <td>2.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>52.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>33.0</td>
      <td>4.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>29.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>19.0</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>25.0</td>
      <td>1.0</td>
      <td>47.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">New Zealand</th>
      <th>(20, 30]</th>
      <td>13.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>22.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>19.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>17.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>39.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>24.0</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>33.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>1.0</td>
      <td>21.0</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>24.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>23.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>15.0</td>
      <td>0.0</td>
      <td>21.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">United Kingdom</th>
      <th>(20, 30]</th>
      <td>12.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>21.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>21.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>13.0</td>
      <td>3.0</td>
      <td>23.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>22.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>0.0</td>
      <td>31.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>14.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>15.0</td>
      <td>7.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>11.0</td>
      <td>0.0</td>
      <td>31.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>28.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>1.0</td>
      <td>28.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>19.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">United States</th>
      <th>(20, 30]</th>
      <td>21.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>16.0</td>
      <td>1.0</td>
      <td>21.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>21.0</td>
      <td>1.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>1.0</td>
      <td>41.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>23.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>30.0</td>
      <td>1.0</td>
      <td>31.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>27.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>25.0</td>
      <td>1.0</td>
      <td>40.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>17.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>2.0</td>
      <td>26.0</td>
      <td>2.0</td>
      <td>39.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>22.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>5.0</td>
      <td>61.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>24.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>15.0</td>
      <td>3.0</td>
      <td>39.0</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>The End&hellip;</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/pandas/">pandas</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/groupby/">groupby</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/data-wrangling/">data wrangling</a>&nbsp;
                  
                </div>
              

            </article>
          
        </div>
        
      </div>
    </div>
  </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:dinkumdata@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/adelr" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/DinkumData" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="/tags/pandas/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Adel Rahmani
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2019
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://adelr.github.io/">Dinkum Data Blog</a>
          
          &nbsp;&bull;&nbsp;
          The text is released under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative
            Commons Attribution 4.0 International License</a>, and the code is released under the <a
            href="https://opensource.org/licenses/MIT">MIT license</a>
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.55.5</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://adelr.github.io/js/main.js"></script>
<script src="https://adelr.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://adelr.github.io/js/load-photoswipe.js"></script>









  </body>
</html>

