<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Overview of all pages with the tag #python - Dinkum Data Blog</title>
  <meta property="og:title" content="Overview of all pages with the tag #python" />
  <meta name="twitter:title" content="Overview of all pages with the tag #python" />
  <meta name="description" content="Overview of all pages with the tag #python, such as: Polyglot Data Wrangling">
  <meta property="og:description" content="Overview of all pages with the tag #python, such as: Polyglot Data Wrangling">
  <meta name="twitter:description" content="Overview of all pages with the tag #python, such as: Polyglot Data Wrangling">
  <meta name="author" content="Adel Rahmani"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Dinkum Data Blog",
    
    "url": "https:\/\/adelr.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/adelr.github.io\/"
  
  
  
  
}
</script>

<meta property="og:title" content="python" />
<meta property="og:image" content="https://adelr.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://adelr.github.io/tags/python/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Dinkum Data Blog" />

  <meta name="twitter:title" content="python" />
  <meta name="twitter:image" content="https://adelr.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@DinkumData" />
  <meta name="twitter:creator" content="@DinkumData" />
  <meta property="og:image" content="https://adelr.github.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://adelr.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@DinkumData" />
  <meta name="twitter:creator" content="@DinkumData" />
  <meta property="og:url" content="https://adelr.github.io/tags/python/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Dinkum Data Blog" />

  <meta name="generator" content="Hugo 0.55.5" />
  <link rel="alternate" href="https://adelr.github.io/index.xml" type="application/rss+xml" title="Dinkum Data Blog"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://adelr.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://adelr.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://adelr.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-96102728-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://adelr.github.io/">Dinkum Data Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Dinkum Data Blog" href="https://adelr.github.io/">
            <img class="avatar-img" src="https://adelr.github.io/img/avatar-icon.png" alt="Dinkum Data Blog" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="tags-heading">
              
                <h1>python</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
  <div class="container" role="main">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        <div class="posts-list">
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2019/03/polyglot_wrangling/">
                <h2 class="post-title">Polyglot Data Wrangling</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on March 28, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;40&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;8477&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<h1 id="sql-vs-python-vs-r">SQL vs Python vs R</h1>

<p>In this post we will look a how basic data wrangling operations can be performed in 3 languages
commonly used in data science:</p>

<ul>
<li>Structured Query Language (SQL)</li>
<li>Python</li>
<li>R
<br /></li>
</ul>

<p>Note that while Python and R have obvious similarities in their approach to data wrangling, SQL is designed to work with relational data, where most of the time consuming operations are (ideally) performed on the database side rather than
in the client&rsquo;s memory. Both Python and R can process data in chunks, or even work with huge, distributed data sets through libraries like <a href="https://docs.dask.org/en/latest/">Dask</a> (Python only) or <a href="https://spark.apache.org/">Apache Spark</a> (Python, R, Scala, Java).
However, we&rsquo;re mostly interested in illustrating some basic data wrangling pipelines in all three languages, so we&rsquo;ll be using a small database that can easily fit in memory.</p>

<p>The <a href="https://jupyter.org/">Jupyter notebook</a> allows us to run all our examples in one place.
We&rsquo;ll run an IPython kernel as our base platform and use an <a href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">IPython magic command</a> to run our R code within the same environment, and we&rsquo;ll use <a href="https://www.sqlalchemy.org/">sqlalchemy</a> to run queries on a postgreSQL data base.</p>

<p>We won&rsquo;t be covering the basics of each language in this post. There are many excellent resources online.
For data wrangling the <a href="https://jakevdp.github.io/PythonDataScienceHandbook/">Python Data Science Handbook</a> is an outstanding book. For R it&rsquo;s hard to get past the wonderful <a href="https://r4ds.had.co.nz/">R for Data Science</a> by Garrett Grolemund and Hadley Wickham. For SQL there are more resources than we can mention, especially once we factor in the various vendor-specific flavours of SQL. One of my personal favourites is <a href="https://www.packtpub.com/application-development/sql-fundamentals-business-intelligence-video">SQL Fundamentals for BI</a> by Jeffrey James.
Our SQL examples are based on some of the contents of that course.</p>

<p>We start by loading the Python required libraries (we&rsquo;ll do all our data wrangling using the awesome <a href="https://pandas.pydata.org/">pandas</a> module) and create a connection to the PostgreSQL database using sqlalchemy.
For our examples we&rsquo;ll be using the well-known <a href="http://www.postgresqltutorial.com/postgresql-sample-database/">dvdrental database</a> which contains 15 tables representing various aspects of a DVD rental business.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Connect to a SQL (PostgreSQL) database</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;postgres:///dvdrental&#39;</span>
<span class="n">con</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># Import pandas for data wrangling in python</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># use ipython magic command to load R into our environment.</span>
<span class="o">%</span><span class="n">load_ext</span> <span class="n">rpy2</span><span class="o">.</span><span class="n">ipython</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<p>All our R code will be preceded by <code>%%R</code> command to run it on the R interpreter from within our Jupyter notebook.
We start by loading the <a href="https://www.tidyverse.org/">tidyverse</a> library (which is in fact a collection of libraries),
and setting an option to improve how some outputs are rendered in the notebook.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
<span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kp">options</span><span class="p">(</span>crayon.enabled <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span></code></pre></div>
<p>Because we&rsquo;re running on top of an ipython kernel, we&rsquo;ll write our SQL queries as strings and use pandas to run them on our database via sqlalchemy.</p>

<hr />

<h2 id="the-data">The data</h2>

<p>First, let&rsquo;s see what tables are in our DVD rental database.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT * FROM pg_catalog.pg_tables;
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pg_&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">df</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sql_&#39;</span><span class="p">))]</span><span class="o">.</span><span class="n">tablename</span><span class="o">.</span><span class="n">values</span>
<span class="k">print</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;category&#39; &#39;country&#39; &#39;film_category&#39; &#39;language&#39; &#39;inventory&#39; &#39;actor&#39;
 &#39;staff&#39; &#39;payment&#39; &#39;rental&#39; &#39;store&#39; &#39;city&#39; &#39;film&#39; &#39;address&#39; &#39;film_actor&#39;
 &#39;customer&#39;]</pre></div>
<p>For convenience, let&rsquo;s create a python dictionary with all the tables as dataframes.</p>

<p>Obviously, this means that we&rsquo;re loading all the tables into memory, <strong>which is not what one would typically want to do with a SQL database</strong>, however, since our database is small, and we&rsquo;re only interested in comparing the wrangling syntax across different languages, this is fine for our purpose.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">tbl</span> <span class="o">=</span> <span class="p">{</span><span class="n">table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;SELECT * FROM {table};&#39;</span><span class="p">,</span> 
                                <span class="n">con</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_date&#39;</span><span class="p">])</span> 
       <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">}</span></code></pre></div>
<p>Let&rsquo;s look at a few rows of the payment table.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">payment</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;payment&#39;</span><span class="p">]</span>
<span class="n">payment</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17503</td>
      <td>341</td>
      <td>2</td>
      <td>1520</td>
      <td>7.99</td>
      <td>2007-02-15 22:25:46.996577</td>
    </tr>
    <tr>
      <th>1</th>
      <td>17504</td>
      <td>341</td>
      <td>1</td>
      <td>1778</td>
      <td>1.99</td>
      <td>2007-02-16 17:23:14.996577</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17505</td>
      <td>341</td>
      <td>1</td>
      <td>1849</td>
      <td>7.99</td>
      <td>2007-02-16 22:41:45.996577</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17506</td>
      <td>341</td>
      <td>2</td>
      <td>2829</td>
      <td>2.99</td>
      <td>2007-02-19 19:39:56.996577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17507</td>
      <td>341</td>
      <td>2</td>
      <td>3130</td>
      <td>7.99</td>
      <td>2007-02-20 17:31:48.996577</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can &ldquo;pass&rdquo; the <code>payment</code> dataframe to R in the following way:</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>i payment
<span class="kp">head</span><span class="p">(</span>payment<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">  payment_id customer_id staff_id rental_id amount        payment_date
0      17503         341        2      1520   7.99 2007-02-15 22:25:46
1      17504         341        1      1778   1.99 2007-02-16 17:23:14
2      17505         341        1      1849   7.99 2007-02-16 22:41:45
3      17506         341        2      2829   2.99 2007-02-19 19:39:56
4      17507         341        2      3130   7.99 2007-02-20 17:31:48
5      17508         341        1      3382   5.99 2007-02-21 12:33:49</pre></div>
<p>Now that we&rsquo;ve got all the tables loaded, let&rsquo;s run a few queries.</p>

<p>Let&rsquo;s start with something simple.</p>

<hr />

<h3 id="which-movie-rentals-were-below-a-dollar-for-customers-with-an-id-above-500">Which movie rentals were below a dollar for customers with an id above 500?</h3>

<h4 id="sql">▶ SQL</h4>

<p>The query is nothing fancy here. We&rsquo;re selecting a few features (columns) from the <code>payment</code> table,
filtering on the dollar amount and customer id before ordering the rows.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.payment_id, p.customer_id, p.amount 
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">WHERE 
</span><span class="s1">    p.amount &lt; 1 AND p.customer_id &gt; 500
</span><span class="s1">ORDER BY 1 ASC, 2 DESC, 3 ASC;
</span><span class="s1">&#39;&#39;&#39;</span>
<span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>     <span class="c1"># run the query on the database</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>                    <span class="c1"># output the shape of the resulting table</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>                          <span class="c1"># display the first few rows</span></code></pre></div><div class="highlight"><pre class="chroma">(413, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18121</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18122</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18125</td>
      <td>503</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18134</td>
      <td>506</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18144</td>
      <td>510</td>
      <td>0.99</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python">▶ Python</h4>

<p>Pandas allow us to chain methods on a dataframe, however, writing everything on a single line is cumbersome for long pipelines.</p>

<p>We can write each step of the pipeline on its own line by wrapping the pipeline in brackets.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span><span class="p">[(</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)]</span>  <span class="c1"># select rows based on conditions</span>
         <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;payment_id&#39;</span><span class="p">,</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">]]</span>            <span class="c1"># select 3 columns</span>
         <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">],</span>  <span class="c1"># sort the rows according to the values  </span>
                      <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">])</span>               <span class="c1">#      in the columns</span>
         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>                                   <span class="c1"># not really required but looks nicer</span>
        <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(413, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18121</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18122</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18125</td>
      <td>503</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18134</td>
      <td>506</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18144</td>
      <td>510</td>
      <td>0.99</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r">▶ R</h4>

<p>For this simple query the R code is similar to the Python one. The pipe symbol <code>%&gt;%</code> is equivalent to the dot symbol in pandas which allows us to chain methods together.</p>

<p>The <code>%%R -o df_r</code> part of the code is a way to transfer the R dataframe back to our Python interpreter.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>o df_r   
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>amount <span class="o">&lt;</span> <span class="m">1</span><span class="p">,</span> customer_id <span class="o">&gt;</span> <span class="m">500</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        select<span class="p">(</span>payment_id<span class="p">,</span> customer_id<span class="p">,</span> amount<span class="p">)</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>payment_id<span class="p">,</span> desc<span class="p">(</span>customer_id<span class="p">),</span> amount<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_r</span><span class="o">.</span><span class="n">shape</span>
<span class="n">df_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>18121</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18122</td>
      <td>502</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>2</th>
      <td>18125</td>
      <td>503</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18134</td>
      <td>506</td>
      <td>0.99</td>
    </tr>
    <tr>
      <th>4</th>
      <td>18144</td>
      <td>510</td>
      <td>0.99</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="sanity-check">Sanity check</h4>

<p>Just to make sure that we&rsquo;ve run our query correctly, we can compare the result from the SQL query with the results of the Python and R pipelines. Because of the fact that R indexing starts at 1 instead of 0, we need to reset the index of the R dataframe after we export it to Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">df_r</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">(True, True)</pre></div>
<p>Any other trivial query could be handled in a similar way&hellip;</p>

<p>Let&rsquo;s look at a query where we need to extract a feature that doesn&rsquo;t appear explicitly in the original data.</p>

<hr />

<h3 id="which-transactions-occured-in-the-month-of-march-only">Which transactions occured in the month of March only?</h3>

<p>The <code>payment</code> table has a <code>payment_date</code> feature from which we will need to extract the month.</p>

<h4 id="sql-1">▶  SQL</h4>

<p>We can extract the month value out of the <code>payment_date</code> column using the <code>EXTRACT</code> function.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.payment_id, p.customer_id cust_id, p.amount, p.payment_date
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">WHERE 
</span><span class="s1">    EXTRACT(month FROM p.payment_date) = 3
</span><span class="s1">    AND p.amount &lt; 1
</span><span class="s1">ORDER BY 
</span><span class="s1">    cust_id DESC, 3 ASC;
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(1021, 4)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>cust_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22611</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-02 15:51:25.996577</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22613</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-21 07:09:41.996577</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22606</td>
      <td>597</td>
      <td>0.99</td>
      <td>2007-03-19 05:51:32.996577</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22589</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-01 20:50:37.996577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22598</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-22 21:49:07.996577</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-1">▶ Python</h4>

<p>When we loaded the payment table from the database using sqlalchemy, the <code>payment_date</code> feature was correctly
parsed as a datetime object.</p>

<p>This allows us to use the pandas <code>dt</code> accessor to extract a variety of date and time related features, including the month.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span><span class="p">[(</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">==</span><span class="mi">3</span><span class="p">)]</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;customer_id&#39;</span><span class="p">:</span> <span class="s1">&#39;cust_id&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reindex</span><span class="p">([</span><span class="s1">&#39;payment_id&#39;</span><span class="p">,</span><span class="s1">&#39;cust_id&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span><span class="s1">&#39;payment_date&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;cust_id&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">])</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
     <span class="p">)</span>
      
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(1021, 4)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>cust_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22611</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-02 15:51:25.996577</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22613</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-21 07:09:41.996577</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22606</td>
      <td>597</td>
      <td>0.99</td>
      <td>2007-03-19 05:51:32.996577</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22589</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-01 20:50:37.996577</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22592</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-17 15:08:26.996577</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-1">▶ R</h4>

<p>A great way to handle datetime objects in R is via the <a href="https://lubridate.tidyverse.org/">lubridate</a> library.
To make it clear when we&rsquo;re using a lubridate object, we won&rsquo;t load the library, but we call its functions using
the <code>lubridate::</code> prefix.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>o df_r
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>amount <span class="o">&lt;</span> <span class="m">1</span><span class="p">,</span> lubridate<span class="o">::</span>month<span class="p">(</span>payment<span class="o">$</span>payment_date<span class="p">)</span><span class="o">==</span><span class="m">3</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        rename<span class="p">(</span>cust_id<span class="o">=</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        select<span class="p">(</span><span class="o">-</span>rental_id<span class="p">,</span> <span class="o">-</span>staff_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>desc<span class="p">(</span>cust_id<span class="p">),</span> amount<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">df_r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_r</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(1021, 4)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>cust_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>22611</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-02 15:51:25+11:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>22613</td>
      <td>598</td>
      <td>0.99</td>
      <td>2007-03-21 07:09:41+11:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22606</td>
      <td>597</td>
      <td>0.99</td>
      <td>2007-03-19 05:51:32+11:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>22589</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-01 20:50:37+11:00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22592</td>
      <td>596</td>
      <td>0.99</td>
      <td>2007-03-17 15:08:26+11:00</td>
    </tr>
  </tbody>
</table>
</div>

<p>Here we get an glimpse into the infinite joy of working with datetime objects.</p>

<p>During the transfer from Python to R and back to Python, our <code>payment_date</code> format has changed slightly.</p>

<p>Instead of worrying about fixing this we&rsquo;ll just exclude that column when comparing the R result with the SQL/Python ones.</p>

<p>Henceforth, we won&rsquo;t be worrying about this issue. We&rsquo;ll simply check that the dataframes shape match and
the first few rows are consistent.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">df_r</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">(True, True)</pre></div>
<hr />

<h3 id="which-day-saw-the-most-business-largest-number-of-transactions">Which day saw the most business (largest number of transactions)?</h3>

<p>This is a common operation. We need to group our payments by date, count how many transactions occured on that date
and order the results accordingly.</p>

<h4 id="sql-2">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.payment_date::date, COUNT(*)
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">GROUP BY 1
</span><span class="s1">ORDER BY 2 DESC
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(32, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_date</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-04-30</td>
      <td>1311</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-04-27</td>
      <td>643</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-04-29</td>
      <td>640</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-04-28</td>
      <td>627</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-04-08</td>
      <td>516</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-04-09</td>
      <td>514</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-04-06</td>
      <td>486</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-04-10</td>
      <td>482</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-04-07</td>
      <td>472</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-04-11</td>
      <td>468</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-04-12</td>
      <td>452</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-02-19</td>
      <td>310</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-02-15</td>
      <td>308</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-02-18</td>
      <td>302</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-02-20</td>
      <td>291</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-02-17</td>
      <td>283</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-02-16</td>
      <td>282</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-02-21</td>
      <td>213</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-05-14</td>
      <td>182</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-04-26</td>
      <td>79</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-04-05</td>
      <td>64</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-02-14</td>
      <td>27</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-2">▶  Python</h4>

<p>The Python pipeline mimics the SQL query rather closely.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
       <span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
     <span class="p">)</span>
<span class="n">df</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_date</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-04-30</td>
      <td>1311</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-04-27</td>
      <td>643</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-04-29</td>
      <td>640</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-04-28</td>
      <td>627</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-04-08</td>
      <td>516</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-04-09</td>
      <td>514</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-04-06</td>
      <td>486</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-04-10</td>
      <td>482</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-04-07</td>
      <td>472</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-04-11</td>
      <td>468</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-04-12</td>
      <td>452</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-02-19</td>
      <td>310</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-02-15</td>
      <td>308</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-02-18</td>
      <td>302</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-02-20</td>
      <td>291</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-02-17</td>
      <td>283</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-02-16</td>
      <td>282</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-02-21</td>
      <td>213</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-05-14</td>
      <td>182</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-04-26</td>
      <td>79</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-04-05</td>
      <td>64</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-02-14</td>
      <td>27</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-2">▶  R</h4>

<p>We follow the same pattern for our R code. The conversion to a dataframe at the end (using <code>as.data.frame</code>) is
simply to get a nicer formatting of the output.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>payment_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment<span class="o">$</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
        summarise<span class="p">(</span>n <span class="o">=</span> n<span class="p">())</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>desc<span class="p">(</span>n<span class="p">))</span> <span class="o">%&gt;%</span>
        <span class="kp">as.data.frame</span><span class="p">()</span>
df_r</code></pre></div><div class="highlight"><pre class="chroma">   payment_date    n
1    2007-04-30 1311
2    2007-03-01  676
3    2007-03-21  673
4    2007-04-27  643
5    2007-04-29  640
6    2007-03-19  631
7    2007-04-28  627
8    2007-03-18  624
9    2007-03-22  621
10   2007-03-20  611
11   2007-03-02  595
12   2007-03-17  584
13   2007-03-23  557
14   2007-04-08  516
15   2007-04-09  514
16   2007-04-06  486
17   2007-04-10  482
18   2007-04-07  472
19   2007-04-11  468
20   2007-04-12  452
21   2007-02-19  310
22   2007-02-15  308
23   2007-02-18  302
24   2007-02-20  291
25   2007-02-17  283
26   2007-02-16  282
27   2007-02-21  213
28   2007-05-14  182
29   2007-04-26   79
30   2007-03-16   72
31   2007-04-05   64
32   2007-02-14   27</pre></div>
<hr />

<h3 id="how-much-did-each-customer-spend-and-when">How much did each customer spend and when?</h3>

<p>We can answer this question in a number of ways. Let&rsquo;s return a sequence of transaction dates for each customer. In SQL we can do that with an array.</p>

<h4 id="sql-3">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    p.customer_id, 
</span><span class="s1">    SUM(p.amount) total, 
</span><span class="s1">    ARRAY_AGG(p.payment_date::date) dates
</span><span class="s1">FROM 
</span><span class="s1">    payment p
</span><span class="s1">GROUP BY 1
</span><span class="s1">ORDER BY 2 DESC
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>total</th>
      <th>dates</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>148</td>
      <td>211.55</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-19, 2007-02-1...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>526</td>
      <td>208.58</td>
      <td>[2007-02-15, 2007-02-16, 2007-02-17, 2007-02-1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>178</td>
      <td>194.61</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-16, 2007-02-1...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>137</td>
      <td>191.62</td>
      <td>[2007-02-18, 2007-02-19, 2007-02-20, 2007-02-2...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>144</td>
      <td>189.60</td>
      <td>[2007-02-16, 2007-02-17, 2007-02-19, 2007-02-2...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-3">▶  Python</h4>

<p>In Python we&rsquo;ll gather the transaction dates for each customer as a list.</p>

<p>We can build that list using a <code>lambda</code> (anonymous) function during the aggregation step.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_date&#39;</span><span class="p">]]</span>
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span>
               <span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
               <span class="s1">&#39;payment_date&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
            <span class="p">})</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_date&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
      <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>total</th>
      <th>date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>148</td>
      <td>211.55</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-19, 2007-02-1...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>526</td>
      <td>208.58</td>
      <td>[2007-02-15, 2007-02-16, 2007-02-17, 2007-02-1...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>178</td>
      <td>194.61</td>
      <td>[2007-02-15, 2007-02-15, 2007-02-16, 2007-02-1...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>137</td>
      <td>191.62</td>
      <td>[2007-02-18, 2007-02-19, 2007-02-20, 2007-02-2...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>144</td>
      <td>189.60</td>
      <td>[2007-02-16, 2007-02-17, 2007-02-19, 2007-02-2...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-3">▶ R</h4>

<p>For this query the R code is similar to the Python one (syntactic idiosyncrasies aside).</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 
df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
      mutate<span class="p">(</span>payment_date <span class="o">=</span> <span class="kp">as.Date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
      summarise<span class="p">(</span>total<span class="o">=</span><span class="kp">sum</span><span class="p">(</span>amount<span class="p">),</span> dates<span class="o">=</span><span class="kt">list</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      arrange<span class="p">(</span>desc<span class="p">(</span>total<span class="p">))</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">print</span><span class="p">(</span><span class="kp">head</span><span class="p">(</span>df_r<span class="p">,</span> <span class="m">5</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 599   3
# A tibble: 5 x 3
  customer_id total dates      
        &lt;int&gt; &lt;dbl&gt; &lt;list&gt;     
1         148  212. &lt;date [45]&gt;
2         526  209. &lt;date [42]&gt;
3         178  195. &lt;date [39]&gt;
4         137  192. &lt;date [38]&gt;
5         144  190. &lt;date [40]&gt;</pre></div>
<p>At first glance it looks like the results are different from the SQL/Python, but this is purely cosmetic. The R data structure (a <code>tibble</code> actually) rounds up the floating point values and shrinks the lists when displaying the results. We could convert the <code>tibble</code> to a R dataframe but the output would be unwieldy.
Instead, we can unpack the first row to show that the data has been parsed correctly.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
<span class="kp">print</span><span class="p">(</span>df_r<span class="o">$</span>total<span class="p">[</span><span class="m">1</span><span class="p">])</span> 
<span class="kp">print</span><span class="p">(</span>df_r<span class="o">$</span>dates<span class="p">[</span><span class="m">1</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 211.55
[[1]]
 [1] &#34;2007-02-15&#34; &#34;2007-02-15&#34; &#34;2007-02-19&#34; &#34;2007-02-19&#34; &#34;2007-02-19&#34;
 [6] &#34;2007-03-01&#34; &#34;2007-03-02&#34; &#34;2007-03-17&#34; &#34;2007-03-17&#34; &#34;2007-03-18&#34;
[11] &#34;2007-03-18&#34; &#34;2007-03-18&#34; &#34;2007-03-20&#34; &#34;2007-03-20&#34; &#34;2007-03-20&#34;
[16] &#34;2007-03-21&#34; &#34;2007-03-21&#34; &#34;2007-03-21&#34; &#34;2007-03-21&#34; &#34;2007-03-22&#34;
[21] &#34;2007-03-22&#34; &#34;2007-03-22&#34; &#34;2007-03-22&#34; &#34;2007-04-05&#34; &#34;2007-04-06&#34;
[26] &#34;2007-04-08&#34; &#34;2007-04-08&#34; &#34;2007-04-08&#34; &#34;2007-04-09&#34; &#34;2007-04-10&#34;
[31] &#34;2007-04-11&#34; &#34;2007-04-12&#34; &#34;2007-04-27&#34; &#34;2007-04-27&#34; &#34;2007-04-27&#34;
[36] &#34;2007-04-28&#34; &#34;2007-04-28&#34; &#34;2007-04-28&#34; &#34;2007-04-29&#34; &#34;2007-04-29&#34;
[41] &#34;2007-04-29&#34; &#34;2007-04-29&#34; &#34;2007-04-30&#34; &#34;2007-04-29&#34; &#34;2007-04-30&#34;</pre></div>
<hr />

<h3 id="which-days-of-march-2007-recorded-no-sale">Which  days of March 2007 recorded no sale?</h3>

<p>This may seem like the sort of query we&rsquo;ve already looked at, however there is a catch.
The database only records transactions that have occurred (it seems obvious when said like that!).
This means that dates with no sales aren&rsquo;t in the database.
Therefore we need to generate a series of dates (with a daily frequency) and join our payment data on it to find the days with no sales.</p>

<p>In PostgreSQL we can use <code>generate_series</code> to do that. Note that we select from it as if it were a table (which
we name <code>gs</code>). By joining on it we can &ldquo;expand&rdquo; our payment data to include the dates for which no transaction took place. These would of course contain <code>NULL</code> values for the transaction data. By identifying where those <code>NULL</code> rows are we can answer the original question.</p>

<h4 id="sql-4">▶  SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    gs::date, p.*
</span><span class="s1">FROM 
</span><span class="s1">    generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 Day&#39;) gs
</span><span class="s1">LEFT JOIN 
</span><span class="s1">    payment p 
</span><span class="s1">ON 
</span><span class="s1">    p.payment_date::date = gs::date
</span><span class="s1">WHERE 
</span><span class="s1">    payment_date is NULL
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="s1">&#39;gs&#39;</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(21,)
0     2007-03-03
1     2007-03-04
2     2007-03-05
3     2007-03-06
4     2007-03-07
5     2007-03-08
6     2007-03-09
7     2007-03-10
8     2007-03-11
9     2007-03-12
10    2007-03-13
11    2007-03-14
12    2007-03-15
13    2007-03-24
14    2007-03-25
15    2007-03-26
16    2007-03-27
17    2007-03-28
18    2007-03-29
19    2007-03-30
20    2007-03-31
Name: gs, dtype: object</pre></div>
<h4 id="python-4">▶ Python</h4>

<p>We could do something similar in Python, however let&rsquo;s try a more pythonic approach and use set operations to extract the dates we want. We simply construct the set of all dates in March 2007 and take the difference with the dates that are already in the database. The moral of the story here is that whereas the Python (and R) syntax can often look <em>SQLish</em>, this is not always the most concise or even suitable way to get to the answer.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;20070301&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;20070331&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(21, 0)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2007-03-03</th>
    </tr>
    <tr>
      <th>2007-03-04</th>
    </tr>
    <tr>
      <th>2007-03-05</th>
    </tr>
    <tr>
      <th>2007-03-06</th>
    </tr>
    <tr>
      <th>2007-03-07</th>
    </tr>
    <tr>
      <th>2007-03-08</th>
    </tr>
    <tr>
      <th>2007-03-09</th>
    </tr>
    <tr>
      <th>2007-03-10</th>
    </tr>
    <tr>
      <th>2007-03-11</th>
    </tr>
    <tr>
      <th>2007-03-12</th>
    </tr>
    <tr>
      <th>2007-03-13</th>
    </tr>
    <tr>
      <th>2007-03-14</th>
    </tr>
    <tr>
      <th>2007-03-15</th>
    </tr>
    <tr>
      <th>2007-03-24</th>
    </tr>
    <tr>
      <th>2007-03-25</th>
    </tr>
    <tr>
      <th>2007-03-26</th>
    </tr>
    <tr>
      <th>2007-03-27</th>
    </tr>
    <tr>
      <th>2007-03-28</th>
    </tr>
    <tr>
      <th>2007-03-29</th>
    </tr>
    <tr>
      <th>2007-03-30</th>
    </tr>
    <tr>
      <th>2007-03-31</th>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-4">▶ R</h4>

<p>Set operations also work in R. The output is a bit strange. We have a list of lists with a single element.
We could flatten the nested list but it would only obfuscate the code so we&rsquo;ll leave it like that.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
gs <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span>lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">),</span> lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">),</span> by <span class="o">=</span> <span class="s">&#39;1 day&#39;</span><span class="p">)</span>
<span class="kp">lapply</span><span class="p">(</span><span class="kp">sort</span><span class="p">(</span><span class="kp">setdiff</span><span class="p">(</span>gs<span class="p">,</span> lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment<span class="o">$</span>payment_date<span class="p">))),</span> <span class="kp">as.Date</span><span class="p">,</span> origin<span class="o">=</span><span class="s">&#39;1970-01-01&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[[1]]
[1] &#34;2007-03-03&#34;

[[2]]
[1] &#34;2007-03-04&#34;

[[3]]
[1] &#34;2007-03-05&#34;

[[4]]
[1] &#34;2007-03-06&#34;

[[5]]
[1] &#34;2007-03-07&#34;

[[6]]
[1] &#34;2007-03-08&#34;

[[7]]
[1] &#34;2007-03-09&#34;

[[8]]
[1] &#34;2007-03-10&#34;

[[9]]
[1] &#34;2007-03-11&#34;

[[10]]
[1] &#34;2007-03-12&#34;

[[11]]
[1] &#34;2007-03-13&#34;

[[12]]
[1] &#34;2007-03-14&#34;

[[13]]
[1] &#34;2007-03-15&#34;

[[14]]
[1] &#34;2007-03-24&#34;

[[15]]
[1] &#34;2007-03-25&#34;

[[16]]
[1] &#34;2007-03-26&#34;

[[17]]
[1] &#34;2007-03-27&#34;

[[18]]
[1] &#34;2007-03-28&#34;

[[19]]
[1] &#34;2007-03-29&#34;

[[20]]
[1] &#34;2007-03-30&#34;

[[21]]
[1] &#34;2007-03-31&#34;</pre></div>
<hr />

<h3 id="how-many-transactions-were-there-for-each-day-of-march-2007">How many transactions were there for each day of March 2007?</h3>

<p>This is a simple question, we just need to keep in mind that some days had no transaction. We should still ouput those with a count of zero. The basic idea is similar to the previous example. We create a time series to &ldquo;pad out&rdquo; the missing days in the <code>payment_date</code> feature.</p>

<h4 id="sql-5">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    gs::date date, 
</span><span class="s1">    COUNT(p.*) number_of_transactions
</span><span class="s1">FROM 
</span><span class="s1">    generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 Day&#39;) gs
</span><span class="s1">LEFT JOIN 
</span><span class="s1">    payment p 
</span><span class="s1">ON 
</span><span class="s1">    p.payment_date::date = gs::date 
</span><span class="s1">GROUP BY 
</span><span class="s1">    gs::date 
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(31, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-03</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-04</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-05</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-06</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-07</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-08</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-14</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-15</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-27</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-28</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-31</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-5">▶ Python</h4>

<p>Similarly, in Python we can create the series of dates for March 2007 using the <code>date_range</code> object from <code>pandas</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;20070301&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;20070331&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">payment_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;payment_date&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;number_of_transactions&#39;</span><span class="p">})</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(31, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-01</td>
      <td>676</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-02</td>
      <td>595</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-03</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-04</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-05</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-06</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-07</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-08</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-14</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-15</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-16</td>
      <td>72</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-17</td>
      <td>584</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-18</td>
      <td>624</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-19</td>
      <td>631</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-20</td>
      <td>611</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-21</td>
      <td>673</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>621</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-23</td>
      <td>557</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-27</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-28</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-31</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-5">▶  R</h4>

<p>Once again, the pattern for R follows the same principles.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 
gs <span class="o">=</span> <span class="kt">data_frame</span><span class="p">(</span>payment_date<span class="o">=</span><span class="kp">seq</span><span class="p">(</span>lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">),</span> 
                                 lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">),</span> 
                                 by <span class="o">=</span> <span class="s">&#39;1 day&#39;</span><span class="p">))</span>

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
      mutate<span class="p">(</span>payment_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      group_by<span class="p">(</span>payment_date<span class="p">)</span> <span class="o">%&gt;%</span> 
      summarise<span class="p">(</span>number_of_transactions<span class="o">=</span>n<span class="p">())</span> <span class="o">%&gt;%</span> 
      right_join<span class="p">(</span>gs<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;payment_date&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span>
      replace_na<span class="p">(</span><span class="kt">list</span><span class="p">(</span>number_of_transactions<span class="o">=</span><span class="m">0</span><span class="p">))</span>

<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">   payment_date number_of_transactions
1    2007-03-01                    676
2    2007-03-02                    595
3    2007-03-03                      0
4    2007-03-04                      0
5    2007-03-05                      0
6    2007-03-06                      0
7    2007-03-07                      0
8    2007-03-08                      0
9    2007-03-09                      0
10   2007-03-10                      0
11   2007-03-11                      0
12   2007-03-12                      0
13   2007-03-13                      0
14   2007-03-14                      0
15   2007-03-15                      0
16   2007-03-16                     72
17   2007-03-17                    584
18   2007-03-18                    624
19   2007-03-19                    631
20   2007-03-20                    611
21   2007-03-21                    673
22   2007-03-22                    621
23   2007-03-23                    557
24   2007-03-24                      0
25   2007-03-25                      0
26   2007-03-26                      0
27   2007-03-27                      0
28   2007-03-28                      0
29   2007-03-29                      0
30   2007-03-30                      0
31   2007-03-31                      0</pre></div>
<hr />

<h3 id="days-with-no-transactions-in-march-2007-alternate-version">Days with no transactions in March 2007 - Alternate version</h3>

<p>Let&rsquo;s revisit the problem we dealt with previous using set operations in Python and R and illustrate how we could answer the question using a more SQLish pipeline.
We can reuse the code from the previous example. We just need to add a filtering step.</p>

<h4 id="sql-6">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    gs::date date, COUNT(p.*) number_of_transactions
</span><span class="s1">FROM 
</span><span class="s1">    generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 Day&#39;) gs
</span><span class="s1">LEFT JOIN 
</span><span class="s1">    payment p 
</span><span class="s1">ON 
</span><span class="s1">    p.payment_date::date = gs::date 
</span><span class="s1">GROUP BY 
</span><span class="s1">    gs::date 
</span><span class="s1">HAVING 
</span><span class="s1">    COUNT(p.*) = 0
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(21, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-03</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-04</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-05</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-06</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-07</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-08</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-09</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-10</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-11</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-13</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-14</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-15</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-25</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-26</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-27</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-28</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-29</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-31</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-6">▶ Python</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">gs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;20070301&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;20070331&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">payment_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;payment_date&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;number_of_transactions&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;number_of_transactions == 0&#39;</span><span class="p">)</span>  
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(21, 1)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>number_of_transactions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2007-03-03</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-04</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-05</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-06</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-07</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-08</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-09</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-10</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-11</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-12</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-13</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-14</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-15</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-24</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-25</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-26</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-27</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-28</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-29</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-30</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2007-03-31</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-6">▶ R</h4>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
gs <span class="o">=</span> <span class="kt">data_frame</span><span class="p">(</span>payment_date<span class="o">=</span><span class="kp">seq</span><span class="p">(</span>lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">),</span> 
                                 lubridate<span class="o">::</span>ymd<span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">),</span> 
                                 by <span class="o">=</span> <span class="s">&#39;1 day&#39;</span><span class="p">))</span>

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
      mutate<span class="p">(</span>payment_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
      group_by<span class="p">(</span>payment_date<span class="p">)</span> <span class="o">%&gt;%</span> 
      summarise<span class="p">(</span>number_of_transactions<span class="o">=</span>n<span class="p">())</span> <span class="o">%&gt;%</span> 
      right_join<span class="p">(</span>gs<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;payment_date&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span>
      replace_na<span class="p">(</span><span class="kt">list</span><span class="p">(</span>number_of_transactions<span class="o">=</span><span class="m">0</span><span class="p">))</span> <span class="o">%&gt;%</span>
      <span class="kp">subset</span><span class="p">(</span>number_of_transactions<span class="o">==</span><span class="m">0</span><span class="p">)</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 21  2
   payment_date number_of_transactions
1    2007-03-03                      0
2    2007-03-04                      0
3    2007-03-05                      0
4    2007-03-06                      0
5    2007-03-07                      0
6    2007-03-08                      0
7    2007-03-09                      0
8    2007-03-10                      0
9    2007-03-11                      0
10   2007-03-12                      0
11   2007-03-13                      0
12   2007-03-14                      0
13   2007-03-15                      0
14   2007-03-24                      0
15   2007-03-25                      0
16   2007-03-26                      0
17   2007-03-27                      0
18   2007-03-28                      0
19   2007-03-29                      0
20   2007-03-30                      0
21   2007-03-31                      0</pre></div>
<hr />

<h3 id="which-movies-have-never-been-rented">Which movies have never been rented?</h3>

<p>So far we&rsquo;ve only worked with a single table out of the 15 contained in the database. To match movies to rental transactions we will need
to use 3 new tables. The film one contains information about the movies, the inventory one links the movies to an inventory id, which is used in the rental table to connect movies to actual rentals.</p>

<p>Let&rsquo;s have a look at the structures of these tables.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">,</span> <span class="s1">&#39;payment&#39;</span><span class="p">,</span> <span class="s1">&#39;rental&#39;</span><span class="p">,</span> <span class="s1">&#39;film&#39;</span><span class="p">]:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT * FROM {t}
</span><span class="s1">LIMIT 1
</span><span class="s1">&#39;&#39;&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">inventory</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>inventory_id</th>
      <th>film_id</th>
      <th>store_id</th>
      <th>last_update</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2006-02-15 10:09:17</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma">payment</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17503</td>
      <td>341</td>
      <td>2</td>
      <td>1520</td>
      <td>7.99</td>
      <td>2007-02-15 22:25:46.996577</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma">rental</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rental_id</th>
      <th>rental_date</th>
      <th>inventory_id</th>
      <th>customer_id</th>
      <th>return_date</th>
      <th>staff_id</th>
      <th>last_update</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2</td>
      <td>2005-05-24 22:54:33</td>
      <td>1525</td>
      <td>459</td>
      <td>2005-05-28 19:40:33</td>
      <td>1</td>
      <td>2006-02-16 02:30:53</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma">film</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>description</th>
      <th>release_year</th>
      <th>language_id</th>
      <th>rental_duration</th>
      <th>rental_rate</th>
      <th>length</th>
      <th>replacement_cost</th>
      <th>rating</th>
      <th>last_update</th>
      <th>special_features</th>
      <th>fulltext</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>133</td>
      <td>Chamber Italian</td>
      <td>A Fateful Reflection of a Moose And a Husband ...</td>
      <td>2006</td>
      <td>1</td>
      <td>7</td>
      <td>4.99</td>
      <td>117</td>
      <td>14.99</td>
      <td>NC-17</td>
      <td>2013-05-26 14:50:58.951</td>
      <td>[Trailers]</td>
      <td>'chamber':1 'fate':4 'husband':11 'italian':2 ...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="sql-7">▶ SQL</h4>

<p>Let&rsquo;s join the tables, count how many times each movie has been rented and select those for which the count is zero.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    t.film_id, t.title, t.rentals 
</span><span class="s1">FROM 
</span><span class="s1">    (SELECT 
</span><span class="s1">        f.film_id, f.title, 
</span><span class="s1">        COUNT(distinct r.rental_id) as rentals
</span><span class="s1">    FROM film f
</span><span class="s1">        LEFT JOIN inventory i ON i.film_id = f.film_id
</span><span class="s1">        LEFT JOIN rental r ON r.inventory_id = i.inventory_id
</span><span class="s1">    GROUP BY 1,2
</span><span class="s1">    HAVING 
</span><span class="s1">        COUNT(distinct r.rental_id) = 0
</span><span class="s1">        ) t
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(42, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rentals</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14</td>
      <td>Alice Fantasia</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33</td>
      <td>Apollo Teen</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36</td>
      <td>Argonauts Town</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>38</td>
      <td>Ark Ridgemont</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41</td>
      <td>Arsenic Independence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>87</td>
      <td>Boondock Ballroom</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>108</td>
      <td>Butch Panther</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>128</td>
      <td>Catch Amistad</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>144</td>
      <td>Chinatown Gladiator</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>148</td>
      <td>Chocolate Duck</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>171</td>
      <td>Commandments Express</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>192</td>
      <td>Crossing Divorce</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>195</td>
      <td>Crowds Telemark</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>198</td>
      <td>Crystal Breaking</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>217</td>
      <td>Dazed Punk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>221</td>
      <td>Deliverance Mulholland</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>318</td>
      <td>Firehouse Vietnam</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>325</td>
      <td>Floats Garden</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>332</td>
      <td>Frankenstein Stranger</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>359</td>
      <td>Gladiator Westward</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>386</td>
      <td>Gump Date</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>404</td>
      <td>Hate Handicap</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>419</td>
      <td>Hocus Frida</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>495</td>
      <td>Kentuckian Giant</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>497</td>
      <td>Kill Brotherhood</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>607</td>
      <td>Muppet Mile</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>642</td>
      <td>Order Betrayed</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>669</td>
      <td>Pearl Destiny</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>671</td>
      <td>Perdition Fargo</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>701</td>
      <td>Psycho Shrunk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>712</td>
      <td>Raiders Antitrust</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>713</td>
      <td>Rainbow Shock</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32</th>
      <td>742</td>
      <td>Roof Champion</td>
      <td>0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>801</td>
      <td>Sister Freddy</td>
      <td>0</td>
    </tr>
    <tr>
      <th>34</th>
      <td>802</td>
      <td>Sky Miracle</td>
      <td>0</td>
    </tr>
    <tr>
      <th>35</th>
      <td>860</td>
      <td>Suicides Silence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>36</th>
      <td>874</td>
      <td>Tadpole Park</td>
      <td>0</td>
    </tr>
    <tr>
      <th>37</th>
      <td>909</td>
      <td>Treasure Command</td>
      <td>0</td>
    </tr>
    <tr>
      <th>38</th>
      <td>943</td>
      <td>Villain Desperate</td>
      <td>0</td>
    </tr>
    <tr>
      <th>39</th>
      <td>950</td>
      <td>Volume House</td>
      <td>0</td>
    </tr>
    <tr>
      <th>40</th>
      <td>954</td>
      <td>Wake Jaws</td>
      <td>0</td>
    </tr>
    <tr>
      <th>41</th>
      <td>955</td>
      <td>Walls Artist</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-7">▶ Python</h4>

<p>The go to approach for join operations in pandas is the <code>merge</code> method. The type of join can be specified as an optional parameter.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">film</span><span class="p">,</span> <span class="n">inventory</span><span class="p">,</span> <span class="n">rental</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;film&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">],</span> <span class="n">tbl</span><span class="p">[</span><span class="s1">&#39;rental&#39;</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">film</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rental</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;inventory_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">])[[</span><span class="s1">&#39;rental_id&#39;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rental_id&#39;</span><span class="p">:</span><span class="s1">&#39;rentals&#39;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;rentals == 0&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
     <span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(42, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rentals</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14</td>
      <td>Alice Fantasia</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>33</td>
      <td>Apollo Teen</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36</td>
      <td>Argonauts Town</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>38</td>
      <td>Ark Ridgemont</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41</td>
      <td>Arsenic Independence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>87</td>
      <td>Boondock Ballroom</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>108</td>
      <td>Butch Panther</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>128</td>
      <td>Catch Amistad</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>144</td>
      <td>Chinatown Gladiator</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>148</td>
      <td>Chocolate Duck</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>171</td>
      <td>Commandments Express</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>192</td>
      <td>Crossing Divorce</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>195</td>
      <td>Crowds Telemark</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>198</td>
      <td>Crystal Breaking</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>217</td>
      <td>Dazed Punk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>221</td>
      <td>Deliverance Mulholland</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>318</td>
      <td>Firehouse Vietnam</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>325</td>
      <td>Floats Garden</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>332</td>
      <td>Frankenstein Stranger</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>359</td>
      <td>Gladiator Westward</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>386</td>
      <td>Gump Date</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>404</td>
      <td>Hate Handicap</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>419</td>
      <td>Hocus Frida</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>495</td>
      <td>Kentuckian Giant</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>497</td>
      <td>Kill Brotherhood</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>607</td>
      <td>Muppet Mile</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>642</td>
      <td>Order Betrayed</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>669</td>
      <td>Pearl Destiny</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>671</td>
      <td>Perdition Fargo</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>701</td>
      <td>Psycho Shrunk</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>712</td>
      <td>Raiders Antitrust</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31</th>
      <td>713</td>
      <td>Rainbow Shock</td>
      <td>0</td>
    </tr>
    <tr>
      <th>32</th>
      <td>742</td>
      <td>Roof Champion</td>
      <td>0</td>
    </tr>
    <tr>
      <th>33</th>
      <td>801</td>
      <td>Sister Freddy</td>
      <td>0</td>
    </tr>
    <tr>
      <th>34</th>
      <td>802</td>
      <td>Sky Miracle</td>
      <td>0</td>
    </tr>
    <tr>
      <th>35</th>
      <td>860</td>
      <td>Suicides Silence</td>
      <td>0</td>
    </tr>
    <tr>
      <th>36</th>
      <td>874</td>
      <td>Tadpole Park</td>
      <td>0</td>
    </tr>
    <tr>
      <th>37</th>
      <td>909</td>
      <td>Treasure Command</td>
      <td>0</td>
    </tr>
    <tr>
      <th>38</th>
      <td>943</td>
      <td>Villain Desperate</td>
      <td>0</td>
    </tr>
    <tr>
      <th>39</th>
      <td>950</td>
      <td>Volume House</td>
      <td>0</td>
    </tr>
    <tr>
      <th>40</th>
      <td>954</td>
      <td>Wake Jaws</td>
      <td>0</td>
    </tr>
    <tr>
      <th>41</th>
      <td>955</td>
      <td>Walls Artist</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-7">▶ R</h4>

<p>We start by &ldquo;transfering&rdquo; the new dataframes to R. The rest of the pipeline is very much like the one used in Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>i rental <span class="o">-</span>i inventory <span class="o">-</span>i film <span class="o">-</span>o df_r
df_r <span class="o">=</span> film <span class="o">%&gt;%</span> 
        left_join<span class="p">(</span>inventory<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;film_id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        left_join<span class="p">(</span>rental<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;inventory_id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>film_id<span class="p">,</span> title<span class="p">)</span> <span class="o">%&gt;%</span> 
        summarise<span class="p">(</span>rentals<span class="o">=</span>n_distinct<span class="p">(</span>rental_id<span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>rentals<span class="o">==</span><span class="m">0</span><span class="p">)</span> <span class="o">%&gt;%</span>
        <span class="kp">as.data.frame</span><span class="p">()</span>

df_r</code></pre></div><div class="highlight"><pre class="chroma">   film_id                  title rentals
1       14         Alice Fantasia       0
2       33            Apollo Teen       0
3       36         Argonauts Town       0
4       38          Ark Ridgemont       0
5       41   Arsenic Independence       0
6       87      Boondock Ballroom       0
7      108          Butch Panther       0
8      128          Catch Amistad       0
9      144    Chinatown Gladiator       0
10     148         Chocolate Duck       0
11     171   Commandments Express       0
12     192       Crossing Divorce       0
13     195        Crowds Telemark       0
14     198       Crystal Breaking       0
15     217             Dazed Punk       0
16     221 Deliverance Mulholland       0
17     318      Firehouse Vietnam       0
18     325          Floats Garden       0
19     332  Frankenstein Stranger       0
20     359     Gladiator Westward       0
21     386              Gump Date       0
22     404          Hate Handicap       0
23     419            Hocus Frida       0
24     495       Kentuckian Giant       0
25     497       Kill Brotherhood       0
26     607            Muppet Mile       0
27     642         Order Betrayed       0
28     669          Pearl Destiny       0
29     671        Perdition Fargo       0
30     701          Psycho Shrunk       0
31     712      Raiders Antitrust       0
32     713          Rainbow Shock       0
33     742          Roof Champion       0
34     801          Sister Freddy       0
35     802            Sky Miracle       0
36     860       Suicides Silence       0
37     874           Tadpole Park       0
38     909       Treasure Command       0
39     943      Villain Desperate       0
40     950           Volume House       0
41     954              Wake Jaws       0
42     955           Walls Artist       0</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_r</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">(True, True)</pre></div>
<hr />

<h3 id="find-each-customer-s-first-order">Find each customer&rsquo;s first order.</h3>

<p>To solve the problem in SQL we need to use a <a href="https://en.wikipedia.org/wiki/Correlated_subquery"><strong>correlated subquery</strong></a> whereby the inner query gets executed for every row of the outer query.</p>

<p>In our case, the inner query gets executed for every row of the outer query because <code>min(rental_id)</code> will change with each customer.</p>

<h4 id="sql-8">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT 
</span><span class="s1">    r.customer_id, 
</span><span class="s1">    min(r.rental_id) first_order_id, 
</span><span class="s1">    (    
</span><span class="s1">        SELECT r2.rental_date::date FROM rental r2 
</span><span class="s1">        WHERE r2.rental_id = min(r.rental_id)
</span><span class="s1">    ) first_order_date
</span><span class="s1">FROM 
</span><span class="s1">    rental r
</span><span class="s1">GROUP BY 1
</span><span class="s1">ORDER BY 1
</span><span class="s1">&#39;&#39;&#39;</span>

<span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_order_id</th>
      <th>first_order_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>76</td>
      <td>2005-05-25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>320</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>435</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1297</td>
      <td>2005-06-15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>731</td>
      <td>2005-05-29</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-8">▶ Python</h4>

<p>In this case the Python syntax is a bit simpler. We group by the <code>customer_id</code> and pick the smallest <code>rental_id</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">rental</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">rental_date</span><span class="o">=</span><span class="n">rental</span><span class="o">.</span><span class="n">rental_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;customer_id&#39;</span> <span class="p">])[</span><span class="s1">&#39;rental_id&#39;</span><span class="p">,</span><span class="s1">&#39;rental_date&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="nb">min</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rental_id&#39;</span><span class="p">:</span><span class="s1">&#39;first_order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rental_date&#39;</span><span class="p">:</span><span class="s1">&#39;first_order_date&#39;</span><span class="p">})</span>
      <span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma">(599, 3)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_order_id</th>
      <th>first_order_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>76</td>
      <td>2005-05-25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>320</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>435</td>
      <td>2005-05-27</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1297</td>
      <td>2005-06-15</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>731</td>
      <td>2005-05-29</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<h4 id="r-8">▶ R</h4>

<p>The R version of the code is similar to the Python one.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R 

df_r <span class="o">=</span> rental <span class="o">%&gt;%</span> 
        mutate<span class="p">(</span>rental_date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>rental_date<span class="p">))</span> <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        summarise_at<span class="p">(</span>vars<span class="p">(</span>rental_id<span class="p">,</span> rental_date<span class="p">),</span> funs<span class="p">(</span><span class="kp">min</span><span class="p">))</span> <span class="o">%&gt;%</span>
        <span class="kp">as.data.frame</span><span class="p">()</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">print</span><span class="p">(</span><span class="kp">head</span><span class="p">(</span>df_r<span class="p">,</span> <span class="m">5</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 599   3
  customer_id rental_id rental_date
1           1        76  2005-05-25
2           2       320  2005-05-27
3           3       435  2005-05-27
4           4      1297  2005-06-15
5           5       731  2005-05-29</pre></div>
<hr />

<h3 id="handling-multiple-conditions">Handling multiple conditions.</h3>

<p>Let&rsquo;s look at a more complex query. We&rsquo;d like to return all the rental transactions conducted by the staff with id 1, for which the rental id is larger than 15000, and the payment occured between 3am and 4am or 11pm and midnight in March 2007.</p>

<h4 id="sql-9">▶ SQL</h4>

<p>Although more complex than our previous examples, this query can be built from the pieces we&rsquo;ve used before.
To keep things somewhat simple, we&rsquo;ll assume that between 3am and 4am means between 3:00 and 3:59. This will allow use to only concern ourselves with the hour number when filtering our data. Same with the second time period.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">WITH base_table AS (
</span><span class="s1">    SELECT gs::date AS date,  p.*
</span><span class="s1">    FROM 
</span><span class="s1">        generate_series(&#39;2007-03-01&#39;, &#39;2007-03-31&#39;, INTERVAL &#39;1 day&#39;) as gs
</span><span class="s1">    LEFT JOIN payment p ON p.payment_date::date=gs::date AND p.staff_id = 1
</span><span class="s1">    ORDER BY 1 NULLS FIRST
</span><span class="s1">) 
</span><span class="s1">SELECT 
</span><span class="s1">    bt.date, bt.payment_id, bt.customer_id, bt.staff_id, bt.rental_id, bt.amount, 
</span><span class="s1">    EXTRACT(hour FROM bt.payment_date)::int AS hour
</span><span class="s1">FROM 
</span><span class="s1">    base_table bt
</span><span class="s1">WHERE 
</span><span class="s1">    bt.rental_id &gt; 15000 
</span><span class="s1">    AND         
</span><span class="s1">    EXTRACT(hour FROM bt.payment_date) IN (4,23)
</span><span class="s1">ORDER BY bt.payment_date, bt.rental_id
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(36, 7)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-22</td>
      <td>23134</td>
      <td>46</td>
      <td>1</td>
      <td>15438</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-22</td>
      <td>23958</td>
      <td>136</td>
      <td>1</td>
      <td>15439</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-22</td>
      <td>23095</td>
      <td>42</td>
      <td>1</td>
      <td>15442</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-22</td>
      <td>22615</td>
      <td>598</td>
      <td>1</td>
      <td>15443</td>
      <td>7.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-22</td>
      <td>22960</td>
      <td>28</td>
      <td>1</td>
      <td>15445</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-22</td>
      <td>20574</td>
      <td>379</td>
      <td>1</td>
      <td>15446</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-22</td>
      <td>21651</td>
      <td>490</td>
      <td>1</td>
      <td>15448</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-22</td>
      <td>20027</td>
      <td>322</td>
      <td>1</td>
      <td>15450</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>21866</td>
      <td>514</td>
      <td>1</td>
      <td>15451</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-22</td>
      <td>20370</td>
      <td>359</td>
      <td>1</td>
      <td>15453</td>
      <td>1.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-22</td>
      <td>24882</td>
      <td>238</td>
      <td>1</td>
      <td>15455</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-22</td>
      <td>25113</td>
      <td>262</td>
      <td>1</td>
      <td>15456</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-22</td>
      <td>19906</td>
      <td>306</td>
      <td>1</td>
      <td>15457</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-22</td>
      <td>22876</td>
      <td>20</td>
      <td>1</td>
      <td>15460</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-22</td>
      <td>23646</td>
      <td>103</td>
      <td>1</td>
      <td>15461</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-22</td>
      <td>20675</td>
      <td>389</td>
      <td>1</td>
      <td>15462</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-22</td>
      <td>23869</td>
      <td>127</td>
      <td>1</td>
      <td>15463</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-22</td>
      <td>23283</td>
      <td>62</td>
      <td>1</td>
      <td>15464</td>
      <td>6.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-22</td>
      <td>21921</td>
      <td>520</td>
      <td>1</td>
      <td>15465</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-22</td>
      <td>20970</td>
      <td>418</td>
      <td>1</td>
      <td>15466</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-22</td>
      <td>23647</td>
      <td>103</td>
      <td>1</td>
      <td>15467</td>
      <td>3.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>20768</td>
      <td>399</td>
      <td>1</td>
      <td>15468</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-22</td>
      <td>22610</td>
      <td>597</td>
      <td>1</td>
      <td>15469</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-23</td>
      <td>24692</td>
      <td>215</td>
      <td>1</td>
      <td>15583</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-23</td>
      <td>21731</td>
      <td>500</td>
      <td>1</td>
      <td>15584</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-23</td>
      <td>22149</td>
      <td>545</td>
      <td>1</td>
      <td>15585</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-23</td>
      <td>21723</td>
      <td>499</td>
      <td>1</td>
      <td>15587</td>
      <td>7.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-23</td>
      <td>21764</td>
      <td>503</td>
      <td>1</td>
      <td>15588</td>
      <td>3.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-23</td>
      <td>22901</td>
      <td>22</td>
      <td>1</td>
      <td>15589</td>
      <td>6.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-23</td>
      <td>23284</td>
      <td>62</td>
      <td>1</td>
      <td>15591</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-23</td>
      <td>24163</td>
      <td>153</td>
      <td>1</td>
      <td>15593</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-03-23</td>
      <td>25135</td>
      <td>264</td>
      <td>1</td>
      <td>15595</td>
      <td>4.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2007-03-23</td>
      <td>24478</td>
      <td>186</td>
      <td>1</td>
      <td>15596</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2007-03-23</td>
      <td>23323</td>
      <td>66</td>
      <td>1</td>
      <td>15598</td>
      <td>8.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>34</th>
      <td>2007-03-23</td>
      <td>23648</td>
      <td>103</td>
      <td>1</td>
      <td>15599</td>
      <td>5.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>35</th>
      <td>2007-03-23</td>
      <td>23729</td>
      <td>113</td>
      <td>1</td>
      <td>15600</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-9">▶ Python</h4>

<p>Just for some variety we use the <code>between</code> method of pandas series to select the March 2007 data.
We pass pandas <code>Timestamp</code> objects to mark the first and last day of the month.
The rest of the pipeline should be self-explanatory. The last line is added for convenience.
We order the columns of the pandas dataframe to match the ordering of the columns in our SQL result.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
  <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">between</span><span class="p">(</span>
              <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2007</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
              <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2007</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">))</span>
      <span class="p">]</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
  <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(hour in (4, 23)) &amp; (rental_id &gt; 15000) &amp; (staff_id == 1)&#39;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;payment_date&#39;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df_sql</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="p">)</span> 

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(36, 7)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>hour</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2007-03-22</td>
      <td>23134</td>
      <td>46</td>
      <td>1</td>
      <td>15438</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007-03-22</td>
      <td>23958</td>
      <td>136</td>
      <td>1</td>
      <td>15439</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2007-03-22</td>
      <td>23095</td>
      <td>42</td>
      <td>1</td>
      <td>15442</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2007-03-22</td>
      <td>22615</td>
      <td>598</td>
      <td>1</td>
      <td>15443</td>
      <td>7.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2007-03-22</td>
      <td>22960</td>
      <td>28</td>
      <td>1</td>
      <td>15445</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2007-03-22</td>
      <td>20574</td>
      <td>379</td>
      <td>1</td>
      <td>15446</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2007-03-22</td>
      <td>21651</td>
      <td>490</td>
      <td>1</td>
      <td>15448</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2007-03-22</td>
      <td>20027</td>
      <td>322</td>
      <td>1</td>
      <td>15450</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2007-03-22</td>
      <td>21866</td>
      <td>514</td>
      <td>1</td>
      <td>15451</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2007-03-22</td>
      <td>20370</td>
      <td>359</td>
      <td>1</td>
      <td>15453</td>
      <td>1.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2007-03-22</td>
      <td>24882</td>
      <td>238</td>
      <td>1</td>
      <td>15455</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2007-03-22</td>
      <td>25113</td>
      <td>262</td>
      <td>1</td>
      <td>15456</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2007-03-22</td>
      <td>19906</td>
      <td>306</td>
      <td>1</td>
      <td>15457</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2007-03-22</td>
      <td>22876</td>
      <td>20</td>
      <td>1</td>
      <td>15460</td>
      <td>2.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2007-03-22</td>
      <td>23646</td>
      <td>103</td>
      <td>1</td>
      <td>15461</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2007-03-22</td>
      <td>20675</td>
      <td>389</td>
      <td>1</td>
      <td>15462</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2007-03-22</td>
      <td>23869</td>
      <td>127</td>
      <td>1</td>
      <td>15463</td>
      <td>5.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-03-22</td>
      <td>23283</td>
      <td>62</td>
      <td>1</td>
      <td>15464</td>
      <td>6.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2007-03-22</td>
      <td>21921</td>
      <td>520</td>
      <td>1</td>
      <td>15465</td>
      <td>0.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2007-03-22</td>
      <td>20970</td>
      <td>418</td>
      <td>1</td>
      <td>15466</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2007-03-22</td>
      <td>23647</td>
      <td>103</td>
      <td>1</td>
      <td>15467</td>
      <td>3.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-03-22</td>
      <td>20768</td>
      <td>399</td>
      <td>1</td>
      <td>15468</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2007-03-22</td>
      <td>22610</td>
      <td>597</td>
      <td>1</td>
      <td>15469</td>
      <td>4.99</td>
      <td>23</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2007-03-23</td>
      <td>24692</td>
      <td>215</td>
      <td>1</td>
      <td>15583</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2007-03-23</td>
      <td>21731</td>
      <td>500</td>
      <td>1</td>
      <td>15584</td>
      <td>2.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2007-03-23</td>
      <td>22149</td>
      <td>545</td>
      <td>1</td>
      <td>15585</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2007-03-23</td>
      <td>21723</td>
      <td>499</td>
      <td>1</td>
      <td>15587</td>
      <td>7.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2007-03-23</td>
      <td>21764</td>
      <td>503</td>
      <td>1</td>
      <td>15588</td>
      <td>3.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2007-03-23</td>
      <td>22901</td>
      <td>22</td>
      <td>1</td>
      <td>15589</td>
      <td>6.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2007-03-23</td>
      <td>23284</td>
      <td>62</td>
      <td>1</td>
      <td>15591</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2007-03-23</td>
      <td>24163</td>
      <td>153</td>
      <td>1</td>
      <td>15593</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2007-03-23</td>
      <td>25135</td>
      <td>264</td>
      <td>1</td>
      <td>15595</td>
      <td>4.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2007-03-23</td>
      <td>24478</td>
      <td>186</td>
      <td>1</td>
      <td>15596</td>
      <td>0.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2007-03-23</td>
      <td>23323</td>
      <td>66</td>
      <td>1</td>
      <td>15598</td>
      <td>8.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>34</th>
      <td>2007-03-23</td>
      <td>23648</td>
      <td>103</td>
      <td>1</td>
      <td>15599</td>
      <td>5.99</td>
      <td>4</td>
    </tr>
    <tr>
      <th>35</th>
      <td>2007-03-23</td>
      <td>23729</td>
      <td>113</td>
      <td>1</td>
      <td>15600</td>
      <td>1.99</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<h4 id="r-9">▶ R</h4>

<p>Once again a similar pipeline can be build in R.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R <span class="o">-</span>o df_r

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>date<span class="o">=</span>lubridate<span class="o">::</span><span class="kp">date</span><span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
  filter<span class="p">(</span>date <span class="o">&gt;=</span> <span class="kp">as.Date</span><span class="p">(</span><span class="s">&#39;2007-03-01&#39;</span><span class="p">)</span> <span class="o">&amp;</span>  date <span class="o">&lt;=</span> <span class="kp">as.Date</span><span class="p">(</span><span class="s">&#39;2007-03-31&#39;</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>hour<span class="o">=</span>lubridate<span class="o">::</span>hour<span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
  filter<span class="p">(</span>hour <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="m">23</span><span class="p">)</span> <span class="o">&amp;</span> rental_id <span class="o">&gt;</span> <span class="m">15000</span> <span class="o">&amp;</span> staff_id <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  arrange<span class="p">(</span>payment_date<span class="p">)</span> <span class="o">%&gt;%</span> 
  select<span class="p">(</span><span class="kp">date</span><span class="p">,</span> payment_id<span class="p">,</span> customer_id<span class="p">,</span> staff_id<span class="p">,</span> rental_id<span class="p">,</span> amount<span class="p">,</span> hour<span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="kp">as.data.frame</span><span class="p">()</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
df_r</code></pre></div><div class="highlight"><pre class="chroma">[1] 36  7
         date payment_id customer_id staff_id rental_id amount hour
1  2007-03-22      23134          46        1     15438   2.99   23
2  2007-03-22      23958         136        1     15439   4.99   23
3  2007-03-22      23095          42        1     15442   2.99   23
4  2007-03-22      22615         598        1     15443   7.99   23
5  2007-03-22      22960          28        1     15445   4.99   23
6  2007-03-22      20574         379        1     15446   4.99   23
7  2007-03-22      21651         490        1     15448   2.99   23
8  2007-03-22      20027         322        1     15450   0.99   23
9  2007-03-22      21866         514        1     15451   2.99   23
10 2007-03-22      20370         359        1     15453   1.99   23
11 2007-03-22      24882         238        1     15455   0.99   23
12 2007-03-22      25113         262        1     15456   0.99   23
13 2007-03-22      19906         306        1     15457   2.99   23
14 2007-03-22      22876          20        1     15460   2.99   23
15 2007-03-22      23646         103        1     15461   5.99   23
16 2007-03-22      20675         389        1     15462   5.99   23
17 2007-03-22      23869         127        1     15463   5.99   23
18 2007-03-22      23283          62        1     15464   6.99   23
19 2007-03-22      21921         520        1     15465   0.99   23
20 2007-03-22      20970         418        1     15466   4.99   23
21 2007-03-22      23647         103        1     15467   3.99   23
22 2007-03-22      20768         399        1     15468   4.99   23
23 2007-03-22      22610         597        1     15469   4.99   23
24 2007-03-23      24692         215        1     15583   2.99    4
25 2007-03-23      21731         500        1     15584   2.99    4
26 2007-03-23      22149         545        1     15585   0.99    4
27 2007-03-23      21723         499        1     15587   7.99    4
28 2007-03-23      21764         503        1     15588   3.99    4
29 2007-03-23      22901          22        1     15589   6.99    4
30 2007-03-23      23284          62        1     15591   0.99    4
31 2007-03-23      24163         153        1     15593   1.99    4
32 2007-03-23      25135         264        1     15595   4.99    4
33 2007-03-23      24478         186        1     15596   0.99    4
34 2007-03-23      23323          66        1     15598   8.99    4
35 2007-03-23      23648         103        1     15599   5.99    4
36 2007-03-23      23729         113        1     15600   1.99    4</pre></div>
<hr />

<h3 id="customer-lifetime-value">Customer lifetime value</h3>

<p>Which customers made their first order on a weekend, paid more than \$5, and have a customer lifetime value (total amount spent) which exceeds \$100?</p>

<h4 id="sql-10">▶ SQL</h4>

<p>For this query we need to extract the day of the week for each transaction. This can be done using <code>dow</code>.</p>

<p>Note that in PostgreSQL Sunday is coded as 0, and Saturday as 6.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT t.* FROM (
</span><span class="s1">    SELECT 
</span><span class="s1">        p.*, 
</span><span class="s1">        EXTRACT(dow FROM p.payment_date)::int  dow,
</span><span class="s1">        (
</span><span class="s1">            SELECT SUM(p3.amount) 
</span><span class="s1">            FROM payment p3
</span><span class="s1">            WHERE p3.customer_id = p.customer_id   
</span><span class="s1">        ) as CLV
</span><span class="s1">    FROM 
</span><span class="s1">        payment p
</span><span class="s1">    WHERE 
</span><span class="s1">        p.payment_id = (
</span><span class="s1">            SELECT MIN(p2.payment_id)
</span><span class="s1">            FROM payment p2
</span><span class="s1">            WHERE p.customer_id = p2.customer_id
</span><span class="s1">        ) 
</span><span class="s1">        AND 
</span><span class="s1">            EXTRACT(dow FROM p.payment_date) IN (0, 6)
</span><span class="s1">        AND 
</span><span class="s1">            p.amount &gt; 5     
</span><span class="s1">
</span><span class="s1">    GROUP BY 1
</span><span class="s1">)t WHERE t.CLV &gt; 100
</span><span class="s1">ORDER BY t.CLV DESC
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div><div class="highlight"><pre class="chroma">(17, 8)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
      <th>dow</th>
      <th>clv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>19029</td>
      <td>137</td>
      <td>1</td>
      <td>2469</td>
      <td>6.99</td>
      <td>2007-02-18 18:52:49.996577</td>
      <td>0</td>
      <td>191.62</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18572</td>
      <td>21</td>
      <td>2</td>
      <td>2235</td>
      <td>7.99</td>
      <td>2007-02-18 02:37:16.996577</td>
      <td>0</td>
      <td>146.68</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17526</td>
      <td>346</td>
      <td>1</td>
      <td>1994</td>
      <td>5.99</td>
      <td>2007-02-17 09:35:32.996577</td>
      <td>6</td>
      <td>145.70</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19502</td>
      <td>265</td>
      <td>2</td>
      <td>2027</td>
      <td>7.99</td>
      <td>2007-02-17 11:35:22.996577</td>
      <td>6</td>
      <td>132.72</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17509</td>
      <td>342</td>
      <td>2</td>
      <td>2190</td>
      <td>5.99</td>
      <td>2007-02-17 23:58:17.996577</td>
      <td>6</td>
      <td>130.68</td>
    </tr>
    <tr>
      <th>5</th>
      <td>17866</td>
      <td>436</td>
      <td>1</td>
      <td>2291</td>
      <td>9.99</td>
      <td>2007-02-18 06:05:12.996577</td>
      <td>0</td>
      <td>126.73</td>
    </tr>
    <tr>
      <th>6</th>
      <td>18099</td>
      <td>497</td>
      <td>2</td>
      <td>2180</td>
      <td>8.99</td>
      <td>2007-02-17 23:16:09.996577</td>
      <td>6</td>
      <td>121.73</td>
    </tr>
    <tr>
      <th>7</th>
      <td>18995</td>
      <td>128</td>
      <td>2</td>
      <td>2519</td>
      <td>7.99</td>
      <td>2007-02-18 22:47:47.996577</td>
      <td>0</td>
      <td>118.70</td>
    </tr>
    <tr>
      <th>8</th>
      <td>19496</td>
      <td>263</td>
      <td>2</td>
      <td>2126</td>
      <td>8.99</td>
      <td>2007-02-17 19:23:02.996577</td>
      <td>6</td>
      <td>116.73</td>
    </tr>
    <tr>
      <th>9</th>
      <td>18636</td>
      <td>32</td>
      <td>2</td>
      <td>1887</td>
      <td>6.99</td>
      <td>2007-02-17 02:21:44.996577</td>
      <td>6</td>
      <td>112.74</td>
    </tr>
    <tr>
      <th>10</th>
      <td>19345</td>
      <td>225</td>
      <td>2</td>
      <td>2226</td>
      <td>7.99</td>
      <td>2007-02-18 02:08:22.996577</td>
      <td>0</td>
      <td>111.76</td>
    </tr>
    <tr>
      <th>11</th>
      <td>18395</td>
      <td>579</td>
      <td>2</td>
      <td>2425</td>
      <td>5.99</td>
      <td>2007-02-18 16:06:11.996577</td>
      <td>0</td>
      <td>111.73</td>
    </tr>
    <tr>
      <th>12</th>
      <td>18554</td>
      <td>16</td>
      <td>2</td>
      <td>1934</td>
      <td>6.99</td>
      <td>2007-02-17 05:33:23.996577</td>
      <td>6</td>
      <td>109.75</td>
    </tr>
    <tr>
      <th>13</th>
      <td>18666</td>
      <td>40</td>
      <td>2</td>
      <td>2470</td>
      <td>7.99</td>
      <td>2007-02-18 18:56:57.996577</td>
      <td>0</td>
      <td>105.74</td>
    </tr>
    <tr>
      <th>14</th>
      <td>18446</td>
      <td>593</td>
      <td>2</td>
      <td>2055</td>
      <td>5.99</td>
      <td>2007-02-17 13:55:29.996577</td>
      <td>6</td>
      <td>101.76</td>
    </tr>
    <tr>
      <th>15</th>
      <td>18367</td>
      <td>572</td>
      <td>2</td>
      <td>1889</td>
      <td>10.99</td>
      <td>2007-02-17 02:33:38.996577</td>
      <td>6</td>
      <td>100.76</td>
    </tr>
    <tr>
      <th>16</th>
      <td>19441</td>
      <td>251</td>
      <td>1</td>
      <td>2238</td>
      <td>6.99</td>
      <td>2007-02-18 02:50:32.996577</td>
      <td>0</td>
      <td>100.75</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-10">▶ Python</h4>

<p>Let&rsquo;s break the pipeline in two parts.
First we compute the subset of customers who placed their first order on a week-end.</p>

<p>Note that unlike PostgreSQL, pandas codes Saturday as 5 and Sunday as 6.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">subset_fo</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dow</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">payment_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">)</span> <span class="c1"># extract the day of the week as an integer</span>
               <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;payment_date&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;rental_id&#39;</span><span class="p">,</span> <span class="s1">&#39;staff_id&#39;</span><span class="p">,</span> <span class="s1">&#39;dow&#39;</span><span class="p">]]</span>
               <span class="o">.</span><span class="n">first</span><span class="p">()</span>                                         <span class="c1"># pick the first row for each group</span>
               <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(amount &gt; 5) &amp; (dow in [5, 6])&#39;</span><span class="p">)</span>
             <span class="p">)</span>
<span class="n">subset_fo</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_date</th>
      <th>payment_id</th>
      <th>amount</th>
      <th>rental_id</th>
      <th>staff_id</th>
      <th>dow</th>
    </tr>
    <tr>
      <th>customer_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>16</th>
      <td>2007-02-17 05:33:23.996577</td>
      <td>18554</td>
      <td>6.99</td>
      <td>1934</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2007-02-17 22:46:24.996577</td>
      <td>18558</td>
      <td>5.99</td>
      <td>2175</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2007-02-18 02:37:16.996577</td>
      <td>18572</td>
      <td>7.99</td>
      <td>2235</td>
      <td>2</td>
      <td>6</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2007-02-17 02:21:44.996577</td>
      <td>18636</td>
      <td>6.99</td>
      <td>1887</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>40</th>
      <td>2007-02-18 18:56:57.996577</td>
      <td>18666</td>
      <td>7.99</td>
      <td>2470</td>
      <td>2</td>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div>

<p>We then join the payment table on this subset to get the information we want.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">payment</span>
       <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">payment</span><span class="o">.</span><span class="n">customer_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">subset_fo</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;amount&#39;</span><span class="p">]]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span><span class="s1">&#39;clv&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;clv &gt;= 100&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subset_fo</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;clv&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df_sql</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df</span></code></pre></div><div class="highlight"><pre class="chroma">(17, 8)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>payment_id</th>
      <th>customer_id</th>
      <th>staff_id</th>
      <th>rental_id</th>
      <th>amount</th>
      <th>payment_date</th>
      <th>dow</th>
      <th>clv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>19029</td>
      <td>137</td>
      <td>1</td>
      <td>2469</td>
      <td>6.99</td>
      <td>2007-02-18 18:52:49.996577</td>
      <td>6</td>
      <td>191.62</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18572</td>
      <td>21</td>
      <td>2</td>
      <td>2235</td>
      <td>7.99</td>
      <td>2007-02-18 02:37:16.996577</td>
      <td>6</td>
      <td>146.68</td>
    </tr>
    <tr>
      <th>2</th>
      <td>17526</td>
      <td>346</td>
      <td>1</td>
      <td>1994</td>
      <td>5.99</td>
      <td>2007-02-17 09:35:32.996577</td>
      <td>5</td>
      <td>145.70</td>
    </tr>
    <tr>
      <th>3</th>
      <td>19502</td>
      <td>265</td>
      <td>2</td>
      <td>2027</td>
      <td>7.99</td>
      <td>2007-02-17 11:35:22.996577</td>
      <td>5</td>
      <td>132.72</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17509</td>
      <td>342</td>
      <td>2</td>
      <td>2190</td>
      <td>5.99</td>
      <td>2007-02-17 23:58:17.996577</td>
      <td>5</td>
      <td>130.68</td>
    </tr>
    <tr>
      <th>5</th>
      <td>17866</td>
      <td>436</td>
      <td>1</td>
      <td>2291</td>
      <td>9.99</td>
      <td>2007-02-18 06:05:12.996577</td>
      <td>6</td>
      <td>126.73</td>
    </tr>
    <tr>
      <th>6</th>
      <td>18099</td>
      <td>497</td>
      <td>2</td>
      <td>2180</td>
      <td>8.99</td>
      <td>2007-02-17 23:16:09.996577</td>
      <td>5</td>
      <td>121.73</td>
    </tr>
    <tr>
      <th>7</th>
      <td>18995</td>
      <td>128</td>
      <td>2</td>
      <td>2519</td>
      <td>7.99</td>
      <td>2007-02-18 22:47:47.996577</td>
      <td>6</td>
      <td>118.70</td>
    </tr>
    <tr>
      <th>8</th>
      <td>19496</td>
      <td>263</td>
      <td>2</td>
      <td>2126</td>
      <td>8.99</td>
      <td>2007-02-17 19:23:02.996577</td>
      <td>5</td>
      <td>116.73</td>
    </tr>
    <tr>
      <th>9</th>
      <td>18636</td>
      <td>32</td>
      <td>2</td>
      <td>1887</td>
      <td>6.99</td>
      <td>2007-02-17 02:21:44.996577</td>
      <td>5</td>
      <td>112.74</td>
    </tr>
    <tr>
      <th>10</th>
      <td>19345</td>
      <td>225</td>
      <td>2</td>
      <td>2226</td>
      <td>7.99</td>
      <td>2007-02-18 02:08:22.996577</td>
      <td>6</td>
      <td>111.76</td>
    </tr>
    <tr>
      <th>11</th>
      <td>18395</td>
      <td>579</td>
      <td>2</td>
      <td>2425</td>
      <td>5.99</td>
      <td>2007-02-18 16:06:11.996577</td>
      <td>6</td>
      <td>111.73</td>
    </tr>
    <tr>
      <th>12</th>
      <td>18554</td>
      <td>16</td>
      <td>2</td>
      <td>1934</td>
      <td>6.99</td>
      <td>2007-02-17 05:33:23.996577</td>
      <td>5</td>
      <td>109.75</td>
    </tr>
    <tr>
      <th>13</th>
      <td>18666</td>
      <td>40</td>
      <td>2</td>
      <td>2470</td>
      <td>7.99</td>
      <td>2007-02-18 18:56:57.996577</td>
      <td>6</td>
      <td>105.74</td>
    </tr>
    <tr>
      <th>14</th>
      <td>18446</td>
      <td>593</td>
      <td>2</td>
      <td>2055</td>
      <td>5.99</td>
      <td>2007-02-17 13:55:29.996577</td>
      <td>5</td>
      <td>101.76</td>
    </tr>
    <tr>
      <th>15</th>
      <td>18367</td>
      <td>572</td>
      <td>2</td>
      <td>1889</td>
      <td>10.99</td>
      <td>2007-02-17 02:33:38.996577</td>
      <td>5</td>
      <td>100.76</td>
    </tr>
    <tr>
      <th>16</th>
      <td>19441</td>
      <td>251</td>
      <td>1</td>
      <td>2238</td>
      <td>6.99</td>
      <td>2007-02-18 02:50:32.996577</td>
      <td>6</td>
      <td>100.75</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="o">==</span><span class="n">df_sql</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<h4 id="r-10">▶ R</h4>

<p>Let&rsquo;s do the same with R. We&rsquo;ll drop the <code>payment_date</code> column at the end so that we can fit all the remaining columns horizontally.</p>

<p>Of course, R (lubridate) uses yet another encoding for the days of the week. Saturday is represented as 7 and Sunday as 1.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R

subset_fo <span class="o">=</span> payment <span class="o">%&gt;%</span> 
              group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
              mutate<span class="p">(</span>dow<span class="o">=</span>lubridate<span class="o">::</span>wday<span class="p">(</span>payment_date<span class="p">))</span> <span class="o">%&gt;%</span> 
              filter<span class="p">(</span>row_number<span class="p">()</span><span class="o">==</span><span class="m">1</span> <span class="o">&amp;</span> dow<span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span> <span class="o">&amp;</span> amount<span class="o">&gt;</span><span class="m">5</span><span class="p">)</span> 

df_r <span class="o">=</span> payment <span class="o">%&gt;%</span> 
        right_join<span class="p">(</span>subset_fo<span class="p">,</span> by<span class="o">=</span><span class="s">&#34;customer_id&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        group_by<span class="p">(</span>customer_id<span class="p">)</span> <span class="o">%&gt;%</span> 
        summarise<span class="p">(</span>clv<span class="o">=</span><span class="kp">sum</span><span class="p">(</span>amount.x<span class="p">))</span> <span class="o">%&gt;%</span> 
        filter<span class="p">(</span>clv <span class="o">&gt;</span> <span class="m">100</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        left_join<span class="p">(</span>subset_fo<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;customer_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
        select<span class="p">(</span>payment_id<span class="p">,</span> customer_id<span class="p">,</span> staff_id<span class="p">,</span> rental_id<span class="p">,</span> amount<span class="p">,</span> payment_date<span class="p">,</span> dow<span class="p">,</span> clv<span class="p">)</span> <span class="o">%&gt;%</span> 
        arrange<span class="p">(</span>desc<span class="p">(</span>clv<span class="p">))</span> <span class="o">%&gt;%</span>
        select<span class="p">(</span><span class="o">-</span>payment_date<span class="p">)</span>

<span class="kp">print</span><span class="p">(</span><span class="kp">dim</span><span class="p">(</span>df_r<span class="p">))</span>
<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[1] 17  7
   payment_id customer_id staff_id rental_id amount dow    clv
1       19029         137        1      2469   6.99   1 191.62
2       18572          21        2      2235   7.99   1 146.68
3       17526         346        1      1994   5.99   7 145.70
4       19502         265        2      2027   7.99   7 132.72
5       17509         342        2      2190   5.99   7 130.68
6       17866         436        1      2291   9.99   1 126.73
7       18099         497        2      2180   8.99   7 121.73
8       18995         128        2      2519   7.99   1 118.70
9       19496         263        2      2126   8.99   7 116.73
10      18636          32        2      1887   6.99   7 112.74
11      19345         225        2      2226   7.99   1 111.76
12      18395         579        2      2425   5.99   1 111.73
13      18554          16        2      1934   6.99   7 109.75
14      18666          40        2      2470   7.99   1 105.74
15      18446         593        2      2055   5.99   7 101.76
16      18367         572        2      1889  10.99   7 100.76
17      19441         251        1      2238   6.99   1 100.75</pre></div>
<hr />

<h3 id="how-many-movies-have-a-replacement-cost-above-or-below-the-average-replacement-cost">How many movies have a replacement cost above or below the average replacement cost?</h3>

<p>Once way to answer this is to compute how many movies have a replacement cost higher than the average, how many
have a replacement cost lower or equal to the average, and take the union of the two.</p>

<h4 id="sql-11">▶ SQL</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">SELECT t.grouping, COUNT(*) FROM (
</span><span class="s1">    SELECT f.*, &#39;above&#39; as grouping
</span><span class="s1">    FROM film f
</span><span class="s1">    WHERE f.replacement_cost &gt; (SELECT AVG(f2.replacement_cost) FROM film f2) 
</span><span class="s1">
</span><span class="s1">    UNION 
</span><span class="s1">
</span><span class="s1">    SELECT f.*, &#39;below_eq&#39; as grouping
</span><span class="s1">    FROM film f
</span><span class="s1">    WHERE f.replacement_cost &lt;= (SELECT AVG(f2.replacement_cost) FROM film f2) 
</span><span class="s1">    )t 
</span><span class="s1">GROUP BY 1
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_sql</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">df_sql</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(2, 2)</pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>grouping</th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>below_eq</td>
      <td>464</td>
    </tr>
    <tr>
      <th>1</th>
      <td>above</td>
      <td>536</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-11">▶ Python</h4>

<p>The Python syntax is definitely simpler here because we can create a Boolean mask telling us whether the replacement cost is above average, and then use <code>value_counts</code> to tally up the <code>True</code> and <code>False</code> counts.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="p">(</span><span class="n">film</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">above</span><span class="o">=</span><span class="n">film</span><span class="o">.</span><span class="n">replacement_cost</span> <span class="o">&gt;</span> <span class="n">film</span><span class="o">.</span><span class="n">replacement_cost</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
  <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;above&#39;</span><span class="p">]</span>
  <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
  <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">{</span><span class="bp">True</span><span class="p">:</span> <span class="s1">&#39;above&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">:</span> <span class="s1">&#39;below_eq&#39;</span><span class="p">})</span>
<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">above       536
below_eq    464
Name: above, dtype: int64</pre></div>
<h4 id="r-11">▶  R</h4>

<p>The R code is similar to the Python one.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
film <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>above<span class="o">=</span>replacement_cost<span class="o">&gt;</span><span class="kp">mean</span><span class="p">(</span>film<span class="o">$</span>replacement_cost<span class="p">))</span> <span class="o">%&gt;%</span> 
  count<span class="p">(</span>above<span class="p">)</span> <span class="o">%&gt;%</span> 
  mutate<span class="p">(</span>above<span class="o">=</span>if_else<span class="p">(</span>above<span class="p">,</span> <span class="s">&#39;above&#39;</span><span class="p">,</span> <span class="s">&#39;below_eq&#39;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"># A tibble: 2 x 2
  above        n
  &lt;chr&gt;    &lt;int&gt;
1 below_eq   464
2 above      536</pre></div>
<hr />

<h3 id="which-movie-generated-the-more-revenue-for-each-viewer-rating-category">Which movie generated the more revenue, for each viewer rating category?</h3>

<h4 id="sql-12">▶ SQL</h4>

<p>The grouping by rating part is straightforward, however, we want the <em>top performing movie</em> within each group.
We can use a window function (the <code>OVER</code> part) to do this.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">WITH some_table AS (
</span><span class="s1">    SELECT 
</span><span class="s1">        f.film_id, 
</span><span class="s1">        f.title, 
</span><span class="s1">        f.rating, 
</span><span class="s1">        SUM(p.amount),
</span><span class="s1">        ROW_NUMBER() OVER(PARTITION BY f.rating ORDER BY SUM(p.amount) DESC)
</span><span class="s1">
</span><span class="s1">    FROM film f
</span><span class="s1">    JOIN inventory i ON f.film_id = i.film_id
</span><span class="s1">    JOIN rental r ON r.inventory_id = i.inventory_id
</span><span class="s1">    JOIN payment p ON p.rental_id = r.rental_id
</span><span class="s1">    GROUP BY 1, 2, 3
</span><span class="s1">    ORDER BY 3) 
</span><span class="s1">    
</span><span class="s1">SELECT st.* FROM some_table st 
</span><span class="s1">WHERE st.row_number = 1
</span><span class="s1">ORDER BY 4 DESC
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_sql</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">con</span><span class="p">)</span>
<span class="n">df_sql</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rating</th>
      <th>sum</th>
      <th>row_number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>879</td>
      <td>Telegraph Voyage</td>
      <td>PG</td>
      <td>215.75</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1000</td>
      <td>Zorro Ark</td>
      <td>NC-17</td>
      <td>199.72</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>460</td>
      <td>Innocent Usual</td>
      <td>PG-13</td>
      <td>191.74</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>764</td>
      <td>Saturday Lambs</td>
      <td>G</td>
      <td>190.74</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>938</td>
      <td>Velvet Terminator</td>
      <td>R</td>
      <td>152.77</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="python-12">▶ Python</h4>

<p>The pattern below is a common one. We group by some features to compute an aggregate measure, and then ungroup (<code>reset_index</code>) to group the data again at a different level of granularity.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">film</span>
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">inventory</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>    
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rental</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;inventory_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">payment</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;rental_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;film_id&#39;</span><span class="p">])[[</span><span class="s1">&#39;amount&#39;</span><span class="p">]]</span>
       <span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">first</span><span class="p">()</span>
       <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">film</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
       <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
       <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;film_id&#39;</span><span class="p">,</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;sum&#39;</span><span class="p">]]</span>
      <span class="p">)</span>

<span class="n">df</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>film_id</th>
      <th>title</th>
      <th>rating</th>
      <th>sum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>879</td>
      <td>Telegraph Voyage</td>
      <td>PG</td>
      <td>215.75</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1000</td>
      <td>Zorro Ark</td>
      <td>NC-17</td>
      <td>199.72</td>
    </tr>
    <tr>
      <th>2</th>
      <td>460</td>
      <td>Innocent Usual</td>
      <td>PG-13</td>
      <td>191.74</td>
    </tr>
    <tr>
      <th>3</th>
      <td>764</td>
      <td>Saturday Lambs</td>
      <td>G</td>
      <td>190.74</td>
    </tr>
    <tr>
      <th>4</th>
      <td>938</td>
      <td>Velvet Terminator</td>
      <td>R</td>
      <td>152.77</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="r-12">▶ R</h4>

<p>This the same approach as in Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-r" data-lang="r"><span class="o">%%</span>R
df_r <span class="o">=</span> film <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>inventory<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;film_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>rental<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;inventory_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>payment<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;rental_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  group_by<span class="p">(</span>rating<span class="p">,</span> film_id<span class="p">)</span> <span class="o">%&gt;%</span> 
  summarise<span class="p">(</span>sum<span class="o">=</span><span class="kp">sum</span><span class="p">(</span>amount<span class="p">,</span> na.rm<span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  ungroup<span class="p">()</span> <span class="o">%&gt;%</span> 
  arrange<span class="p">(</span>desc<span class="p">(</span><span class="kp">sum</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  group_by<span class="p">(</span>rating<span class="p">)</span> <span class="o">%&gt;%</span> 
  filter<span class="p">(</span>row_number<span class="p">()</span><span class="o">==</span><span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  left_join<span class="p">(</span>film<span class="p">,</span> by<span class="o">=</span><span class="s">&#39;film_id&#39;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  select<span class="p">(</span>film_id<span class="p">,</span> title<span class="p">,</span> rating.x<span class="p">,</span> <span class="kp">sum</span><span class="p">)</span> 

<span class="kp">as.data.frame</span><span class="p">(</span>df_r<span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">  film_id             title rating.x    sum
1     879  Telegraph Voyage       PG 215.75
2    1000         Zorro Ark    NC-17 199.72
3     460    Innocent Usual    PG-13 191.74
4     764    Saturday Lambs        G 190.74
5     938 Velvet Terminator        R 152.77</pre></div>
<hr />

<p>Hopefully, the examples above show that a significant part of the syntax used to wrangle structured data (data arranged in tables), in both Python (pandas) and R (tidyverse), has been influenced by SQL.</p>

<p>Many of the pipelines we built are comprised of the same steps as the corresponding SQL query. This is especially true for basic queries where we do
simple things like group by columns or build a simple aggregate measure.
Similarly, syntactic differences aside, joining operations work in a comparable way across the three languages.</p>

<p>As we consider more complex operations, however, a direct port of the SQL querie to the other languages may not be the most optimal way.
We saw a small example of this when we computed which days in March had no rentals.
The good news, however, is that these languages aren&rsquo;t mutually exclusive. After all, we did run all our SQL via Python (pandas).
Rather these languages complement each other and can be used in conjunction to build pipelines that can perform complex manipulation of the data in an
efficient way. Very often, SQL is used to first extract a subset of the data from a large database, which can then be manipulated and transformed further in Python or R.</p>

<p>To steal a line from  Alexandre Dumas&rsquo; The Three Musketeers, this is truly a case of <em>All for one and one for all</em>!</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/sql/">sql</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/r/">r</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/pandas/">pandas</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/tidyverse/">tidyverse</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/data-wrangling/">data wrangling</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2019/01/regex_intro/">
                <h2 class="post-title">Introduction to regular expressions</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on January 30, 2019
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;18&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3625&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  <div style="background-color:#FBEFFB;">
<hr style="height:5px;border:none;color:#333;background-color:#333;" />
<h3>Jamie Zawinski:</h3>
<blockquote><b>Some people, when confronted with a problem, think <em>"I know, I'll use regular expressions".</em> <br>Now they have two problems.</b></blockquote>

<hr style="height:5px;border:none;color:#333;background-color:#333;" />
</div>

<div>
<h2> 1. Prelude:</h2>
<h4>Regular expressions are powerful...</h4>
<br>
<figure>
<img src="http://imgs.xkcd.com/comics/regular_expressions.png" width="500">
<figcaption><center>http://xkcd.com/208/</center></figcaption>
</figure>

<br />
<br />
<h4> ...but at first, they can be puzzling.</h4>
<br>
<figure>
<img src="http://imgs.xkcd.com/comics/perl_problems.png" width="600">
<figcaption><center>http://xkcd.com/1171/</center></figcaption>
</figure>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:90% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:90% !important; }</style>

<div>
<h2> 2. Introduction</h2>
<p>A regular expression (<a href="http://en.wikipedia.org/wiki/Regular_expression">regex</a>) is a sequence of literal characters, and metacharacters, which defines <b>search patterns</b>. </p>

<p>Most programming languages have some implementation of regular expressions, however, their syntax may vary.</p>

<p>One basic example is the asterisk used as a wildcard by most file systems to denote any number of characters. </p>

<p>For instance, <code>*.txt</code> 
denotes all files with a <code>.txt</code> extension.</p>

<p>The most elementary search pattern is the one that consists of the very characters you're looking for. </p>

<p>The <code>find</code> method of strings does just that.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span> <span class="o">=</span> <span class="s2">&#34;To be or not to be&#34;</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;not&#39;</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;question&#39;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">9 -1</pre></div>
<p><strong>For a more general, and powerful approach to pattern searching, Python has the <code>re</code> module</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">re</span></code></pre></div>
<p>We&rsquo;ll use the opening paragraphs from <em>A Tale of Two Cities</em> as an example.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dickens</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">It was the best of times, it was the worst of times, 
</span><span class="s1">it was the age of wisdom, it was the age of foolishness, it was the epoch of belief,
</span><span class="s1">it was the epoch of incredulity, it was the season of Light, it was the season of Darkness,
</span><span class="s1">it was the spring of hope, it was the winter of despair, we had everything before us, we had
</span><span class="s1">nothing before us, we were all going direct to Heaven, we were all going direct the other way -
</span><span class="s1">in short, the period was so far like the present period, that some of its noisiest authorities
</span><span class="s1">insisted on its being received, for good or for evil, in the superlative degree of comparison only.
</span><span class="s1">
</span><span class="s1">There were a king with a large jaw and a queen with a plain face, on the
</span><span class="s1">throne of England; there were a king with a large jaw and a queen with
</span><span class="s1">a fair face, on the throne of France. In both countries it was clearer
</span><span class="s1">than crystal to the lords of the State preserves of loaves and fishes,
</span><span class="s1">that things in general were settled for ever.
</span><span class="s1">
</span><span class="s1">It was the year of Our Lord one thousand seven hundred and seventy-five.
</span><span class="s1">Spiritual revelations were conceded to England at that favoured period,
</span><span class="s1">as at this. Mrs. Southcott had recently attained her five-and-twentieth
</span><span class="s1">blessed birthday, of whom a prophetic private in the Life Guards had
</span><span class="s1">heralded the sublime appearance by announcing that arrangements were
</span><span class="s1">made for the swallowing up of London and Westminster. Even the Cock-lane
</span><span class="s1">ghost had been laid only a round dozen of years, after rapping out its
</span><span class="s1">messages, as the spirits of this very year last past (supernaturally
</span><span class="s1">deficient in originality) rapped out theirs. Mere messages in the
</span><span class="s1">earthly order of events had lately come to the English Crown and People,
</span><span class="s1">from a congress of British subjects in America: which, strange
</span><span class="s1">to relate, have proved more important to the human race than any
</span><span class="s1">communications yet received through any of the chickens of the Cock-lane
</span><span class="s1">brood.
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div>
<h3> <center><font color=MediumVioletRed>A. Literals</font></center></h3>

<p><strong>The <code>search</code> method of the <code>re</code> module returns a <code>_sre.SRE_Match</code> object which has some useful properties.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">&lt;class &#39;_sre.SRE_Match&#39;&gt;
end
endpos
expand
group
groupdict
groups
lastgroup
lastindex
pos
re
regs
span
start
string</pre></div>
<p><strong>The result of the search will tell us if, and where the pattern is found in the string.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;result.span(): &#34;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">span</span><span class="p">())</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34;result.group():&#34;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="n">dickens</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span></code></pre></div><div class="highlight"><pre class="chroma">result.span():  (20, 25)
result.group(): times
times</pre></div>
<p><strong>There are other useful functions for finding a pattern beside the <code>search</code> function.</h4></strong></p>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3><br />
If a search pattern is to be reused, it is faster to <em>compile</em> it first. We'll do that henceforth.
 <br>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;times&#39;</span><span class="p">)</span>

<span class="c1"># only matches the beginning of the string.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;match:  &#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

<span class="c1"># search for first match</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;search: &#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

<span class="c1"># returns a list of all matches.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;findall:&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">match:   None
search:  times
findall: [&#39;times&#39;, &#39;times&#39;]</pre></div>
<div style="background-color:#F7F2E0;">
<h4> <font color=MediumVioletRed>Note:</font> </h4>
<p>What we've used above is an example of search pattern involving literals. 
<b>The pattern was the very string we were looking for.</b></p>

<p>Notice that we didn't have to worry about punctuation. The pattern is the only sub-string returned by the <code>search</code> or <code>findall</code> function, if it is found.</p>
</div>

<h3> <center><font color=MediumVioletRed>B. Character classes</font></center></h3>

<p>Sometimes we&rsquo;d like to consider variants of a string. For, instance, <code>&quot;It&quot;</code> and <code>&quot;it&quot;</code>.</p>

<p>This means that we need to look for <strong>either</strong> an uppercase &ldquo;i&rdquo; or a lowercase one, followed by the letter &ldquo;t&rdquo;.</p>

<p>Character classes are specified using <strong>square brackets</strong>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[Ii]t&#39;</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;It&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;]</pre></div>
<p>This is a simple example of character set.</p>

<p><code>[Ii]</code> means match <b>any one</b> of the characters between the square brackets.</p>

<p>Using character sets allows us to greatly simplify our syntax.</p>

<p>Python has some <b>predefined character sets</b> which help us write compact code.</p>

<table style="width:90%">
  <th>Character Class
  </th>
  <th>Matches
  </th>
  <tr>
      <td><code>[A-Z]</code></td>
      <td><b>any single</b> letter of the Latin alphabet in uppercase</td> 
  </tr>
  <tr>
      <td><code>[a-z]</code></td>
      <td><b>any single</b>  letter of the Latin alphabet in uppercase</td> 
  </tr>
  <tr>
      <td><code>[A-z]</code></td>
      <td><b>any single</b>  letter of the Latin alphabet in either lowercase or uppercase</td> 
  </tr>
  <tr>
      <td><code>[0-9]</code></td>
      <td><b>any single digit</b> between 0 and 9</td> 
  </tr>  <tr>
    <td><code>[^0-9]</code></td>
    <td><b>any character except for single digit</b> between 0 and 9</td> 
  </tr>
</table>

<p>Here's an example:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[0-9]&#39;</span><span class="p">,</span> <span class="s2">&#34;Today is the 23rd of May&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;2&#39;, &#39;3&#39;]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-z]&#39;</span><span class="p">,</span> <span class="s2">&#34;Today is the 23rd of May&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;T&#39;,
 &#39;o&#39;,
 &#39;d&#39;,
 &#39;a&#39;,
 &#39;y&#39;,
 &#39;i&#39;,
 &#39;s&#39;,
 &#39;t&#39;,
 &#39;h&#39;,
 &#39;e&#39;,
 &#39;r&#39;,
 &#39;d&#39;,
 &#39;o&#39;,
 &#39;f&#39;,
 &#39;M&#39;,
 &#39;a&#39;,
 &#39;y&#39;]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^A-z ]&#39;</span><span class="p">,</span> <span class="s2">&#34;Today is the 23rd of May&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;2&#39;, &#39;3&#39;]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^0-9]&#39;</span><span class="p">,</span> <span class="s2">&#34;Today is the 23rd of May&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;T&#39;,
 &#39;o&#39;,
 &#39;d&#39;,
 &#39;a&#39;,
 &#39;y&#39;,
 &#39; &#39;,
 &#39;i&#39;,
 &#39;s&#39;,
 &#39; &#39;,
 &#39;t&#39;,
 &#39;h&#39;,
 &#39;e&#39;,
 &#39; &#39;,
 &#39;r&#39;,
 &#39;d&#39;,
 &#39; &#39;,
 &#39;o&#39;,
 &#39;f&#39;,
 &#39; &#39;,
 &#39;M&#39;,
 &#39;a&#39;,
 &#39;y&#39;]</pre></div>
<p>Back to our long string.</p>

<p>If we were searching for a substring made of any single uppercase letter followed by any single lower case letter
we could write:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z][a-z]&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;Li&#39;, &#39;Da&#39;, &#39;He&#39;, &#39;Th&#39;, &#39;En&#39;, &#39;Fr&#39;, &#39;In&#39;, &#39;St&#39;, &#39;It&#39;, &#39;Ou&#39;, &#39;Lo&#39;, &#39;Sp&#39;, &#39;En&#39;, &#39;Mr&#39;, &#39;So&#39;, &#39;Li&#39;, &#39;Gu&#39;, &#39;Lo&#39;, &#39;We&#39;, &#39;Ev&#39;, &#39;Co&#39;, &#39;Me&#39;, &#39;En&#39;, &#39;Cr&#39;, &#39;Pe&#39;, &#39;Br&#39;, &#39;Am&#39;, &#39;Co&#39;]</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<ul>
<li>Notice that except for a couple of elements in the list, we didn't get entire words. 
</li><br>
<li>The regular expression only specifies a pattern with one uppercase letter, followed by one lower case letter.</li><br>
<li>That's usually not what you're after. You'd probably want to extract <b>whole words</b> which start with an uppercase letter, followed by any number of lowercase letters (capitalised words).  </li>
</ul>

</div>

<p><strong>Maybe all we need is to add more <code>[a-z]</code> sets to our patterns? Let&rsquo;s try that&hellip;</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z][a-z][a-z]&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;Lig&#39;, &#39;Dar&#39;, &#39;Hea&#39;, &#39;The&#39;, &#39;Eng&#39;, &#39;Fra&#39;, &#39;Sta&#39;, &#39;Our&#39;, &#39;Lor&#39;, &#39;Spi&#39;, &#39;Eng&#39;, &#39;Mrs&#39;, &#39;Sou&#39;, &#39;Lif&#39;, &#39;Gua&#39;, &#39;Lon&#39;, &#39;Wes&#39;, &#39;Eve&#39;, &#39;Coc&#39;, &#39;Mer&#39;, &#39;Eng&#39;, &#39;Cro&#39;, &#39;Peo&#39;, &#39;Bri&#39;, &#39;Ame&#39;, &#39;Coc&#39;]</pre></div>
<p><strong>That&rsquo;s not really what we want.</strong></p>

<p>Sure we&rsquo;ve now got one more lowercase letter after the first, uppercase one, but we still don&rsquo;t have whole words, unless our string contains capitalised, three-letter words. To top it off, we&rsquo;ve now lost <code>&quot;It&quot;</code>!</p>

<p>In other words, unless you want to only extract capitalised words, with a <strong>specific number of letter</strong>, this is not the way to go.</p>

<p>Actually, even in that case, this is not a smart way to do it.</p>

<p>If we wanted to find all the capitalised words that are, say, 10 letters long, we don&rsquo;t really want to have to type a pattern such as:</p>
<div class="highlight"><pre class="chroma">[A-Z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z][a-z]</pre></div>
<p>We need a way to specify that we want <strong>one or more</strong> lowercase letters.</p>

<p>For this we need more than literals or character sets, we need <strong>metacharacters</strong>.</p>

<h3><center><font color=MediumVioletRed>C. Metacharacters</font></center></h3>

<p>Literals are characters which are simply part of the pattern we are looking for.</p>

<p>Metacharacters, on the other hand, act like <b>modifiers</b>. They change how the literals, or character classes are handled.</p>

<p>By default each literal is matched only once. By using the <code>+</code> symbol, any character or character class appearing <b>just before</b>  the metacharacter will be matched <b>one or more times</b>.</p>

<p>There are several modifiers that we can use.</p>

<table style="width:60%">
  <th>Modifier
  </th>
  <th>Number of occurences
  </th>
  <tr>
      <td><code>+</code></td>
    <td><b>one</b> or more</td> 
  </tr>
  <tr>
      <td><code>*</code></td>
    <td><b>zero</b> or more</td> 
  </tr>
  <tr>
      <td><code>?</code></td>
    <td>zero or one</td> 
  </tr>
  <tr>
      <td><code>{m}</code></td>
      <td><code>m</code> times</td> 
  </tr> 
  <tr>
      <td><code>{m, n}</code></td>
      <td>between <code>m</code> and <code>n</code> times</td> 
  </tr> 
</table>

<p>For instance, if we wanted to extract a list of the words that are capitalised in a string, in the past we may have written something like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">([</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">dickens</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">()])</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;Light,&#39;, &#39;Darkness,&#39;, &#39;Heaven,&#39;, &#39;There&#39;, &#39;England;&#39;, &#39;France.&#39;, &#39;In&#39;, &#39;State&#39;, &#39;It&#39;, &#39;Our&#39;, &#39;Lord&#39;, &#39;Spiritual&#39;, &#39;England&#39;, &#39;Mrs.&#39;, &#39;Southcott&#39;, &#39;Life&#39;, &#39;Guards&#39;, &#39;London&#39;, &#39;Westminster.&#39;, &#39;Even&#39;, &#39;Cock-lane&#39;, &#39;Mere&#39;, &#39;English&#39;, &#39;Crown&#39;, &#39;People,&#39;, &#39;British&#39;, &#39;America:&#39;, &#39;Cock-lane&#39;]</pre></div>
<p>Notice, however, that some of the words have punctuation symbols attached to them.</p>

<p>No big deal, we know how to deal with this.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">string</span> 
<span class="k">print</span><span class="p">([</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">dickens</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">()])</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;Light&#39;, &#39;Darkness&#39;, &#39;Heaven&#39;, &#39;There&#39;, &#39;England&#39;, &#39;France&#39;, &#39;In&#39;, &#39;State&#39;, &#39;It&#39;, &#39;Our&#39;, &#39;Lord&#39;, &#39;Spiritual&#39;, &#39;England&#39;, &#39;Mrs&#39;, &#39;Southcott&#39;, &#39;Life&#39;, &#39;Guards&#39;, &#39;London&#39;, &#39;Westminster&#39;, &#39;Even&#39;, &#39;Cock-lane&#39;, &#39;Mere&#39;, &#39;English&#39;, &#39;Crown&#39;, &#39;People&#39;, &#39;British&#39;, &#39;America&#39;, &#39;Cock-lane&#39;]</pre></div>
<p>That worked fine, however the syntax is a bit unwieldy.</p>

<p>Another version could be.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">string</span> 
<span class="k">print</span><span class="p">([</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">dickens</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
 <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">istitle</span><span class="p">()])</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;Light&#39;, &#39;Darkness&#39;, &#39;Heaven&#39;, &#39;There&#39;, &#39;England&#39;, &#39;France&#39;, &#39;In&#39;, &#39;State&#39;, &#39;It&#39;, &#39;Our&#39;, &#39;Lord&#39;, &#39;Spiritual&#39;, &#39;England&#39;, &#39;Mrs&#39;, &#39;Southcott&#39;, &#39;Life&#39;, &#39;Guards&#39;, &#39;London&#39;, &#39;Westminster&#39;, &#39;Even&#39;, &#39;Mere&#39;, &#39;English&#39;, &#39;Crown&#39;, &#39;People&#39;, &#39;British&#39;, &#39;America&#39;]</pre></div>
<p>Notice, however, that we lost a word&hellip;</p>

<p><strong>Using a regular expression, we can specify character sets which match our pattern.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z][a-z]+&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;Light&#39;, &#39;Darkness&#39;, &#39;Heaven&#39;, &#39;There&#39;, &#39;England&#39;, &#39;France&#39;, &#39;In&#39;, &#39;State&#39;, &#39;It&#39;, &#39;Our&#39;, &#39;Lord&#39;, &#39;Spiritual&#39;, &#39;England&#39;, &#39;Mrs&#39;, &#39;Southcott&#39;, &#39;Life&#39;, &#39;Guards&#39;, &#39;London&#39;, &#39;Westminster&#39;, &#39;Even&#39;, &#39;Cock&#39;, &#39;Mere&#39;, &#39;English&#39;, &#39;Crown&#39;, &#39;People&#39;, &#39;British&#39;, &#39;America&#39;, &#39;Cock&#39;]</pre></div>
<p><strong>Notice that with this pattern, hyphenated words are split and only the first part is returned. Let&rsquo;s handle this case.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[A-Z][a-z]+-?[a-z]*&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">dickens</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;Light&#39;, &#39;Darkness&#39;, &#39;Heaven&#39;, &#39;There&#39;, &#39;England&#39;, &#39;France&#39;, &#39;In&#39;, &#39;State&#39;, &#39;It&#39;, &#39;Our&#39;, &#39;Lord&#39;, &#39;Spiritual&#39;, &#39;England&#39;, &#39;Mrs&#39;, &#39;Southcott&#39;, &#39;Life&#39;, &#39;Guards&#39;, &#39;London&#39;, &#39;Westminster&#39;, &#39;Even&#39;, &#39;Cock-lane&#39;, &#39;Mere&#39;, &#39;English&#39;, &#39;Crown&#39;, &#39;People&#39;, &#39;British&#39;, &#39;America&#39;, &#39;Cock-lane&#39;]</pre></div>
<h3><center><font color=MediumVioletRed>D. Other built-in character classes and metacharacters</font></center></h3>

<table style="width:90%">
  <th>Class
  </th>
  <th>Matches
  </th>
  <tr>
      <td><code>.</code></td>
      <td>any character except <code>\n</code></td> 
  </tr>
  <tr>
      <td><code>\d</code></td>
    <td>Any numeric character</td> 
  </tr>
  <tr>
      <td><code>\D</code></td>
    <td>Non-numeric character</td> 
  </tr>
  <tr>
      <td><code>\w</code></td>
      <td>alphanumeric characters (same as <code>[0-9a-zA-Z_]</code>)</td> 
  </tr>
  <tr>
      <td><code>\W</code></td>
    <td>Non-alphanumeric characters</td> 
  </tr>
  <tr>
      <td><code>\b</code></td>
    <td>word boundary</td> 
  </tr> 
  <tr>
      <td><code>\s</code></td>
      <td>whitespace character (including <code>\n</code>, <code>\t</code>)</td> 
  </tr> 
  <tr>
      <td><code>\S</code></td>
    <td>Non-whitespace character </td> 
  </tr> 
  <tr>
      <td><code>^</code></td>
    <td>Start of line </td> 
  </tr> 
  <tr>
    <td><code>$</code></td>
    <td>End of line </td> 
  </tr> 
</table>

<p><strong>First word of each sentence.</strong></p>

<p>We use <code>re.MULTILINE</code> to have the patterned searched across more than one line.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\w+&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;It&#39;, &#39;it&#39;, &#39;it&#39;, &#39;it&#39;, &#39;nothing&#39;, &#39;in&#39;, &#39;insisted&#39;, &#39;There&#39;, &#39;throne&#39;, &#39;a&#39;, &#39;than&#39;, &#39;that&#39;, &#39;It&#39;, &#39;Spiritual&#39;, &#39;as&#39;, &#39;blessed&#39;, &#39;heralded&#39;, &#39;made&#39;, &#39;ghost&#39;, &#39;messages&#39;, &#39;deficient&#39;, &#39;earthly&#39;, &#39;from&#39;, &#39;to&#39;, &#39;communications&#39;, &#39;brood&#39;]</pre></div>
<p><strong>Last word of each sentence.</strong></p>

<p>This is a bit more tricky. First note the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+$&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;had&#39;, &#39;authorities&#39;, &#39;the&#39;, &#39;with&#39;, &#39;clearer&#39;, &#39;twentieth&#39;, &#39;had&#39;, &#39;were&#39;, &#39;lane&#39;, &#39;its&#39;, &#39;supernaturally&#39;, &#39;the&#39;, &#39;strange&#39;, &#39;any&#39;, &#39;lane&#39;]</pre></div>
<p>The problem here is that our pattern will only consider a word as being a match if it is at the end of a line if there is no other character after it.</p>

<p>Let&rsquo;s try to include the possibility of a punctuation symbol.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+.?$&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;belief,&#39;, &#39;Darkness,&#39;, &#39;had&#39;, &#39;authorities&#39;, &#39;only.&#39;, &#39;the&#39;, &#39;with&#39;, &#39;clearer&#39;, &#39;fishes,&#39;, &#39;ever.&#39;, &#39;five.&#39;, &#39;period,&#39;, &#39;twentieth&#39;, &#39;had&#39;, &#39;were&#39;, &#39;lane&#39;, &#39;its&#39;, &#39;supernaturally&#39;, &#39;the&#39;, &#39;People,&#39;, &#39;strange&#39;, &#39;any&#39;, &#39;lane&#39;, &#39;brood.&#39;]</pre></div>
<p>That&rsquo;s better but we don&rsquo;t actually want the punctuation symbols to appear in the result.</p>

<h3> <center><font color=MediumVioletRed>E. Capture Groups</font></center></h3>

<p>We can use a <strong>capture group</strong> to specify which part of the pattern should be returned as a group, using parentheses.</p>

<p>Let&rsquo;s first see how this works on a simple example.</p>

<p><strong>No groups</strong></p>

<p>We get a list back.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+\s\d+\w{0,2}&#39;</span><span class="p">,</span> <span class="s2">&#34;Let&#39;s meet on November 9 at 5pm, or November 12 at 11am or 4pm.&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;November 9&#39;, &#39;at 5pm&#39;, &#39;November 12&#39;, &#39;at 11am&#39;, &#39;or 4pm&#39;]</pre></div>
<p><strong>2 capture groups</strong></p>

<p>We get a list of tuples with 2 elements.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)\s(\d+)\w{0,2}&#39;</span><span class="p">,</span> <span class="s2">&#34;Let&#39;s meet on November 9 at 5pm, or November 12 at 11am or 4pm.&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[(&#39;November&#39;, &#39;9&#39;), (&#39;at&#39;, &#39;5&#39;), (&#39;November&#39;, &#39;12&#39;), (&#39;at&#39;, &#39;11&#39;), (&#39;or&#39;, &#39;4&#39;)]</pre></div>
<p><strong>1 non-capture group, starting with <code>(?:</code> and 1 capture group.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:\w+)\s(\d+)\w{0,2}&#39;</span><span class="p">,</span> <span class="s2">&#34;Let&#39;s meet on November 9 at 5pm, or November 12 at 11am or 4pm.&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;9&#39;, &#39;5&#39;, &#39;12&#39;, &#39;11&#39;, &#39;4&#39;]</pre></div>
<p><strong>Note:</strong></p>

<p>This example is a bit lame. The same result could be achieved more simply, but it illustrates how non-capture groups work.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="s2">&#34;Let&#39;s meet on November 9 at 5pm, or November 12 at 11am or 4pm.&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;9&#39;, &#39;5&#39;, &#39;12&#39;, &#39;11&#39;, &#39;4&#39;]</pre></div>
<p><strong>Back to our problem of finding the last words of each line.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+).?$&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;belief&#39;, &#39;Darkness&#39;, &#39;had&#39;, &#39;authorities&#39;, &#39;only&#39;, &#39;the&#39;, &#39;with&#39;, &#39;clearer&#39;, &#39;fishes&#39;, &#39;ever&#39;, &#39;five&#39;, &#39;period&#39;, &#39;twentieth&#39;, &#39;had&#39;, &#39;were&#39;, &#39;lane&#39;, &#39;its&#39;, &#39;supernaturally&#39;, &#39;the&#39;, &#39;People&#39;, &#39;strange&#39;, &#39;any&#39;, &#39;lane&#39;, &#39;brood&#39;]</pre></div>
<p>Almost there. We just need to take care of hyphenated words and whitespaces.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># You can usually write multiple regular expressions to perform a task,</span>
<span class="c1"># however, it&#39;s best to try and make the regular expression as discriminating as possible.</span>

<span class="c1"># Method 1</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;([\w+-?]+\w+).?[\s-]*$&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="c1"># Method 2</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;([\w+-?]+\w+).?\W*$&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="c1"># Method 3</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;([\w-]+)\W*$&#39;</span><span class="p">,</span> <span class="n">dickens</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;times&#39;, &#39;belief&#39;, &#39;Darkness&#39;, &#39;had&#39;, &#39;way&#39;, &#39;authorities&#39;, &#39;only&#39;, &#39;the&#39;, &#39;with&#39;, &#39;clearer&#39;, &#39;fishes&#39;, &#39;ever&#39;, &#39;seventy-five&#39;, &#39;period&#39;, &#39;five-and-twentieth&#39;, &#39;had&#39;, &#39;were&#39;, &#39;Cock-lane&#39;, &#39;its&#39;, &#39;supernaturally&#39;, &#39;the&#39;, &#39;People&#39;, &#39;strange&#39;, &#39;any&#39;, &#39;Cock-lane&#39;, &#39;brood&#39;]
[&#39;times&#39;, &#39;belief&#39;, &#39;Darkness&#39;, &#39;had&#39;, &#39;way&#39;, &#39;authorities&#39;, &#39;only&#39;, &#39;the&#39;, &#39;with&#39;, &#39;clearer&#39;, &#39;fishes&#39;, &#39;ever&#39;, &#39;seventy-five&#39;, &#39;period&#39;, &#39;five-and-twentieth&#39;, &#39;had&#39;, &#39;were&#39;, &#39;Cock-lane&#39;, &#39;its&#39;, &#39;supernaturally&#39;, &#39;the&#39;, &#39;People&#39;, &#39;strange&#39;, &#39;any&#39;, &#39;Cock-lane&#39;, &#39;brood&#39;]
[&#39;times&#39;, &#39;belief&#39;, &#39;Darkness&#39;, &#39;had&#39;, &#39;way&#39;, &#39;authorities&#39;, &#39;only&#39;, &#39;the&#39;, &#39;with&#39;, &#39;clearer&#39;, &#39;fishes&#39;, &#39;ever&#39;, &#39;seventy-five&#39;, &#39;period&#39;, &#39;five-and-twentieth&#39;, &#39;had&#39;, &#39;were&#39;, &#39;Cock-lane&#39;, &#39;its&#39;, &#39;supernaturally&#39;, &#39;the&#39;, &#39;People&#39;, &#39;strange&#39;, &#39;any&#39;, &#39;Cock-lane&#39;, &#39;brood&#39;]</pre></div>
<h2>3. Data Extraction</h2>

<p>When we're working with data you haven't generated, we usually have little control over the formatting of the data.</p>

<p>What's worse, the formatting can be inconsistent. This is where regular expression can be extremely useful.</p>

<p>Consider the data below. We'd like to extract the credit card information for each entry.<p> 

<p>Notice that the credit card numbers are not formatted in a consistent way.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">messy_data</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">Ms. Dixie T Patenaude 18 rue Descartes STRASBOURG Alsace 67100 FR France Dixie.Patenaude@teleworm.us Shound Cheecaey3s 03.66.62.81.38 Grondin 4/15/1958 MasterCard 5379 7969 2881 8421 958 12/2017 nan 1Z 114 58A 80 2148 893 8 Blue Safety specialist Atlas Realty 2000 Subaru Outback AnalystWatch.fr O- 191.0 86.8 5&#39; 11&#34; 156 dd0548bb-a8b5-438d-b181-c76ad282a9a1 48.577584 7.842637
</span><span class="s1">Mr. Silvano G Romani 34 Faunce Crescent WHITE TOP NSW 2675 AU Australia Silvano-Romani@einrot.com Pock1993 AeV7ziek (02) 6166 5988 Sagese 2/25/1993 MasterCard 5253-7637-4959-3303 404 06-2018 nan 1Z 814 E43 42 9322 015 2 Green Coin vending and amusement machine servicer repairer Miller &amp; Rhoads 1998 Honda S-MX StarJock.com.au B+ 128.3 58.3 6&#39; 2&#34; 189 7e310daa-46f5-407e-8dda-d975715ac4d5 -33.429793 145.234214
</span><span class="s1">Mr. Felix C Fried 37 Jubilee Drive CAXTON nan CB3 5WG GB United Kingdom FelixFried@rhyta.com Derser Aisequ0haz 078 1470 0903 Eisenhauer 1/19/1933 Visa 4716046346218902 738 02 2018 SP 39 75 51 D 1Z V88 635 94 7608 112 4 Blue School psychologist Wetson&#39;s 2001 Audi Allroad MoverRelocation.co.uk O+ 188.5 85.7 5&#39; 7&#34; 169 95515377-74a9-4c1e-9117-44b9753dad8c 51.922175 -0.353221
</span><span class="s1">&#39;&#39;&#39;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">credit_card_number</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4})&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">credit_card_number</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">messy_data</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39;5379 7969 2881 8421&#39;, &#39;5253-7637-4959-3303&#39;, &#39;4716046346218902&#39;]</pre></div>
<p>Let&rsquo;s write a regular expression called <code>height</code> to extract the height of each person in the data.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">height</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d)</span><span class="se">\&#39;</span><span class="s1">\s+(\d{,2})&#34;&#39;</span><span class="p">)</span>

<span class="n">height</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">messy_data</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">[(&#39;5&#39;, &#39;11&#39;), (&#39;6&#39;, &#39;2&#39;), (&#39;5&#39;, &#39;7&#39;)]</pre></div>
<p><strong>For more complex patterns we can use <em>named</em> capture groups.</strong></p>

<h3> <center><font color=MediumVioletRed>A. Named Capture Groups</font></center></h3>

<p>Let's write a regular expression that will extract not just the credit card number, but also the card type, CCV number, and expiry date.</p>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<p>When you are extracting several groups that correspond to a particular type of information, it's often useful to associate a name with each group. That's what named groups allow you to do.</p>

<p>A named group has the form <code>(?P&lt;name&gt;regex)</code>.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">credit_card_details</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;(?P&lt;CardType&gt;Visa|MasterCard).*&#39;</span>
                                 <span class="s1">&#39;(?P&lt;CardNumber&gt;\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4})[-\s]?&#39;</span>
                                 <span class="s1">&#39;(?P&lt;CCV&gt;\d{3})\s+&#39;</span>
                                 <span class="s1">&#39;(?P&lt;Expiry&gt;\d{2}[- /]{1}\d{4})&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">messy_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">credit_card_details</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">())</span></code></pre></div><div class="highlight"><pre class="chroma">{&#39;CardType&#39;: &#39;MasterCard&#39;, &#39;CardNumber&#39;: &#39;5379 7969 2881 8421&#39;, &#39;CCV&#39;: &#39;958&#39;, &#39;Expiry&#39;: &#39;12/2017&#39;}
{&#39;CardType&#39;: &#39;MasterCard&#39;, &#39;CardNumber&#39;: &#39;5253-7637-4959-3303&#39;, &#39;CCV&#39;: &#39;404&#39;, &#39;Expiry&#39;: &#39;06-2018&#39;}
{&#39;CardType&#39;: &#39;Visa&#39;, &#39;CardNumber&#39;: &#39;4716046346218902&#39;, &#39;CCV&#39;: &#39;738&#39;, &#39;Expiry&#39;: &#39;02 2018&#39;}</pre></div>
<p>We can get a nicer output by transforming the dictionary into a dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">credit_card_details</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span>  <span class="n">messy_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CCV</th>
      <th>CardNumber</th>
      <th>CardType</th>
      <th>Expiry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>958</td>
      <td>5379 7969 2881 8421</td>
      <td>MasterCard</td>
      <td>12/2017</td>
    </tr>
    <tr>
      <th>1</th>
      <td>404</td>
      <td>5253-7637-4959-3303</td>
      <td>MasterCard</td>
      <td>06-2018</td>
    </tr>
    <tr>
      <th>2</th>
      <td>738</td>
      <td>4716046346218902</td>
      <td>Visa</td>
      <td>02 2018</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let&rsquo;s now write a regular expression <code>email</code> that will extract the email address from our data, and return the login and internet service provider for each entry, as two named capture groups.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">email</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;Login&gt;\S+)@(?P&lt;ISP&gt;\S+)&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">email</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span>  <span class="n">messy_data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ISP</th>
      <th>Login</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>teleworm.us</td>
      <td>Dixie.Patenaude</td>
    </tr>
    <tr>
      <th>1</th>
      <td>einrot.com</td>
      <td>Silvano-Romani</td>
    </tr>
    <tr>
      <th>2</th>
      <td>rhyta.com</td>
      <td>FelixFried</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>B. Pandas &amp; Regular expressions</font></center></h3>

<p>For more complex data sets we can of course combine the strengths of regular expressions and Pandas.</p>

<p>As an example, let&rsquo;s revisit the birthday formatting problem of a previous post.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&#34;data/people.csv&#34;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>8/25/1968</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1/31/1962</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1/10/1964</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>4/12/1933</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>11/20/1946</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>

<p>We'd like the dates to be formatted as <code>year-month-day</code>.</p>

<p>In a previous notebook we worked out a solution using the <code>datetime</code> module.</p>

<p>Let's do this using regular expressions.</p>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>In a previous post we did more than simply change the format of the dates. We created a special datetime objects which can be used to perform <b>computations</b> on dates. Here we're merely focussing on the formatting aspect to illustrate how regular expressions can be combined with our usual Pandas workflow.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Compile the regex first for increased speed.</span>
<span class="n">birthday</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;month&gt;\d{1,2})/(?P&lt;day&gt;\d{1,2})/(?P&lt;year&gt;\d{2,4})&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">transform_birthday</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">birthday</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&#34;-&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">date</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]])</span>
    
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">transform_birthday</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>1968-8-25</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1962-1-31</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1964-1-10</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>1933-4-12</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>1946-11-20</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>By using Pandas&rsquo; advanced regex syntax we can achieve the same thing in one line of code.</strong></p>

<p>Let&rsquo;s reload the original data.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>8/25/1968</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1/31/1962</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1/10/1964</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>4/12/1933</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>11/20/1946</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>

<p>We can extract the day, month and year of birth for each person in one line of code by passing the compiled regex to the
<code>str.extract</code> method of our Pandas Series corresponding to the <code>Birthday</code> column.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">birthday</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>month</th>
      <th>day</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8</td>
      <td>25</td>
      <td>1968</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>31</td>
      <td>1962</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>10</td>
      <td>1964</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>12</td>
      <td>1933</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11</td>
      <td>20</td>
      <td>1946</td>
    </tr>
  </tbody>
</table>
</div>

<p>Note that the names of the columns have been automatically extracted from the named groups of the regex <code>birthday</code>.</p>

<p>Using this, we can use the <code>apply</code> method to process the date in the format that we want.</p>

<p>For more clarity, we wrap our method chaining expression in parentheses, which allows us to write each method call on a new line.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
                     <span class="o">.</span><span class="n">Birthday</span>
                     <span class="o">.</span><span class="nb">str</span>
                     <span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">birthday</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                     <span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">date</span><span class="p">:</span><span class="s2">&#34;-&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">date</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> 
                                                  <span class="n">date</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> 
                                                  <span class="n">date</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]),</span> 
                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>1968-8-25</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1962-1-31</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1964-1-10</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>1933-4-12</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>1946-11-20</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>That being said, the best way to achieve our goal in pandas is to let it parse the dates automatically!</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">])</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>1968-08-25</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1962-01-31</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1964-01-10</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>1933-04-12</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>1946-11-20</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName                object
Surname                  object
Gender                   object
StreetAddress            object
City                     object
Country                  object
Birthday         datetime64[ns]
BloodType                object
dtype: object</pre></div>
<p>The End&hellip;</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/regex/">regex</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/11/pandas_groupby/">
                <h2 class="post-title">Pandas (Blood)groupby</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on November 15, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;37&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;7831&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<h2 id="1-pandas-groupby">1. Pandas GroupBy</h2>

<p>To illustrate how the pandas <code>groupby</code> operation works let&rsquo;s use some fake data. With <code>numpy</code> it&rsquo;s trivial to generate random numerical data, however, it&rsquo;s usually a lot more tedious to generate random people data that looks realistic.</p>

<p>A very useful tool for this is the <a href="http://www.fakenamegenerator.com/">Fake Name Generator</a>. That&rsquo;s what I used to generate
this dataset.</p>

<p>Let&rsquo;s load the dataset into a dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/people.csv&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>8/25/1968</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1/31/1962</td>
      <td>A+</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1/10/1964</td>
      <td>B+</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>4/12/1933</td>
      <td>O-</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>11/20/1946</td>
      <td>A+</td>
    </tr>
  </tbody>
</table>
</div>

<p>The data contains information about fictitious people.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName        5000
Surname          5000
Gender           5000
StreetAddress    5000
City             5000
Country          5000
Birthday         5000
BloodType        5000
dtype: int64</pre></div>
<div style="background-color:#F7F2E0;">
<h4> <font color=MediumVioletRed>Remark:</font> </h4>
<p>We've got different types of variables here. For instance, <code>Gender</code> is a categorical variable, so are <code>BloodType</code> and <code>Country</code>. </p>
<p><code>Birthday</code> can be thought of as an interval variable, although we'll convert it to an <code>Age</code> variable, which is more convenient for our purpose, and will be treated as a continuous numeric variable. </p>
<p>Notice, however, that by default pandas will identify non-numeric data as a generic object, which is not the most efficient way of handling categorical data. Let's fix that.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName        object
Surname          object
Gender           object
StreetAddress    object
City             object
Country          object
Birthday         object
BloodType        object
dtype: object</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Gender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">GivenName          object
Surname            object
Gender           category
StreetAddress      object
City               object
Country          category
Birthday           object
BloodType        category
dtype: object</pre></div>
<h3> <center><font color=MediumVioletRed>A. Dealing with dates.</font></center></h3>

<h4>Method 1 - <code>datetime</code> module.</h4>

<p>One of the features (columns) in our dataset is <code>Birthday</code>. While this information may be useful if you wanted to
find out, for instance, how many people share a birthday, most of the time we mainly care about their age.</p>

<p>One way to convert the <code>Birthday</code> into an <code>Age</code> feature would be to extract the year and compute the current year minus
the birthday year. The <code>split</code> method of string objects could be used for that, however, there&rsquo;s a more elegant, and general
way of handling dates in Python using the <a href="https://pymotw.com/3/datetime/"><code>datetime.strptime</code> function</a>.</p>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>This isn't necessarily the fastest, or best way to handle date and time objects in <code>pandas</code>. </p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&#34;21/01/2019&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">%d</span><span class="s2">/%m/%Y&#34;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">2019
62 days, 20:14:58.495945</pre></div>
<p>The <code>datetime</code> module allows you to manipulate date objects and perform basic <strong>operations on dates</strong>. It also allows you to
format dates in a consistent way.</p>

<p>We can apply this to our <code>Birthday</code> feature.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">(&#39;8/25/1968&#39;, &#39;1/31/1962&#39;)</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&#34;%m/</span><span class="si">%d</span><span class="s2">/%Y&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">datetime.datetime(1968, 8, 25, 0, 0)</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s2">&#34;%m/</span><span class="si">%d</span><span class="s2">/%Y&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">datetime.datetime(1962, 1, 31, 0, 0)</pre></div>
<h4 id="let-s-use-the-pandas-apply-method-to-format-the-dates-in-a-consistent-way">Let&rsquo;s use the Pandas <code>apply</code> method to format the dates in a consistent way</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">],</span> <span class="s2">&#34;%m/</span><span class="si">%d</span><span class="s2">/%Y&#34;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0   1968-08-25
1   1962-01-31
2   1964-01-10
3   1933-04-12
4   1946-11-20
Name: Birthday, dtype: datetime64[ns]</pre></div>
<h4>Method 2 - using the <code>to_datetime</code> method of pandas.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">original_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span><span class="p">)</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0   1968-08-25
1   1962-01-31
2   1964-01-10
3   1933-04-12
4   1946-11-20
Name: Birthday, dtype: datetime64[ns]</pre></div>
<h4>Method 3 - convert at reading time.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">original_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">])</span>
<span class="n">original_data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0   1968-08-25
1   1962-01-31
2   1964-01-10
3   1933-04-12
4   1946-11-20
Name: Birthday, dtype: datetime64[ns]</pre></div>
<h4>We can now define an <code>Age</code> feature by subtracting the year of birth from the current year.</h4> 

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Because we are not hard-coding (typing by hand) the current date, if we come back to this code in a year's time and run it again,
    the <code>Age</code> will be updated automatically. </p>
</div>

<h4 id="we-could-compute-the-age-using-code-apply-code-to-iterate-through-the-rows-of-the-dataframe">We could compute the age using <code>apply</code> to iterate through the rows of the dataframe&hellip;</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0    51
1    57
2    55
3    86
4    73
dtype: int64</pre></div>
<h4>However, it is usually faster to operate on the whole dataframe at one.</h4>

<p>Datetime methods on a pandas series (such as a column of a dataframe), can be accessed via the <code>dt</code> method.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0    51
1    57
2    55
3    86
4    73
Name: Birthday, dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GivenName</th>
      <th>Surname</th>
      <th>Gender</th>
      <th>StreetAddress</th>
      <th>City</th>
      <th>Country</th>
      <th>Birthday</th>
      <th>BloodType</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Stepanida</td>
      <td>Sukhorukova</td>
      <td>female</td>
      <td>62 Ockham Road</td>
      <td>EASTER WHYNTIE</td>
      <td>United Kingdom</td>
      <td>1968-08-25</td>
      <td>A+</td>
      <td>51</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Hiệu</td>
      <td>Lương</td>
      <td>male</td>
      <td>4 Iolaire Road</td>
      <td>NEW CROSS</td>
      <td>United Kingdom</td>
      <td>1962-01-31</td>
      <td>A+</td>
      <td>57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Petra</td>
      <td>Neudorf</td>
      <td>female</td>
      <td>56 Victoria Road</td>
      <td>LISTON</td>
      <td>United Kingdom</td>
      <td>1964-01-10</td>
      <td>B+</td>
      <td>55</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Eho</td>
      <td>Amano</td>
      <td>female</td>
      <td>83 Stroud Rd</td>
      <td>OGMORE</td>
      <td>United Kingdom</td>
      <td>1933-04-12</td>
      <td>O-</td>
      <td>86</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Noah</td>
      <td>Niland</td>
      <td>male</td>
      <td>61 Wrexham Rd</td>
      <td>FACEBY</td>
      <td>United Kingdom</td>
      <td>1946-11-20</td>
      <td>A+</td>
      <td>73</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>B. GroupBy feature.</font></center></h3>

<p>Given the data, common questions to answer would be how certain features are distributed in each
country, or for each gender.</p>

<p>These could be as simple as <strong>What is the average age in each country?</strong>
to much more complex questions such as <strong>How many people of each blood type are there in each country, for
each gender, for a given age group?</strong></p>

<p>Fortunately, Pandas&rsquo; <code>GroupBy</code> method allows us to organise the data in ways only limited by our sagacity.</p>

<h4> Let's look at the country distribution first.  </h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Country</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">Australia         1800
Italy              800
United States      700
United Kingdom     500
New Zealand        500
France             500
Iceland            200
Name: Country, dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Country</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span></code></pre></div>
<p><img src="output_31_0.png" alt="png" /></p>

<h4 id="the-groupby-method-creates-a-groupby-object">The <code>groupby</code> method creates a <code>GroupBy</code> object.</h4>

<p>The <code>groupby</code> object is a recipe for how to perform operation on the data.</p>

<p>To use a <code>groupby</code> object, we need to perform some operation on it.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span>
<span class="n">grouped_by_country</span></code></pre></div><div class="highlight"><pre class="chroma">&lt;pandas.core.groupby.generic.DataFrameGroupBy object at 0x106ca5710&gt;</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="o">.</span><span class="n">size</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">Country
Australia         1800
France             500
Iceland            200
Italy              800
New Zealand        500
United Kingdom     500
United States      700
dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="o">.</span><span class="n">ngroups</span></code></pre></div><div class="highlight"><pre class="chroma">7</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped_by_country</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Australia
France
Iceland
Italy
New Zealand
United Kingdom
United States</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">Country
Australia         57.817778
France            57.944000
Iceland           57.660000
Italy             56.607500
New Zealand       56.630000
United Kingdom    57.740000
United States     57.415714
Name: Age, dtype: float64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Recall that the <code>apply</code> method allows you to apply an <b>arbitrary function</b> to all the rows in your dataframe. Therefore, as long as you can express your operations as a function (lambda or otherwise), you can include it in the <code>apply</code>, <b>even if your function returns multiple values</b>, provided you wrap them in a tuple.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                                           <span class="n">f</span><span class="s1">&#39;{x.mean():0.2f}&#39;</span><span class="p">,</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                                           <span class="n">f</span><span class="s1">&#39;{x.std():0.2f}&#39;</span><span class="p">)</span>
                                <span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Country
Australia         (24, 57.82, 91, 19.49)
France            (24, 57.94, 91, 19.54)
Iceland           (24, 57.66, 91, 19.46)
Italy             (24, 56.61, 91, 18.98)
New Zealand       (24, 56.63, 91, 19.05)
United Kingdom    (24, 57.74, 91, 19.53)
United States     (24, 57.42, 91, 19.29)
Name: Age, dtype: object</pre></div>
<h4 id="a-different-and-nicer-output-can-be-obtained-using-the-agg-method-on-a-groupby-object">A different and nicer output can be obtained using the <code>agg</code> method on a groupby object.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>mean</th>
      <th>max</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>24</td>
      <td>57.817778</td>
      <td>91</td>
      <td>19.488031</td>
    </tr>
    <tr>
      <th>France</th>
      <td>24</td>
      <td>57.944000</td>
      <td>91</td>
      <td>19.541869</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>24</td>
      <td>57.660000</td>
      <td>91</td>
      <td>19.461194</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>24</td>
      <td>56.607500</td>
      <td>91</td>
      <td>18.981275</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>24</td>
      <td>56.630000</td>
      <td>91</td>
      <td>19.049905</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>24</td>
      <td>57.740000</td>
      <td>91</td>
      <td>19.527905</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>24</td>
      <td>57.415714</td>
      <td>91</td>
      <td>19.285003</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="for-categorical-variables-such-as-bloodtype-basic-information-can-be-extracted-using-the-describe-method">For categorical variables, such as <code>BloodType</code>, basic information can be extracted using the <code>describe</code> method.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>1800</td>
      <td>8</td>
      <td>O+</td>
      <td>648</td>
    </tr>
    <tr>
      <th>France</th>
      <td>500</td>
      <td>8</td>
      <td>O+</td>
      <td>184</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>200</td>
      <td>7</td>
      <td>O+</td>
      <td>86</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>800</td>
      <td>8</td>
      <td>O+</td>
      <td>299</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>500</td>
      <td>8</td>
      <td>O+</td>
      <td>185</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>500</td>
      <td>8</td>
      <td>O+</td>
      <td>188</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>700</td>
      <td>8</td>
      <td>O+</td>
      <td>273</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;GivenName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>1800</td>
      <td>1368</td>
      <td>Michael</td>
      <td>9</td>
    </tr>
    <tr>
      <th>France</th>
      <td>500</td>
      <td>444</td>
      <td>Anna</td>
      <td>4</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>200</td>
      <td>193</td>
      <td>Dieter</td>
      <td>2</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>800</td>
      <td>677</td>
      <td>Jennifer</td>
      <td>6</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>500</td>
      <td>447</td>
      <td>James</td>
      <td>4</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>500</td>
      <td>450</td>
      <td>Ellis</td>
      <td>3</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>700</td>
      <td>620</td>
      <td>Lily</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>

<p><code>describe</code> only tells us about the most frequent blood type. To get a count of the boodtypes let us use a <code>Counter</code> object.</p>

<div style="background-color:#FBEFFB;">
<h4>Which item appears most frequently?</h4>

Counting the number of objects of a given type is such a common operation that Python has a very useful <code>Counter</code> object
from the <code>collections</code> module. 

What a <code>Counter</code> object does to a sequence of items is group the elements of the sequence into bins according to their value, and count how many element each bin has. A <code>Counter</code> object also had several useful properties, for instance, to determine the most common object in the sequence.
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
<span class="n">c</span></code></pre></div><div class="highlight"><pre class="chroma">Counter({&#39;a&#39;: 3, &#39;b&#39;: 5, &#39;c&#39;: 2})</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">[(&#39;b&#39;, 5), (&#39;a&#39;, 3), (&#39;c&#39;, 2)]
[(&#39;b&#39;, 5), (&#39;a&#39;, 3)]
[(&#39;b&#39;, 5)]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Country            
Australia       A+     468.0
                A-      59.0
                AB+    100.0
                AB-      8.0
                B+     419.0
                B-      24.0
                O+     648.0
                O-      74.0
France          A+     145.0
                A-      17.0
                AB+     19.0
                AB-      1.0
                B+     106.0
                B-       4.0
                O+     184.0
                O-      24.0
Iceland         A+      45.0
                A-       6.0
                AB+      5.0
                B+      44.0
                B-       5.0
                O+      86.0
                O-       9.0
Italy           A+     207.0
                A-      31.0
                AB+     37.0
                AB-      5.0
                B+     185.0
                B-       4.0
                O+     299.0
                O-      32.0
New Zealand     A+     154.0
                A-       9.0
                AB+     21.0
                AB-      5.0
                B+     100.0
                B-       5.0
                O+     185.0
                O-      21.0
United Kingdom  A+     132.0
                A-      23.0
                AB+     25.0
                AB-      4.0
                B+     102.0
                B-       7.0
                O+     188.0
                O-      19.0
United States   A+     157.0
                A-      25.0
                AB+     35.0
                AB-      4.0
                B+     157.0
                B-      15.0
                O+     273.0
                O-      34.0
Name: BloodType, dtype: float64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Note how the result is one long column of information. This result is actually a Pandas <code>Series</code> object (recall that a <code>Series</code> object is essentially an array with an index).</p>

<p>It may look a bit like a dataframe, but remember that in a dataframe each column corresponds to a <b>unique</b> feature. Here, what looks like the second column is actually a second level for the index. We'll talk about multi-index shortly.  </p>
<p>The result as it stands may not be the easiest to read. It would be better if we could transform it back into a dataframe so
that we could compare the results for two countries more easily. In Pandas, you can do that with one command: <code>unstack</code>.
</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>468.0</td>
      <td>59.0</td>
      <td>100.0</td>
      <td>8.0</td>
      <td>419.0</td>
      <td>24.0</td>
      <td>648.0</td>
      <td>74.0</td>
    </tr>
    <tr>
      <th>France</th>
      <td>145.0</td>
      <td>17.0</td>
      <td>19.0</td>
      <td>1.0</td>
      <td>106.0</td>
      <td>4.0</td>
      <td>184.0</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>45.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>NaN</td>
      <td>44.0</td>
      <td>5.0</td>
      <td>86.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>207.0</td>
      <td>31.0</td>
      <td>37.0</td>
      <td>5.0</td>
      <td>185.0</td>
      <td>4.0</td>
      <td>299.0</td>
      <td>32.0</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>154.0</td>
      <td>9.0</td>
      <td>21.0</td>
      <td>5.0</td>
      <td>100.0</td>
      <td>5.0</td>
      <td>185.0</td>
      <td>21.0</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>132.0</td>
      <td>23.0</td>
      <td>25.0</td>
      <td>4.0</td>
      <td>102.0</td>
      <td>7.0</td>
      <td>188.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>157.0</td>
      <td>25.0</td>
      <td>35.0</td>
      <td>4.0</td>
      <td>157.0</td>
      <td>15.0</td>
      <td>273.0</td>
      <td>34.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>If we want to switch the index and the columns around, we need to specify the <code>level</code> parameter in  <code>unstack()</code> which, by default, is -1, that is the last (innermost) level of the index.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Country</th>
      <th>Australia</th>
      <th>France</th>
      <th>Iceland</th>
      <th>Italy</th>
      <th>New Zealand</th>
      <th>United Kingdom</th>
      <th>United States</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>468.0</td>
      <td>145.0</td>
      <td>45.0</td>
      <td>207.0</td>
      <td>154.0</td>
      <td>132.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.0</td>
      <td>17.0</td>
      <td>6.0</td>
      <td>31.0</td>
      <td>9.0</td>
      <td>23.0</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>100.0</td>
      <td>19.0</td>
      <td>5.0</td>
      <td>37.0</td>
      <td>21.0</td>
      <td>25.0</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>8.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>419.0</td>
      <td>106.0</td>
      <td>44.0</td>
      <td>185.0</td>
      <td>100.0</td>
      <td>102.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>24.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>648.0</td>
      <td>184.0</td>
      <td>86.0</td>
      <td>299.0</td>
      <td>185.0</td>
      <td>188.0</td>
      <td>273.0</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>74.0</td>
      <td>24.0</td>
      <td>9.0</td>
      <td>32.0</td>
      <td>21.0</td>
      <td>19.0</td>
      <td>34.0</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="the-level-can-also-be-specified-by-name">The level can also be specified by name</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Country</th>
      <th>Australia</th>
      <th>France</th>
      <th>Iceland</th>
      <th>Italy</th>
      <th>New Zealand</th>
      <th>United Kingdom</th>
      <th>United States</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>468.0</td>
      <td>145.0</td>
      <td>45.0</td>
      <td>207.0</td>
      <td>154.0</td>
      <td>132.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.0</td>
      <td>17.0</td>
      <td>6.0</td>
      <td>31.0</td>
      <td>9.0</td>
      <td>23.0</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>100.0</td>
      <td>19.0</td>
      <td>5.0</td>
      <td>37.0</td>
      <td>21.0</td>
      <td>25.0</td>
      <td>35.0</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>8.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>419.0</td>
      <td>106.0</td>
      <td>44.0</td>
      <td>185.0</td>
      <td>100.0</td>
      <td>102.0</td>
      <td>157.0</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>24.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>7.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>648.0</td>
      <td>184.0</td>
      <td>86.0</td>
      <td>299.0</td>
      <td>185.0</td>
      <td>188.0</td>
      <td>273.0</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>74.0</td>
      <td>24.0</td>
      <td>9.0</td>
      <td>32.0</td>
      <td>21.0</td>
      <td>19.0</td>
      <td>34.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Note that we have a  bunch of <code>NaN</code> in our dataframe. This indicates that no one from Iceland has blood type <code>AB+</code> in our dataset.</p>

<p>Since there was no such data in our dataset, it appears as a <strong>missing value</strong>.</p>

<p>However, here, a value of 0 would be more appropriate. We can tell the dataframe to
replace its missing values by 0 using the <code>fillna</code> method.</p>

<p>Since we&rsquo;re dealing with count data, it&rsquo;s also a good idea to convert the type to <code>int</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>468</td>
      <td>59</td>
      <td>100</td>
      <td>8</td>
      <td>419</td>
      <td>24</td>
      <td>648</td>
      <td>74</td>
    </tr>
    <tr>
      <th>France</th>
      <td>145</td>
      <td>17</td>
      <td>19</td>
      <td>1</td>
      <td>106</td>
      <td>4</td>
      <td>184</td>
      <td>24</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>45</td>
      <td>6</td>
      <td>5</td>
      <td>0</td>
      <td>44</td>
      <td>5</td>
      <td>86</td>
      <td>9</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>207</td>
      <td>31</td>
      <td>37</td>
      <td>5</td>
      <td>185</td>
      <td>4</td>
      <td>299</td>
      <td>32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>154</td>
      <td>9</td>
      <td>21</td>
      <td>5</td>
      <td>100</td>
      <td>5</td>
      <td>185</td>
      <td>21</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>132</td>
      <td>23</td>
      <td>25</td>
      <td>4</td>
      <td>102</td>
      <td>7</td>
      <td>188</td>
      <td>19</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>157</td>
      <td>25</td>
      <td>35</td>
      <td>4</td>
      <td>157</td>
      <td>15</td>
      <td>273</td>
      <td>34</td>
    </tr>
  </tbody>
</table>
</div>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>We are using <b>fake data</b> so don't give too much credence to these results. </p>

<p>This being said,  blood type frequencies do vary
across countries and you can read more about it <a href="http://en.wikipedia.org/wiki/Blood_type_distribution_by_country">here</a>.
</p>
</div>

<h3> <center><font color=MediumVioletRed>C. GroupBy on multiple features.</font></center></h3>

<p>Of, course, <code>GroupBy</code> operations aren&rsquo;t limited to single features.</p>

<p>If we want to see the data grouped by country <b>and</b> blood type , we just need to specify both features in constructing the <code>GroupBy</code> object.
<h4>Note that with a <code>groupby</code> on multiple features we can obtain the previous result in a different way.</h4></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;BloodType&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>468</td>
      <td>59</td>
      <td>100</td>
      <td>8</td>
      <td>419</td>
      <td>24</td>
      <td>648</td>
      <td>74</td>
    </tr>
    <tr>
      <th>France</th>
      <td>145</td>
      <td>17</td>
      <td>19</td>
      <td>1</td>
      <td>106</td>
      <td>4</td>
      <td>184</td>
      <td>24</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>45</td>
      <td>6</td>
      <td>5</td>
      <td>0</td>
      <td>44</td>
      <td>5</td>
      <td>86</td>
      <td>9</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>207</td>
      <td>31</td>
      <td>37</td>
      <td>5</td>
      <td>185</td>
      <td>4</td>
      <td>299</td>
      <td>32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>154</td>
      <td>9</td>
      <td>21</td>
      <td>5</td>
      <td>100</td>
      <td>5</td>
      <td>185</td>
      <td>21</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>132</td>
      <td>23</td>
      <td>25</td>
      <td>4</td>
      <td>102</td>
      <td>7</td>
      <td>188</td>
      <td>19</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>157</td>
      <td>25</td>
      <td>35</td>
      <td>4</td>
      <td>157</td>
      <td>15</td>
      <td>273</td>
      <td>34</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="let-s-group-our-data-based-on-country-and-gender">Let&rsquo;s group our data based on country and gender.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">])</span>

<span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>229.0</td>
      <td>29.0</td>
      <td>54.0</td>
      <td>4.0</td>
      <td>205.0</td>
      <td>13.0</td>
      <td>328.0</td>
      <td>41.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>239.0</td>
      <td>30.0</td>
      <td>46.0</td>
      <td>4.0</td>
      <td>214.0</td>
      <td>11.0</td>
      <td>320.0</td>
      <td>33.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>76.0</td>
      <td>11.0</td>
      <td>10.0</td>
      <td>NaN</td>
      <td>47.0</td>
      <td>2.0</td>
      <td>79.0</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69.0</td>
      <td>6.0</td>
      <td>9.0</td>
      <td>1.0</td>
      <td>59.0</td>
      <td>2.0</td>
      <td>105.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>22.0</td>
      <td>5.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>17.0</td>
      <td>4.0</td>
      <td>34.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>23.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>52.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>102.0</td>
      <td>14.0</td>
      <td>22.0</td>
      <td>1.0</td>
      <td>89.0</td>
      <td>1.0</td>
      <td>160.0</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>105.0</td>
      <td>17.0</td>
      <td>15.0</td>
      <td>4.0</td>
      <td>96.0</td>
      <td>3.0</td>
      <td>139.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>75.0</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>53.0</td>
      <td>2.0</td>
      <td>91.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>79.0</td>
      <td>4.0</td>
      <td>13.0</td>
      <td>4.0</td>
      <td>47.0</td>
      <td>3.0</td>
      <td>94.0</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>65.0</td>
      <td>6.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>55.0</td>
      <td>4.0</td>
      <td>99.0</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>67.0</td>
      <td>17.0</td>
      <td>11.0</td>
      <td>3.0</td>
      <td>47.0</td>
      <td>3.0</td>
      <td>89.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>89.0</td>
      <td>13.0</td>
      <td>18.0</td>
      <td>3.0</td>
      <td>77.0</td>
      <td>7.0</td>
      <td>138.0</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>68.0</td>
      <td>12.0</td>
      <td>17.0</td>
      <td>1.0</td>
      <td>80.0</td>
      <td>8.0</td>
      <td>135.0</td>
      <td>22.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>Once again let&rsquo;s replace missing values by 0.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>229</td>
      <td>29</td>
      <td>54</td>
      <td>4</td>
      <td>205</td>
      <td>13</td>
      <td>328</td>
      <td>41</td>
    </tr>
    <tr>
      <th>male</th>
      <td>239</td>
      <td>30</td>
      <td>46</td>
      <td>4</td>
      <td>214</td>
      <td>11</td>
      <td>320</td>
      <td>33</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>76</td>
      <td>11</td>
      <td>10</td>
      <td>0</td>
      <td>47</td>
      <td>2</td>
      <td>79</td>
      <td>16</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>6</td>
      <td>9</td>
      <td>1</td>
      <td>59</td>
      <td>2</td>
      <td>105</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>22</td>
      <td>5</td>
      <td>2</td>
      <td>0</td>
      <td>17</td>
      <td>4</td>
      <td>34</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>23</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>27</td>
      <td>1</td>
      <td>52</td>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>102</td>
      <td>14</td>
      <td>22</td>
      <td>1</td>
      <td>89</td>
      <td>1</td>
      <td>160</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>105</td>
      <td>17</td>
      <td>15</td>
      <td>4</td>
      <td>96</td>
      <td>3</td>
      <td>139</td>
      <td>15</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>75</td>
      <td>5</td>
      <td>8</td>
      <td>1</td>
      <td>53</td>
      <td>2</td>
      <td>91</td>
      <td>9</td>
    </tr>
    <tr>
      <th>male</th>
      <td>79</td>
      <td>4</td>
      <td>13</td>
      <td>4</td>
      <td>47</td>
      <td>3</td>
      <td>94</td>
      <td>12</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>65</td>
      <td>6</td>
      <td>14</td>
      <td>1</td>
      <td>55</td>
      <td>4</td>
      <td>99</td>
      <td>13</td>
    </tr>
    <tr>
      <th>male</th>
      <td>67</td>
      <td>17</td>
      <td>11</td>
      <td>3</td>
      <td>47</td>
      <td>3</td>
      <td>89</td>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>89</td>
      <td>13</td>
      <td>18</td>
      <td>3</td>
      <td>77</td>
      <td>7</td>
      <td>138</td>
      <td>12</td>
    </tr>
    <tr>
      <th>male</th>
      <td>68</td>
      <td>12</td>
      <td>17</td>
      <td>1</td>
      <td>80</td>
      <td>8</td>
      <td>135</td>
      <td>22</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Age</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
    </tr>
  </tbody>
</table>
</div>

<p>Notice how we didn&rsquo;t specify the <code>Age</code> feature. Pandas automatically outputs results for which the <code>mean</code> function makes sense. Here only Age fits the bill.</p>

<p>Like with any dataframe, you can also use <code>apply</code> to map a function to the grouped data, however, for anything more complex, like applying multiple functions at once, the <code>agg</code> method is more convenient.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;std&#39;</span><span class="p">])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>mean</th>
      <th>std</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>58.101883</td>
      <td>19.587278</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.531773</td>
      <td>19.394326</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>25</td>
      <td>91</td>
      <td>59.207469</td>
      <td>19.041143</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>56.768340</td>
      <td>19.961407</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.315217</td>
      <td>19.527343</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.953704</td>
      <td>19.490896</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.300493</td>
      <td>19.116494</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>90</td>
      <td>55.893401</td>
      <td>18.838508</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>55.823770</td>
      <td>19.546233</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.398438</td>
      <td>18.570202</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.284047</td>
      <td>20.168651</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>58.222222</td>
      <td>18.856132</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>24</td>
      <td>91</td>
      <td>57.299720</td>
      <td>19.167134</td>
    </tr>
    <tr>
      <th>male</th>
      <td>24</td>
      <td>91</td>
      <td>57.536443</td>
      <td>19.434197</td>
    </tr>
  </tbody>
</table>
</div>

<p><h4> For descriptive statistics of numerical data, the <code>quantile</code> function is also useful.</h4>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>The 0.5 quantile is the <b>median</b> of our data.</p>
</div></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">((</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">))</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>0.1</th>
      <th>0.25</th>
      <th>0.5</th>
      <th>0.75</th>
      <th>0.9</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>31.0</td>
      <td>41.00</td>
      <td>58.0</td>
      <td>75.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.0</td>
      <td>41.00</td>
      <td>58.0</td>
      <td>74.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>31.0</td>
      <td>44.00</td>
      <td>61.0</td>
      <td>76.00</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.0</td>
      <td>37.00</td>
      <td>57.0</td>
      <td>75.00</td>
      <td>83.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>32.1</td>
      <td>40.75</td>
      <td>59.0</td>
      <td>74.00</td>
      <td>83.9</td>
    </tr>
    <tr>
      <th>male</th>
      <td>32.0</td>
      <td>42.00</td>
      <td>56.5</td>
      <td>74.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31.0</td>
      <td>41.00</td>
      <td>57.0</td>
      <td>73.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31.0</td>
      <td>39.00</td>
      <td>55.0</td>
      <td>71.00</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>29.3</td>
      <td>39.00</td>
      <td>54.0</td>
      <td>72.25</td>
      <td>83.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>32.0</td>
      <td>41.00</td>
      <td>58.0</td>
      <td>72.00</td>
      <td>83.5</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>29.6</td>
      <td>39.00</td>
      <td>57.0</td>
      <td>75.00</td>
      <td>85.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.2</td>
      <td>43.00</td>
      <td>59.0</td>
      <td>73.00</td>
      <td>83.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>31.0</td>
      <td>41.00</td>
      <td>57.0</td>
      <td>74.00</td>
      <td>84.0</td>
    </tr>
    <tr>
      <th>male</th>
      <td>30.0</td>
      <td>40.50</td>
      <td>58.0</td>
      <td>74.00</td>
      <td>83.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>How can we use the <code>grouped_by_country_and_gender</code> object to output the number of people who were born
on a given month (numbered 1 to 12), for each country, and for each gender?</p>

<p><b>Hint:</b>
This can be done in one line using <code>apply</code> and <code>value_counts</code>, but you need to make sure you keep track of the type of object you are dealing with at each stage of the pipeline.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Method 1 - one liner </span>
<span class="p">(</span><span class="n">grouped_by_country_and_gender</span><span class="p">[</span><span class="s1">&#39;Birthday&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
            <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>83</td>
      <td>75</td>
      <td>70</td>
      <td>66</td>
      <td>71</td>
      <td>78</td>
      <td>90</td>
      <td>77</td>
      <td>70</td>
      <td>65</td>
      <td>73</td>
      <td>85</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>64</td>
      <td>74</td>
      <td>71</td>
      <td>74</td>
      <td>57</td>
      <td>77</td>
      <td>91</td>
      <td>80</td>
      <td>81</td>
      <td>81</td>
      <td>78</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>26</td>
      <td>15</td>
      <td>18</td>
      <td>13</td>
      <td>30</td>
      <td>22</td>
      <td>22</td>
      <td>19</td>
      <td>11</td>
      <td>21</td>
      <td>21</td>
      <td>23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>22</td>
      <td>15</td>
      <td>22</td>
      <td>28</td>
      <td>19</td>
      <td>22</td>
      <td>26</td>
      <td>23</td>
      <td>26</td>
      <td>22</td>
      <td>16</td>
      <td>18</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>7</td>
      <td>11</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>10</td>
      <td>10</td>
      <td>12</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>7</td>
      <td>11</td>
      <td>15</td>
      <td>2</td>
      <td>8</td>
      <td>9</td>
      <td>11</td>
      <td>6</td>
      <td>12</td>
      <td>10</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31</td>
      <td>34</td>
      <td>39</td>
      <td>33</td>
      <td>36</td>
      <td>28</td>
      <td>33</td>
      <td>36</td>
      <td>36</td>
      <td>37</td>
      <td>34</td>
      <td>29</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31</td>
      <td>28</td>
      <td>35</td>
      <td>41</td>
      <td>27</td>
      <td>28</td>
      <td>37</td>
      <td>33</td>
      <td>29</td>
      <td>33</td>
      <td>33</td>
      <td>39</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>18</td>
      <td>20</td>
      <td>19</td>
      <td>21</td>
      <td>22</td>
      <td>26</td>
      <td>26</td>
      <td>15</td>
      <td>14</td>
      <td>23</td>
      <td>23</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>22</td>
      <td>16</td>
      <td>22</td>
      <td>30</td>
      <td>19</td>
      <td>16</td>
      <td>25</td>
      <td>18</td>
      <td>25</td>
      <td>23</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>22</td>
      <td>14</td>
      <td>20</td>
      <td>31</td>
      <td>22</td>
      <td>19</td>
      <td>24</td>
      <td>34</td>
      <td>14</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>16</td>
      <td>22</td>
      <td>26</td>
      <td>20</td>
      <td>21</td>
      <td>23</td>
      <td>18</td>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>38</td>
      <td>32</td>
      <td>35</td>
      <td>24</td>
      <td>37</td>
      <td>25</td>
      <td>25</td>
      <td>25</td>
      <td>32</td>
      <td>31</td>
      <td>21</td>
      <td>32</td>
    </tr>
    <tr>
      <th>male</th>
      <td>44</td>
      <td>30</td>
      <td>23</td>
      <td>25</td>
      <td>23</td>
      <td>29</td>
      <td>31</td>
      <td>29</td>
      <td>26</td>
      <td>28</td>
      <td>26</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Method 2 - Starting from the original data</span>
<span class="c1"># create a month series first and use it to perform groupby</span>

<span class="n">months</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="p">(</span><span class="n">data</span>
   <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="n">months</span><span class="p">])[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>
   <span class="o">.</span><span class="n">count</span><span class="p">()</span>
   <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
   <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Birthday</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>83</td>
      <td>75</td>
      <td>70</td>
      <td>66</td>
      <td>71</td>
      <td>78</td>
      <td>90</td>
      <td>77</td>
      <td>70</td>
      <td>65</td>
      <td>73</td>
      <td>85</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>64</td>
      <td>74</td>
      <td>71</td>
      <td>74</td>
      <td>57</td>
      <td>77</td>
      <td>91</td>
      <td>80</td>
      <td>81</td>
      <td>81</td>
      <td>78</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>26</td>
      <td>15</td>
      <td>18</td>
      <td>13</td>
      <td>30</td>
      <td>22</td>
      <td>22</td>
      <td>19</td>
      <td>11</td>
      <td>21</td>
      <td>21</td>
      <td>23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>22</td>
      <td>15</td>
      <td>22</td>
      <td>28</td>
      <td>19</td>
      <td>22</td>
      <td>26</td>
      <td>23</td>
      <td>26</td>
      <td>22</td>
      <td>16</td>
      <td>18</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>7</td>
      <td>11</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>10</td>
      <td>10</td>
      <td>12</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>7</td>
      <td>11</td>
      <td>15</td>
      <td>2</td>
      <td>8</td>
      <td>9</td>
      <td>11</td>
      <td>6</td>
      <td>12</td>
      <td>10</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31</td>
      <td>34</td>
      <td>39</td>
      <td>33</td>
      <td>36</td>
      <td>28</td>
      <td>33</td>
      <td>36</td>
      <td>36</td>
      <td>37</td>
      <td>34</td>
      <td>29</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31</td>
      <td>28</td>
      <td>35</td>
      <td>41</td>
      <td>27</td>
      <td>28</td>
      <td>37</td>
      <td>33</td>
      <td>29</td>
      <td>33</td>
      <td>33</td>
      <td>39</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>18</td>
      <td>20</td>
      <td>19</td>
      <td>21</td>
      <td>22</td>
      <td>26</td>
      <td>26</td>
      <td>15</td>
      <td>14</td>
      <td>23</td>
      <td>23</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>22</td>
      <td>16</td>
      <td>22</td>
      <td>30</td>
      <td>19</td>
      <td>16</td>
      <td>25</td>
      <td>18</td>
      <td>25</td>
      <td>23</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>22</td>
      <td>14</td>
      <td>20</td>
      <td>31</td>
      <td>22</td>
      <td>19</td>
      <td>24</td>
      <td>34</td>
      <td>14</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>16</td>
      <td>22</td>
      <td>26</td>
      <td>20</td>
      <td>21</td>
      <td>23</td>
      <td>18</td>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>38</td>
      <td>32</td>
      <td>35</td>
      <td>24</td>
      <td>37</td>
      <td>25</td>
      <td>25</td>
      <td>25</td>
      <td>32</td>
      <td>31</td>
      <td>21</td>
      <td>32</td>
    </tr>
    <tr>
      <th>male</th>
      <td>44</td>
      <td>30</td>
      <td>23</td>
      <td>25</td>
      <td>23</td>
      <td>29</td>
      <td>31</td>
      <td>29</td>
      <td>26</td>
      <td>28</td>
      <td>26</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Note that although we&#39;ve used &#39;Age&#39; here, any feature would have done. </span>
<span class="c1"># Do you see why?</span>

<span class="c1"># Method 3 - Starting from the original data and assign a new month column</span>
<span class="p">(</span><span class="n">data</span>
   <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">Birthday</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>
   <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">])[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span>
   <span class="o">.</span><span class="n">count</span><span class="p">()</span>
   <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
   <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>month</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>11</th>
      <th>12</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>83</td>
      <td>75</td>
      <td>70</td>
      <td>66</td>
      <td>71</td>
      <td>78</td>
      <td>90</td>
      <td>77</td>
      <td>70</td>
      <td>65</td>
      <td>73</td>
      <td>85</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>64</td>
      <td>74</td>
      <td>71</td>
      <td>74</td>
      <td>57</td>
      <td>77</td>
      <td>91</td>
      <td>80</td>
      <td>81</td>
      <td>81</td>
      <td>78</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>26</td>
      <td>15</td>
      <td>18</td>
      <td>13</td>
      <td>30</td>
      <td>22</td>
      <td>22</td>
      <td>19</td>
      <td>11</td>
      <td>21</td>
      <td>21</td>
      <td>23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>22</td>
      <td>15</td>
      <td>22</td>
      <td>28</td>
      <td>19</td>
      <td>22</td>
      <td>26</td>
      <td>23</td>
      <td>26</td>
      <td>22</td>
      <td>16</td>
      <td>18</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>7</td>
      <td>11</td>
      <td>3</td>
      <td>6</td>
      <td>5</td>
      <td>10</td>
      <td>10</td>
      <td>12</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>8</td>
    </tr>
    <tr>
      <th>male</th>
      <td>7</td>
      <td>11</td>
      <td>15</td>
      <td>2</td>
      <td>8</td>
      <td>9</td>
      <td>11</td>
      <td>6</td>
      <td>12</td>
      <td>10</td>
      <td>9</td>
      <td>8</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>31</td>
      <td>34</td>
      <td>39</td>
      <td>33</td>
      <td>36</td>
      <td>28</td>
      <td>33</td>
      <td>36</td>
      <td>36</td>
      <td>37</td>
      <td>34</td>
      <td>29</td>
    </tr>
    <tr>
      <th>male</th>
      <td>31</td>
      <td>28</td>
      <td>35</td>
      <td>41</td>
      <td>27</td>
      <td>28</td>
      <td>37</td>
      <td>33</td>
      <td>29</td>
      <td>33</td>
      <td>33</td>
      <td>39</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>18</td>
      <td>20</td>
      <td>19</td>
      <td>21</td>
      <td>22</td>
      <td>26</td>
      <td>26</td>
      <td>15</td>
      <td>14</td>
      <td>23</td>
      <td>23</td>
      <td>17</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>22</td>
      <td>16</td>
      <td>22</td>
      <td>30</td>
      <td>19</td>
      <td>16</td>
      <td>25</td>
      <td>18</td>
      <td>25</td>
      <td>23</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>22</td>
      <td>14</td>
      <td>20</td>
      <td>31</td>
      <td>22</td>
      <td>19</td>
      <td>24</td>
      <td>34</td>
      <td>14</td>
    </tr>
    <tr>
      <th>male</th>
      <td>21</td>
      <td>16</td>
      <td>22</td>
      <td>26</td>
      <td>20</td>
      <td>21</td>
      <td>23</td>
      <td>18</td>
      <td>17</td>
      <td>21</td>
      <td>19</td>
      <td>19</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>38</td>
      <td>32</td>
      <td>35</td>
      <td>24</td>
      <td>37</td>
      <td>25</td>
      <td>25</td>
      <td>25</td>
      <td>32</td>
      <td>31</td>
      <td>21</td>
      <td>32</td>
    </tr>
    <tr>
      <th>male</th>
      <td>44</td>
      <td>30</td>
      <td>23</td>
      <td>25</td>
      <td>23</td>
      <td>29</td>
      <td>31</td>
      <td>29</td>
      <td>26</td>
      <td>28</td>
      <td>26</td>
      <td>29</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>D. MultiIndex.</font></center></h3>

<p><h4> We can of course group the data by more than 2 features.</h4>
However, results might get a bit harder to take in.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;Gender&#39;</span><span class="p">,</span><span class="s1">&#39;BloodType&#39;</span><span class="p">])[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">s</span></code></pre></div><div class="highlight"><pre class="chroma">Country         Gender  BloodType
Australia       female  A+           59.36
                        A-           59.90
                        AB+          53.13
                        AB-          61.50
                        B+           56.62
                        B-           66.00
                        O+           58.46
                        O-           58.02
                male    A+           57.67
                        A-           51.70
                        AB+          59.98
                        AB-          62.00
                        B+           58.79
                        B-           44.73
                        O+           56.94
                        O-           59.76
France          female  A+           58.54
                        A-           53.09
                        AB+          63.40
                        B+           58.47
                        B-           61.50
                        O+           60.18
                        O-           61.06
                male    A+           60.81
                        A-           56.00
                        AB+          62.78
                        AB-          41.00
                        B+           55.03
                        B-           67.00
                        O+           53.90
                                     ...  
United Kingdom  female  AB+          49.79
                        AB-          63.00
                        B+           55.33
                        B-           65.50
                        O+           57.16
                        O-           63.23
                male    A+           57.39
                        A-           60.41
                        AB+          53.91
                        AB-          65.33
                        B+           59.68
                        B-           32.67
                        O+           58.37
                        O-           64.83
United States   female  A+           57.46
                        A-           71.54
                        AB+          58.44
                        AB-          53.67
                        B+           55.75
                        B-           65.57
                        O+           57.57
                        O-           41.83
                male    A+           55.07
                        A-           47.08
                        AB+          55.12
                        AB-          66.00
                        B+           54.34
                        B-           71.25
                        O+           61.33
                        O-           55.73
Name: Age, Length: 109, dtype: float64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p><code>s</code> is a Pandas <code>Series</code> object with a <code>MultiIndex</code> object as its index.
</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">index</span></code></pre></div><div class="highlight"><pre class="chroma">MultiIndex(levels=[[&#39;Australia&#39;, &#39;France&#39;, &#39;Iceland&#39;, &#39;Italy&#39;, &#39;New Zealand&#39;, &#39;United Kingdom&#39;, &#39;United States&#39;], [&#39;female&#39;, &#39;male&#39;], [&#39;A+&#39;, &#39;A-&#39;, &#39;AB+&#39;, &#39;AB-&#39;, &#39;B+&#39;, &#39;B-&#39;, &#39;O+&#39;, &#39;O-&#39;]],
           codes=[[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6], [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1], [0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 4, 5, 6, 7, 0, 1, 2, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7]],
           names=[&#39;Country&#39;, &#39;Gender&#39;, &#39;BloodType&#39;])</pre></div>
<p>We can convert the MultiIndexed series to a MultiIndexed dataframe using unstack.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.67</td>
      <td>51.70</td>
      <td>59.98</td>
      <td>62.00</td>
      <td>58.79</td>
      <td>44.73</td>
      <td>56.94</td>
      <td>59.76</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>0.00</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>male</th>
      <td>60.81</td>
      <td>56.00</td>
      <td>62.78</td>
      <td>41.00</td>
      <td>55.03</td>
      <td>67.00</td>
      <td>53.90</td>
      <td>65.62</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>0.00</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>male</th>
      <td>62.09</td>
      <td>35.00</td>
      <td>57.00</td>
      <td>0.00</td>
      <td>59.37</td>
      <td>74.00</td>
      <td>55.13</td>
      <td>81.00</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>male</th>
      <td>54.45</td>
      <td>54.47</td>
      <td>62.60</td>
      <td>44.75</td>
      <td>54.82</td>
      <td>66.00</td>
      <td>57.32</td>
      <td>55.47</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>male</th>
      <td>60.39</td>
      <td>74.75</td>
      <td>65.08</td>
      <td>64.00</td>
      <td>53.96</td>
      <td>52.33</td>
      <td>54.68</td>
      <td>57.42</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.39</td>
      <td>60.41</td>
      <td>53.91</td>
      <td>65.33</td>
      <td>59.68</td>
      <td>32.67</td>
      <td>58.37</td>
      <td>64.83</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.07</td>
      <td>47.08</td>
      <td>55.12</td>
      <td>66.00</td>
      <td>54.34</td>
      <td>71.25</td>
      <td>61.33</td>
      <td>55.73</td>
    </tr>
  </tbody>
</table>
</div>

<p>To access specific data using the MultiIndex for a <strong>Series</strong>, you can use the <code>xs</code> method and specify the level at which you are extracting the data, if you are not using the top level.</p>

<p>To access specific data using the MultiIndex for a <strong>DataFrame</strong>, you can use the <code>loc</code> method, but specifying the level is a bit more involved.</p>

<h4 id="top-level-selection">Top level selection</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">Gender  BloodType
female  A+           59.36
        A-           59.90
        AB+          53.13
        AB-          61.50
        B+           56.62
        B-           66.00
        O+           58.46
        O-           58.02
male    A+           57.67
        A-           51.70
        AB+          59.98
        AB-          62.00
        B+           58.79
        B-           44.73
        O+           56.94
        O-           59.76
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="p">:]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>59.36</td>
      <td>59.9</td>
      <td>53.13</td>
      <td>61.5</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.67</td>
      <td>51.7</td>
      <td>59.98</td>
      <td>62.0</td>
      <td>58.79</td>
      <td>44.73</td>
      <td>56.94</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is equivalent to:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>59.36</td>
      <td>59.9</td>
      <td>53.13</td>
      <td>61.5</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.67</td>
      <td>51.7</td>
      <td>59.98</td>
      <td>62.0</td>
      <td>58.79</td>
      <td>44.73</td>
      <td>56.94</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>

<p>The levels can be exchanged either by unstacking the right level, or by transposing the resulting dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>BloodType</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>59.36</td>
      <td>57.67</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.90</td>
      <td>51.70</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>53.13</td>
      <td>59.98</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>61.50</td>
      <td>62.00</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>56.62</td>
      <td>58.79</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>66.00</td>
      <td>44.73</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>58.02</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">T</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>BloodType</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A+</th>
      <td>59.36</td>
      <td>57.67</td>
    </tr>
    <tr>
      <th>A-</th>
      <td>59.90</td>
      <td>51.70</td>
    </tr>
    <tr>
      <th>AB+</th>
      <td>53.13</td>
      <td>59.98</td>
    </tr>
    <tr>
      <th>AB-</th>
      <td>61.50</td>
      <td>62.00</td>
    </tr>
    <tr>
      <th>B+</th>
      <td>56.62</td>
      <td>58.79</td>
    </tr>
    <tr>
      <th>B-</th>
      <td>66.00</td>
      <td>44.73</td>
    </tr>
    <tr>
      <th>O+</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>O-</th>
      <td>58.02</td>
      <td>59.76</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="to-select-data-at-a-deeper-level-of-the-multiindex-you-need-to-specify-the-level">To select data at a deeper level of the multiindex, you need to  specify the level.</h4>

<h4 id="here-s-an-example-with-gender">Here&rsquo;s an example with Gender.</h4>

<p>Notice the different syntax using <code>xs</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>France</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>NaN</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>NaN</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="selecting-the-data-from-a-deeper-level-is-trickier-with-a-dataframe">Selecting the data from a deeper level is trickier with a dataframe.</h4>

<h4 id="we-need-to-specify-an-index-slice">We need to specify an index <code>slice</code>.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="s1">&#39;female&#39;</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>France</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>0.00</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>0.00</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
  </tbody>
</table>
</div>

<p>or alternatively, using a pandas <code>IndexSlice</code> object.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span> <span class="s1">&#39;female&#39;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>59.36</td>
      <td>59.90</td>
      <td>53.13</td>
      <td>61.50</td>
      <td>56.62</td>
      <td>66.00</td>
      <td>58.46</td>
      <td>58.02</td>
    </tr>
    <tr>
      <th>France</th>
      <td>58.54</td>
      <td>53.09</td>
      <td>63.40</td>
      <td>0.00</td>
      <td>58.47</td>
      <td>61.50</td>
      <td>60.18</td>
      <td>61.06</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>56.95</td>
      <td>63.40</td>
      <td>63.00</td>
      <td>0.00</td>
      <td>60.06</td>
      <td>67.25</td>
      <td>53.15</td>
      <td>60.00</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>55.68</td>
      <td>55.36</td>
      <td>68.50</td>
      <td>46.00</td>
      <td>56.07</td>
      <td>57.00</td>
      <td>57.96</td>
      <td>55.12</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>57.49</td>
      <td>59.20</td>
      <td>50.50</td>
      <td>67.00</td>
      <td>58.19</td>
      <td>45.00</td>
      <td>53.22</td>
      <td>58.33</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>58.42</td>
      <td>63.17</td>
      <td>49.79</td>
      <td>63.00</td>
      <td>55.33</td>
      <td>65.50</td>
      <td>57.16</td>
      <td>63.23</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.46</td>
      <td>71.54</td>
      <td>58.44</td>
      <td>53.67</td>
      <td>55.75</td>
      <td>65.57</td>
      <td>57.57</td>
      <td>41.83</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="same-if-you-want-to-select-bloodtype-as-the-level">Same if you want to select <code>BloodType</code> as the level.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;O+&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;BloodType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>France</th>
      <td>60.18</td>
      <td>53.90</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>53.15</td>
      <td>55.13</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>57.96</td>
      <td>57.32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>53.22</td>
      <td>54.68</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>57.16</td>
      <td>58.37</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.57</td>
      <td>61.33</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;O+&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;BloodType&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Gender</th>
      <th>female</th>
      <th>male</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <td>58.46</td>
      <td>56.94</td>
    </tr>
    <tr>
      <th>France</th>
      <td>60.18</td>
      <td>53.90</td>
    </tr>
    <tr>
      <th>Iceland</th>
      <td>53.15</td>
      <td>55.13</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>57.96</td>
      <td>57.32</td>
    </tr>
    <tr>
      <th>New Zealand</th>
      <td>53.22</td>
      <td>54.68</td>
    </tr>
    <tr>
      <th>United Kingdom</th>
      <td>57.16</td>
      <td>58.37</td>
    </tr>
    <tr>
      <th>United States</th>
      <td>57.57</td>
      <td>61.33</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="multiple-levels-can-be-specified-at-once">Multiple levels can be specified at once</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span><span class="s1">&#39;female&#39;</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;Gender&#39;</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">BloodType
A+     59.36
A-     59.90
AB+    53.13
AB-    61.50
B+     56.62
B-     66.00
O+     58.46
O-     58.02
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">),</span> <span class="p">:]</span></code></pre></div><div class="highlight"><pre class="chroma">BloodType
A+     59.36
A-     59.90
AB+    53.13
AB-    61.50
B+     56.62
B-     66.00
O+     58.46
O-     58.02
Name: (Australia, female), dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span><span class="s1">&#39;O+&#39;</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span><span class="s1">&#39;BloodType&#39;</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">Gender
female    58.46
male      56.94
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;O+&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">Gender
female    58.46
male      56.94
Name: O+, dtype: float64</pre></div>
<h3 id="let-s-visualise-some-of-these-results">Let&rsquo;s visualise some of these results</h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># colormap from matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="c1"># Also see this stackoverflow post for the legend placement: </span>
<span class="c1"># http://stackoverflow.com/questions/23556153/how-to-put-legend-outside-the-plot-with-pandas</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
       <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> 
             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> 
             <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
             <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired_r</span><span class="p">)</span>
     <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_105_0.png" alt="png" /></p>

<h4 id="notice-the-difference-between-the-previous-plot-and-the-one-below">Notice the difference between the previous plot and the one below.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;female&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;Gender&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span>
       <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> 
             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> 
             <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> 
             <span class="n">ec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
             <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">colormap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired_r</span><span class="p">)</span>
     <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_107_0.png" alt="png" /></p>

<h3> <center><font color=MediumVioletRed>E. Fine Tuning.</font></center></h3>

<p>So far we&rsquo;ve applied an operation on a <b>single feature</b> of a GroupBy object.</p>

<p>For instance, we&rsquo;ve computed the mean for the <code>Age</code> feature, and then, <b>in a separate computation</b> we&rsquo;ve computed
a count of the blood types.</p>

<p>You can actually do everything at once by specifying <b>a different operation for each feature</b> using a dictionary,
and use the <code>agg</code> method to aggregate the data across the dataframe.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">data_count</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Counter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

<span class="n">method</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">],</span> <span class="s1">&#39;BloodType&#39;</span><span class="p">:</span> <span class="n">data_count</span><span class="p">}</span>

<span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;data_count&#39;</span><span class="p">:</span><span class="s1">&#39;group_counts&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Age</th>
      <th>BloodType</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>group_counts</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
      <td>19.587278</td>
      <td>((B+, 205), (O-, 41), (AB+, 54), (O+, 328), (A...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
      <td>19.394326</td>
      <td>((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
      <td>19.041143</td>
      <td>((A-, 11), (B+, 47), (A+, 76), (O+, 79), (O-, ...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
      <td>19.961407</td>
      <td>((B+, 59), (A+, 69), (AB+, 9), (O+, 105), (O-,...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
      <td>19.527343</td>
      <td>((O+, 34), (A+, 22), (B-, 4), (B+, 17), (A-, 5...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
      <td>19.490896</td>
      <td>((O+, 52), (A+, 23), (AB+, 3), (B+, 27), (O-, ...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
      <td>19.116494</td>
      <td>((A+, 102), (O+, 160), (B+, 89), (O-, 17), (AB...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
      <td>18.838508</td>
      <td>((A+, 105), (O+, 139), (B+, 96), (AB-, 4), (B-...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
      <td>19.546233</td>
      <td>((O-, 9), (O+, 91), (A+, 75), (AB+, 8), (B+, 5...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
      <td>18.570202</td>
      <td>((A+, 79), (O+, 94), (AB+, 13), (B+, 47), (O-,...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
      <td>20.168651</td>
      <td>((A+, 65), (B+, 55), (O-, 13), (O+, 99), (AB+,...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
      <td>18.856132</td>
      <td>((A+, 67), (B+, 47), (O-, 6), (A-, 17), (O+, 8...</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
      <td>19.167134</td>
      <td>((A+, 89), (B+, 77), (O+, 138), (AB+, 18), (A-...</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
      <td>19.434197</td>
      <td>((A+, 68), (O+, 135), (B+, 80), (A-, 12), (AB+...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="accessing-a-particular-portion-of-the-result-is-just-a-matter-of-navigating-the-multilevel-structure-of-the-index-and-the-columns">Accessing a particular portion of the result is just a matter of navigating the multilevel structure of the index and the columns.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[[(</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">)]]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Age</th>
      <th>BloodType</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>data_count</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <th>male</th>
      <td>57.531773</td>
      <td>19.394326</td>
      <td>((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is equivalent to</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">])</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th colspan="2" halign="left">Age</th>
      <th>BloodType</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>data_count</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Australia</th>
      <th>male</th>
      <td>57.531773</td>
      <td>19.394326</td>
      <td>((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="notice-the-difference-with">Notice the difference with</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;male&#39;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">Age        mean                                                    57.5318
           std                                                     19.3943
BloodType  data_count    ((B+, 214), (AB+, 46), (A+, 239), (O+, 320), (...
Name: (Australia, male), dtype: object</pre></div>
<h4 id="we-can-select-data-using-levels-of-the-columns">We can select data using levels of the columns.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)]]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>Age</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
    </tr>
  </tbody>
</table>
</div>

<p>This is equivalent to</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">([(</span><span class="s1">&#39;Age&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead tr th {
        text-align: left;
    }
    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th></th>
      <th>Age</th>
    </tr>
    <tr>
      <th></th>
      <th></th>
      <th>mean</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>58.101883</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.531773</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>59.207469</td>
    </tr>
    <tr>
      <th>male</th>
      <td>56.768340</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>57.315217</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.953704</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>57.300493</td>
    </tr>
    <tr>
      <th>male</th>
      <td>55.893401</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>55.823770</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.398438</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>57.284047</td>
    </tr>
    <tr>
      <th>male</th>
      <td>58.222222</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>57.299720</td>
    </tr>
    <tr>
      <th>male</th>
      <td>57.536443</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="you-can-go-as-deep-as-you-need">You can go as &ldquo;deep&rdquo; as you need.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;Age&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">58.10188261351052</pre></div>
<p>This is equivalent to</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">xs</span><span class="p">((</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">))[</span><span class="s1">&#39;Age&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">58.10188261351052</pre></div>
<h4 id="to-extract-just-the-values-without-the-index-use-the-values-attribute">To extract just the values (without the index), use the <code>values</code> attribute.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Australia&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span></code></pre></div><div class="highlight"><pre class="chroma">array([dict_items([(&#39;B+&#39;, 205), (&#39;O-&#39;, 41), (&#39;AB+&#39;, 54), (&#39;O+&#39;, 328), (&#39;A+&#39;, 229), (&#39;A-&#39;, 29), (&#39;B-&#39;, 13), (&#39;AB-&#39;, 4)])],
      dtype=object)</pre></div>
<h4 id="cross-tabulation-is-an-effective-way-to-have-a-quick-look-at-how-the-data-is-distributed-across-categories">Cross-tabulation is an effective way to have a quick look at how the data is distributed across categories.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Gender</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">BloodType</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
      <th>All</th>
    </tr>
    <tr>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>female</th>
      <td>658</td>
      <td>83</td>
      <td>128</td>
      <td>10</td>
      <td>543</td>
      <td>33</td>
      <td>929</td>
      <td>116</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>male</th>
      <td>650</td>
      <td>87</td>
      <td>114</td>
      <td>17</td>
      <td>570</td>
      <td>31</td>
      <td>934</td>
      <td>97</td>
      <td>2500</td>
    </tr>
    <tr>
      <th>All</th>
      <td>1308</td>
      <td>170</td>
      <td>242</td>
      <td>27</td>
      <td>1113</td>
      <td>64</td>
      <td>1863</td>
      <td>213</td>
      <td>5000</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">Country</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Gender</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">BloodType</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
      <th>All</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Gender</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Australia</th>
      <th>female</th>
      <td>229</td>
      <td>29</td>
      <td>54</td>
      <td>4</td>
      <td>205</td>
      <td>13</td>
      <td>328</td>
      <td>41</td>
      <td>903</td>
    </tr>
    <tr>
      <th>male</th>
      <td>239</td>
      <td>30</td>
      <td>46</td>
      <td>4</td>
      <td>214</td>
      <td>11</td>
      <td>320</td>
      <td>33</td>
      <td>897</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">France</th>
      <th>female</th>
      <td>76</td>
      <td>11</td>
      <td>10</td>
      <td>0</td>
      <td>47</td>
      <td>2</td>
      <td>79</td>
      <td>16</td>
      <td>241</td>
    </tr>
    <tr>
      <th>male</th>
      <td>69</td>
      <td>6</td>
      <td>9</td>
      <td>1</td>
      <td>59</td>
      <td>2</td>
      <td>105</td>
      <td>8</td>
      <td>259</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Iceland</th>
      <th>female</th>
      <td>22</td>
      <td>5</td>
      <td>2</td>
      <td>0</td>
      <td>17</td>
      <td>4</td>
      <td>34</td>
      <td>8</td>
      <td>92</td>
    </tr>
    <tr>
      <th>male</th>
      <td>23</td>
      <td>1</td>
      <td>3</td>
      <td>0</td>
      <td>27</td>
      <td>1</td>
      <td>52</td>
      <td>1</td>
      <td>108</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Italy</th>
      <th>female</th>
      <td>102</td>
      <td>14</td>
      <td>22</td>
      <td>1</td>
      <td>89</td>
      <td>1</td>
      <td>160</td>
      <td>17</td>
      <td>406</td>
    </tr>
    <tr>
      <th>male</th>
      <td>105</td>
      <td>17</td>
      <td>15</td>
      <td>4</td>
      <td>96</td>
      <td>3</td>
      <td>139</td>
      <td>15</td>
      <td>394</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">New Zealand</th>
      <th>female</th>
      <td>75</td>
      <td>5</td>
      <td>8</td>
      <td>1</td>
      <td>53</td>
      <td>2</td>
      <td>91</td>
      <td>9</td>
      <td>244</td>
    </tr>
    <tr>
      <th>male</th>
      <td>79</td>
      <td>4</td>
      <td>13</td>
      <td>4</td>
      <td>47</td>
      <td>3</td>
      <td>94</td>
      <td>12</td>
      <td>256</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United Kingdom</th>
      <th>female</th>
      <td>65</td>
      <td>6</td>
      <td>14</td>
      <td>1</td>
      <td>55</td>
      <td>4</td>
      <td>99</td>
      <td>13</td>
      <td>257</td>
    </tr>
    <tr>
      <th>male</th>
      <td>67</td>
      <td>17</td>
      <td>11</td>
      <td>3</td>
      <td>47</td>
      <td>3</td>
      <td>89</td>
      <td>6</td>
      <td>243</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">United States</th>
      <th>female</th>
      <td>89</td>
      <td>13</td>
      <td>18</td>
      <td>3</td>
      <td>77</td>
      <td>7</td>
      <td>138</td>
      <td>12</td>
      <td>357</td>
    </tr>
    <tr>
      <th>male</th>
      <td>68</td>
      <td>12</td>
      <td>17</td>
      <td>1</td>
      <td>80</td>
      <td>8</td>
      <td>135</td>
      <td>22</td>
      <td>343</td>
    </tr>
    <tr>
      <th>All</th>
      <th></th>
      <td>1308</td>
      <td>170</td>
      <td>242</td>
      <td>27</td>
      <td>1113</td>
      <td>64</td>
      <td>1863</td>
      <td>213</td>
      <td>5000</td>
    </tr>
  </tbody>
</table>
</div>

<h3> <center><font color=MediumVioletRed>F. GroupBy on continuous features.</font></center></h3>

<p>We&rsquo;ve seen how we can group the data according to the features that are in the original dataset.</p>

<p>For instance, grouping the data by country is trivial. Same for the blood type because these are <b>categorical</b> data.</p>

<p>But what about <code>Age</code>? If we do a <code>groupby</code> without thinking too much about it we get something rather useless.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">g</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="p">[</span><span class="s1">&#39;BloodType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">       Age
count  24     37
       25     72
       26     73
       27     86
       28     69
       29     81
       30     71
       31     86
       32     73
       33     78
       34     54
       35     79
       36     70
       37     88
       38     70
       39     81
       40     62
       41     75
       42     66
       43     70
       44     67
       45     80
       46     85
       47     65
       48     77
       49     88
       50     77
       51     75
       52     83
       53     86
              ..
freq   62     28
       63     41
       64     26
       65     26
       66     38
       67     28
       68     35
       69     36
       70     25
       71     25
       72     39
       73     21
       74     32
       75     39
       76     21
       77     20
       78     33
       79     32
       80     30
       81     21
       82     34
       83     27
       84     25
       85     25
       86     28
       87     32
       88     23
       89     30
       90     24
       91     18
Length: 272, dtype: object</pre></div>
<p>We get one entry for each year of <code>Age</code> which isn&rsquo;t what we want.</p>

<p>Ideally, we&rsquo;d want to split the data into age groups and use that to group the data. Pandas has a <code>cut</code> function that allows us to do that.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">count    5000.000000
mean       57.447600
std        19.339422
min        24.000000
25%        41.000000
50%        57.000000
75%        74.000000
max        91.000000
Name: Age, dtype: float64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">bins</span></code></pre></div><div class="highlight"><pre class="chroma">array([20, 30, 40, 50, 60, 70, 80, 90])</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Age</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
<span class="n">labels</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">0    (50, 60]
1    (50, 60]
2    (50, 60]
3    (80, 90]
4    (70, 80]
Name: Age, dtype: category
Categories (7, interval[int64]): [(20, 30] &lt; (30, 40] &lt; (40, 50] &lt; (50, 60] &lt; (60, 70] &lt; (70, 80] &lt; (80, 90]]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">data</span><span class="o">.</span><span class="n">Age</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">0    51
1    57
2    55
3    86
4    73
Name: Age, dtype: int64</pre></div>
<h4 id="we-can-use-the-newly-created-label-to-partition-the-age-variable-into-intervals">We can use the newly created label to partition the Age variable into intervals.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>

<span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Age             (20, 30]  (30, 40]  (40, 50]  (50, 60]  (60, 70]  (70, 80]  \
Country                                                                      
Australia            177       254       269       275       257       280   
France                48        76        68        71        75        76   
Iceland               16        32        36        24        30        26   
Italy                 74       131       120       134       128        96   
New Zealand           49        76        81        70        93        57   
United Kingdom        54        69        77        64        72        91   
United States         71       103        99       111       102       115   

Age             (80, 90]  
Country                   
Australia            272  
France                82  
Iceland               34  
Italy                111  
New Zealand           71  
United Kingdom        69  
United States         94  </pre></div>
<p>If we want the <code>Age</code> groups to be our index we can use <code>unstack(0)</code> or much the more explicit and therefore better, <code>unstack('Country')</code> .</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Country</th>
      <th>Australia</th>
      <th>France</th>
      <th>Iceland</th>
      <th>Italy</th>
      <th>New Zealand</th>
      <th>United Kingdom</th>
      <th>United States</th>
    </tr>
    <tr>
      <th>Age</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(20, 30]</th>
      <td>177</td>
      <td>48</td>
      <td>16</td>
      <td>74</td>
      <td>49</td>
      <td>54</td>
      <td>71</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>254</td>
      <td>76</td>
      <td>32</td>
      <td>131</td>
      <td>76</td>
      <td>69</td>
      <td>103</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>269</td>
      <td>68</td>
      <td>36</td>
      <td>120</td>
      <td>81</td>
      <td>77</td>
      <td>99</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>275</td>
      <td>71</td>
      <td>24</td>
      <td>134</td>
      <td>70</td>
      <td>64</td>
      <td>111</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>257</td>
      <td>75</td>
      <td>30</td>
      <td>128</td>
      <td>93</td>
      <td>72</td>
      <td>102</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>280</td>
      <td>76</td>
      <td>26</td>
      <td>96</td>
      <td>57</td>
      <td>91</td>
      <td>115</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>272</td>
      <td>82</td>
      <td>34</td>
      <td>111</td>
      <td>71</td>
      <td>69</td>
      <td>94</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="just-like-before-we-can-pass-more-features-to-the-groupby-method">Just like before, we can pass more features to the <code>groupby</code> method.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">grouped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="s1">&#39;BloodType&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">])</span>
<span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;BloodType&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BloodType</th>
      <th>A+</th>
      <th>A-</th>
      <th>AB+</th>
      <th>AB-</th>
      <th>B+</th>
      <th>B-</th>
      <th>O+</th>
      <th>O-</th>
    </tr>
    <tr>
      <th>Country</th>
      <th>Age</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="7" valign="top">Australia</th>
      <th>(20, 30]</th>
      <td>41.0</td>
      <td>11.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>49.0</td>
      <td>3.0</td>
      <td>53.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>63.0</td>
      <td>8.0</td>
      <td>14.0</td>
      <td>2.0</td>
      <td>57.0</td>
      <td>4.0</td>
      <td>97.0</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>73.0</td>
      <td>9.0</td>
      <td>16.0</td>
      <td>2.0</td>
      <td>56.0</td>
      <td>2.0</td>
      <td>100.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>74.0</td>
      <td>5.0</td>
      <td>16.0</td>
      <td>0.0</td>
      <td>67.0</td>
      <td>2.0</td>
      <td>100.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>60.0</td>
      <td>7.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>55.0</td>
      <td>8.0</td>
      <td>106.0</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>85.0</td>
      <td>7.0</td>
      <td>15.0</td>
      <td>1.0</td>
      <td>57.0</td>
      <td>4.0</td>
      <td>101.0</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>65.0</td>
      <td>11.0</td>
      <td>16.0</td>
      <td>3.0</td>
      <td>77.0</td>
      <td>1.0</td>
      <td>84.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">France</th>
      <th>(20, 30]</th>
      <td>17.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>19.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>17.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>28.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>17.0</td>
      <td>3.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>12.0</td>
      <td>0.0</td>
      <td>27.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>18.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>2.0</td>
      <td>32.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>23.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>25.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>22.0</td>
      <td>5.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>30.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>17.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">Iceland</th>
      <th>(20, 30]</th>
      <td>4.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>7.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>1.0</td>
      <td>15.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>5.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>17.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>8.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>5.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>0.0</td>
      <td>12.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>7.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>3.0</td>
      <td>9.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>9.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>10.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">Italy</th>
      <th>(20, 30]</th>
      <td>19.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>23.0</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>39.0</td>
      <td>8.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>0.0</td>
      <td>45.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>36.0</td>
      <td>4.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>40.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>27.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>32.0</td>
      <td>1.0</td>
      <td>62.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>33.0</td>
      <td>2.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>27.0</td>
      <td>1.0</td>
      <td>52.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>33.0</td>
      <td>4.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>29.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>19.0</td>
      <td>5.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>25.0</td>
      <td>1.0</td>
      <td>47.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">New Zealand</th>
      <th>(20, 30]</th>
      <td>13.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>11.0</td>
      <td>1.0</td>
      <td>22.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>19.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>17.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>1.0</td>
      <td>39.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>24.0</td>
      <td>2.0</td>
      <td>4.0</td>
      <td>1.0</td>
      <td>8.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>33.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>1.0</td>
      <td>21.0</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>24.0</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>17.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>23.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>15.0</td>
      <td>0.0</td>
      <td>21.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">United Kingdom</th>
      <th>(20, 30]</th>
      <td>12.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>21.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>21.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>13.0</td>
      <td>3.0</td>
      <td>23.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>22.0</td>
      <td>2.0</td>
      <td>5.0</td>
      <td>0.0</td>
      <td>14.0</td>
      <td>0.0</td>
      <td>31.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>14.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>14.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>15.0</td>
      <td>7.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>11.0</td>
      <td>0.0</td>
      <td>31.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>28.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>24.0</td>
      <td>1.0</td>
      <td>28.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>19.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>1.0</td>
      <td>29.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th rowspan="7" valign="top">United States</th>
      <th>(20, 30]</th>
      <td>21.0</td>
      <td>3.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>16.0</td>
      <td>1.0</td>
      <td>21.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(30, 40]</th>
      <td>21.0</td>
      <td>1.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>26.0</td>
      <td>1.0</td>
      <td>41.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>(40, 50]</th>
      <td>23.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>1.0</td>
      <td>30.0</td>
      <td>1.0</td>
      <td>31.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>(50, 60]</th>
      <td>27.0</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>1.0</td>
      <td>25.0</td>
      <td>1.0</td>
      <td>40.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(60, 70]</th>
      <td>17.0</td>
      <td>6.0</td>
      <td>5.0</td>
      <td>2.0</td>
      <td>26.0</td>
      <td>2.0</td>
      <td>39.0</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>(70, 80]</th>
      <td>22.0</td>
      <td>1.0</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>18.0</td>
      <td>5.0</td>
      <td>61.0</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>(80, 90]</th>
      <td>24.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>15.0</td>
      <td>3.0</td>
      <td>39.0</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>The End&hellip;</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/pandas/">pandas</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/groupby/">groupby</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/data-wrangling/">data wrangling</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/10/unicode_intro/">
                <h2 class="post-title">Unicode strings in Python</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 5, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;16&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3273&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<h1 id="1-unicode-an-introduction">1. Unicode: an introduction.</h1>

<p>Computers only understand one thing: <b>binary</b> code. For instance, when you type the letter &ldquo;A&rdquo; the computer
must represent this as a sequence of 0s and 1s.</p>

<p>Therefore we need a rule (code) for converting between characters and sequences of 0s and 1s. A basic way to do this is
provided by the <a href="http://www.ascii-code.com/">ASCII code</a>.</p>

<p>The ASCII code uses 1 byte (8 bits) to encode 256 possible characters, corresponding to a binary number between 0 and $255 = 2^7+2^6+2^5+2^4+2^3+2^2+2^1+2^0$.</p>

<p>These can be split into 3 groups (see the link above). The usual characters used in English are those whose ASCII codes are between
32 and 127.</p>

<p>For instance the letter &ldquo;A&rdquo; corresponds to the number 65 which is treated by the computer as the binary sequence $1000001$.</p>

<p>In Python, the ASCII code of a given letter can be obtained using the <code>ord</code> function. It can be converted to binary using <code>bin</code>, and to hexadecimal (base 16) code using <code>hex</code>.</p>

<p>Conversely, the character corresponding to a given ASCII code can be obtained using the <code>chr</code> function.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span>


<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Character: A&#34;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;ASCII code:&#34;</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Binary code:&#34;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Hexadecimal code:&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;chr(65):&#34;</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">65</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>
<div class="highlight"><pre class="chroma">Character: A
ASCII code: 65
Binary code: 0b1000001
Hexadecimal code: 0x41
chr(65): A</pre></div>
<p>The result above tells us that the <strong>binary</strong> code for A (starting with <code>0b</code>) corresponds to the decimal number $2^6+2^0=64+1=65$.</p>

<p>Similarly, the <strong>hexadecimal</strong> code (starting with <code>0x</code>) tells us that A corresponds to $4\times 16^1+1\times 16^0=64+1=65$ in old money (base 10).</p>

<p>Let&rsquo;s have a look at all the characters whose ASCII code is between 32 and 127</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">)])</span></code></pre></div><div class="highlight"><pre class="chroma">[&#39; &#39;, &#39;!&#39;, &#39;&#34;&#39;, &#39;#&#39;, &#39;$&#39;, &#39;%&#39;, &#39;&amp;&#39;, &#34;&#39;&#34;, &#39;(&#39;, &#39;)&#39;, &#39;*&#39;, &#39;+&#39;, &#39;,&#39;, &#39;-&#39;, &#39;.&#39;, &#39;/&#39;, &#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;:&#39;, &#39;;&#39;, &#39;&lt;&#39;, &#39;=&#39;, &#39;&gt;&#39;, &#39;?&#39;, &#39;@&#39;, &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;, &#39;H&#39;, &#39;I&#39;, &#39;J&#39;, &#39;K&#39;, &#39;L&#39;, &#39;M&#39;, &#39;N&#39;, &#39;O&#39;, &#39;P&#39;, &#39;Q&#39;, &#39;R&#39;, &#39;S&#39;, &#39;T&#39;, &#39;U&#39;, &#39;V&#39;, &#39;W&#39;, &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;, &#39;[&#39;, &#39;\\&#39;, &#39;]&#39;, &#39;^&#39;, &#39;_&#39;, &#39;`&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;, &#39;k&#39;, &#39;l&#39;, &#39;m&#39;, &#39;n&#39;, &#39;o&#39;, &#39;p&#39;, &#39;q&#39;, &#39;r&#39;, &#39;s&#39;, &#39;t&#39;, &#39;u&#39;, &#39;v&#39;, &#39;w&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;, &#39;{&#39;, &#39;|&#39;, &#39;}&#39;, &#39;~&#39;]</pre></div>
<p>Because the ASCII code is using (at most) 1 byte, it cannot represent more than 256 characters. This is sufficient to writing English text but it's not enough to code other symbols such as non-English alphabet, accented characters, as well as more esoteric characters... Hence, another type of character encoding is needed.</p>
<p>Modern character encoding  is built on <b>Unicode</b> which contains (at this time) more than <a href="http://www.babelstone.co.uk/Unicode/HowMany.html">130,000 characters</a>. Note that not all web browsers/fonts are able to display all these characters. In Unicode each character is represented by a code point. When stored/processed by a computer the character is encoded on 1 or more bytes. </p>

<div style="background-color:#FBEFFB;"><p style="font-size:20px;color:#FF0080">&#9888; Beware!</p> <!--- Warning --->

<p><b>We mustn't confuse the code point and the byte encoding associated with any given character</b>.</p> 
<p>Think of the code point as an identification number for a character (kind of like your social security number). This code point is distinct from the binary representation of said character in terms of 1s and 0s. <p>How do we connect the two?</p> <p>That's what <b>encodings</b>  are for. An encoding provides a convention for passing from code point to bytes.</p>


<p>There are several encodings of Unicode characters. The main one for our purpose is called UTF-8. It uses a variable length encoding (1, 2, 3 or 4 bytes).</p>

<p>Unicode has the advantage of being a superset of ASCII. In other words, all the ASCII codes are also valid <a href="http://unicode-table.com/en/">Unicode codes</a>.</p>

<p>Here's an example. The <a href="http://www.fileformat.info/info/unicode/char/20aC/index.htm">euro sign</a>  &#8364; has code <code>U+20AC</code>.
The <code>U+</code> tells us it's a unicode code point and the <code>20AC</code> is a hexadecimal number (base 16) which corresponds to 8364 in base 10.</p>

<p>In Python 3 <b>strings are by default unicode</b>, so the type <code>str</code> holds for any valid unicode character, <em>not just those that can be encoded using ASCII</em>.</p>

<p>We can represent code points in Python using a special string starting with <code>\u</code>.</p>

</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">euro</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\u20AC</span><span class="s1">&#39;</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Character:&#34;</span><span class="p">,</span> <span class="n">euro</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Decimal code point:&#34;</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">euro</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Hexadecimal code point:&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">euro</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Binary code point:&#34;</span><span class="p">,</span> <span class="nb">bin</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">euro</span><span class="p">)))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Type:&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">euro</span><span class="p">))</span> 
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Character length:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">euro</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">Character: €
Decimal code point: 8364
Hexadecimal code point: 0x20ac
Binary code point: 0b10000010101100
Type: &lt;class &#39;str&#39;&gt;
Character length: 1</pre></div>
<p>Notice that we have an string of type <code>str</code> and its length is 1 character. 
</p>
<p>Notice also that, in this case, the Unicode code point used by Python is actually based on the hexadecimal code associated with the character.</p>

<p>The hexadecimal value <code>20ac</code> corresponds to the decimal value $2\times 16^3+0\times 16^2+10\times 16^1+12\times 16^0=8192+160+12=8364$.</p>

<p>If we encode the string (character really) using UTF-8, we get its byte representation, which <b>has type <code>bytes</code> and is encoded over 3 bytes</b>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">euroUTF8</span> <span class="o">=</span> <span class="n">euro</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded character:&#34;</span><span class="p">,</span> <span class="n">euroUTF8</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded type:&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">euroUTF8</span><span class="p">))</span> 
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded character length:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">euroUTF8</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">UTF-8 encoded character: b&#39;\xe2\x82\xac&#39;
UTF-8 encoded type: &lt;class &#39;bytes&#39;&gt;
UTF-8 encoded character length: 3</pre></div>
<p>Contrast this with:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">A_UTF8</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded character:&#34;</span><span class="p">,</span> <span class="n">A_UTF8</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded type:&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">A_UTF8</span><span class="p">))</span> 
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded character length:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">A_UTF8</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">UTF-8 encoded character: b&#39;A&#39;
UTF-8 encoded type: &lt;class &#39;bytes&#39;&gt;
UTF-8 encoded character length: 1</pre></div>
<p><strong>As long as we don&rsquo;t confuse unicode and bytes, and get our encodings right, we and Python strings will live happily for ever after.</strong></p>

<p><strong>One way to think about this is that we encode a string to pass it to the computer, and we decode it to show it to a human.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Unicode character:&#34;</span><span class="p">,</span> <span class="n">euro</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8 encoded character:&#34;</span><span class="p">,</span> <span class="n">euroUTF8</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Decoded bytes:&#34;</span><span class="p">,</span> <span class="n">euroUTF8</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">Unicode character: €
UTF-8 encoded character: b&#39;\xe2\x82\xac&#39;
Decoded bytes: €</pre></div>
<p>Note that the default encoding on many systems (at least in the English speaking world) used to be ASCII, but UTF-8 has become the norm.</p>

<p>(There are some additional things happening with the <code>print</code> function, but we won&rsquo;t get into it here.)</p>

<p>Note that <code>ord</code> and <code>chr</code> work with Unicode.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;€&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">8364</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">chr</span><span class="p">(</span><span class="mi">8364</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">&#39;€&#39;</pre></div>
<p>You can also refer to unicode characters using their name in Python using the special <code>&lsquo;\N{NAME}&rsquo;</code> syntax.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s1">&#39;</span><span class="se">\N{EURO SIGN}</span><span class="s1">&#39;</span></code></pre></div><div class="highlight"><pre class="chroma">&#39;€&#39;</pre></div>
<p>Most of the agonising pain associated with Unicode in Python has to do with not specifying (or knowing) whether we&rsquo;re dealing with unicode or bytes.</p>

<p>Once that&rsquo;s clear, your Python code can handle non-ASCII characters. Let&rsquo;s start with something easy.</p>

<h4> German</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;Straße&#39;</span>
<span class="n">sUTF8</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="p">,</span> <span class="n">sUTF8</span></code></pre></div><div class="highlight"><pre class="chroma">(&#39;Straße&#39;, b&#39;Stra\xc3\x9fe&#39;)</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Length of s :&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Length of encoded s:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sUTF8</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">Length of s : 6
Length of encoded s: 7</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Unicode :&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">Unicode : [&#39;S&#39;, &#39;t&#39;, &#39;r&#39;, &#39;a&#39;, &#39;ß&#39;, &#39;e&#39;]</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8   :&#34;</span><span class="p">,[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sUTF8</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma">UTF-8   : [83, 116, 114, 97, 195, 159, 101]</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
<p>Notice how the character ß is represented by the 2 bytes <code>\xc3\x9f</code> however, 223 is the code point for the German <em>Eszett</em>, so is there a problem? </p>    
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">chr</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">&#39;ß&#39;</pre></div>
<p>In base 16 (hexadecimal), <code>df</code> corresponds to the number 223.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">int</span><span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">223</pre></div>
<p>We can specify a hexadecimal code in a string using the <code>\x</code> prefix.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s1">&#39;</span><span class="se">\xdf</span><span class="s1">&#39;</span></code></pre></div><div class="highlight"><pre class="chroma">&#39;ß&#39;</pre></div>
<p>So if <code>&lsquo;\xdf&rsquo;</code> represents our unicode character, what does <code>&ldquo;\xc3\x9f&rdquo;</code> represents?</p>

<p>It represents the encoding of our unicode character over 2 bytes using UTF-8.</p>

<p>We can decode the corresponding byte string and get the unicode character to print to the notebook.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xc3\x9f</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">&#39;ß&#39;</pre></div>
<p>In a different encoding (e.g. <code>latin-1</code>), the same letter would be encoded as <code>\xdf</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">b&#39;Stra\xdfe&#39;</pre></div>
<h4 id="french">French</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&#34;Les cons, ça ose tout. C&#39;est même à ça qu&#39;on les reconnaît.&#34;</span>
<span class="n">sUTF8</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sUTF8</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Les cons, ça ose tout. C&#39;est même à ça qu&#39;on les reconnaît.
b&#34;Les cons, \xc3\xa7a ose tout. C&#39;est m\xc3\xaame \xc3\xa0 \xc3\xa7a qu&#39;on les reconna\xc3\xaet.&#34;</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sLATIN1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;latin-1&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="n">sLATIN1</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Les cons, ça ose tout. C&#39;est même à ça qu&#39;on les reconnaît.
b&#34;Les cons, \xe7a ose tout. C&#39;est m\xeame \xe0 \xe7a qu&#39;on les reconna\xeet.&#34;</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="s2">&#34;Length of s :&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">,</span>  
      <span class="s2">&#34;Length of UTF-8 encoded s:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sUTF8</span><span class="p">),</span> <span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">,</span>  
      <span class="s2">&#34;Length of LATIN-1 encoded s:&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sLATIN1</span><span class="p">),</span>
      <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Unicode :&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">],</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34;UTF-8   :&#34;</span><span class="p">,[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sUTF8</span><span class="p">],</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34;Latin-1 :&#34;</span><span class="p">,[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sLATIN1</span><span class="p">],</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Length of s : 59     Length of UTF-8 encoded s: 64   Length of LATIN-1 encoded s: 59 

Unicode : [&#39;L&#39;, &#39;e&#39;, &#39;s&#39;, &#39; &#39;, &#39;c&#39;, &#39;o&#39;, &#39;n&#39;, &#39;s&#39;, &#39;,&#39;, &#39; &#39;, &#39;ç&#39;, &#39;a&#39;, &#39; &#39;, &#39;o&#39;, &#39;s&#39;, &#39;e&#39;, &#39; &#39;, &#39;t&#39;, &#39;o&#39;, &#39;u&#39;, &#39;t&#39;, &#39;.&#39;, &#39; &#39;, &#39;C&#39;, &#34;&#39;&#34;, &#39;e&#39;, &#39;s&#39;, &#39;t&#39;, &#39; &#39;, &#39;m&#39;, &#39;ê&#39;, &#39;m&#39;, &#39;e&#39;, &#39; &#39;, &#39;à&#39;, &#39; &#39;, &#39;ç&#39;, &#39;a&#39;, &#39; &#39;, &#39;q&#39;, &#39;u&#39;, &#34;&#39;&#34;, &#39;o&#39;, &#39;n&#39;, &#39; &#39;, &#39;l&#39;, &#39;e&#39;, &#39;s&#39;, &#39; &#39;, &#39;r&#39;, &#39;e&#39;, &#39;c&#39;, &#39;o&#39;, &#39;n&#39;, &#39;n&#39;, &#39;a&#39;, &#39;î&#39;, &#39;t&#39;, &#39;.&#39;] 

UTF-8   : [76, 101, 115, 32, 99, 111, 110, 115, 44, 32, 195, 167, 97, 32, 111, 115, 101, 32, 116, 111, 117, 116, 46, 32, 67, 39, 101, 115, 116, 32, 109, 195, 170, 109, 101, 32, 195, 160, 32, 195, 167, 97, 32, 113, 117, 39, 111, 110, 32, 108, 101, 115, 32, 114, 101, 99, 111, 110, 110, 97, 195, 174, 116, 46] 

Latin-1 : [76, 101, 115, 32, 99, 111, 110, 115, 44, 32, 231, 97, 32, 111, 115, 101, 32, 116, 111, 117, 116, 46, 32, 67, 39, 101, 115, 116, 32, 109, 234, 109, 101, 32, 224, 32, 231, 97, 32, 113, 117, 39, 111, 110, 32, 108, 101, 115, 32, 114, 101, 99, 111, 110, 110, 97, 238, 116, 46] </pre></div>
<p>This is fine but these languages are using the usual latin alphabet with the exception of a few special characters such as accents.</p>

<p>What about languages that use a completely different alphabet? Let&rsquo;s find out.</p>

<h4 id="greek">Greek</h4>

<p>(source: <a href="http://sacred-texts.com/cla/homer/greek/ili01.htm">http://sacred-texts.com/cla/homer/greek/ili01.htm</a>)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># unicode string</span>
<span class="n">iliad</span> <span class="o">=</span>  <span class="s2">&#34;μῆνιν ἄειδε θεὰ Πηληϊάδεω Ἀχιλῆος&#34;</span>
<span class="k">print</span><span class="p">(</span><span class="n">iliad</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">iliad</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iliad</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">μῆνιν ἄειδε θεὰ Πηληϊάδεω Ἀχιλῆος
&lt;class &#39;str&#39;&gt;
34</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># byte string</span>
<span class="n">iliad</span> <span class="o">=</span> <span class="s2">&#34;μῆνιν ἄειδε θεὰ Πηληϊάδεω Ἀχιλῆος&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">iliad</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">iliad</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iliad</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">b&#39;\xce\xbc\xe1\xbf\x86\xce\xbd\xce\xb9\xce\xbd \xe1\xbc\x84\xce\xb5\xce\xb9\xce\xb4\xce\xb5 \xce\xb8\xce\xb5\xe1\xbd\xb0 \xce\xa0\xce\xb7\xce\xbb\xce\xb7\xce\xb9\xcc\x88\xe1\xbd\xb1\xce\xb4\xce\xb5\xcf\x89 \xe1\xbc\x88\xcf\x87\xce\xb9\xce\xbb\xe1\xbf\x86\xce\xbf\xcf\x82&#39;
&lt;class &#39;bytes&#39;&gt;
70</pre></div>
<p><br>
<div style="background-color:#FBEFFB;"><p style="font-size:20px;color:#FF0080">&#9888; Stop and think!</p> <!--- Warning --->
So how many characters are there in the string? 70 or 34?
How would you list the individual characters within the string?
</div>
<br></p>

<p>The answer is 34. These are the actual characters that compose the string.</p>

<p>The encoded version will have a different number of bytes depending on the encoding.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># unicode string</span>
<span class="n">iliad</span> <span class="o">=</span>  <span class="s2">&#34;μῆνιν ἄειδε θεὰ Πηληϊάδεω Ἀχιλῆος&#34;</span>

<span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">iliad</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">1    μ
2    ῆ
3    ν
4    ι
5    ν
6     
7    ἄ
8    ε
9    ι
10   δ
11   ε
12    
13   θ
14   ε
15   ὰ
16    
17   Π
18   η
19   λ
20   η
21   ι
22   ̈
23   ά
24   δ
25   ε
26   ω
27    
28   Ἀ
29   χ
30   ι
31   λ
32   ῆ
33   ο
34   ς</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># byte string</span>
<span class="n">iliad_encoded</span> <span class="o">=</span>  <span class="s2">&#34;μῆνιν ἄειδε θεὰ Πηληϊάδεω Ἀχιλῆος&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">iliad_encoded</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">1    206
2    188
3    225
4    191
5    134
6    206
7    189
8    206
9    185
10   206
11   189
12   32
13   225
14   188
15   132
16   206
17   181
18   206
19   185
20   206
21   180
22   206
23   181
24   32
25   206
26   184
27   206
28   181
29   225
30   189
31   176
32   32
33   206
34   160
35   206
36   183
37   206
38   187
39   206
40   183
41   206
42   185
43   204
44   136
45   225
46   189
47   177
48   206
49   180
50   206
51   181
52   207
53   137
54   32
55   225
56   188
57   136
58   207
59   135
60   206
61   185
62   206
63   187
64   225
65   191
66   134
67   206
68   191
69   207
70   130</pre></div>
<h4 id="what-s-going-on">What&rsquo;s going on?</h4>

<p>We have a <strong>sequence of bytes</strong> and we are outputing each individual byte value.</p>

<p>Python has no way of knowing what characters these bytes represent, hence we see a bunch of numbers.</p>

<p>The same applies to any other language.</p>

<h4 id="hebrew">Hebrew</h4>

<p>(source: <a href="http://sacred-texts.com/bib/tan/gen001.htm">http://sacred-texts.com/bib/tan/gen001.htm</a>)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># unicode string</span>
<span class="n">gen1</span> <span class="o">=</span> <span class="s2">&#34;בְּרֵאשִׁ֖ית בָּרָ֣א אֱלֹהִ֑ים אֵ֥ת הַשָּׁמַ֖יִם וְאֵ֥ת הָאָֽרֶץ&#34;</span>
<span class="k">print</span><span class="p">(</span><span class="n">gen1</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">gen1</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gen1</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">בְּרֵאשִׁ֖ית בָּרָ֣א אֱלֹהִ֑ים אֵ֥ת הַשָּׁמַ֖יִם וְאֵ֥ת הָאָֽרֶץ
&lt;class &#39;str&#39;&gt;
64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># byte string</span>
<span class="n">gen1_UTF8</span> <span class="o">=</span> <span class="s2">&#34;בְּרֵאשִׁ֖ית בָּרָ֣א אֱלֹהִ֑ים אֵ֥ת הַשָּׁמַ֖יִם וְאֵ֥ת הָאָֽרֶץ&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">gen1_UTF8</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">gen1_UTF8</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gen1_UTF8</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">b&#39;\xd7\x91\xd6\xbc\xd6\xb0\xd7\xa8\xd6\xb5\xd7\x90\xd7\xa9\xd7\x81\xd6\xb4\xd6\x96\xd7\x99\xd7\xaa \xd7\x91\xd6\xbc\xd6\xb8\xd7\xa8\xd6\xb8\xd6\xa3\xd7\x90 \xd7\x90\xd6\xb1\xd7\x9c\xd6\xb9\xd7\x94\xd6\xb4\xd6\x91\xd7\x99\xd7\x9d \xd7\x90\xd6\xb5\xd6\xa5\xd7\xaa \xd7\x94\xd6\xb7\xd7\xa9\xd7\x81\xd6\xbc\xd6\xb8\xd7\x9e\xd6\xb7\xd6\x96\xd7\x99\xd6\xb4\xd7\x9d \xd7\x95\xd6\xb0\xd7\x90\xd6\xb5\xd6\xa5\xd7\xaa \xd7\x94\xd6\xb8\xd7\x90\xd6\xb8\xd6\xbd\xd7\xa8\xd6\xb6\xd7\xa5&#39;
&lt;class &#39;bytes&#39;&gt;
122</pre></div>
<h4 id="chinese">Chinese</h4>

<p>(source: <a href="http://ctext.org/art-of-war">http://ctext.org/art-of-war</a>)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># unicode string</span>
<span class="n">sun</span> <span class="o">=</span> <span class="s2">&#34;孫子曰：兵者，國之大事，死生之地，存亡之道，不可不察也&#34;</span>
<span class="k">print</span><span class="p">(</span><span class="n">sun</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">sun</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sun</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">孫子曰：兵者，國之大事，死生之地，存亡之道，不可不察也
&lt;class &#39;str&#39;&gt;
27</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># byte string</span>
<span class="n">sun_UTF8</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&#34;孫子曰：兵者，國之大事，死生之地，存亡之道，不可不察也&#34;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sun_UTF8</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">sun_UTF8</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sun_UTF8</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">b&#39;\xe5\xad\xab\xe5\xad\x90\xe6\x9b\xb0\xef\xbc\x9a\xe5\x85\xb5\xe8\x80\x85\xef\xbc\x8c\xe5\x9c\x8b\xe4\xb9\x8b\xe5\xa4\xa7\xe4\xba\x8b\xef\xbc\x8c\xe6\xad\xbb\xe7\x94\x9f\xe4\xb9\x8b\xe5\x9c\xb0\xef\xbc\x8c\xe5\xad\x98\xe4\xba\xa1\xe4\xb9\x8b\xe9\x81\x93\xef\xbc\x8c\xe4\xb8\x8d\xe5\x8f\xaf\xe4\xb8\x8d\xe5\xaf\x9f\xe4\xb9\x9f&#39;
&lt;class &#39;bytes&#39;&gt;
81</pre></div>
<h4 id="other-characters">Other characters</h4>

<p>Unicode is not restricted to what we may traditionally think as human languages. It also includes many other characters.</p>

<p>Let&rsquo;s create a helper function to print a large number of unicode characters in a nice way.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">print_unicode</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">%</span><span class="n">width</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">print_unicode</span><span class="p">(</span><span class="mi">128000</span><span class="p">,</span> <span class="mi">128300</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">🐀
🐁 🐂 🐃 🐄 🐅 🐆 🐇 🐈 🐉 🐊 🐋 🐌 🐍 🐎 🐏 🐐 🐑 🐒 🐓 🐔 🐕 🐖 🐗 🐘 🐙 🐚 🐛 🐜 🐝 🐞
🐟 🐠 🐡 🐢 🐣 🐤 🐥 🐦 🐧 🐨 🐩 🐪 🐫 🐬 🐭 🐮 🐯 🐰 🐱 🐲 🐳 🐴 🐵 🐶 🐷 🐸 🐹 🐺 🐻 🐼
🐽 🐾 🐿 👀 👁 👂 👃 👄 👅 👆 👇 👈 👉 👊 👋 👌 👍 👎 👏 👐 👑 👒 👓 👔 👕 👖 👗 👘 👙 👚
👛 👜 👝 👞 👟 👠 👡 👢 👣 👤 👥 👦 👧 👨 👩 👪 👫 👬 👭 👮 👯 👰 👱 👲 👳 👴 👵 👶 👷 👸
👹 👺 👻 👼 👽 👾 👿 💀 💁 💂 💃 💄 💅 💆 💇 💈 💉 💊 💋 💌 💍 💎 💏 💐 💑 💒 💓 💔 💕 💖
💗 💘 💙 💚 💛 💜 💝 💞 💟 💠 💡 💢 💣 💤 💥 💦 💧 💨 💩 💪 💫 💬 💭 💮 💯 💰 💱 💲 💳 💴
💵 💶 💷 💸 💹 💺 💻 💼 💽 💾 💿 📀 📁 📂 📃 📄 📅 📆 📇 📈 📉 📊 📋 📌 📍 📎 📏 📐 📑 📒
📓 📔 📕 📖 📗 📘 📙 📚 📛 📜 📝 📞 📟 📠 📡 📢 📣 📤 📥 📦 📧 📨 📩 📪 📫 📬 📭 📮 📯 📰
📱 📲 📳 📴 📵 📶 📷 📸 📹 📺 📻 📼 📽 📾 📿 🔀 🔁 🔂 🔃 🔄 🔅 🔆 🔇 🔈 🔉 🔊 🔋 🔌 🔍 🔎
🔏 🔐 🔑 🔒 🔓 🔔 🔕 🔖 🔗 🔘 🔙 🔚 🔛 🔜 🔝 🔞 🔟 🔠 🔡 🔢 🔣 🔤 🔥 🔦 🔧 🔨 🔩 🔪 🔫 </pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
These are characters, not images. You can write them to a file on your computer's hard drive, and read them back in.
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># UTF-8 is used by default on my machine</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;unicode.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">128000</span><span class="p">,</span> <span class="mi">128300</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">code</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="err">!</span><span class="n">cat</span> <span class="nb">unicode</span><span class="o">.</span><span class="n">txt</span></code></pre></div><div class="highlight"><pre class="chroma">🐀🐁🐂🐃🐄🐅🐆🐇🐈🐉🐊🐋🐌🐍🐎🐏🐐🐑🐒🐓🐔🐕🐖🐗🐘🐙🐚🐛🐜🐝🐞🐟🐠🐡🐢🐣🐤🐥🐦🐧🐨🐩🐪🐫🐬🐭🐮🐯🐰🐱🐲🐳🐴🐵🐶🐷🐸🐹🐺🐻🐼🐽🐾🐿👀👁👂👃👄👅👆👇👈👉👊👋👌👍👎👏👐👑👒👓👔👕👖👗👘👙👚👛👜👝👞👟👠👡👢👣👤👥👦👧👨👩👪👫👬👭👮👯👰👱👲👳👴👵👶👷👸👹👺👻👼👽👾👿💀💁💂💃💄💅💆💇💈💉💊💋💌💍💎💏💐💑💒💓💔💕💖💗💘💙💚💛💜💝💞💟💠💡💢💣💤💥💦💧💨💩💪💫💬💭💮💯💰💱💲💳💴💵💶💷💸💹💺💻💼💽💾💿📀📁📂📃📄📅📆📇📈📉📊📋📌📍📎📏📐📑📒📓📔📕📖📗📘📙📚📛📜📝📞📟📠📡📢📣📤📥📦📧📨📩📪📫📬📭📮📯📰📱📲📳📴📵📶📷📸📹📺📻📼📽📾📿🔀🔁🔂🔃🔄🔅🔆🔇🔈🔉🔊🔋🔌🔍🔎🔏🔐🔑🔒🔓🔔🔕🔖🔗🔘🔙🔚🔛🔜🔝🔞🔟🔠🔡🔢🔣🔤🔥🔦🔧🔨🔩🔪🔫</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Remark:</font> </h3>
We can also get Python to print out the names of the characters.
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">128000</span><span class="p">,</span> <span class="mi">128100</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span></code></pre></div><div class="highlight"><pre class="chroma">🐀 RAT
🐁 MOUSE
🐂 OX
🐃 WATER BUFFALO
🐄 COW
🐅 TIGER
🐆 LEOPARD
🐇 RABBIT
🐈 CAT
🐉 DRAGON
🐊 CROCODILE
🐋 WHALE
🐌 SNAIL
🐍 SNAKE
🐎 HORSE
🐏 RAM
🐐 GOAT
🐑 SHEEP
🐒 MONKEY
🐓 ROOSTER
🐔 CHICKEN
🐕 DOG
🐖 PIG
🐗 BOAR
🐘 ELEPHANT
🐙 OCTOPUS
🐚 SPIRAL SHELL
🐛 BUG
🐜 ANT
🐝 HONEYBEE
🐞 LADY BEETLE
🐟 FISH
🐠 TROPICAL FISH
🐡 BLOWFISH
🐢 TURTLE
🐣 HATCHING CHICK
🐤 BABY CHICK
🐥 FRONT-FACING BABY CHICK
🐦 BIRD
🐧 PENGUIN
🐨 KOALA
🐩 POODLE
🐪 DROMEDARY CAMEL
🐫 BACTRIAN CAMEL
🐬 DOLPHIN
🐭 MOUSE FACE
🐮 COW FACE
🐯 TIGER FACE
🐰 RABBIT FACE
🐱 CAT FACE
🐲 DRAGON FACE
🐳 SPOUTING WHALE
🐴 HORSE FACE
🐵 MONKEY FACE
🐶 DOG FACE
🐷 PIG FACE
🐸 FROG FACE
🐹 HAMSTER FACE
🐺 WOLF FACE
🐻 BEAR FACE
🐼 PANDA FACE
🐽 PIG NOSE
🐾 PAW PRINTS
🐿 CHIPMUNK
👀 EYES
👁 EYE
👂 EAR
👃 NOSE
👄 MOUTH
👅 TONGUE
👆 WHITE UP POINTING BACKHAND INDEX
👇 WHITE DOWN POINTING BACKHAND INDEX
👈 WHITE LEFT POINTING BACKHAND INDEX
👉 WHITE RIGHT POINTING BACKHAND INDEX
👊 FISTED HAND SIGN
👋 WAVING HAND SIGN
👌 OK HAND SIGN
👍 THUMBS UP SIGN
👎 THUMBS DOWN SIGN
👏 CLAPPING HANDS SIGN
👐 OPEN HANDS SIGN
👑 CROWN
👒 WOMANS HAT
👓 EYEGLASSES
👔 NECKTIE
👕 T-SHIRT
👖 JEANS
👗 DRESS
👘 KIMONO
👙 BIKINI
👚 WOMANS CLOTHES
👛 PURSE
👜 HANDBAG
👝 POUCH
👞 MANS SHOE
👟 ATHLETIC SHOE
👠 HIGH-HEELED SHOE
👡 WOMANS SANDAL
👢 WOMANS BOOTS
👣 FOOTPRINTS</pre></div>
<p>Similarly, we can find out the names of the characters we used previously.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">iliad</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">μ GREEK SMALL LETTER MU
ῆ GREEK SMALL LETTER ETA WITH PERISPOMENI
ν GREEK SMALL LETTER NU
ι GREEK SMALL LETTER IOTA
ν GREEK SMALL LETTER NU
  SPACE
ἄ GREEK SMALL LETTER ALPHA WITH PSILI AND OXIA
ε GREEK SMALL LETTER EPSILON
ι GREEK SMALL LETTER IOTA
δ GREEK SMALL LETTER DELTA
ε GREEK SMALL LETTER EPSILON
  SPACE
θ GREEK SMALL LETTER THETA
ε GREEK SMALL LETTER EPSILON
ὰ GREEK SMALL LETTER ALPHA WITH VARIA
  SPACE
Π GREEK CAPITAL LETTER PI
η GREEK SMALL LETTER ETA
λ GREEK SMALL LETTER LAMDA
η GREEK SMALL LETTER ETA
ι GREEK SMALL LETTER IOTA
̈ COMBINING DIAERESIS
ά GREEK SMALL LETTER ALPHA WITH OXIA
δ GREEK SMALL LETTER DELTA
ε GREEK SMALL LETTER EPSILON
ω GREEK SMALL LETTER OMEGA
  SPACE
Ἀ GREEK CAPITAL LETTER ALPHA WITH PSILI
χ GREEK SMALL LETTER CHI
ι GREEK SMALL LETTER IOTA
λ GREEK SMALL LETTER LAMDA
ῆ GREEK SMALL LETTER ETA WITH PERISPOMENI
ο GREEK SMALL LETTER OMICRON
ς GREEK SMALL LETTER FINAL SIGMA</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">gen1</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">ב HEBREW LETTER BET
ּ HEBREW POINT DAGESH OR MAPIQ
ְ HEBREW POINT SHEVA
ר HEBREW LETTER RESH
ֵ HEBREW POINT TSERE
א HEBREW LETTER ALEF
ש HEBREW LETTER SHIN
ׁ HEBREW POINT SHIN DOT
ִ HEBREW POINT HIRIQ
֖ HEBREW ACCENT TIPEHA
י HEBREW LETTER YOD
ת HEBREW LETTER TAV
  SPACE
ב HEBREW LETTER BET
ּ HEBREW POINT DAGESH OR MAPIQ
ָ HEBREW POINT QAMATS
ר HEBREW LETTER RESH
ָ HEBREW POINT QAMATS
֣ HEBREW ACCENT MUNAH
א HEBREW LETTER ALEF
  SPACE
א HEBREW LETTER ALEF
ֱ HEBREW POINT HATAF SEGOL
ל HEBREW LETTER LAMED
ֹ HEBREW POINT HOLAM
ה HEBREW LETTER HE
ִ HEBREW POINT HIRIQ
֑ HEBREW ACCENT ETNAHTA
י HEBREW LETTER YOD
ם HEBREW LETTER FINAL MEM
  SPACE
א HEBREW LETTER ALEF
ֵ HEBREW POINT TSERE
֥ HEBREW ACCENT MERKHA
ת HEBREW LETTER TAV
  SPACE
ה HEBREW LETTER HE
ַ HEBREW POINT PATAH
ש HEBREW LETTER SHIN
ׁ HEBREW POINT SHIN DOT
ּ HEBREW POINT DAGESH OR MAPIQ
ָ HEBREW POINT QAMATS
מ HEBREW LETTER MEM
ַ HEBREW POINT PATAH
֖ HEBREW ACCENT TIPEHA
י HEBREW LETTER YOD
ִ HEBREW POINT HIRIQ
ם HEBREW LETTER FINAL MEM
  SPACE
ו HEBREW LETTER VAV
ְ HEBREW POINT SHEVA
א HEBREW LETTER ALEF
ֵ HEBREW POINT TSERE
֥ HEBREW ACCENT MERKHA
ת HEBREW LETTER TAV
  SPACE
ה HEBREW LETTER HE
ָ HEBREW POINT QAMATS
א HEBREW LETTER ALEF
ָ HEBREW POINT QAMATS
ֽ HEBREW POINT METEG
ר HEBREW LETTER RESH
ֶ HEBREW POINT SEGOL
ץ HEBREW LETTER FINAL TSADI</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sun</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="n">c</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">孫 CJK UNIFIED IDEOGRAPH-5B6B
子 CJK UNIFIED IDEOGRAPH-5B50
曰 CJK UNIFIED IDEOGRAPH-66F0
： FULLWIDTH COLON
兵 CJK UNIFIED IDEOGRAPH-5175
者 CJK UNIFIED IDEOGRAPH-8005
， FULLWIDTH COMMA
國 CJK UNIFIED IDEOGRAPH-570B
之 CJK UNIFIED IDEOGRAPH-4E4B
大 CJK UNIFIED IDEOGRAPH-5927
事 CJK UNIFIED IDEOGRAPH-4E8B
， FULLWIDTH COMMA
死 CJK UNIFIED IDEOGRAPH-6B7B
生 CJK UNIFIED IDEOGRAPH-751F
之 CJK UNIFIED IDEOGRAPH-4E4B
地 CJK UNIFIED IDEOGRAPH-5730
， FULLWIDTH COMMA
存 CJK UNIFIED IDEOGRAPH-5B58
亡 CJK UNIFIED IDEOGRAPH-4EA1
之 CJK UNIFIED IDEOGRAPH-4E4B
道 CJK UNIFIED IDEOGRAPH-9053
， FULLWIDTH COMMA
不 CJK UNIFIED IDEOGRAPH-4E0D
可 CJK UNIFIED IDEOGRAPH-53EF
不 CJK UNIFIED IDEOGRAPH-4E0D
察 CJK UNIFIED IDEOGRAPH-5BDF
也 CJK UNIFIED IDEOGRAPH-4E5F</pre></div>
<p>The End.</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/unicode/">unicode</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/08/simul_t_test/">
                <h2 class="post-title">That ain&#39;t dancing Sally!</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on August 29, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;5&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;994&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<p><b>Same difference.</b></p>

<p>Congratulations! Your simulation code from the previous post has impressed all and sundry and you've been asked to teach introductory statistics to first year students at the prestigious Vandelay University. </p>

<p>You've got 2 stats classes, one with a group of 65 students, and another with a group of 35 students.
We assume that the students have been randomly allocated to each group, and that they share the same
final exam.</p>

<p>The difference between the groups is the teaching technique employed. With group1 you teach a standard stats course,
while with group2 you sometimes use interpretive dance instead of equations to explain statistical concepts.</p><br>

<div align='center'>
<img src="https://media.giphy.com/media/xT1XGXgtj8PWdvCLFS/giphy.gif" width="400">
</div>

<p>Let's jump right in.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c1"># suppress warning messages.</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># import the scipy module which comtains scientific and stats functions.</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="kn">as</span> <span class="nn">stats</span>

<span class="c1"># usual plotting stuff.</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># set the matplotlib style </span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&#34;seaborn-darkgrid&#34;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<p>Here are the marks (out of 100) in the final exam for these two groups.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">57</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>
       <span class="mi">55</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>
       <span class="mi">100</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
       <span class="mi">62</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">69</span><span class="p">])</span>

<span class="n">group2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
       <span class="mi">59</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>
       <span class="mi">52</span><span class="p">])</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">group1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">group2</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">65 35</pre></div>
<p>When you compare the marks between the two groups you notice that, on average, the marks in group2 are lower
that those in group1.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">diff</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">group2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">7.934065934065934</pre></div>
<p>We can visualise the distribution of marks in both groups using a box plot.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">((</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&#34;group&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;mark&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_8_0.png" alt="png" /></p>

<h5 id="is-this-difference-in-means-statistically-significant-i-e-should-you-drop-the-interpretive-dance-routine">Is this difference in means statistically significant (i.e., should you drop the interpretive dance routine)?</h5>

<p>Statistics should be able to provide us with an answer. Thankfully, some of my best friends are statisticians.
I found one of those magnificent statistical creatures, and I asked them about differences between means of two groups.
They mumbled something about beer, students, and tea test or something&hellip; I couldn&rsquo;t tell what they were saying so I went to <code>scipy</code> instead and
it turns out there&rsquo;s an app for that.</p>

<p>The t-test is a statistical test that can tell us whether the difference in means between our two groups is statistically significant.</p>

<p>First, let us observe that the two groups have similar variances (this allows us to run a particular flavour of the test).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">group1</span><span class="o">.</span><span class="n">var</span><span class="p">(),</span> <span class="n">group2</span><span class="o">.</span><span class="n">var</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">(179.0248520710059, 175.55102040816323)</pre></div>
<p>Close enough for us. Let&rsquo;s run the test.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">t</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Probability that a difference at least as extreme as {diff:0.2f} is due to chance (t test): {p*100:.2f}%&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Probability that a difference at least as extreme as 7.93 is due to chance (t test): 0.60%</pre></div>
<h6 id="but-what-does-it-all-mean">But what does it all mean?</h6>

<p>To the simulation!</p>

<p>We are trying to test whether there is a genuine (statistically significant) difference between the two groups.</p>

<p>One way that we can test this is to estimate how likely we are to observe a difference between the means of the two groups of at least 7.93, <strong>if we assume that there&rsquo;s no difference in marks between the two groups</strong> (null hypothesis).</p>

<p>We can accomplish that by pooling all the values together and randomly shuffling (assigning) 65 of these values to group1 and the rest to group2.</p>

<p>Using this shuffling scheme, we will get an average difference between the two groups around zero, and the spread of the values we get will tell us how extreme (i.e., unlikely) a value of 7.93 or larger would be under the null hypothesis.</p>

<p>Let&rsquo;s randomly shuffle the data across the two groups and compute the difference in means 100,000 times.
(this may take a moment)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">N</span> <span class="o">=</span> <span class="mi">100000</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>

<span class="c1"># Let&#39;s pool the marks together</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">))</span>

<span class="n">i</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">size</span>

<span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="c1"># shuffle the data using random permutation (most useless code comment ever!)</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    
    <span class="c1"># split the shuffled data into 2 groups</span>
    <span class="n">grp1</span><span class="p">,</span> <span class="n">grp2</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">shuffle</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
    
    <span class="c1"># compute the difference in means</span>
    <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grp1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grp2</span><span class="p">))</span>
    
<span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">L</span><span class="p">)</span></code></pre></div>
<p>Let&rsquo;s plot a histogram of the results.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference between group means&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&#34;Observed</span><span class="se">\n</span><span class="s2">difference</span><span class="se">\n</span><span class="s2">($7.93$)&#34;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&#34;difference in means&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_17_0.png" alt="png" /></p>

<p>On the histogram, we see that the observed difference is quite far from the mode of the distribution.</p>

<p>In other words, it appears that a difference of 7.93 or more (in magnitude) does not occur very often. Let&rsquo;s quantify this.</p>

<p><strong>Proportion of simulated trials where the (absolute value of the) difference exceeds the observed difference.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pSim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="nb">abs</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">diff</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Probability that the difference at least as extreme as {diff:0.2f} is due to chance (Simulation): {pSim*100:.2f}%&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Probability that the difference at least as extreme as 7.93 is due to chance (Simulation): 0.58%</pre></div>
<h5 id="this-is-not-too-bad-considering-the-true-result-is-0-60">This is not too bad considering the true result is  0.60%.</h5>

<p>This result means that if we assume that the two groups are sampled from the same population of students, the probability of observing a difference in means of at least 7.93 between the group just by random chance is only around 0.6%.</p>

<p>It is quite typical for the threshold for statistical significance to be set at 5%. Therefore, in this case,
we&rsquo;d conclude that the difference between the two groups is statistically significant. In other words, the teaching
method has an impact on the marks. You might want to put that leotard away, stop the gyrations cause <a href="https://youtu.be/B5dogmMj-s0"><em>that ain&rsquo;t dancing Sally!</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/probability/">probability</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/statistics/">statistics</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/seinfeld/">seinfeld</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/06/simul_birthday/">
                <h2 class="post-title">Happy birthday to you!</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on June 29, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;15&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2998&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<p><br><p>The Birthday Problem is a classic problem in probability theory. We will use it to illustrate how to use simulation to get an estimate of the probability of some event occuring.</p></p>

<p>Imagine that you are at a party with $N$ people (including yourself).
Let's assume that we have 365 days in a year and that the birthday of the people attending the party 
is randomly distributed with a uniform distribution, meaning that each of the 365 days is equally probable as a birthday (if you were born on February 29, you'll need to go to another party).</p>

<p><em>How large does $N$ need to be for the probability of having at least 2 people share a birthday to be at least 50%? What about 90%?</em></p>

<p>(Note that this is different from asking for the probability of anyone sharing a birthday with a <b>given</b> person)</p>

<p>We can easily work out the edge cases. We know that if we have 1 person at the party, the probability of 2 or more
people sharing a birthday is 0, and if we have 366 or more people, that probability will be 1 owing to the
<a href="https://en.wikipedia.org/wiki/Pigeonhole_principle">pigeonhole principle</a>.</p>

<p>It also makes intuitive sense that the probability of shared birthdays increases monotonically as the number of guests increases, therefore, we know that we will reach the 50% threshold somewhere between 2 and 365 guests.
Not a great <em>guesstimate</em> by any means, but nonetheless, it gives us a starting point.</p>

<p>This is the kind of problem that can be solved using probability theory, however, let's see if we can get to the answer using simulation.</p>

<p>Let's break the problem down into pieces.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c1"># suppress warning messages.</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># import the scipy module which comtains scientific and stats functions.</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># set the matplotlib style </span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&#34;seaborn-darkgrid&#34;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<p>First, we define a numpy array called <code>days</code> that contains the day numbers for the year (1 to 365).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
<span class="n">days</span></code></pre></div><div class="highlight"><pre class="chroma">array([  1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,
        14,  15,  16,  17,  18,  19,  20,  21,  22,  23,  24,  25,  26,
        27,  28,  29,  30,  31,  32,  33,  34,  35,  36,  37,  38,  39,
        40,  41,  42,  43,  44,  45,  46,  47,  48,  49,  50,  51,  52,
        53,  54,  55,  56,  57,  58,  59,  60,  61,  62,  63,  64,  65,
        66,  67,  68,  69,  70,  71,  72,  73,  74,  75,  76,  77,  78,
        79,  80,  81,  82,  83,  84,  85,  86,  87,  88,  89,  90,  91,
        92,  93,  94,  95,  96,  97,  98,  99, 100, 101, 102, 103, 104,
       105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117,
       118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130,
       131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143,
       144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156,
       157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169,
       170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182,
       183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195,
       196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208,
       209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221,
       222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234,
       235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247,
       248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260,
       261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273,
       274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286,
       287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299,
       300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312,
       313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325,
       326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338,
       339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351,
       352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364,
       365])</pre></div>
<p>Assuming there are $N=50$ people at the party, let&rsquo;s create an array <code>guests_bday</code> that will contain $N$ day numbers randomly drawn (with replacement) from the array <code>days</code>.</p>

<p>We&rsquo;ll use the random seed 42 to ensure that ours results are reproducible.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">guests_bday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">guests_bday</span></code></pre></div><div class="highlight"><pre class="chroma">array([103, 349, 271, 107,  72, 189,  21, 103, 122, 215, 331,  88, 100,
       360, 152, 131, 150, 309, 258, 344, 294, 192, 277, 161, 314,  22,
       253, 236, 345,  49,  59, 170, 188, 271, 190, 175,  51, 364,  55,
       244, 320, 131, 307, 135,  21, 329, 167, 274,  89, 316])</pre></div>
<p>The number of unique birthdays in <code>guests_bday</code> is given by</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">num_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">guests_bday</span><span class="p">)</span><span class="o">.</span><span class="n">size</span>
<span class="n">num_unique</span></code></pre></div><div class="highlight"><pre class="chroma">46</pre></div>
<p>In this example, we have 46 unique birthdays for 50 guests.</p>

<p>Now that we know how to compute the number of unique birthdays for a particular sample of $N$ guests, let&rsquo;s write a function <code>shared_birthdays</code> that takes integers $N$ and <code>n_trials</code> as parameters, and returns the proportion of trials where two or more people share a birthday.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">shared_birthdays</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">)])</span></code></pre></div>
<p>Rather that manually changing the number of people at the party, let&rsquo;s consider all possibilities between 0 and 100 at once (Hang on! A party with 0 people? &ldquo;It happens&rdquo;, the poor wretch replied, quickly looking away to wipe a tear with a <em>désinvolture</em> that belied his inner turmoil&hellip;).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">number_of_people</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shared_birthdays</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">number_of_people</span><span class="p">])</span></code></pre></div>
<p>We can now find the threshold above which we have a probability of shared birthday &gt; 50%.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">number_of_people</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">23</pre></div>
<p>According to our computation, if we have 23 or more people at the party, the probability of at least 2 people sharing a birthday is larger than 50%.</p>

<p>Similarly, to reach the 90% threshold&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">number_of_people</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma">41</pre></div>
<p>&hellip; we need at least 41 guests.</p>

<p>Let&rsquo;s plot the result of the simulation</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">number_of_people</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">number_of_people</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&#34;50%&#34;</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">93</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&#34;90%&#34;</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">93</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of guests&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Probability of at least 2 people sharing a birthday&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_18_0.png" alt="png" /></p>

<p>So how can we check these results against the exact probability? When trying to determine the probability of a particular event occuring, it's often useful to consider the probability of the event __not__ occuring. Since these
are two mutually exclusive events, their probabilities must sum to 1.</p>

<p>In our case, given N &lt; 366 guests, the probability of no two guests sharing a birthday can be computed in the following way.</p>

<p><em>Assume that no two guests share a birthday.</em>
Let's consider a guest which we'll label as guest1. This guest will take one "birthday slot" out of 365.
We then choose another guest, guest2, whose birthday must fall on one of the 364 unoccupied slots left.
We then choose another guest, guest3, whose birthday must fall on one of the 363 unoccupied slots left.
And on and on till we choose guestN whose birthday must fall on one of the (365-N+1) unoccupied slots left (recall that N &lt; 366).</p>

<p>We can summarise this by saying that there are $$365\times364\times\cdots\times(365-N+1)=\frac{365!}{(365-N)!}$$ possible combinations of guests and birthdays that don't lead to a shared birthday.</p>

<p>Since, we're interested in (probabilities) proportions not number of configurations, we need to divide this
number by the total number of birthday configurations for $N$ guests, which is just $365^N$ (each guest can have any birthday independently of the others). However, recall that this is the probability of <em>no shared birthdays</em>. To get the result we want we need to subtract this probability from 1. Hence, the exact (under the assumptions of the problem) probability of at least 2 people among $N$ guests sharing a birthday is:$$1 - \frac{365!}{365^N(365-N)!}$$</p>

<p>Let's compute this probability.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">exact_probability_shared_bday</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">factorial</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span><span class="o">/</span><span class="n">factorial</span><span class="p">(</span><span class="mi">365</span><span class="o">-</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="mi">365</span><span class="o">**</span><span class="n">N</span>

<span class="n">exact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">exact_probability_shared_bday</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">number_of_people</span><span class="p">])</span>

<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exact</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;We need {number_of_people[idx]} guests to reach the 50% threshold&#34;</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exact</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;We need {number_of_people[idx]} guests to reach the 90% threshold&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">We need 23 guests to reach the 50% threshold
We need 41 guests to reach the 90% threshold</pre></div>
<p><b>We get the same results as with the simulation!</b>
<center>
<img  src="https://media.giphy.com/media/l3vR6aasfs0Ae3qdG/giphy.gif" width="400">
</center></p>

<p>Let&rsquo;s plot the two results on the same graph.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">number_of_people</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">number_of_people</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;exact&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">number_of_people</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&#34;50%&#34;</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">93</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&#34;90%&#34;</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">93</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of guests&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Probability of at least 2 people sharing a birthday&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_23_0.png" alt="png" /></p>

<h4 id="can-we-generalise-our-simulation-beyond-pairs">Can we generalise our simulation beyond pairs?</h4>

<p>The first thing to notice is that our initial strategy isn&rsquo;t going to work anymore.</p>

<p><code>np.unique(np.random.choice(days, size=N)).size &lt; N</code> basically checks whether we have more guests than unique birthdays. This is an easy way to check whether <strong>at least</strong> two guests share a birthday, but it will fail to produce the correct answer if we&rsquo;re looking to find out know whether <strong>at least M</strong> guests share a birthay with M &gt; 2.</p>

<p>Instead of looking at the difference between number of guests and number of unique birthdays, let&rsquo;s count the number of unique birthdays directly. We can do that with numpy&rsquo;s <code>bincount</code> function.</p>

<p>While we&rsquo;re at it, we might as well look at variations of this problem, the probability that <strong>the maximum number of of people sharing a birthday</strong> is M, or the probability of having <strong>at most</strong> M people share a birthday.</p>

<p>First, let&rsquo;s illustrate how <code>bincount</code> works.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">a</span></code></pre></div><div class="highlight"><pre class="chroma">array([6, 3, 7, 4, 6, 9, 2, 6, 7, 4, 3, 7, 7, 2, 5, 4, 1, 7, 5, 1])</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">array([0, 2, 2, 2, 3, 2, 3, 5, 0, 1])</pre></div>
<p>This gives us the number of occurences of each value from 0 to 9 in a.</p>

<p>We can make things more explicit in the following way:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;The value {value} appears {count} times in a.&#34;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">The value 0 appears 0 times in a.
The value 1 appears 2 times in a.
The value 2 appears 2 times in a.
The value 3 appears 2 times in a.
The value 4 appears 3 times in a.
The value 5 appears 2 times in a.
The value 6 appears 3 times in a.
The value 7 appears 5 times in a.
The value 8 appears 0 times in a.
The value 9 appears 1 times in a.</pre></div>
<p>Let&rsquo;s use <code>bincount</code> to count the largest number of people sharing a birthday in each of our trials.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">at_least_M_shared_birthdays</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">M</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">)])</span>

<span class="k">def</span> <span class="nf">at_most_M_shared_birthdays</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># the only difference with the previous function is &gt;= becomes &lt;=</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">M</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">)])</span>

<span class="k">def</span> <span class="nf">a_maximum_of_M_shared_birthdays</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="c1"># the only difference with the first function is &gt;= becomes ==</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">==</span> <span class="n">M</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">)])</span>

<span class="c1"># put the three functions in a dictionary to make it easier to choose between them later.</span>
<span class="n">shared_bday</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">shared_bday</span><span class="p">[</span><span class="s1">&#39;at least&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">at_least_M_shared_birthdays</span>
<span class="n">shared_bday</span><span class="p">[</span><span class="s1">&#39;at most&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">at_most_M_shared_birthdays</span>
<span class="n">shared_bday</span><span class="p">[</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">a_maximum_of_M_shared_birthdays</span></code></pre></div>
<p>We create a utility function to run the simulation and plot the results.</p>

<p>Recall that M is the number of people sharing a birthday.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;at least&#39;</span><span class="p">):</span>

    <span class="n">number_of_guests</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">method</span> <span class="o">=</span> <span class="n">shared_bday</span><span class="p">[</span><span class="n">how</span><span class="p">]</span> 

    <span class="n">sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">method</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="n">M</span><span class="p">)</span> <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">number_of_guests</span><span class="p">])</span> 
    
    <span class="c1"># let&#39;s get the 0.5 and 0.9 thresholds if they are reached.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">threshold50</span> <span class="o">=</span> <span class="n">number_of_guests</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">threshold50</span> <span class="o">=</span> <span class="bp">None</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">threshold90</span> <span class="o">=</span> <span class="n">number_of_guests</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> 
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">threshold90</span> <span class="o">=</span> <span class="bp">None</span>   
    
    <span class="n">step</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">max_num_guests</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">number_of_guests</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">number_of_guests</span><span class="p">)[::</span><span class="n">step</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of guests&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Probability of {how} {M} people sharing a birthday&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">threshold50</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&#34;at least&#34;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;50% threshold for {M} shared birthdays reached for {threshold50} guests.&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">threshold90</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&#34;at least&#34;</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;90% threshold for {M} shared birthdays reached for {threshold90} guests.&#34;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></code></pre></div>
<p>As a sanity check, let&rsquo;s redo the computation for pairs (M=2).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">50% threshold for 2 shared birthdays reached for 23 guests.
90% threshold for 2 shared birthdays reached for 41 guests.</pre></div>
<p><img src="output_34_1.png" alt="png" /></p>

<p>Looking good!</p>

<p>With this new code we can now ask a different question.</p>

<p>What is the probability that we have <strong>at most</strong> than 2 people sharing a birthday?</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;at most&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_36_0.png" alt="png" /></p>

<p>This is a monotonically decreasing function of the number of guests (aside from the random noise), which makes sense.</p>

<p>This isn&rsquo;t the most interesting of results so we&rsquo;ll skip it henceforth.</p>

<p>Let&rsquo;s look at the probability of the maximum number of shared birthdays being 2.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_38_0.png" alt="png" /></p>

<p>That&rsquo;s interesting. The probability starts off like the probability of observing <em>at least</em> 2 people sharing a birthday, but it never reaches the 90% threshold. Instead, after around 45 or so guests the probability starts <em>decreasing</em>. This of course makes sense, as the number of guests increases, we reach a point where having more than 2 people share a birthday is no longer unlikely. When the guests number is larger than 87, the probability of having only singletons (unique birthdays) or pairs dips below 50%. Let&rsquo;s keep this in mind&hellip;</p>

<h4 id="what-about-trios">What about trios?</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">50% threshold for 3 shared birthdays reached for 87 guests.
90% threshold for 3 shared birthdays reached for 132 guests.</pre></div>
<p><img src="output_40_1.png" alt="png" /></p>

<p>Notice that the probability of having 3 or more people sharing a birthday reach the 50% mark for 87 guests.</p>

<p>This is the same value for which the probability of having no more than 2 people share a birthday drops below
50%.</p>

<p>This is not a coincidence as these two events are mutually exclusive. You can either have at most 2 people sharing a birthday ($M \leqslant 2$) or more than 2 people sharing a birthday ($M&gt;2$ which is equivalent to $M \geqslant 3$ since we don&rsquo;t usually chop up the guests into pieces).</p>

<p>What about having a maximum of 3 people share a birthday?</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_42_0.png" alt="png" /></p>

<p>Similarly to the pairs, the trios see their probability wane after about 130 guests, and it dips below 50% at about
188 guests. We can now guess what happens, as the number of guests reaches 188, the probability of having 4 or more people share a birthday is more likely than not. Which takes us to&hellip;</p>

<h4 id="quartets">Quartets</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">50% threshold for 4 shared birthdays reached for 188 guests.
90% threshold for 4 shared birthdays reached for 259 guests.</pre></div>
<p><img src="output_44_1.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_45_0.png" alt="png" /></p>

<p>Once again we get that now familiar shape (notice that the shape becomes more symmetrical as M increases).</p>

<p>The decrease in probability heralds the arrival of&hellip;</p>

<h4 id="quintets">Quintets</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">50% threshold for 5 shared birthdays reached for 314 guests.
90% threshold for 5 shared birthdays reached for 413 guests.</pre></div>
<p><img src="output_47_1.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_48_0.png" alt="png" /></p>

<h4 id="sextets">Sextets</h4>

<p>(This is starting to take some time to run&hellip;)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">50% threshold for 6 shared birthdays reached for 457 guests.
90% threshold for 6 shared birthdays reached for 586 guests.</pre></div>
<p><img src="output_50_1.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_51_0.png" alt="png" /></p>

<p>We are barely reaching the 50% threshold now.</p>

<p>And one last one for the road.</p>

<h4 id="septets">Septets</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">50% threshold for 7 shared birthdays reached for 616 guests.
90% threshold for 7 shared birthdays reached for 768 guests.</pre></div>
<p><img src="output_53_1.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_shared_birthday_prob</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">max_num_guests</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;a maximum of&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_54_0.png" alt="png" /></p>

<p>It looks like were we to smoothen out this plot, the probability would never reach 50%.</p>

<p>There you have it!</p>

<p>Hopefully, this little exploration of the birthday problem illustrates how useful simulation can be.
In the case of the <em>generalised</em> version of the problem beyond pairs, we were able to simulate the problem
easily by making a small modification to our original code.</p>

<p>Perhaps one question remains. How can we be sure that our simulation gives a reasonable (however we want define it)
approximation of the answer?</p>

<p>Well, for pairs we compared our code to the exact result. Can we do the same
for M &gt; 2?</p>

<p>It turns out that there exists an exact answer to this problem for the general case, however it is much more involved
than our little derivation for M = 2.</p>

<p>For more information I&rsquo;ll refer you to <a href="https://apps.carleton.edu/curricular/math/assets/birthday_comps.pdf">this paper by Fisher, Funk, and Sams</a>.</p>

<p>We can nonetheless compare our simulation to the authors&rsquo; exact result for the 50% threshold for the values of M they used:</p>
<div class="highlight"><pre class="chroma">| M              | 2  | 3  | 4   | 5   | 6   | 7   |
|----------------|----|----|-----|-----|-----------|
| exact          | 23 | 88 | 187 | 313 | N/A | N/A |
| our simulation | 23 | 87 | 188 | 314 | 457 | 616 |</pre></div>
<p>We&rsquo;re in the right ball park. We could probably improve our results a bit by using more than 1000 trials.</p>

<p>It might also be interesting to record the variance across the trials during our simulation.</p>

<p>This, as they say, will be left as an exercise for the reader, and the next time you&rsquo;re at a birthday party, if there are more than 23 people present be sure to sing &ldquo;Haaaaappy birthday to <em>youse</em>!&ldquo;, the pairs, trios, quartets, etc&hellip; will be grateful (the person organising the birthday party, not so much, oddly enough. There&rsquo;s no pleasing some people anyway).</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/probability/">probability</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/statistics/">statistics</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/06/simul_coin_flip/">
                <h2 class="post-title">Do you feel lucky?</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on June 15, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;17&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3562&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<p><br><p>A coin flipped 100 times comes up heads 60 times. How likely is it that the coin is fair?</p></p>

<p>This is a basic example of <em>statistical inference</em>, trying to infer an estimate of some quantity (here the  probability for heads) from some data (observation of 100 coin flips). This type of problem is invariably described in every first year stats course. To solve it, we first need to represent the underlying process generating our observations in a mathematical form. For coin flips, the binomial distribution is the natural choice. Let's affectionately call our random variable representing the <b>number</b> of heads $X$.</p>

<p>The probability of observing k heads in a run of N coin flips is given by the <b>probability mass function (pmf)</b>:</p>

<p>$$P(X=k) = \left(\begin{array}{c}N \\ k \end{array}   \right)p^k\, (1-p)^{N-k} = \dfrac{N!}{k!(N-k)!}\,p^k\, (1-p)^{N-k}$$</p>

<p>But where does this formula come from? It's actually quite simple. If we denote by p the probability of heads (outcome H) for one coin flip, the probability of tails (outcome T) is $1-p$ because we only have 2 mutually exclusive outcomes (we assume the coin doesn't land sideways).</p>

<p>If we flip the coin 2 times, since each coin flip is independent, we multiply the probabilities of the outcomes of each flip. For instance, the probability of observing HH (two heads) is $p^2$. The probability associated with TT is $(1-p)^2$, while the one associated with HT is $p(1-p)$, etc...</p>

<p>So if we flip the coin $N$ times, what is the probability of observing $k$ heads? Well, it's the probability of observing any configuration with $k$ heads and $N-k$ tails, which is $p^k(1-p)^{N-k}$ times the number of such configurations. To count the configurations we simply need to formalise the fact that, for this problem, the ordering doesn't matter. As far as we are concerned, HTH, HHT, and THH are equivalent, they all represent 2 heads in 3 coin flips. Instead of thinking about one coin flipped $N$ times, let's consider the equivalent problem of $N$ identical coins flipped once each.</p> 

<p>How many ways can we arrange the $N$ coins? We've got $N$ options when picking the first coin. Once that's done, we've got $N-1$ ways of choosing the second coin, and so on, all the way to the last coin for which there's only one choice left to make, namely that very coin... 
This means that there are $N\times(N-1)\times\cdots2\times1$ ways or arranging the $N$ coins, which is the factorial of $N$ or $N!$.</p>

<p>Now suppose that $k\leq N$ of these coins have landed heads up. This means of course that $N-k$ coins show tails.
If we were to reorder the $k$ coins among themselves, this would not change our result. We'd still have $k$ heads out of $N$ flips. Same with the $N-k$ tails. Therefore, when it comes to counting the number of configurations for which we have $k$ heads, we should divide the total number of ways to arrange $N$ coins by the total number of ways we can rearrange the $k$ heads among themselves, and the $N-k$ tails among themselves. This ends up to be the binomial coefficient called "N choose k":</p>

<p>$$\left(\begin{array}{c}N \\ k \end{array}\right) = \frac{N!}{k!(N-k)!}.$$</p>

<p>Hence the formula above.</p>

<p>One minor detail is that we don't know the value of $p$, the probability that a coin flip lands heads up.
For a fair coin, we of course expect that $p=0.5$. Using the formula above we can also compute the probability of 60 heads
out of 100 coin flips for a fair coin.</p>

<p>This will be our starting in figuring out how to compute an estimate of $p$.</p>

<p>Let&rsquo;s import all the modules we need.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># usual stuff</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c1"># suppress warning messages.</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># import the scipy module which contains scientific and stats functions.</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>

<span class="c1"># import matplotlib and redirect plots to jupyter notebook. (cm is for color maps)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># sets the default figure size </span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="c1"># sets some default plotting styles.</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&#34;darkgrid&#34;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<p>Let&rsquo;s write a Python function that computes the formula above.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="k">def</span> <span class="nf">choose</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">k</span><span class="p">)</span> <span class="p">))</span>

<span class="k">def</span> <span class="nf">binom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">choose</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">k</span><span class="p">)</span>

<span class="n">binom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">0.010843866711637987</pre></div>
<p>So the pmf tells us that the probability of getting 60 heads out of 100 coin flips is a hair above 1%, <em><b>if the coin is fair</b></em>.</p>

<p>Note that this does not tell us if the coin is fair. So let&rsquo;s determine how <em>likely</em> are we to observe 60 heads <b>or more</b> in a sequence of 100 flips from a fair coin.</p>

<p>There&rsquo;s typically 2 ways that this problem is solved in introductory stats courses.</p>

<h3 id="method-1-binomial-distribution">Method 1: Binomial Distribution</h3>

<h4 id="one-tailed-binomial-test">One-tailed binomial test.</h4>

<p>Under the hypothesis that the coin is fair, the probability of observing at least 60 heads in a run of 100 coin flips can be computed using the one-tailed binomial test. One tailed means we only care for differences in one direction, either higher or smaller than the result that is expected under the hypothesis that the coin is fair. Here we only care about the probability of observing 60 <b>or more</b> heads. The <code>scipy</code> module has a suitable implementation of the <em>two-tailed</em> binomial test that we can divide by 2 to get the one-tailed result (note that we can divide the two-tailed result by 2 only because we are testing the hypothesis that the coin is fair and for p=0.5 the distribution is symmetric).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binom_test</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span></code></pre></div><div class="highlight"><pre class="chroma">0.02844396682049039</pre></div>
<p>That's around 2.8%. This number is nothing more that the sum of the probabilities for all the values of k between 60 and 100.</p>

<div>
$$\sum_{k = 60}^{100}\left(\begin{array}{c}N\\k \end{array}   \right)p^k\, (1-p)^{N-k}$$
</div>

<p>Here's a check using our <code>binom</code> function if you don't believe me.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">sum</span><span class="p">(</span><span class="n">binom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">101</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">0.028443966820490392</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<p>The sum version has the advantage of stating explicit what the computation is doing.
We'll use this approach henceforth whenever we need to perform a binomial test.</p>
</div>

<h3 id="method-2-normal-approximation-to-the-binomial-distribution">Method 2: Normal approximation to the binomial distribution</h3>

<h4 id="one-tailed-z-test">One-tailed Z-test</h4>

<p>When we have a large enough number of coin flips, we can approximate the <b>discrete</b> binomial distribution by a suitably defined <b>continuous</b> normal (gaussian) distribution with mean 50 ($=Np$) and standard deviation $\sqrt{Np(1-p)}$, courtesy of the famous <a href="http://www.math.uah.edu/stat/sample/CLT.html">central limit theorem</a>.</p>

<p>This allows us to use the beloved Z test of introductory stats courses to determine the probability of observing <em>at least</em> 60 heads, under the hypothesis that the coin is fair. The Z test is just a way to compute how likely it is to observe a value of the the random variable that is beyond a given distance from its assumed mean, using units of the standard deviation.</p>

<p>Once again, <code>scipy</code> can help us by supplying the <a href="https://www.youtube.com/watch?v=4BswLMKgXzU">cumulative distribution function (cdf)</a> for our normal distribution. The cdf is a function that tells us the probability of getting a value lower than, or equal to the value we are considering. The cdf obviously integrates (sums) to 1.
By subtracting the cdf at a given value z_0 from 1, we get the probability of observing a result at least as large
as z_0.</p>

<p>The probability we want is:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)))</span>  <span class="c1"># notice the -0.5?</span></code></pre></div><div class="highlight"><pre class="chroma">0.028716559816001852</pre></div>
<p>We could have computed this directly by first computing the Z score for k, which is nothing more than the observed count of heads minus its average for a fair coin (50), divided by its standard deviation.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">mean</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">sd</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span> <span class="c1"># standard deviation (the mean is 50 for a fair coin)</span>
<span class="n">zscore</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">sd</span>  <span class="c1"># notice the -0.5?</span>

<span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">zscore</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">0.028716559816001852</pre></div>
<div style="background-color:#F7F2E0;">
<h3><font color=MediumVioletRed>Note:</font></h3>
    
Why did we substract 0.5 from k? It called a <a href="http://www.statisticshowto.com/what-is-the-continuity-correction-factor/">continuity correction.</a> We need it to compensate for the fact that we are substituting a continuous distribution for a discrete one.
</div>

<h3 id="method-3-simulation">Method 3: Simulation</h3>

<p>This is all nice and peachy, but deep down, do we really understand everything we&rsquo;ve done above?
Coin flips are a fairly trivial concept, so our reasoning should be straightforward, however, what would we
have done if we hadn&rsquo;t been provided with the pmf of the binomial distribution? Since we derived from
&ldquo;first principles&rdquo; above, it wouldn&rsquo;t have been much of a problem. However, could we have worked out the normal approximation to the binomial
distribution (a tad trickier perhaps, with that continuity-correction business)?
There&rsquo;s got to be a better way! Not really, but there&rsquo;s a <em>different</em> way: <b>simulation</b>.</p>

<p>The question is how likely is it for a fair coin to land 60 or more times heads up in a sequence of 100 flips?</p>

<p>One way to find out is to flip a <b>fair</b> coin 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads. Then we flip the coin another 100 times and record the number of heads&hellip; You get the gist.</p>

<p>If we repeat this a large enough number of times, we should get an estimate of how likely it is for a fair coin
to land heads up 60 or more times in a run of 100 flips simply by computing the proportion of trials where we got 60 or more heads.</p>

<h4>Let the computer flip some coins for us!</h4>

<p><code>numpy</code> has a very useful function called <code>random.randint</code> that will randomly pick an integer drawn from a uniform random distribution.</p>

<p>For instance, let 1 correspond to heads and 0 to tails, we can simulate 10 flips of a fair coin with:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">array([1, 1, 1, 1, 0, 0, 1, 0, 0, 1])</pre></div>
<p>Note that we can simulate multiple trials of 10 flips by passing a tuple to the size parameter of the function.</p>

<p>Here&rsquo;s for instance a series of 3 trials with 10 flips each.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma">array([[1, 0, 1, 1, 0, 0, 0, 1, 0, 0],
       [1, 0, 1, 0, 1, 0, 0, 0, 0, 0],
       [1, 1, 1, 0, 0, 1, 0, 1, 0, 0]])</pre></div>
<h4 id="let-s-flip-our-fair-coin-200-million-times">Let&rsquo;s flip our fair coin 200 million times.</h4>

<p>We&rsquo;ll simulate 2 million trials of 100 coin flips. Since we get 1 for heads and 0 for tails, the number
of heads in a trial is simply the sum of all the values observed in that trial.</p>

<p>We set the random seed so that we all get the same result, not that it matters that much here.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># number of flips per trial</span>
<span class="n">repeats</span> <span class="o">=</span> <span class="mi">2000000</span>   <span class="c1"># number of trials</span>

<span class="c1"># we flip the &#34;coin&#34; N times and compute the sum of 1s (heads).</span>
<span class="c1"># the whole thing is repeated &#34;repeats&#34; times.</span>
<span class="n">coin_flips</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">repeats</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">coin_flips</span><span class="o">.</span><span class="n">shape</span></code></pre></div><div class="highlight"><pre class="chroma">(2000000,)</pre></div>
<h4 id="let-s-compute-the-normal-approximation-to-the-binomial-distribution-for-our-case">Let&rsquo;s compute the normal approximation to the binomial distribution for our case.</h4>

<p>(this is so that we can plot it alongside our histogram)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># probability of heads for a fair coin</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">coin_flips</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">coin_flips</span><span class="o">.</span><span class="nb">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>   <span class="c1"># 100 evenly spaced values between the min and max counts</span>
<span class="n">ndist</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">p</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)))</span> <span class="c1"># we use scipy to compute the normal approximation</span></code></pre></div>
<h4 id="let-s-plot-the-histogram-of-our-simulation-as-well-as-the-normal-approximation">Let&rsquo;s plot the histogram of our simulation, as well as the normal approximation.</h4>

<p>The red vertical line marks the observed result (number of heads).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">coin_flips</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="c1"># plot the histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;observed # heads&#34;</span><span class="p">)</span>  <span class="c1"># plot a vertical line at x = k</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># label for the x axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P(k)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># label for the y axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;{} coin flips repeated {:,d} times&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">repeats</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="c1"># title of the figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndist</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&#34;normal approx.&#34;</span><span class="p">)</span> <span class="c1"># plot normal approximation curve</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># add legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1"># display the result</span></code></pre></div>
<p><img src="output_25_0.png" alt="png" /></p>

<h4 id="let-s-extract-the-proportion-of-our-100-coin-flip-trials-which-have-60-or-more-heads-from-our-simulation">Let&rsquo;s extract the proportion of our 100 coin flip trials which have 60 or more heads from our simulation.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coin_flips</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">0.0285285</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<p>Computing the mean is the same as adding all the values for which the condition is true, which gives us the number of trials where we got at least k heads, and dividing by the number of trials, which gives us the proportion we're after.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">coin_flips</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">repeats</span></code></pre></div><div class="highlight"><pre class="chroma">0.0285285</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<p>In the context of statistical inference (the frequentist kind), this probability is called a p-value. It gives us the probability of observing a result as or more extreme than the one observed ($X\geqslant 60$) if the null hypothesis ($p=0.5$) is true. It also sometimes gives statistics a bad name...</p>
</div>

<p>Not a bad estimate of the propability of having $X\geqslant 60$ under the (null) hypothesis that the coin is fair.</p>

<p>So it looks like our simulation works for 60 or more heads. It would be nice to check that it works for other values.</p>

<p>We could either change the value of k above, and re-run our code, or we could copy and paste the code and change
the value of k, but neither approach is good programming practice. Whenever we realise that we&rsquo;d like to run the same piece of code multiple times, for different values of parameters, we should <b>wrap our code in a function</b>.</p>

<p>Let&rsquo;s do that.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">compute_pvalue</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;p-value&#34;</span><span class="p">,</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Our simulation:         &#34;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coin_flips</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">),</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Scipy (Binomial test):  &#34;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">binom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">kvalue</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">kvalue</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">101</span><span class="p">)),</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Scipy (Normal Approx):  &#34;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))))</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">coin_flips</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndist</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P(k)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;{} coin flips repeated {:,d} times&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">repeats</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">compute_pvalue</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">p-value 
Our simulation:          0.0285285 
Scipy (Binomial test):   0.028443966820490392 
Scipy (Normal Approx):   0.028716559816001852</pre></div>
<p><img src="output_32_1.png" alt="png" /></p>

<p>We've considered the probability that the number of heads is at least k in a run of 100 coin flips.</p>

<p>Let's write a version of the code above that will compute, and visualise the probability that the number of heads is <b>exactly</b> k in a run of 100 coin flips, under the hypothesis that the coin is fair.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">compute_pvalue_B</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;p-value&#34;</span><span class="p">,</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Our simulation:         &#34;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coin_flips</span> <span class="o">==</span> <span class="n">k</span><span class="p">),</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Scipy (Binomial test):  &#34;</span><span class="p">,</span> <span class="n">binom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Scipy (Normal Approx):  &#34;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)))</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">))))</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">coin_flips</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndist</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P(k)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;{} coin flips repeated {:,d} times&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">repeats</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="n">compute_pvalue_B</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">p-value 
Our simulation:          0.0108845 
Scipy (Binomial test):   0.010843866711637987 
Scipy (Normal Approx):   0.010852139253185289</pre></div>
<p><img src="output_34_1.png" alt="png" /></p>

<p>Let's now write a version of the code above that will compute, and visualise the probability that the number of heads is <b>between</b> two values k_1 and k_2 in a run of 100 coin flips, under the hypothesis that the coin is fair (assume that $0\leqslant k_1 \leqslant 50$ and $50 \leqslant k_2 \leqslant 100$).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">compute_pvalue</span><span class="p">(</span><span class="n">k1</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">k2</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;p-value&#34;</span><span class="p">,</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Our simulation:         &#34;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">coin_flips</span> <span class="o">&gt;=</span> <span class="n">k1</span><span class="p">,</span> <span class="n">coin_flips</span> <span class="o">&lt;=</span> <span class="n">k2</span><span class="p">)),</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Scipy (Binomial test):  &#34;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">([</span><span class="n">binom</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="o">+</span><span class="mi">1</span><span class="p">)]),</span>
          <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Scipy (Normal Approx):  &#34;</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">k2</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)))</span><span class="o">-</span>
                                        <span class="n">sp</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">k1</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)))</span> <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">coin_flips</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndist</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k2</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$P(k)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;{} coin flips repeated {:,d} times&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">repeats</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
<span class="n">compute_pvalue</span><span class="p">(</span><span class="n">k1</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">k2</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">p-value 
Our simulation:          0.847064 
Scipy (Binomial test):   0.8467733878542303 
Scipy (Normal Approx):   0.8464695184908008</pre></div>
<p><img src="output_36_1.png" alt="png" /></p>

<hr style="height:5px;border:none;color:#333;background-color:#333;" />

<h1> Dice roll</h1>

<p>Aside from its usefulness in statistical inference, simulation is a nice way to explore problems which involve counting occurences of a certain event. Since this is the basic concept behind probability theory, simulation can be an convenient way to tackle probabilitic problems.</p>

<p>Let's look at a simple example.</p>

<p>Assuming that we have a regular, fair, six-sided die with sides numbered 1 to 6.</p> 

<p>What is the probability of getting:
<ul>
<li> 6 when rolling the die once?</li>
<li> no 6 when rolling the die once?</li>
</ul></p>

<p>What about the probability of getting:
<ul>
<li> no 6 when rolling the die twice?</li>
<li> a single 6 when rolling the die twice?</li>
<li> two 6s when rolling the die twice?</li>
</ul>
<p>We can of course enumerate (count) all the ways you can obtain the required outcome, and normalise (divide) this by all the  possible outcomes, but it&rsquo;s not a great general strategy. A better way is to work out the exact mathematical formula for the probability we&rsquo;re interested in. We&rsquo;ll do that shortly, but first let&rsquo;s just simulate the process of rolling dice.</p></p>

<p>Let's create a function <code>roll_dice</code> that takes two integers <code>n_rolls</code> and <code>n_trials</code>
as arguments, and returns an array with the number of 6s obtained in each of the <code>n_trials</code> trials when we roll <code>n_rolls</code> dice at the same time.</p>

<p>For instance, <code>roll_dice(2, 10)</code> would return an array of 10 values representing the number of 6s observed when rolling 2 dice in each of the 10 trials.</p>

<p>We'll fix the random seed for reproducibility.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">roll_dice</span><span class="p">(</span><span class="n">n_rolls</span><span class="p">,</span> <span class="n">n_trials</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">die_rolls</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">n_rolls</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">die_rolls</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">roll_dice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">array([0, 0, 0, 0, 0, 0, 1, 0, 2, 0])</pre></div>
<p>Note that the values in the array represent the number of 6s observed in each of the 10 trials.</p>

<p>The function below will visualise the result of <code>roll_dice</code> as a histogram.</p>

<p>It uses the <code>roll_dice</code> function to compute the counts of 6s across <code>n_trials</code> trials by default.</p>

<p>It will also output the numerical value for the proportion of 6s in each case.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="n">n_rolls</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_trials</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
    <span class="n">rolls</span> <span class="o">=</span> <span class="n">roll_dice</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">=</span><span class="n">n_rolls</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="n">n_trials</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">rolls</span><span class="p">,</span> 
                      <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> 
                      <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                      <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> 
                      <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span> 
                      <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span>
                    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Number of 6s in {n_rolls} rolls over {n_trials:,} trials&#39;</span><span class="p">,</span>
              <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="s2">&#34;Number of 6s: {i:3d} | Proportion: {values[0][i]:.6f}&#34;</span> 
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_histogram</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Number of 6s:   0 | Proportion: 0.695630
Number of 6s:   1 | Proportion: 0.276400
Number of 6s:   2 | Proportion: 0.027970</pre></div>
<p><img src="output_44_1.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_histogram</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Number of 6s:   0 | Proportion: 0.580000
Number of 6s:   1 | Proportion: 0.345960
Number of 6s:   2 | Proportion: 0.069400
Number of 6s:   3 | Proportion: 0.004640</pre></div>
<p><img src="output_45_1.png" alt="png" /></p>

<p>Assuming that we have regular, fair, six-sided dice, what is the probability of getting exactly five 6s when we roll 10 dice at the same time (or the same die 10 times in a row)?</p> 

<p><b>Hints:</b> </p>
The <code>choose</code> function we introduced earlier gives us the number of ways you can
pick k interchangeable items from a collection of N elements.

<p>Using the <code>choose</code> function we introduced earlier, we can write the proportion of rolls where we get exactly 5 sixes. In 10 rolls, we have $6^{10}$ possible outcomes. If we observe 5 sixes, this means that we
also have 5 values other than 6. These 5 values come in $5^5$ combinations (5 ways to choose something other than 6 for each of the 5 dice). How many ways are there to choose which 5 dice don't show a 6: "10 choose 5" ways. Hence:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">choose</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="o">**</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">**</span> <span class="mi">10</span></code></pre></div><div class="highlight"><pre class="chroma">0.013023810204237159</pre></div>
<p>Meaning that the probability of observing five 6s in 10 rolls is about 1.3%.</p>

<p>We can check that against our dice roll simulation code.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_histogram</span><span class="p">(</span><span class="n">n_rolls</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">Number of 6s:   0 | Proportion: 0.161252
Number of 6s:   1 | Proportion: 0.323586
Number of 6s:   2 | Proportion: 0.290073
Number of 6s:   3 | Proportion: 0.155074
Number of 6s:   4 | Proportion: 0.054466
Number of 6s:   5 | Proportion: 0.013067
Number of 6s:   6 | Proportion: 0.002203
Number of 6s:   7 | Proportion: 0.000253
Number of 6s:   8 | Proportion: 0.000026
Number of 6s:   9 | Proportion: 0.000000
Number of 6s:  10 | Proportion: 0.000000</pre></div>
<p><img src="output_50_1.png" alt="png" /></p>

<h4>The exact result.</h4>

<p>Let's implement the formula for an arbitrary number k of 6s when rolling N fair dice ($k\leqslant N$).   </p> 

<p>We'll call this function <code>number_of_sixes(N, k)</code>.</p>

<p><p>We&rsquo;ll use this function to:</p>
<ol>
<li>check the simulation results in the histogram above.</li>
<li>compute the probability of getting
<b>at least</b> five 6s in 10 rolls of a die.</li>
<li>compute the probability of getting
<b>at most</b> five 6s in 10 rolls of a die.</li>
</ol>
</ul></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">number_of_sixes</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">choose</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="o">**</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="o">**</span><span class="n">N</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Probability of {:2d} 6s in 10 rolls: {:.6f}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">number_of_sixes</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
    
<span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Probability of at least five 6s in 10 rolls: {:.6f}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">number_of_sixes</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">))))</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Probability of at most five 6s in 10 rolls: {:.6f}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">number_of_sixes</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))))</span></code></pre></div><div class="highlight"><pre class="chroma">Probability of  0 6s in 10 rolls: 0.161506
Probability of  1 6s in 10 rolls: 0.323011
Probability of  2 6s in 10 rolls: 0.290710
Probability of  3 6s in 10 rolls: 0.155045
Probability of  4 6s in 10 rolls: 0.054266
Probability of  5 6s in 10 rolls: 0.013024
Probability of  6 6s in 10 rolls: 0.002171
Probability of  7 6s in 10 rolls: 0.000248
Probability of  8 6s in 10 rolls: 0.000019
Probability of  9 6s in 10 rolls: 0.000001
Probability of 10 6s in 10 rolls: 0.000000

Probability of at least five 6s in 10 rolls: 0.015462

Probability of at most five 6s in 10 rolls: 0.997562</pre></div>
<p>Our simulation results above are in good agreement with these exact values.</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/probability/">probability</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/statistics/">statistics</a>&nbsp;
                  
                </div>
              

            </article>
          
            <article class="post-preview">
              <a href="https://adelr.github.io/2018/05/seinfeld_effect/">
                <h2 class="post-title">Seinfeld&#39;s Magnificent Seven</h2>

                
              </a>

              <p class="post-meta">
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on May 10, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;15&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3136&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Adel Rahmani
  
  
</span>


              </p>
              <div class="post-entry">
                
                  

<p>In this post I want to take a look at a classic data set: the US baby names.</p>

<p>While the origin of many names can be found in popular culture and (what's the alternative to popular culture? 
impopular culture?) elsewhere, we shall focus on how the TV show Seinfeld may have influenced the naming of hundreds of innocent babies.</p>

<p>We'll roughly follow the steps outlined by Wes McKinney in his excellent book <a href="http://shop.oreilly.com/product/0636920023784.do">Python for Data Analysis</a> to load the data.</p>

<p>Let's first start by importing a couple of modules.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-white&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&#34;&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;&#34;</span><span class="p">))</span></code></pre></div>
<style>.container { width:100% !important; }</style>

<h3> <center><font color=MediumVioletRed>A. Loading the data</font></center></h3>

<p>The dataset can be downloaded from <a href="http://www.ssa.gov/oact/babynames/limits.html">http://www.ssa.gov/oact/babynames/limits.html</a>.</p>

<p>(Follow the link and download the dataset
in the datasets directory, in a directory called names, and unzip it).</p>

<p>The dataset contains the top 1000 most popular names starting in 1880.</p>

<p>The data for each year is in its own text file. For instance, the data for 1880 is in the file <code>yob1880.txt</code> (which should
be located in the datasets/names/ folder.)</p>

<p>The first thing to do is merge the data for all the different years into a single dataframe, however, as a warm up, let&rsquo;s look at the data for a single year.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/names/yob1880.txt&#39;</span><span class="p">)</span>
<span class="err">!</span><span class="n">head</span> <span class="p">{</span><span class="n">input_path</span><span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma">Mary,F,7065
Anna,F,2604
Emma,F,2003
Elizabeth,F,1939
Minnie,F,1746
Margaret,F,1578
Ida,F,1472
Alice,F,1414
Bertha,F,1320
Sarah,F,1288</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names1880</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;births&#39;</span><span class="p">])</span>
<span class="n">names1880</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>sex</th>
      <th>births</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Mary</td>
      <td>F</td>
      <td>7065</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Anna</td>
      <td>F</td>
      <td>2604</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Emma</td>
      <td>F</td>
      <td>2003</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Elizabeth</td>
      <td>F</td>
      <td>1939</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Minnie</td>
      <td>F</td>
      <td>1746</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let&rsquo;s try to automate the loading of all the files.</p>

<p>First we need a list of all the files in our directory.</p>

<p>A <code>Path</code> object has a <code>glob</code> method that returns a generator with the elements within a given directory.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;data/names&#39;</span><span class="p">)</span>
<span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dataset_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&#34;*.txt&#34;</span><span class="p">))]</span>
<span class="c1"># Extract a list of years</span>
<span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span></code></pre></div>
<h4 id="we-gather-the-data-into-a-single-dataset-in-two-steps">We gather the data into a single dataset in two steps:</h4>

<ol>
<li>We create a list of dataframes where each element corresponds to a particular year.</li>
<li>We concatenate all the data (why can&rsquo;t we use merge here?) into a single dataframe.</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="nb">file</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">years</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dataset_dir</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;births&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
    <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
<span class="n">names</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>    
<span class="n">names</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>sex</th>
      <th>births</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Mary</td>
      <td>F</td>
      <td>7065</td>
      <td>1880</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Anna</td>
      <td>F</td>
      <td>2604</td>
      <td>1880</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Emma</td>
      <td>F</td>
      <td>2003</td>
      <td>1880</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Elizabeth</td>
      <td>F</td>
      <td>1939</td>
      <td>1880</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Minnie</td>
      <td>F</td>
      <td>1746</td>
      <td>1880</td>
    </tr>
  </tbody>
</table>
</div>

<div style="background-color:#F2FBEF;">
<p>It's always a good idea to check the data types of our features (columns). Don't assume that the data you downloaded is in the right format. </p>

<p>If we fix any issue early, it'll make the analysis a lot easier.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">name      object
sex       object
births     int64
year      object
dtype: object</pre></div>
<p>The <code>year</code> feature is of type <code>object</code> which is Python&rsquo;s way of telling us it&rsquo;s got a generic datatype.</p>

<p>We&rsquo;d like it to be a <code>datetime</code> type so let&rsquo;s fix that.</p>

<p>Pandas has <a href="http://pandas.pydata.org/pandas-docs/stable/timeseries.html">several features</a> that make manipulating date and timestamp objects easy.</p>

<p>(We&rsquo;ll also change the type of <code>sex</code> to category while we&rsquo;re at it)</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">])</span>
<span class="n">names</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">sex</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>sex</th>
      <th>births</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Mary</td>
      <td>F</td>
      <td>7065</td>
      <td>1880-01-01</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Anna</td>
      <td>F</td>
      <td>2604</td>
      <td>1880-01-01</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Emma</td>
      <td>F</td>
      <td>2003</td>
      <td>1880-01-01</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Elizabeth</td>
      <td>F</td>
      <td>1939</td>
      <td>1880-01-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Minnie</td>
      <td>F</td>
      <td>1746</td>
      <td>1880-01-01</td>
    </tr>
  </tbody>
</table>
</div>

<p>Notice how our year column has been changed into a <code>datetime</code> object.</p>

<p>By default, since we only specified the year, the <code>datetime</code> object is set at time 00:00:00 on the 1st of January.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">dtypes</span></code></pre></div><div class="highlight"><pre class="chroma">name              object
sex             category
births             int64
year      datetime64[ns]
dtype: object</pre></div>
<h3> <center><font color=MediumVioletRed>B. Exploring the data</font></center></h3>

<h4 id="so-how-big-is-our-dataset">So how big is our dataset?</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">name      1924665
sex       1924665
births    1924665
year      1924665
dtype: int64</pre></div>
<h4 id="how-is-the-data-split-on-the-sex-of-the-baby">How is the data split on the sex of the baby?</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">sex</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">F    1138293
M     786372
Name: sex, dtype: int64</pre></div>
<h4 id="let-s-get-percentages">Let&rsquo;s get percentages.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">sex</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="s1">&#39;{x*100:.0f}%&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma">F    59%
M    41%
Name: sex, dtype: object</pre></div>
<h4 id="let-s-find-the-total-number-of-births-for-each-year-for-both-sexes">Let&rsquo;s find the total number of births for each year, for both sexes.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">total_births_per_year_per_sex</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="nb">sum</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">total_births_per_year_per_sex</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>sex</th>
      <th>F</th>
      <th>M</th>
    </tr>
    <tr>
      <th>year</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1880-01-01</th>
      <td>90993</td>
      <td>110491</td>
    </tr>
    <tr>
      <th>1881-01-01</th>
      <td>91953</td>
      <td>100743</td>
    </tr>
    <tr>
      <th>1882-01-01</th>
      <td>107847</td>
      <td>113686</td>
    </tr>
    <tr>
      <th>1883-01-01</th>
      <td>112319</td>
      <td>104627</td>
    </tr>
    <tr>
      <th>1884-01-01</th>
      <td>129020</td>
      <td>114442</td>
    </tr>
  </tbody>
</table>
</div>

<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<p>The <code>pivot_table</code> method is just a convenient shortcut for a <code>groupby</code> operation.</p>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">births</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>sex</th>
      <th>F</th>
      <th>M</th>
    </tr>
    <tr>
      <th>year</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1880-01-01</th>
      <td>90993</td>
      <td>110491</td>
    </tr>
    <tr>
      <th>1881-01-01</th>
      <td>91953</td>
      <td>100743</td>
    </tr>
    <tr>
      <th>1882-01-01</th>
      <td>107847</td>
      <td>113686</td>
    </tr>
    <tr>
      <th>1883-01-01</th>
      <td>112319</td>
      <td>104627</td>
    </tr>
    <tr>
      <th>1884-01-01</th>
      <td>129020</td>
      <td>114442</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">total_births_per_year_per_sex</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> 
                                   <span class="n">title</span><span class="o">=</span><span class="s2">&#34;Total births by sex and year&#34;</span><span class="p">,</span> 
                                   <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                   <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> 
                                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span></code></pre></div>
<p><img src="output_27_0.png" alt="png" /></p>

<h4 id="how-many-unique-names-are-there-for-each-year-and-gender">How many unique names are there for each year and gender?</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">unique_names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">])[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">unique_names</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&#34;Unique names by sex and year&#34;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span></code></pre></div>
<p><img src="output_30_0.png" alt="png" /></p>

<h4 id="how-many-names-from-1880-were-still-used-in-the-most-recent-year-we-have-and-which-ones-have-fallen-into-desuetude">How many names from 1880 were still used in the most recent year we have, and which ones have fallen into desuetude?</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">last_year</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>

<span class="n">s1880</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">1880</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">slast</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">last_year</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;&#34;&#34;
</span><span class="s2">There were {len(s1880)} distinct names recorded in 1880
</span><span class="s2">There were {len(slast)} distinct names recorded in {last_year}</span><span class="se">\n</span><span class="s2">
</span><span class="s2">{len(slast.intersection(s1880))} names were found in both years
</span><span class="s2">{len(s1880.difference(slast))} names found in 1880 were not recorded in {last_year}
</span><span class="s2">{len(slast.difference(s1880))} names found in {last_year} were not recorded in 1880
</span><span class="s2">&#34;&#34;&#34;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;The names recorded in 1880 but no longer in use in {last_year} are:</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">,</span> 
      <span class="nb">sorted</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">s1880</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">slast</span><span class="p">)]))</span></code></pre></div><div class="highlight"><pre class="chroma">There were 1889 distinct names recorded in 1880
There were 29910 distinct names recorded in 2017

1501 names were found in both years
388 names found in 1880 were not recorded in 2017
28409 names found in 2017 were not recorded in 1880

The names recorded in 1880 but no longer in use in 2017 are:

 [&#39;Ab&#39;, &#39;Adelbert&#39;, &#39;Adline&#39;, &#39;Adolf&#39;, &#39;Adolphus&#39;, &#39;Agustus&#39;, &#39;Albertina&#39;, &#39;Albertine&#39;, &#39;Albertus&#39;, &#39;Alcide&#39;, &#39;Alda&#39;, &#39;Alf&#39;, &#39;Algie&#39;, &#39;Almeda&#39;, &#39;Almer&#39;, &#39;Almon&#39;, &#39;Alonza&#39;, &#39;Alpheus&#39;, &#39;Altha&#39;, &#39;Alvah&#39;, &#39;Alvena&#39;, &#39;Alverta&#39;, &#39;Alvia&#39;, &#39;Anner&#39;, &#39;Annis&#39;, &#39;Araminta&#39;, &#39;Arch&#39;, &#39;Ardelia&#39;, &#39;Ardella&#39;, &#39;Arminta&#39;, &#39;Arther&#39;, &#39;Arvid&#39;, &#39;Arvilla&#39;, &#39;Asberry&#39;, &#39;Asbury&#39;, &#39;Aurthur&#39;, &#39;Auther&#39;, &#39;Author&#39;, &#39;Authur&#39;, &#39;Babe&#39;, &#39;Ballard&#39;, &#39;Bama&#39;, &#39;Barnett&#39;, &#39;Barney&#39;, &#39;Bart&#39;, &#39;Bedford&#39;, &#39;Bena&#39;, &#39;Benjaman&#39;, &#39;Benjamine&#39;, &#39;Bertie&#39;, &#39;Berton&#39;, &#39;Bertram&#39;, &#39;Bess&#39;, &#39;Besse&#39;, &#39;Bettie&#39;, &#39;Bird&#39;, &#39;Birt&#39;, &#39;Birtha&#39;, &#39;Birtie&#39;, &#39;Blanch&#39;, &#39;Budd&#39;, &#39;Buford&#39;, &#39;Bulah&#39;, &#39;Burley&#39;, &#39;Burr&#39;, &#39;Butler&#39;, &#39;Byrd&#39;, &#39;Caddie&#39;, &#39;Celie&#39;, &#39;Ceylon&#39;, &#39;Chalmers&#39;, &#39;Chancy&#39;, &#39;Charlotta&#39;, &#39;Chas&#39;, &#39;Chin&#39;, &#39;Christena&#39;, &#39;Cicero&#39;, &#39;Cinda&#39;, &#39;Clarance&#39;, &#39;Clarinda&#39;, &#39;Classie&#39;, &#39;Claud&#39;, &#39;Claudie&#39;, &#39;Claudine&#39;, &#39;Claus&#39;, &#39;Clemie&#39;, &#39;Clemmie&#39;, &#39;Cloyd&#39;, &#39;Clyda&#39;, &#39;Colonel&#39;, &#39;Commodore&#39;, &#39;Concepcion&#39;, &#39;Corda&#39;, &#39;Cordella&#39;, &#39;Cordia&#39;, &#39;Cordie&#39;, &#39;Corine&#39;, &#39;Cornelious&#39;, &#39;Creola&#39;, &#39;Dee&#39;, &#39;Dellar&#39;, &#39;Dewitt&#39;, &#39;Dicie&#39;, &#39;Dick&#39;, &#39;Dillard&#39;, &#39;Dillie&#39;, &#39;Docia&#39;, &#39;Dock&#39;, &#39;Doctor&#39;, &#39;Dolphus&#39;, &#39;Donie&#39;, &#39;Dosha&#39;, &#39;Doshia&#39;, &#39;Doshie&#39;, &#39;Dow&#39;, &#39;Drucilla&#39;, &#39;Drusilla&#39;, &#39;Duff&#39;, &#39;Earle&#39;, &#39;Early&#39;, &#39;Edd&#39;, &#39;Edmonia&#39;, &#39;Ednah&#39;, &#39;Edyth&#39;, &#39;Effa&#39;, &#39;Eldora&#39;, &#39;Electa&#39;, &#39;Elick&#39;, &#39;Eliga&#39;, &#39;Eligah&#39;, &#39;Elige&#39;, &#39;Elizebeth&#39;, &#39;Ellar&#39;, &#39;Elmire&#39;, &#39;Elmo&#39;, &#39;Elmore&#39;, &#39;Elzie&#39;, &#39;Emmer&#39;, &#39;Eola&#39;, &#39;Ephriam&#39;, &#39;Erasmus&#39;, &#39;Erastus&#39;, &#39;Ernst&#39;, &#39;Estell&#39;, &#39;Estie&#39;, &#39;Etha&#39;, &#39;Ethelyn&#39;, &#39;Ethyl&#39;, &#39;Etna&#39;, &#39;Etter&#39;, &#39;Fayette&#39;, &#39;Ferd&#39;, &#39;Finis&#39;, &#39;Firman&#39;, &#39;Flem&#39;, &#39;Fleming&#39;, &#39;Florance&#39;, &#39;Florida&#39;, &#39;Flossie&#39;, &#39;Floy&#39;, &#39;Freda&#39;, &#39;Friend&#39;, &#39;Frona&#39;, &#39;Fronie&#39;, &#39;Fronnie&#39;, &#39;Garfield&#39;, &#39;Gee&#39;, &#39;Gorge&#39;, &#39;Gottlieb&#39;, &#39;Green&#39;, &#39;Guss&#39;, &#39;Gussie&#39;, &#39;Gust&#39;, &#39;Gustavus&#39;, &#39;Hamp&#39;, &#39;Handy&#39;, &#39;Hardie&#39;, &#39;Harl&#39;, &#39;Harrie&#39;, &#39;Harriette&#39;, &#39;Harve&#39;, &#39;Hassie&#39;, &#39;Hedwig&#39;, &#39;Helma&#39;, &#39;Hence&#39;, &#39;Hermann&#39;, &#39;Hermine&#39;, &#39;Hessie&#39;, &#39;Hester&#39;, &#39;Hettie&#39;, &#39;Hillard&#39;, &#39;Hilliard&#39;, &#39;Hilma&#39;, &#39;Holmes&#39;, &#39;Hortense&#39;, &#39;Hosteen&#39;, &#39;Hoy&#39;, &#39;Hulda&#39;, &#39;Huldah&#39;, &#39;Hyman&#39;, &#39;Icy&#39;, &#39;Idell&#39;, &#39;Irven&#39;, &#39;Isham&#39;, &#39;Izora&#39;, &#39;Jennette&#39;, &#39;Josiephine&#39;, &#39;Junious&#39;, &#39;Kittie&#39;, &#39;Kizzie&#39;, &#39;Knute&#39;, &#39;Lafe&#39;, &#39;Lavenia&#39;, &#39;Lavonia&#39;, &#39;Lawyer&#39;, &#39;Leatha&#39;, &#39;Leitha&#39;, &#39;Lem&#39;, &#39;Lemma&#39;, &#39;Lessie&#39;, &#39;Letha&#39;, &#39;Letitia&#39;, &#39;Letta&#39;, &#39;Lew&#39;, &#39;Lewie&#39;, &#39;Liddie&#39;, &#39;Lidie&#39;, &#39;Lige&#39;, &#39;Liller&#39;, &#39;Lillis&#39;, &#39;Lissie&#39;, &#39;Littie&#39;, &#39;Lollie&#39;, &#39;Loma&#39;, &#39;Lon&#39;, &#39;Lonie&#39;, &#39;Lotta&#39;, &#39;Louetta&#39;, &#39;Loula&#39;, &#39;Louvenia&#39;, &#39;Lovisa&#39;, &#39;Ludie&#39;, &#39;Lue&#39;, &#39;Lugenia&#39;, &#39;Lular&#39;, &#39;Lulie&#39;, &#39;Lum&#39;, &#39;Lutie&#39;, &#39;Luvenia&#39;, &#39;Madge&#39;, &#39;Madie&#39;, &#39;Madora&#39;, &#39;Mal&#39;, &#39;Malvina&#39;, &#39;Mammie&#39;, &#39;Manda&#39;, &#39;Manerva&#39;, &#39;Manervia&#39;, &#39;Manford&#39;, &#39;Manie&#39;, &#39;Manley&#39;, &#39;Manly&#39;, &#39;Margaretta&#39;, &#39;Margeret&#39;, &#39;Mart&#39;, &#39;Mat&#39;, &#39;Math&#39;, &#39;Matie&#39;, &#39;Maymie&#39;, &#39;Media&#39;, &#39;Melville&#39;, &#39;Mertie&#39;, &#39;Merton&#39;, &#39;Meta&#39;, &#39;Mettie&#39;, &#39;Mignon&#39;, &#39;Milford&#39;, &#39;Mima&#39;, &#39;Minda&#39;, &#39;Miner&#39;, &#39;Minervia&#39;, &#39;Minor&#39;, &#39;Minta&#39;, &#39;Mintie&#39;, &#39;Missouri&#39;, &#39;Mittie&#39;, &#39;Mont&#39;, &#39;Mortimer&#39;, &#39;Morton&#39;, &#39;Mozella&#39;, &#39;Myrta&#39;, &#39;Myrtie&#39;, &#39;Myrtle&#39;, &#39;Nan&#39;, &#39;Nannie&#39;, &#39;Nat&#39;, &#39;Nealie&#39;, &#39;Neppie&#39;, &#39;Nimrod&#39;, &#39;Nolie&#39;, &#39;Nonie&#39;, &#39;Norval&#39;, &#39;Ocie&#39;, &#39;Octave&#39;, &#39;Oda&#39;, &#39;Olie&#39;, &#39;Omie&#39;, &#39;Onie&#39;, &#39;Oral&#39;, &#39;Orie&#39;, &#39;Orilla&#39;, &#39;Orley&#39;, &#39;Orpha&#39;, &#39;Orrie&#39;, &#39;Orval&#39;, &#39;Osie&#39;, &#39;Ossie&#39;, &#39;Otelia&#39;, &#39;Otha&#39;, &#39;Otho&#39;, &#39;Ottie&#39;, &#39;Pansy&#39;, &#39;Paralee&#39;, &#39;Pat&#39;, &#39;Pattie&#39;, &#39;Pearlie&#39;, &#39;Perley&#39;, &#39;Permelia&#39;, &#39;Pink&#39;, &#39;Pinkey&#39;, &#39;Pinkie&#39;, &#39;Pinkney&#39;, &#39;Pleas&#39;, &#39;Pleasant&#39;, &#39;Ples&#39;, &#39;Pollie&#39;, &#39;Press&#39;, &#39;Redden&#39;, &#39;Rella&#39;, &#39;Reta&#39;, &#39;Rice&#39;, &#39;Rillie&#39;, &#39;Roena&#39;, &#39;Rolla&#39;, &#39;Rosia&#39;, &#39;Rube&#39;, &#39;Sannie&#39;, &#39;Sim&#39;, &#39;Squire&#39;, &#39;Sudie&#39;, &#39;Sybilla&#39;, &#39;Sylvanus&#39;, &#39;Tella&#39;, &#39;Tempie&#39;, &#39;Tennie&#39;, &#39;Teressa&#39;, &#39;Theda&#39;, &#39;Theophile&#39;, &#39;Thursa&#39;, &#39;Tilmon&#39;, &#39;Tishie&#39;, &#39;Tobe&#39;, &#39;Ula&#39;, &#39;Vannie&#39;, &#39;Venie&#39;, &#39;Verdie&#39;, &#39;Vern&#39;, &#39;Verne&#39;, &#39;Vernie&#39;, &#39;Vertie&#39;, &#39;Viney&#39;, &#39;Virgie&#39;, &#39;Volney&#39;, &#39;Wash&#39;, &#39;Watt&#39;, &#39;Weaver&#39;, &#39;Wilburn&#39;, &#39;Wilda&#39;, &#39;Wilhelmine&#39;, &#39;Willam&#39;, &#39;Wm&#39;, &#39;Wong&#39;, &#39;Wood&#39;, &#39;Woodie&#39;, &#39;Worthy&#39;, &#39;Yee&#39;, &#39;Yetta&#39;, &#39;Zilpha&#39;]</pre></div>
<h3> <center><font color=MediumVioletRed>C. Data Exploration</font></center></h3>

<h4> Let's extract the names that were given to both male and female babies and put it in a list named <code>both</code>.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">s1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
<span class="n">s2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">sex</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

<span class="n">both</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;{len(both)} names in our dataset were given to both boys and girls. </span><span class="se">\n\n</span><span class="s2"> Here&#39;s a sample:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&#34; | &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">both</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]))</span></code></pre></div><div class="highlight"><pre class="chroma">10663 names in our dataset were given to both boys and girls. 

 Here&#39;s a sample:

Ovis | Honor | Honore | Brandyn | Dorcus | Michel | Million | Donavan | Kemonie | Alie | Shalom | Sagan | Maeson | Kharis | Tenny | Daron | Madeline | Torey | Dandy | Nasir | Lavorn | Tracey | Ali | Kanya | Huey | Hershel | Kiren | Unnamed | Mose | Dakari | Navid | Krystian | Koi | Giavonni | Justine | Kamar | Derrell | Rajdeep | Leyton | Mong | Seattle | Vader | Anias | Camaree | Zimri | Khamauri | Jireh | Choyce | Cleo | Marki | Keontay | Shakari | Amarie | Jrue | Refugia | Luster | Levorn | Dillon | Joie | Dalas | Son | Graham | Samie | Larson | Kylynn | Kearney | Dejah | Teegan | Jahzel | Brunell | Delijah | Asiyah | Taelin | Rafa | Edward | Essie | Kenzie | Kwan | Honour | Britney | Shirl | Dara | Berthal | Keymoni | Madelyn | Dorey | Trinell | Maury | Skyylar | Courtnay | Lyncoln | Modie | Octavious | Jaice | Snow | Domique | Eva | Jeremy | Kobee | Sae</pre></div>
<p>Upon a more careful examination of the whole output, some interesting observations can be made.</p>
<p>For instance I would expect names like Lucille to be only given to girls (or <a href="https://en.wikipedia.org/wiki/Lucille_(guitar)">B.B. King's guitar</a>), but according to our result, these names were also given to boys. </p>

<p>On the other hand, while to me the name Basil may evoke a cantankerous hotel manager in Torquay, apparently, some parents thought it the perfect moniker for their baby girl. Similarly, the name Sylvester was given to both boys and girls.</p>

<p>Let's have a closer look.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Lucille&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>sex</th>
      <th>births</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>248</th>
      <td>Lucille</td>
      <td>F</td>
      <td>40</td>
      <td>1880-01-01</td>
    </tr>
    <tr>
      <th>223</th>
      <td>Lucille</td>
      <td>F</td>
      <td>48</td>
      <td>1881-01-01</td>
    </tr>
    <tr>
      <th>170</th>
      <td>Lucille</td>
      <td>F</td>
      <td>85</td>
      <td>1882-01-01</td>
    </tr>
    <tr>
      <th>220</th>
      <td>Lucille</td>
      <td>F</td>
      <td>66</td>
      <td>1883-01-01</td>
    </tr>
    <tr>
      <th>188</th>
      <td>Lucille</td>
      <td>F</td>
      <td>94</td>
      <td>1884-01-01</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="in-how-many-years-does-the-name-lucille-appear-for-either-boys-or-girls">In how many years does the name Lucille appear for either boys or girls?</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Lucille&#39;</span><span class="p">][</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">F    138
M     49
Name: sex, dtype: int64</pre></div>
<div style="background-color:#F7F2E0;">
<h3> <font color=MediumVioletRed>Note:</font> </h3>
<p>Note that <b>this is not</b> the number of babies of each sex with that name. </p>

<p>We've grouped the data by <code>year</code> and <code>sex</code> so this count corresponds to the <b>number of years</b> in which at least five babies of either gender were named Lucille (5 being the yearly threshold beyond which a name isn't recorded in the data set).</p>
</div>

<p>We can compute the same information for other names.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Basil&#39;</span><span class="p">][</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">M    138
F     13
Name: sex, dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Sylvester&#39;</span><span class="p">][</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">M    138
F     62
Name: sex, dtype: int64</pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Hannah&#39;</span><span class="p">][</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">F    138
M     38
Name: sex, dtype: int64</pre></div>
<p>Let&rsquo;s get the <strong>total number</strong> of babies named Basil for any given year?</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">basil</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Basil&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> 
                                                 <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> 
                                                 <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> 
                                                 <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                                                 <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span> <span class="p">)</span>
<span class="n">basil</span><span class="o">.</span><span class="n">head</span><span class="p">()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>sex</th>
      <th>F</th>
      <th>M</th>
    </tr>
    <tr>
      <th>year</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1880-01-01</th>
      <td>0</td>
      <td>11</td>
    </tr>
    <tr>
      <th>1881-01-01</th>
      <td>0</td>
      <td>9</td>
    </tr>
    <tr>
      <th>1882-01-01</th>
      <td>0</td>
      <td>12</td>
    </tr>
    <tr>
      <th>1883-01-01</th>
      <td>0</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1884-01-01</th>
      <td>0</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let&rsquo;s filter out the years where no girl was named Basil.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">basil</span><span class="p">[</span><span class="n">basil</span><span class="o">.</span><span class="n">F</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
    .dataframe tbody tr th {
        vertical-align: top;
    }
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>sex</th>
      <th>F</th>
      <th>M</th>
    </tr>
    <tr>
      <th>year</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1919-01-01</th>
      <td>7</td>
      <td>262</td>
    </tr>
    <tr>
      <th>1927-01-01</th>
      <td>5</td>
      <td>249</td>
    </tr>
    <tr>
      <th>2006-01-01</th>
      <td>7</td>
      <td>64</td>
    </tr>
    <tr>
      <th>2008-01-01</th>
      <td>5</td>
      <td>31</td>
    </tr>
    <tr>
      <th>2009-01-01</th>
      <td>7</td>
      <td>56</td>
    </tr>
    <tr>
      <th>2010-01-01</th>
      <td>11</td>
      <td>47</td>
    </tr>
    <tr>
      <th>2011-01-01</th>
      <td>7</td>
      <td>44</td>
    </tr>
    <tr>
      <th>2012-01-01</th>
      <td>20</td>
      <td>45</td>
    </tr>
    <tr>
      <th>2013-01-01</th>
      <td>21</td>
      <td>56</td>
    </tr>
    <tr>
      <th>2014-01-01</th>
      <td>17</td>
      <td>44</td>
    </tr>
    <tr>
      <th>2015-01-01</th>
      <td>16</td>
      <td>52</td>
    </tr>
    <tr>
      <th>2016-01-01</th>
      <td>22</td>
      <td>60</td>
    </tr>
    <tr>
      <th>2017-01-01</th>
      <td>24</td>
      <td>58</td>
    </tr>
  </tbody>
</table>
</div>

<h4 id="note-that-we-have-13-years-in-agreement-with-the-output-of-value-counts-above">Note that we have 13 years, in agreement with the output of <code>value_counts</code> above.</h4>

<p>Let&rsquo;s visualise this for a couple of names. I&rsquo;m using a <code>log</code> scale because otherwise only the data for the dominant gender would be visible.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">basil</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
           <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Basil&#39;</span><span class="p">,</span> 
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span></code></pre></div>
<p><img src="output_49_0.png" alt="png" /></p>

<p>We can daisy chain the name selection and the plotting.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Christina&#39;</span><span class="p">]</span>
 <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> 
              <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> 
              <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> 
              <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
              <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
       <span class="n">logy</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
       <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> 
       <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Christina&#39;</span><span class="p">,</span>
       <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="p">);</span></code></pre></div>
<p><img src="output_51_0.png" alt="png" /></p>

<h4 id="let-s-put-that-code-into-a-function-to-make-it-more-convenient-and-follow-the-dry-principle">Let&rsquo;s put that code into a function to make it more convenient and follow the DRY principle.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">timeline_name</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Basil&#39;</span><span class="p">,</span> <span class="n">use_log</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> 
                         <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> 
                         <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> 
                         <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">)</span>
            <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                  <span class="n">logy</span><span class="o">=</span><span class="n">use_log</span><span class="p">,</span> 
                  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
                  <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> 
                  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">timeline_name</span><span class="p">(</span><span class="s1">&#39;Lucille&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_54_0.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">timeline_name</span><span class="p">(</span><span class="s1">&#39;Hannah&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_55_0.png" alt="png" /></p>

<h3> <center><font color=MediumVioletRed>D. The Seinfeld effect?</font></center></h3>

<p>Note that a plausible explanation of why the dominant gender for a given name may have changed over the years can sometimes be found relatively easily, as in the case of the name <b>Ashley</b>...</p> 

<p>For other names, a change in popularity may be due to a less conventional reason... </p>

<p>In an episode of <a href="http://www.imdb.com/title/tt0697774/">Seinfeld</a> George mentions to his friends that should he ever have a kid, he'd name him (or her) Seven, after the jersey number of Yankee baseball player Mickey Mantle.</p>

<iframe
        width="400"
        height="300"
        src="https://www.youtube.com/embed/NRUdaWZ4FN0"
        frameborder="0"
        allowfullscreen
        ></iframe>

<p>First, let&rsquo;s check whether &ldquo;Seven&rdquo; is in our data set.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s1">&#39;Seven&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">True</pre></div>
<p>Giddy up!</p>

<p>The Seinfeld episode was aired in 1996.</p>

<p>Let&rsquo;s see if there&rsquo;s any indication that it may have influenced the popularity of the name &ldquo;Seven&rdquo;.</p>

<p>First let&rsquo;s create a date range over which to plot the data.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">seinfeldYear</span> <span class="o">=</span> <span class="s1">&#39;1996&#39;</span>
<span class="n">start</span> <span class="o">=</span> <span class="s1">&#39;1991&#39;</span>
<span class="n">end</span>   <span class="o">=</span> <span class="s1">&#39;2018&#39;</span>

<span class="c1"># Let&#39;s create a range of dates from start to end.</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-JAN&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">date_range</span></code></pre></div><div class="highlight"><pre class="chroma">DatetimeIndex([&#39;1991-01-31&#39;, &#39;1992-01-31&#39;, &#39;1993-01-31&#39;, &#39;1994-01-31&#39;,
               &#39;1995-01-31&#39;, &#39;1996-01-31&#39;, &#39;1997-01-31&#39;, &#39;1998-01-31&#39;,
               &#39;1999-01-31&#39;, &#39;2000-01-31&#39;, &#39;2001-01-31&#39;, &#39;2002-01-31&#39;,
               &#39;2003-01-31&#39;, &#39;2004-01-31&#39;, &#39;2005-01-31&#39;, &#39;2006-01-31&#39;,
               &#39;2007-01-31&#39;, &#39;2008-01-31&#39;, &#39;2009-01-31&#39;, &#39;2010-01-31&#39;,
               &#39;2011-01-31&#39;, &#39;2012-01-31&#39;, &#39;2013-01-31&#39;, &#39;2014-01-31&#39;,
               &#39;2015-01-31&#39;, &#39;2016-01-31&#39;, &#39;2017-01-31&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;A-JAN&#39;)</pre></div>
<p>Let&rsquo;s visualise the trend for &ldquo;Seven&rdquo;.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># The data</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Seven&#39;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> 
                         <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> 
                         <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> 
                         <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">)</span>
       <span class="p">)</span>

<span class="c1"># The base plot</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> 
          <span class="n">logy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
          <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
          <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> 
          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Seven&#39;</span><span class="p">,</span> 
          <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># The vertical strip</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">seinfeldYear</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>

<span class="c1"># Ensure that the labels on the x axis match the years.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">date_range</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span> <span class="p">)</span>

<span class="c1"># Annotate the figure with some text by specifying location using xy parameter</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Episode &#34;The Seven&#34; is aired&#39;</span><span class="p">,</span> 
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">seinfeldYear</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">&#34;%Y&#34;</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span>
            <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<p><img src="output_64_0.png" alt="png" /></p>

<p>Note that this <em>does not prove</em> that the show "created" the name fad (correlation &#8800; causation and all that; there could be another reason behind both the increase in popularity of the name, and the use of the name in the show), but it does seem to indicate that it enhanced it...</p> 
<p>Poor kids! Serenity now!</p>

<h3> <center><font color=MediumVioletRed>E. Mom &amp; Pop culture </font></center></h3>

<p>While we&rsquo;re on this topic, can we find other possible influences of pop culture in the data set?</p>

<p>Let&rsquo;s create a general function that we can use to plot various trends.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_name_event</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">names</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&#34;Seven&#34;</span><span class="p">,</span>
                    <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1996&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1968&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2013&#39;</span><span class="p">,</span> 
                    <span class="n">event</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;A-JAN&#39;</span><span class="p">):</span>    
    
    <span class="n">date_range</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;births&#39;</span><span class="p">,</span> 
                         <span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> 
                         <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> 
                         <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
           <span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> 
                   <span class="n">logy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
                   <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
                   <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                   <span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&#34;Name: {name} | {event} in {year}&#34;</span><span class="p">,</span> 
                   <span class="n">grid</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span><span class="o">.</span><span class="nb">max</span><span class="p">(),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">date_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">date_range</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span> <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></code></pre></div>
<h4 id="first-let-s-look-at-a-few-movie-characters-actors">First, let&rsquo;s look at a few movie characters/actors.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Neo&#34;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1999&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The movie The Matrix is released&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_69_0.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Trinity&#34;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1999&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The movie The Matrix is released&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_70_0.png" alt="png" /></p>

<h4 id="how-about-further-back-in-time">How about further back in time?</h4>

<p>Errol Flynn got his big break in Captain Blood back in 1935. Let&rsquo;s see if all that swashbuckling influenced parents when it came to naming their progeny.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Errol&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1935&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1931&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The movie Captain Blood is released&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_72_0.png" alt="png" /></p>

<h4 id="another-possible-hollywood-influence-around-the-same-time">Another possible Hollywood influence around the same time.</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Hedy&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1938&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1915&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1971&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The actress Hedy Lamarr made her Hollywood debut&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_74_0.png" alt="png" /></p>

<h4 id="earlier-still">Earlier still</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Greta&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1925&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1910&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The actress Greta Garbo made her Hollywood debut&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_76_0.png" alt="png" /></p>

<p>Of course, we can&rsquo;t talk about movies without talking about Star Wars.</p>

<p>Let&rsquo;s see if we can track the names of some of the characters.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Leia&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1977&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1995&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The movie Star Wars is released&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_78_0.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Han&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1977&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2015&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The movie Star Wars is released&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_79_0.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Lando&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1977&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2015&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The movie Star Wars is released&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_80_0.png" alt="png" /></p>

<p>Hmmmm&hellip; A bit surprising.</p>

<p>What about other characters from the trilogy?</p>

<p>Fortunately (for the kids) there doesn&rsquo;t seem to be any Jabba or Jar Jar in our list&hellip; (TBH, I&rsquo;m mildly disappointed).</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">characters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;jabba&#34;</span><span class="p">,</span> <span class="s2">&#34;yoda&#34;</span><span class="p">,</span> <span class="s2">&#34;chewbacca&#34;</span><span class="p">,</span> <span class="s2">&#34;jar jar&#34;</span><span class="p">}</span>

<span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&amp;</span> <span class="n">characters</span></code></pre></div><div class="highlight"><pre class="chroma">set()</pre></div>
<p>Let&rsquo;s look at the main character of another popular movie series.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Indiana&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2015&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The movie Raiders Of The Lost Ark was released&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_84_0.png" alt="png" /></p>

<p>While on this topic&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Harrison&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1975&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2015&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The movie Raiders Of The Lost Ark was released&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_86_0.png" alt="png" /></p>

<p>In a different genre we also have:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Clint&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1966&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1950&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The movie The Good, the Bad, and the Ugly was released&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_88_0.png" alt="png" /></p>

<p>We&rsquo;ve focused on movies, but of course, popular culture&rsquo;s influence on baby names isn&rsquo;t limited to movies or television.</p>

<p>Songs or singers can also contribute to the popularity of a given name.</p>

<p>Here are a couple of examples.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Elvis&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1955&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1945&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1991&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;Radios start playing Elvis Presley&#39;s songs&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_90_0.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Michelle&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1965&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1960&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s1">&#39;The song Michelle is released by The Beatles&#39;</span><span class="p">)</span></code></pre></div>
<p><img src="output_91_0.png" alt="png" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Jermaine&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1970&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1960&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The Jackson 5 top the charts&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_92_0.png" alt="png" /></p>

<p>&hellip; And a couple of more recent ones</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Beyonce&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1998&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1995&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2015&#39;</span><span class="p">,</span> 
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;The group Destiny&#39;s Child released its debut album&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_94_0.png" alt="png" /></p>

<p>Same with sport.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">plot_name_event</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;Kobe&#34;</span><span class="p">,</span>  <span class="n">year</span><span class="o">=</span><span class="s1">&#39;1996&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;1988&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2015&#39;</span><span class="p">,</span>
                <span class="n">event</span><span class="o">=</span><span class="s2">&#34;NBA player Kobe Bryant made his debut in the league&#34;</span><span class="p">)</span></code></pre></div>
<p><img src="output_96_0.png" alt="png" /></p>

<p>I&rsquo;ll stop here, but I&rsquo;m sure many other interesting patterns can be found in this data set&hellip;</p>

<p>As I mentioned earlier, the fact that a name&rsquo;s increase in popularity coincides with a particular event isn&rsquo;t enough to demonstrate a causal relationship, however for some of these examples the coincidence is certainly interesting.</p>

<p>In any case, I&rsquo;d like to think that hundreds, if not thousands, of people owe their moniker to George Costanza.</p>

<p>A sobering thought.</p>

<p>That&rsquo;s ok. It could have been worse&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="s2">&#34;Mulva&#34;</span> <span class="ow">in</span> <span class="n">names</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma">False</pre></div>
<p>I had to check!</p>

                
              </div>

              
                <div class="blog-tags">
                  
                    <a href="https://adelr.github.io//tags/python/">python</a>&nbsp;
                  
                    <a href="https://adelr.github.io//tags/seinfeld/">seinfeld</a>&nbsp;
                  
                </div>
              

            </article>
          
        </div>
        
      </div>
    </div>
  </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:dinkumdata@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/adelr" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/DinkumData" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="/tags/python/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Adel Rahmani
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2019
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://adelr.github.io/">Dinkum Data Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.55.5</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://adelr.github.io/js/main.js"></script>
<script src="https://adelr.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://adelr.github.io/js/load-photoswipe.js"></script>









  </body>
</html>

